
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://msk-mind.github.io/luna/reference/pathology/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-8.5.10">
    
    
      
        <title>Luna Pathology - luna: Multi-modality Oncology Data Analysis in Python</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="None" data-md-color-accent="None">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#luna-pathology" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="luna: Multi-modality Oncology Data Analysis in Python" class="md-header__button md-logo" aria-label="luna: Multi-modality Oncology Data Analysis in Python" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            luna: Multi-modality Oncology Data Analysis in Python
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Luna Pathology
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/msk-mind/luna" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    msk-mind/luna
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="luna: Multi-modality Oncology Data Analysis in Python" class="md-nav__button md-logo" aria-label="luna: Multi-modality Oncology Data Analysis in Python" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    luna: Multi-modality Oncology Data Analysis in Python
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/msk-mind/luna" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    msk-mind/luna
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        About
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart/" class="md-nav__link">
        Quick Start
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../user/" class="md-nav__link">
        User Guide
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../tutorials/">Tutorials</a>
          
            <label for="__nav_6">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Tutorials" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/1_dataset-prep/" class="md-nav__link">
        Dataset Preparation Tutorial
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/2_tiling-file/" class="md-nav__link">
        Tile Generation Tutorial (File Edition)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/2_tiling-waystation/" class="md-nav__link">
        Tile Generation Tutorial (Waystation edition)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/3_model-training/" class="md-nav__link">
        Model Training Tutorial
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/4_inference-and-visualization/" class="md-nav__link">
        Inference and Visualization Tutorial
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/5_end-to-end-pipeline/" class="md-nav__link">
        Snakemake End-To-End Tutorial
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/6_dsa-tools/" class="md-nav__link">
        Digital Slide Archive (DSA) Visualization Tutorial
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/7_dsa-annotation/" class="md-nav__link">
        DSA Annotation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/spatial_stats/" class="md-nav__link">
        Calculate and Visualize K-function Statistics
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_7">
          CLI Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="CLI Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          CLI Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_1" type="checkbox" id="__nav_7_1" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_7_1">
          Pathology
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pathology" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_1">
          <span class="md-nav__icon md-icon"></span>
          Pathology
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli_reference/pathology/detect_tissue/" class="md-nav__link">
        detect_tissue
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli_reference/pathology/dsa/" class="md-nav__link">
        dsa
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli_reference/pathology/dsa_upload/" class="md-nav__link">
        dsa_upload
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli_reference/pathology/extract_shape_features/" class="md-nav__link">
        extract_shape_features
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli_reference/pathology/extract_stain_texture/" class="md-nav__link">
        extract_stain_texture
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli_reference/pathology/generate_mask/" class="md-nav__link">
        generate_mask
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli_reference/pathology/generate_tile_mask/" class="md-nav__link">
        generate_tile_mask
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli_reference/pathology/generate_tiles/" class="md-nav__link">
        generate_tiles
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli_reference/pathology/infer_tiles/" class="md-nav__link">
        infer_tiles
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli_reference/pathology/label_tiles/" class="md-nav__link">
        label_tiles
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli_reference/pathology/run_stardist_cell_detection/" class="md-nav__link">
        run_stardist_cell_detection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli_reference/pathology/save_tiles/" class="md-nav__link">
        save_tiles
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli_reference/pathology/slide_etl/" class="md-nav__link">
        slide_etl
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli_reference/pathology/visualize_tiles_png/" class="md-nav__link">
        visualize_tiles_png
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_2" type="checkbox" id="__nav_7_2" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_7_2">
          Radiology
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Radiology" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_2">
          <span class="md-nav__icon md-icon"></span>
          Radiology
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli_reference/radiology/coregister_volumes/" class="md-nav__link">
        coregister_volumes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli_reference/radiology/dicom_to_itk/" class="md-nav__link">
        dicom_to_itk
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli_reference/radiology/extract_radiomics/" class="md-nav__link">
        extract_radiomics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli_reference/radiology/extract_voxels/" class="md-nav__link">
        extract_voxels
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli_reference/radiology/generate_threshold_mask/" class="md-nav__link">
        generate_threshold_mask
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli_reference/radiology/match_metadata/" class="md-nav__link">
        match_metadata
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli_reference/radiology/randomize_contours/" class="md-nav__link">
        randomize_contours
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli_reference/radiology/window_volume/" class="md-nav__link">
        window_volume
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cli_reference/radiology/xnat_etl/" class="md-nav__link">
        xnat_etl
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_8">
          API Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          API Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common/" class="md-nav__link">
        Luna Common
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Luna Pathology
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Luna Pathology
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#luna.pathology" class="md-nav__link">
    pathology
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luna.pathology.analysis" class="md-nav__link">
    analysis
  </a>
  
    <nav class="md-nav" aria-label="analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml" class="md-nav__link">
    ml
  </a>
  
    <nav class="md-nav" aria-label="ml">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchClassifier" class="md-nav__link">
    BaseTorchClassifier
  </a>
  
    <nav class="md-nav" aria-label="BaseTorchClassifier">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchClassifier.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchClassifier.setup" class="md-nav__link">
    setup()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchTileClassifier" class="md-nav__link">
    BaseTorchTileClassifier
  </a>
  
    <nav class="md-nav" aria-label="BaseTorchTileClassifier">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchTileClassifier.forward" class="md-nav__link">
    forward()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchTileClassifier.predict" class="md-nav__link">
    predict()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchTileClassifier.setup" class="md-nav__link">
    setup()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchTileDataset" class="md-nav__link">
    BaseTorchTileDataset
  </a>
  
    <nav class="md-nav" aria-label="BaseTorchTileDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchTileDataset.__getitem__" class="md-nav__link">
    __getitem__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchTileDataset.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchTileDataset.preprocess" class="md-nav__link">
    preprocess()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchTileDataset.setup" class="md-nav__link">
    setup()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.HDF5Dataset" class="md-nav__link">
    HDF5Dataset
  </a>
  
    <nav class="md-nav" aria-label="HDF5Dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.HDF5Dataset.__getitem__" class="md-nav__link">
    __getitem__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.HDF5Dataset.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.TorchTransformModel" class="md-nav__link">
    TorchTransformModel
  </a>
  
    <nav class="md-nav" aria-label="TorchTransformModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.TorchTransformModel.get_preprocess" class="md-nav__link">
    get_preprocess()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.TorchTransformModel.transform" class="md-nav__link">
    transform()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.get_group_stratified_sampler" class="md-nav__link">
    get_group_stratified_sampler()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.post_transform_to_2d" class="md-nav__link">
    post_transform_to_2d()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luna.pathology.cli" class="md-nav__link">
    cli
  </a>
  
    <nav class="md-nav" aria-label="cli">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.create_wide_shape_features_query" class="md-nav__link">
    create_wide_shape_features_query
  </a>
  
    <nav class="md-nav" aria-label="create_wide_shape_features_query">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.create_wide_shape_features_query.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.create_wide_shape_features_query.create_wide_shape_features_query" class="md-nav__link">
    create_wide_shape_features_query()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_annotation_etl" class="md-nav__link">
    dsa_annotation_etl
  </a>
  
    <nav class="md-nav" aria-label="dsa_annotation_etl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_annotation_etl.DsaAnnotationProcessor" class="md-nav__link">
    DsaAnnotationProcessor
  </a>
  
    <nav class="md-nav" aria-label="DsaAnnotationProcessor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_annotation_etl.DsaAnnotationProcessor.build_proxy_repr_dsa" class="md-nav__link">
    build_proxy_repr_dsa()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_annotation_etl.DsaAnnotationProcessor.histomics_annotation_table_to_geojson" class="md-nav__link">
    histomics_annotation_table_to_geojson()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_annotation_etl.DsaAnnotationProcessor.run" class="md-nav__link">
    run()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_annotation_etl.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_annotation_etl.dsa_annotation_etl" class="md-nav__link">
    dsa_annotation_etl()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_upload" class="md-nav__link">
    dsa_upload
  </a>
  
    <nav class="md-nav" aria-label="dsa_upload">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_upload.__upload_annotation_to_dsa" class="md-nav__link">
    __upload_annotation_to_dsa()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_upload.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_upload.upload_annotation_to_dsa" class="md-nav__link">
    upload_annotation_to_dsa()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz" class="md-nav__link">
    dsa_viz
  </a>
  
    <nav class="md-nav" aria-label="dsa_viz">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.__bmp_polygon" class="md-nav__link">
    __bmp_polygon()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.__heatmap" class="md-nav__link">
    __heatmap()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.__qupath_polygon" class="md-nav__link">
    __qupath_polygon()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.__regional_polygon" class="md-nav__link">
    __regional_polygon()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.__stardist_cell" class="md-nav__link">
    __stardist_cell()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.__stardist_polygon" class="md-nav__link">
    __stardist_polygon()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.__stardist_polygon_tile" class="md-nav__link">
    __stardist_polygon_tile()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.bitmask_polygon" class="md-nav__link">
    bitmask_polygon()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.bitmask_polygon_cli" class="md-nav__link">
    bitmask_polygon_cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.bmp_polygon" class="md-nav__link">
    bmp_polygon()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.bmp_polygon_cli" class="md-nav__link">
    bmp_polygon_cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.check_filepaths_valid" class="md-nav__link">
    check_filepaths_valid()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.get_dsa_annotation" class="md-nav__link">
    get_dsa_annotation()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.heatmap" class="md-nav__link">
    heatmap()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.heatmap_cli" class="md-nav__link">
    heatmap_cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.qupath_polygon" class="md-nav__link">
    qupath_polygon()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.qupath_polygon_cli" class="md-nav__link">
    qupath_polygon_cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.regional_polygon" class="md-nav__link">
    regional_polygon()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.regional_polygon_cli" class="md-nav__link">
    regional_polygon_cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.save_dsa_annotation" class="md-nav__link">
    save_dsa_annotation()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.stardist_cell" class="md-nav__link">
    stardist_cell()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.stardist_cell_cli" class="md-nav__link">
    stardist_cell_cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.stardist_polygon" class="md-nav__link">
    stardist_polygon()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.stardist_polygon_cli" class="md-nav__link">
    stardist_polygon_cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.stardist_polygon_tile" class="md-nav__link">
    stardist_polygon_tile()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.stardist_polygon_tile_cli" class="md-nav__link">
    stardist_polygon_tile_cli()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_kfunction_statistics" class="md-nav__link">
    extract_kfunction_statistics
  </a>
  
    <nav class="md-nav" aria-label="extract_kfunction_statistics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_kfunction_statistics.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_kfunction_statistics.extract_kfunction" class="md-nav__link">
    extract_kfunction()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_shape_features" class="md-nav__link">
    extract_shape_features
  </a>
  
    <nav class="md-nav" aria-label="extract_shape_features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_shape_features.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_shape_features.extract_shape_features" class="md-nav__link">
    extract_shape_features()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_stain_texture" class="md-nav__link">
    extract_stain_texture
  </a>
  
    <nav class="md-nav" aria-label="extract_stain_texture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_stain_texture.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_stain_texture.extract_stain_texture" class="md-nav__link">
    extract_stain_texture()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_tile_shape_features" class="md-nav__link">
    extract_tile_shape_features
  </a>
  
    <nav class="md-nav" aria-label="extract_tile_shape_features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_tile_shape_features.__extract_tile_shape_features" class="md-nav__link">
    __extract_tile_shape_features()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_tile_shape_features.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_tile_shape_features.extract_tile_shape_features" class="md-nav__link">
    extract_tile_shape_features()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_tile_statistics" class="md-nav__link">
    extract_tile_statistics
  </a>
  
    <nav class="md-nav" aria-label="extract_tile_statistics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_tile_statistics.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_tile_statistics.extract_tile_statistics" class="md-nav__link">
    extract_tile_statistics()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_mask" class="md-nav__link">
    generate_mask
  </a>
  
    <nav class="md-nav" aria-label="generate_mask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_mask.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_mask.generate_mask" class="md-nav__link">
    generate_mask()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_tile_labels" class="md-nav__link">
    generate_tile_labels
  </a>
  
    <nav class="md-nav" aria-label="generate_tile_labels">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_tile_labels.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_tile_labels.generate_tile_labels" class="md-nav__link">
    generate_tile_labels()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_tile_mask" class="md-nav__link">
    generate_tile_mask
  </a>
  
    <nav class="md-nav" aria-label="generate_tile_mask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_tile_mask.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_tile_mask.convert_tiles_to_mask" class="md-nav__link">
    convert_tiles_to_mask()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_tiles" class="md-nav__link">
    generate_tiles
  </a>
  
    <nav class="md-nav" aria-label="generate_tiles">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_tiles.__generate_tiles" class="md-nav__link">
    __generate_tiles()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_tiles.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.infer_tile_labels" class="md-nav__link">
    infer_tile_labels
  </a>
  
    <nav class="md-nav" aria-label="infer_tile_labels">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.infer_tile_labels.__infer_tile_labels" class="md-nav__link">
    __infer_tile_labels()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.infer_tile_labels.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.infer_tile_labels.infer_tile_labels" class="md-nav__link">
    infer_tile_labels()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.merge_shape_features" class="md-nav__link">
    merge_shape_features
  </a>
  
    <nav class="md-nav" aria-label="merge_shape_features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.merge_shape_features.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_stardist_cell_detection" class="md-nav__link">
    run_stardist_cell_detection
  </a>
  
    <nav class="md-nav" aria-label="run_stardist_cell_detection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_stardist_cell_detection.__stardist_cell_lymphocyte" class="md-nav__link">
    __stardist_cell_lymphocyte()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_stardist_cell_detection.__stardist_simple" class="md-nav__link">
    __stardist_simple()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_stardist_cell_detection.stardist_cell_lymphocyte" class="md-nav__link">
    stardist_cell_lymphocyte()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_stardist_cell_detection.stardist_cell_lymphocyte_cli" class="md-nav__link">
    stardist_cell_lymphocyte_cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_stardist_cell_detection.stardist_simple" class="md-nav__link">
    stardist_simple()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_stardist_cell_detection.stardist_simple_cli" class="md-nav__link">
    stardist_simple_cli()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_tissue_detection" class="md-nav__link">
    run_tissue_detection
  </a>
  
    <nav class="md-nav" aria-label="run_tissue_detection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_tissue_detection.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_tissue_detection.compute_otsu_score" class="md-nav__link">
    compute_otsu_score()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_tissue_detection.compute_purple_score" class="md-nav__link">
    compute_purple_score()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_tissue_detection.compute_stain_score" class="md-nav__link">
    compute_stain_score()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_tissue_detection.detect_tissue" class="md-nav__link">
    detect_tissue()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.save_tiles" class="md-nav__link">
    save_tiles
  </a>
  
    <nav class="md-nav" aria-label="save_tiles">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.save_tiles.__save_tiles" class="md-nav__link">
    __save_tiles()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.save_tiles.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.save_tiles.save_tiles" class="md-nav__link">
    save_tiles()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.slide_etl" class="md-nav__link">
    slide_etl
  </a>
  
    <nav class="md-nav" aria-label="slide_etl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.slide_etl.SlideBuilder" class="md-nav__link">
    SlideBuilder
  </a>
  
    <nav class="md-nav" aria-label="SlideBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.slide_etl.SlideBuilder.get_slide" class="md-nav__link">
    get_slide()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.slide_etl.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.slide_etl.slide_etl" class="md-nav__link">
    slide_etl()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.visualize_tile_labels_png" class="md-nav__link">
    visualize_tile_labels_png
  </a>
  
    <nav class="md-nav" aria-label="visualize_tile_labels_png">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.visualize_tile_labels_png.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.visualize_tile_labels_png.visualize_tiles" class="md-nav__link">
    visualize_tiles()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luna.pathology.common" class="md-nav__link">
    common
  </a>
  
    <nav class="md-nav" aria-label="common">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.annotation_utils" class="md-nav__link">
    annotation_utils
  </a>
  
    <nav class="md-nav" aria-label="annotation_utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.annotation_utils.check_slideviewer_and_download_bmp" class="md-nav__link">
    check_slideviewer_and_download_bmp()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.annotation_utils.convert_bmp_to_npy" class="md-nav__link">
    convert_bmp_to_npy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.annotation_utils.convert_slide_bitmap_to_geojson" class="md-nav__link">
    convert_slide_bitmap_to_geojson()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.annotation_utils.get_slide_bitmap" class="md-nav__link">
    get_slide_bitmap()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.build_geojson" class="md-nav__link">
    build_geojson
  </a>
  
    <nav class="md-nav" aria-label="build_geojson">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.build_geojson.add_contours_for_label" class="md-nav__link">
    add_contours_for_label()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.build_geojson.build_all_geojsons_from_default" class="md-nav__link">
    build_all_geojsons_from_default()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.build_geojson.build_default_geojson_from_annotation" class="md-nav__link">
    build_default_geojson_from_annotation()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.build_geojson.build_geojson_from_annotation" class="md-nav__link">
    build_geojson_from_annotation()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.build_geojson.build_geojson_from_pointclick_json" class="md-nav__link">
    build_geojson_from_pointclick_json()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.build_geojson.build_labelset_specific_geojson" class="md-nav__link">
    build_labelset_specific_geojson()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.build_geojson.concatenate_regional_geojsons" class="md-nav__link">
    concatenate_regional_geojsons()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.build_geojson.find_parents" class="md-nav__link">
    find_parents()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.build_geojson.handler" class="md-nav__link">
    handler()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.deepzoom" class="md-nav__link">
    deepzoom
  </a>
  
    <nav class="md-nav" aria-label="deepzoom">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.deepzoom.DeepZoomGenerator" class="md-nav__link">
    DeepZoomGenerator
  </a>
  
    <nav class="md-nav" aria-label="DeepZoomGenerator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.deepzoom.DeepZoomGenerator.level_count" class="md-nav__link">
    level_count
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.deepzoom.DeepZoomGenerator.level_dimensions" class="md-nav__link">
    level_dimensions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.deepzoom.DeepZoomGenerator.level_tiles" class="md-nav__link">
    level_tiles
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.deepzoom.DeepZoomGenerator.tile_count" class="md-nav__link">
    tile_count
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.deepzoom.DeepZoomGenerator.get_tile" class="md-nav__link">
    get_tile()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.schemas" class="md-nav__link">
    schemas
  </a>
  
    <nav class="md-nav" aria-label="schemas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.schemas.SlideTiles" class="md-nav__link">
    SlideTiles
  </a>
  
    <nav class="md-nav" aria-label="SlideTiles">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.schemas.SlideTiles.check" class="md-nav__link">
    check()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.slideviewer_client" class="md-nav__link">
    slideviewer_client
  </a>
  
    <nav class="md-nav" aria-label="slideviewer_client">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.slideviewer_client.download_sv_point_annotation" class="md-nav__link">
    download_sv_point_annotation()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.slideviewer_client.download_zip" class="md-nav__link">
    download_zip()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.slideviewer_client.fetch_slide_ids" class="md-nav__link">
    fetch_slide_ids()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.slideviewer_client.get_slide_id" class="md-nav__link">
    get_slide_id()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.slideviewer_client.unzip" class="md-nav__link">
    unzip()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils" class="md-nav__link">
    utils
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.address_to_coord" class="md-nav__link">
    address_to_coord()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.convert_halo_xml_to_roi" class="md-nav__link">
    convert_halo_xml_to_roi()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.convert_xml_to_mask" class="md-nav__link">
    convert_xml_to_mask()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.coord_to_address" class="md-nav__link">
    coord_to_address()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.extract_patch_texture_features" class="md-nav__link">
    extract_patch_texture_features()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.get_downscaled_thumbnail" class="md-nav__link">
    get_downscaled_thumbnail()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.get_full_resolution_generator" class="md-nav__link">
    get_full_resolution_generator()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.get_layer_names" class="md-nav__link">
    get_layer_names()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.get_scale_factor_at_magnification" class="md-nav__link">
    get_scale_factor_at_magnification()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.get_stain_vectors_macenko" class="md-nav__link">
    get_stain_vectors_macenko()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.get_tile_array" class="md-nav__link">
    get_tile_array()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.get_tile_arrays" class="md-nav__link">
    get_tile_arrays()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.get_tile_color" class="md-nav__link">
    get_tile_color()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.pull_stain_channel" class="md-nav__link">
    pull_stain_channel()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.visualize_tiling_scores" class="md-nav__link">
    visualize_tiling_scores()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luna.pathology.dsa" class="md-nav__link">
    dsa
  </a>
  
    <nav class="md-nav" aria-label="dsa">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler" class="md-nav__link">
    dsa_api_handler
  </a>
  
    <nav class="md-nav" aria-label="dsa_api_handler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.copy_item" class="md-nav__link">
    copy_item()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.create_collection" class="md-nav__link">
    create_collection()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.create_folder" class="md-nav__link">
    create_folder()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.create_s3_assetstore" class="md-nav__link">
    create_s3_assetstore()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.dsa_authenticate" class="md-nav__link">
    dsa_authenticate()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.get_annotation_df" class="md-nav__link">
    get_annotation_df()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.get_assetstore_uuid" class="md-nav__link">
    get_assetstore_uuid()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.get_collection_metadata" class="md-nav__link">
    get_collection_metadata()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.get_collection_uuid" class="md-nav__link">
    get_collection_uuid()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.get_folder_uuid" class="md-nav__link">
    get_folder_uuid()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.get_item_uuid" class="md-nav__link">
    get_item_uuid()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.get_item_uuid_by_folder" class="md-nav__link">
    get_item_uuid_by_folder()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.get_slide_annotation" class="md-nav__link">
    get_slide_annotation()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.get_slide_df" class="md-nav__link">
    get_slide_df()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.import_assetstore_to_folder" class="md-nav__link">
    import_assetstore_to_folder()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.push_annotation_to_dsa_image" class="md-nav__link">
    push_annotation_to_dsa_image()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.system_check" class="md-nav__link">
    system_check()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.utils" class="md-nav__link">
    utils
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.utils.get_color" class="md-nav__link">
    get_color()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.utils.get_continuous_color" class="md-nav__link">
    get_continuous_color()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.utils.vectorize_np_array_bitmask_by_pixel_value" class="md-nav__link">
    vectorize_np_array_bitmask_by_pixel_value()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luna.pathology.slideviewer" class="md-nav__link">
    slideviewer
  </a>
  
    <nav class="md-nav" aria-label="slideviewer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.slideviewer.regional_annotation" class="md-nav__link">
    regional_annotation
  </a>
  
    <nav class="md-nav" aria-label="regional_annotation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.slideviewer.regional_annotation.dask_generate" class="md-nav__link">
    dask_generate
  </a>
  
    <nav class="md-nav" aria-label="dask_generate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.slideviewer.regional_annotation.dask_generate.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.slideviewer.regional_annotation.dask_generate.create_geojson_table" class="md-nav__link">
    create_geojson_table()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luna.pathology.spatial" class="md-nav__link">
    spatial
  </a>
  
    <nav class="md-nav" aria-label="spatial">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.spatial.stats" class="md-nav__link">
    stats
  </a>
  
    <nav class="md-nav" aria-label="stats">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.spatial.stats.Kfunction" class="md-nav__link">
    Kfunction()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.spatial.transforms" class="md-nav__link">
    transforms
  </a>
  
    <nav class="md-nav" aria-label="transforms">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.spatial.transforms.generate_k_function_statistics" class="md-nav__link">
    generate_k_function_statistics()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../radiology/" class="md-nav__link">
        Luna Radiology
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_9">
          Developers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Developers" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Developers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/" class="md-nav__link">
        Development Guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../publications/" class="md-nav__link">
        Publications
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../history/" class="md-nav__link">
        Release History
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#luna.pathology" class="md-nav__link">
    pathology
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luna.pathology.analysis" class="md-nav__link">
    analysis
  </a>
  
    <nav class="md-nav" aria-label="analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml" class="md-nav__link">
    ml
  </a>
  
    <nav class="md-nav" aria-label="ml">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchClassifier" class="md-nav__link">
    BaseTorchClassifier
  </a>
  
    <nav class="md-nav" aria-label="BaseTorchClassifier">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchClassifier.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchClassifier.setup" class="md-nav__link">
    setup()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchTileClassifier" class="md-nav__link">
    BaseTorchTileClassifier
  </a>
  
    <nav class="md-nav" aria-label="BaseTorchTileClassifier">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchTileClassifier.forward" class="md-nav__link">
    forward()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchTileClassifier.predict" class="md-nav__link">
    predict()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchTileClassifier.setup" class="md-nav__link">
    setup()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchTileDataset" class="md-nav__link">
    BaseTorchTileDataset
  </a>
  
    <nav class="md-nav" aria-label="BaseTorchTileDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchTileDataset.__getitem__" class="md-nav__link">
    __getitem__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchTileDataset.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchTileDataset.preprocess" class="md-nav__link">
    preprocess()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.BaseTorchTileDataset.setup" class="md-nav__link">
    setup()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.HDF5Dataset" class="md-nav__link">
    HDF5Dataset
  </a>
  
    <nav class="md-nav" aria-label="HDF5Dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.HDF5Dataset.__getitem__" class="md-nav__link">
    __getitem__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.HDF5Dataset.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.TorchTransformModel" class="md-nav__link">
    TorchTransformModel
  </a>
  
    <nav class="md-nav" aria-label="TorchTransformModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.TorchTransformModel.get_preprocess" class="md-nav__link">
    get_preprocess()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.TorchTransformModel.transform" class="md-nav__link">
    transform()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.get_group_stratified_sampler" class="md-nav__link">
    get_group_stratified_sampler()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.analysis.ml.post_transform_to_2d" class="md-nav__link">
    post_transform_to_2d()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luna.pathology.cli" class="md-nav__link">
    cli
  </a>
  
    <nav class="md-nav" aria-label="cli">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.create_wide_shape_features_query" class="md-nav__link">
    create_wide_shape_features_query
  </a>
  
    <nav class="md-nav" aria-label="create_wide_shape_features_query">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.create_wide_shape_features_query.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.create_wide_shape_features_query.create_wide_shape_features_query" class="md-nav__link">
    create_wide_shape_features_query()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_annotation_etl" class="md-nav__link">
    dsa_annotation_etl
  </a>
  
    <nav class="md-nav" aria-label="dsa_annotation_etl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_annotation_etl.DsaAnnotationProcessor" class="md-nav__link">
    DsaAnnotationProcessor
  </a>
  
    <nav class="md-nav" aria-label="DsaAnnotationProcessor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_annotation_etl.DsaAnnotationProcessor.build_proxy_repr_dsa" class="md-nav__link">
    build_proxy_repr_dsa()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_annotation_etl.DsaAnnotationProcessor.histomics_annotation_table_to_geojson" class="md-nav__link">
    histomics_annotation_table_to_geojson()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_annotation_etl.DsaAnnotationProcessor.run" class="md-nav__link">
    run()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_annotation_etl.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_annotation_etl.dsa_annotation_etl" class="md-nav__link">
    dsa_annotation_etl()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_upload" class="md-nav__link">
    dsa_upload
  </a>
  
    <nav class="md-nav" aria-label="dsa_upload">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_upload.__upload_annotation_to_dsa" class="md-nav__link">
    __upload_annotation_to_dsa()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_upload.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_upload.upload_annotation_to_dsa" class="md-nav__link">
    upload_annotation_to_dsa()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz" class="md-nav__link">
    dsa_viz
  </a>
  
    <nav class="md-nav" aria-label="dsa_viz">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.__bmp_polygon" class="md-nav__link">
    __bmp_polygon()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.__heatmap" class="md-nav__link">
    __heatmap()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.__qupath_polygon" class="md-nav__link">
    __qupath_polygon()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.__regional_polygon" class="md-nav__link">
    __regional_polygon()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.__stardist_cell" class="md-nav__link">
    __stardist_cell()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.__stardist_polygon" class="md-nav__link">
    __stardist_polygon()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.__stardist_polygon_tile" class="md-nav__link">
    __stardist_polygon_tile()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.bitmask_polygon" class="md-nav__link">
    bitmask_polygon()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.bitmask_polygon_cli" class="md-nav__link">
    bitmask_polygon_cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.bmp_polygon" class="md-nav__link">
    bmp_polygon()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.bmp_polygon_cli" class="md-nav__link">
    bmp_polygon_cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.check_filepaths_valid" class="md-nav__link">
    check_filepaths_valid()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.get_dsa_annotation" class="md-nav__link">
    get_dsa_annotation()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.heatmap" class="md-nav__link">
    heatmap()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.heatmap_cli" class="md-nav__link">
    heatmap_cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.qupath_polygon" class="md-nav__link">
    qupath_polygon()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.qupath_polygon_cli" class="md-nav__link">
    qupath_polygon_cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.regional_polygon" class="md-nav__link">
    regional_polygon()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.regional_polygon_cli" class="md-nav__link">
    regional_polygon_cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.save_dsa_annotation" class="md-nav__link">
    save_dsa_annotation()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.stardist_cell" class="md-nav__link">
    stardist_cell()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.stardist_cell_cli" class="md-nav__link">
    stardist_cell_cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.stardist_polygon" class="md-nav__link">
    stardist_polygon()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.stardist_polygon_cli" class="md-nav__link">
    stardist_polygon_cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.stardist_polygon_tile" class="md-nav__link">
    stardist_polygon_tile()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.dsa_viz.stardist_polygon_tile_cli" class="md-nav__link">
    stardist_polygon_tile_cli()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_kfunction_statistics" class="md-nav__link">
    extract_kfunction_statistics
  </a>
  
    <nav class="md-nav" aria-label="extract_kfunction_statistics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_kfunction_statistics.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_kfunction_statistics.extract_kfunction" class="md-nav__link">
    extract_kfunction()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_shape_features" class="md-nav__link">
    extract_shape_features
  </a>
  
    <nav class="md-nav" aria-label="extract_shape_features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_shape_features.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_shape_features.extract_shape_features" class="md-nav__link">
    extract_shape_features()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_stain_texture" class="md-nav__link">
    extract_stain_texture
  </a>
  
    <nav class="md-nav" aria-label="extract_stain_texture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_stain_texture.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_stain_texture.extract_stain_texture" class="md-nav__link">
    extract_stain_texture()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_tile_shape_features" class="md-nav__link">
    extract_tile_shape_features
  </a>
  
    <nav class="md-nav" aria-label="extract_tile_shape_features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_tile_shape_features.__extract_tile_shape_features" class="md-nav__link">
    __extract_tile_shape_features()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_tile_shape_features.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_tile_shape_features.extract_tile_shape_features" class="md-nav__link">
    extract_tile_shape_features()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_tile_statistics" class="md-nav__link">
    extract_tile_statistics
  </a>
  
    <nav class="md-nav" aria-label="extract_tile_statistics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_tile_statistics.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.extract_tile_statistics.extract_tile_statistics" class="md-nav__link">
    extract_tile_statistics()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_mask" class="md-nav__link">
    generate_mask
  </a>
  
    <nav class="md-nav" aria-label="generate_mask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_mask.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_mask.generate_mask" class="md-nav__link">
    generate_mask()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_tile_labels" class="md-nav__link">
    generate_tile_labels
  </a>
  
    <nav class="md-nav" aria-label="generate_tile_labels">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_tile_labels.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_tile_labels.generate_tile_labels" class="md-nav__link">
    generate_tile_labels()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_tile_mask" class="md-nav__link">
    generate_tile_mask
  </a>
  
    <nav class="md-nav" aria-label="generate_tile_mask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_tile_mask.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_tile_mask.convert_tiles_to_mask" class="md-nav__link">
    convert_tiles_to_mask()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_tiles" class="md-nav__link">
    generate_tiles
  </a>
  
    <nav class="md-nav" aria-label="generate_tiles">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_tiles.__generate_tiles" class="md-nav__link">
    __generate_tiles()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.generate_tiles.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.infer_tile_labels" class="md-nav__link">
    infer_tile_labels
  </a>
  
    <nav class="md-nav" aria-label="infer_tile_labels">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.infer_tile_labels.__infer_tile_labels" class="md-nav__link">
    __infer_tile_labels()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.infer_tile_labels.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.infer_tile_labels.infer_tile_labels" class="md-nav__link">
    infer_tile_labels()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.merge_shape_features" class="md-nav__link">
    merge_shape_features
  </a>
  
    <nav class="md-nav" aria-label="merge_shape_features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.merge_shape_features.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_stardist_cell_detection" class="md-nav__link">
    run_stardist_cell_detection
  </a>
  
    <nav class="md-nav" aria-label="run_stardist_cell_detection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_stardist_cell_detection.__stardist_cell_lymphocyte" class="md-nav__link">
    __stardist_cell_lymphocyte()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_stardist_cell_detection.__stardist_simple" class="md-nav__link">
    __stardist_simple()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_stardist_cell_detection.stardist_cell_lymphocyte" class="md-nav__link">
    stardist_cell_lymphocyte()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_stardist_cell_detection.stardist_cell_lymphocyte_cli" class="md-nav__link">
    stardist_cell_lymphocyte_cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_stardist_cell_detection.stardist_simple" class="md-nav__link">
    stardist_simple()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_stardist_cell_detection.stardist_simple_cli" class="md-nav__link">
    stardist_simple_cli()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_tissue_detection" class="md-nav__link">
    run_tissue_detection
  </a>
  
    <nav class="md-nav" aria-label="run_tissue_detection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_tissue_detection.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_tissue_detection.compute_otsu_score" class="md-nav__link">
    compute_otsu_score()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_tissue_detection.compute_purple_score" class="md-nav__link">
    compute_purple_score()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_tissue_detection.compute_stain_score" class="md-nav__link">
    compute_stain_score()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.run_tissue_detection.detect_tissue" class="md-nav__link">
    detect_tissue()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.save_tiles" class="md-nav__link">
    save_tiles
  </a>
  
    <nav class="md-nav" aria-label="save_tiles">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.save_tiles.__save_tiles" class="md-nav__link">
    __save_tiles()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.save_tiles.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.save_tiles.save_tiles" class="md-nav__link">
    save_tiles()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.slide_etl" class="md-nav__link">
    slide_etl
  </a>
  
    <nav class="md-nav" aria-label="slide_etl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.slide_etl.SlideBuilder" class="md-nav__link">
    SlideBuilder
  </a>
  
    <nav class="md-nav" aria-label="SlideBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.slide_etl.SlideBuilder.get_slide" class="md-nav__link">
    get_slide()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.slide_etl.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.slide_etl.slide_etl" class="md-nav__link">
    slide_etl()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.visualize_tile_labels_png" class="md-nav__link">
    visualize_tile_labels_png
  </a>
  
    <nav class="md-nav" aria-label="visualize_tile_labels_png">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.visualize_tile_labels_png.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.cli.visualize_tile_labels_png.visualize_tiles" class="md-nav__link">
    visualize_tiles()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luna.pathology.common" class="md-nav__link">
    common
  </a>
  
    <nav class="md-nav" aria-label="common">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.annotation_utils" class="md-nav__link">
    annotation_utils
  </a>
  
    <nav class="md-nav" aria-label="annotation_utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.annotation_utils.check_slideviewer_and_download_bmp" class="md-nav__link">
    check_slideviewer_and_download_bmp()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.annotation_utils.convert_bmp_to_npy" class="md-nav__link">
    convert_bmp_to_npy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.annotation_utils.convert_slide_bitmap_to_geojson" class="md-nav__link">
    convert_slide_bitmap_to_geojson()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.annotation_utils.get_slide_bitmap" class="md-nav__link">
    get_slide_bitmap()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.build_geojson" class="md-nav__link">
    build_geojson
  </a>
  
    <nav class="md-nav" aria-label="build_geojson">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.build_geojson.add_contours_for_label" class="md-nav__link">
    add_contours_for_label()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.build_geojson.build_all_geojsons_from_default" class="md-nav__link">
    build_all_geojsons_from_default()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.build_geojson.build_default_geojson_from_annotation" class="md-nav__link">
    build_default_geojson_from_annotation()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.build_geojson.build_geojson_from_annotation" class="md-nav__link">
    build_geojson_from_annotation()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.build_geojson.build_geojson_from_pointclick_json" class="md-nav__link">
    build_geojson_from_pointclick_json()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.build_geojson.build_labelset_specific_geojson" class="md-nav__link">
    build_labelset_specific_geojson()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.build_geojson.concatenate_regional_geojsons" class="md-nav__link">
    concatenate_regional_geojsons()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.build_geojson.find_parents" class="md-nav__link">
    find_parents()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.build_geojson.handler" class="md-nav__link">
    handler()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.deepzoom" class="md-nav__link">
    deepzoom
  </a>
  
    <nav class="md-nav" aria-label="deepzoom">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.deepzoom.DeepZoomGenerator" class="md-nav__link">
    DeepZoomGenerator
  </a>
  
    <nav class="md-nav" aria-label="DeepZoomGenerator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.deepzoom.DeepZoomGenerator.level_count" class="md-nav__link">
    level_count
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.deepzoom.DeepZoomGenerator.level_dimensions" class="md-nav__link">
    level_dimensions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.deepzoom.DeepZoomGenerator.level_tiles" class="md-nav__link">
    level_tiles
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.deepzoom.DeepZoomGenerator.tile_count" class="md-nav__link">
    tile_count
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.deepzoom.DeepZoomGenerator.get_tile" class="md-nav__link">
    get_tile()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.schemas" class="md-nav__link">
    schemas
  </a>
  
    <nav class="md-nav" aria-label="schemas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.schemas.SlideTiles" class="md-nav__link">
    SlideTiles
  </a>
  
    <nav class="md-nav" aria-label="SlideTiles">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.schemas.SlideTiles.check" class="md-nav__link">
    check()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.slideviewer_client" class="md-nav__link">
    slideviewer_client
  </a>
  
    <nav class="md-nav" aria-label="slideviewer_client">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.slideviewer_client.download_sv_point_annotation" class="md-nav__link">
    download_sv_point_annotation()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.slideviewer_client.download_zip" class="md-nav__link">
    download_zip()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.slideviewer_client.fetch_slide_ids" class="md-nav__link">
    fetch_slide_ids()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.slideviewer_client.get_slide_id" class="md-nav__link">
    get_slide_id()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.slideviewer_client.unzip" class="md-nav__link">
    unzip()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils" class="md-nav__link">
    utils
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.address_to_coord" class="md-nav__link">
    address_to_coord()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.convert_halo_xml_to_roi" class="md-nav__link">
    convert_halo_xml_to_roi()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.convert_xml_to_mask" class="md-nav__link">
    convert_xml_to_mask()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.coord_to_address" class="md-nav__link">
    coord_to_address()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.extract_patch_texture_features" class="md-nav__link">
    extract_patch_texture_features()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.get_downscaled_thumbnail" class="md-nav__link">
    get_downscaled_thumbnail()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.get_full_resolution_generator" class="md-nav__link">
    get_full_resolution_generator()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.get_layer_names" class="md-nav__link">
    get_layer_names()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.get_scale_factor_at_magnification" class="md-nav__link">
    get_scale_factor_at_magnification()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.get_stain_vectors_macenko" class="md-nav__link">
    get_stain_vectors_macenko()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.get_tile_array" class="md-nav__link">
    get_tile_array()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.get_tile_arrays" class="md-nav__link">
    get_tile_arrays()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.get_tile_color" class="md-nav__link">
    get_tile_color()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.pull_stain_channel" class="md-nav__link">
    pull_stain_channel()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.common.utils.visualize_tiling_scores" class="md-nav__link">
    visualize_tiling_scores()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luna.pathology.dsa" class="md-nav__link">
    dsa
  </a>
  
    <nav class="md-nav" aria-label="dsa">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler" class="md-nav__link">
    dsa_api_handler
  </a>
  
    <nav class="md-nav" aria-label="dsa_api_handler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.copy_item" class="md-nav__link">
    copy_item()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.create_collection" class="md-nav__link">
    create_collection()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.create_folder" class="md-nav__link">
    create_folder()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.create_s3_assetstore" class="md-nav__link">
    create_s3_assetstore()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.dsa_authenticate" class="md-nav__link">
    dsa_authenticate()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.get_annotation_df" class="md-nav__link">
    get_annotation_df()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.get_assetstore_uuid" class="md-nav__link">
    get_assetstore_uuid()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.get_collection_metadata" class="md-nav__link">
    get_collection_metadata()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.get_collection_uuid" class="md-nav__link">
    get_collection_uuid()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.get_folder_uuid" class="md-nav__link">
    get_folder_uuid()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.get_item_uuid" class="md-nav__link">
    get_item_uuid()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.get_item_uuid_by_folder" class="md-nav__link">
    get_item_uuid_by_folder()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.get_slide_annotation" class="md-nav__link">
    get_slide_annotation()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.get_slide_df" class="md-nav__link">
    get_slide_df()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.import_assetstore_to_folder" class="md-nav__link">
    import_assetstore_to_folder()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.push_annotation_to_dsa_image" class="md-nav__link">
    push_annotation_to_dsa_image()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.dsa_api_handler.system_check" class="md-nav__link">
    system_check()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.utils" class="md-nav__link">
    utils
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.utils.get_color" class="md-nav__link">
    get_color()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.utils.get_continuous_color" class="md-nav__link">
    get_continuous_color()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.dsa.utils.vectorize_np_array_bitmask_by_pixel_value" class="md-nav__link">
    vectorize_np_array_bitmask_by_pixel_value()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luna.pathology.slideviewer" class="md-nav__link">
    slideviewer
  </a>
  
    <nav class="md-nav" aria-label="slideviewer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.slideviewer.regional_annotation" class="md-nav__link">
    regional_annotation
  </a>
  
    <nav class="md-nav" aria-label="regional_annotation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.slideviewer.regional_annotation.dask_generate" class="md-nav__link">
    dask_generate
  </a>
  
    <nav class="md-nav" aria-label="dask_generate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.slideviewer.regional_annotation.dask_generate.cli" class="md-nav__link">
    cli()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.slideviewer.regional_annotation.dask_generate.create_geojson_table" class="md-nav__link">
    create_geojson_table()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luna.pathology.spatial" class="md-nav__link">
    spatial
  </a>
  
    <nav class="md-nav" aria-label="spatial">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.spatial.stats" class="md-nav__link">
    stats
  </a>
  
    <nav class="md-nav" aria-label="stats">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.spatial.stats.Kfunction" class="md-nav__link">
    Kfunction()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luna.pathology.spatial.transforms" class="md-nav__link">
    transforms
  </a>
  
    <nav class="md-nav" aria-label="transforms">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luna.pathology.spatial.transforms.generate_k_function_statistics" class="md-nav__link">
    generate_k_function_statistics()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/msk-mind/luna/edit/master/docs/reference/pathology.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="luna-pathology">Luna Pathology<a class="headerlink" href="#luna-pathology" title="Permanent link">&para;</a></h1>


<div class="doc doc-object doc-module">



<a id="luna.pathology"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-module">




<h2 id="luna.pathology.analysis" class="doc doc-heading">
          <code>analysis</code>


<a href="#luna.pathology.analysis" class="headerlink" title="Permanent link">&para;</a></h2>

  <div class="doc doc-contents ">
  
      <p>Created on April 27, 2021</p>
<p>@author: pashaa@mskcc.org</p>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-module">




<h3 id="luna.pathology.analysis.ml" class="doc doc-heading">
          <code>ml</code>


<a href="#luna.pathology.analysis.ml" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">




<h4 id="luna.pathology.analysis.ml.BaseTorchClassifier" class="doc doc-heading">
          <code>BaseTorchClassifier</code>


<a href="#luna.pathology.analysis.ml.BaseTorchClassifier" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><span title="torch.nn.Module">Module</span></code></p>


            <details class="quote">
              <summary>Source code in <code>src/luna/pathology/analysis/ml.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-233" name="__codelineno-0-233"></a><span class="k">class</span> <span class="nc">BaseTorchClassifier</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize BaseTorchClassifier</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a><span class="sd">        A generic base class for a PyTorch classifier model. This serves as the base class inhereted</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a><span class="sd">        for model training and inference.</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="sd">        Will run on cuda if available, on the device specified by the CUDA_VISIBLE_DEVICES environment variable</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="sd">            kwargs: Keyward arguements passed onto the subclass method</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">BaseTorchClassifier</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cuda_is_available</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cuda_is_available</span><span class="p">:</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set classifier modules</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="sd">        Template/abstract method where individual modules that make up the forward pass are configured</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">            kwargs: Keyword arguements passed onto the subclass method</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;setup() has not been implimented in the subclass!&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h5 id="luna.pathology.analysis.ml.BaseTorchClassifier.__init__" class="doc doc-heading">
          <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#luna.pathology.analysis.ml.BaseTorchClassifier.__init__" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Initialize BaseTorchClassifier</p>
<p>A generic base class for a PyTorch classifier model. This serves as the base class inhereted
for model training and inference.</p>
<p>Will run on cuda if available, on the device specified by the CUDA_VISIBLE_DEVICES environment variable</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>kwargs</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Keyward arguements passed onto the subclass method</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/analysis/ml.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-234" name="__codelineno-0-234"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize BaseTorchClassifier</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a><span class="sd">    A generic base class for a PyTorch classifier model. This serves as the base class inhereted</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a><span class="sd">    for model training and inference.</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="sd">    Will run on cuda if available, on the device specified by the CUDA_VISIBLE_DEVICES environment variable</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="sd">        kwargs: Keyward arguements passed onto the subclass method</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>    <span class="nb">super</span><span class="p">(</span><span class="n">BaseTorchClassifier</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">cuda_is_available</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cuda_is_available</span><span class="p">:</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h5 id="luna.pathology.analysis.ml.BaseTorchClassifier.setup" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">setup</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#luna.pathology.analysis.ml.BaseTorchClassifier.setup" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Set classifier modules</p>
<p>Template/abstract method where individual modules that make up the forward pass are configured</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>kwargs</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Keyword arguements passed onto the subclass method</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/analysis/ml.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Set classifier modules</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="sd">    Template/abstract method where individual modules that make up the forward pass are configured</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">        kwargs: Keyword arguements passed onto the subclass method</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;setup() has not been implimented in the subclass!&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h4 id="luna.pathology.analysis.ml.BaseTorchTileClassifier" class="doc doc-heading">
          <code>BaseTorchTileClassifier</code>


<a href="#luna.pathology.analysis.ml.BaseTorchTileClassifier" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><a class="autorefs autorefs-internal" title="luna.pathology.analysis.ml.BaseTorchClassifier" href="#luna.pathology.analysis.ml.BaseTorchClassifier">BaseTorchClassifier</a></code></p>


            <details class="quote">
              <summary>Source code in <code>src/luna/pathology/analysis/ml.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="k">class</span> <span class="nc">BaseTorchTileClassifier</span><span class="p">(</span><span class="n">BaseTorchClassifier</span><span class="p">):</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">tile_data</span><span class="p">):</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Forward pass for base classifier class</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="sd">        Loads a tile image from the tile manifest</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a><span class="sd">            index (list[str]): Tile address indicies with length B</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a><span class="sd">            tile_data (torch.tensor): Input tiles of shape (B, *)</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a><span class="sd">            pd.DataFrame: Dataframe of output features</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cuda_is_available</span><span class="p">:</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>            <span class="n">tile_data</span> <span class="o">=</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">tile_data</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>                <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>            <span class="p">)</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set classifier modules</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="sd">        Template/abstract method where individual modules that make up the forward pass are configured</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a><span class="sd">            kwargs: Keyword arguements passed onto the subclass method</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;setup() has not been implimented in the subclass!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_tiles</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">):</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;predict method</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a><span class="sd">        Loads a tile image from the tile manifest, must be manually implimented to pass the input tensor through the modules specified in setup()</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a><span class="sd">            input_tiles (torch.tensor): Input tiles of shape (B, *)</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a><span class="sd">            torch.tensor: 2D tensor with (B, C) where B is the batch dimension and C are output classes or features</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;predict() has not been implimented in the subclass!&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h5 id="luna.pathology.analysis.ml.BaseTorchTileClassifier.forward" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">tile_data</span><span class="p">)</span></code>

<a href="#luna.pathology.analysis.ml.BaseTorchTileClassifier.forward" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Forward pass for base classifier class</p>
<p>Loads a tile image from the tile manifest</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>index</code></td>
          <td>
                <code>list[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Tile address indicies with length B</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tile_data</code></td>
          <td>
                <code><span title="torch.tensor">tensor</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Input tiles of shape (B, *)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>pd.DataFrame: Dataframe of output features</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/analysis/ml.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">tile_data</span><span class="p">):</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Forward pass for base classifier class</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="sd">    Loads a tile image from the tile manifest</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a><span class="sd">        index (list[str]): Tile address indicies with length B</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a><span class="sd">        tile_data (torch.tensor): Input tiles of shape (B, *)</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a><span class="sd">        pd.DataFrame: Dataframe of output features</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cuda_is_available</span><span class="p">:</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>        <span class="n">tile_data</span> <span class="o">=</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">tile_data</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>            <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h5 id="luna.pathology.analysis.ml.BaseTorchTileClassifier.predict" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">predict</span><span class="p">(</span><span class="n">input_tiles</span><span class="p">)</span></code>

<a href="#luna.pathology.analysis.ml.BaseTorchTileClassifier.predict" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>predict method</p>
<p>Loads a tile image from the tile manifest, must be manually implimented to pass the input tensor through the modules specified in setup()</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_tiles</code></td>
          <td>
                <code><span title="torch.tensor">tensor</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Input tiles of shape (B, *)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>torch.tensor: 2D tensor with (B, C) where B is the batch dimension and C are output classes or features</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/analysis/ml.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-298" name="__codelineno-0-298"></a><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_tiles</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">):</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;predict method</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a><span class="sd">    Loads a tile image from the tile manifest, must be manually implimented to pass the input tensor through the modules specified in setup()</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a><span class="sd">        input_tiles (torch.tensor): Input tiles of shape (B, *)</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a><span class="sd">        torch.tensor: 2D tensor with (B, C) where B is the batch dimension and C are output classes or features</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;predict() has not been implimented in the subclass!&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h5 id="luna.pathology.analysis.ml.BaseTorchTileClassifier.setup" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">setup</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#luna.pathology.analysis.ml.BaseTorchTileClassifier.setup" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Set classifier modules</p>
<p>Template/abstract method where individual modules that make up the forward pass are configured</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>kwargs</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Keyword arguements passed onto the subclass method</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/analysis/ml.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Set classifier modules</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="sd">    Template/abstract method where individual modules that make up the forward pass are configured</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a><span class="sd">        kwargs: Keyword arguements passed onto the subclass method</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;setup() has not been implimented in the subclass!&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h4 id="luna.pathology.analysis.ml.BaseTorchTileDataset" class="doc doc-heading">
          <code>BaseTorchTileDataset</code>


<a href="#luna.pathology.analysis.ml.BaseTorchTileDataset" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><span title="torch.utils.data.Dataset">Dataset</span></code></p>

  
      <p>Base class for a tile dataset</p>
<p>Impliments the usual torch dataset methods, and additionally provides a decoding of the binary tile data.
PIL images can be further preprocessed before becoming torch tensors via an abstract preprocess method</p>
<p>Will send the tensors to gpu if available, on the device specified by CUDA_VISIBLE_DEVICES="1"</p>

            <details class="quote">
              <summary>Source code in <code>src/luna/pathology/analysis/ml.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="k">class</span> <span class="nc">BaseTorchTileDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for a tile dataset</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">    Impliments the usual torch dataset methods, and additionally provides a decoding of the binary tile data.</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">    PIL images can be further preprocessed before becoming torch tensors via an abstract preprocess method</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">    Will send the tensors to gpu if available, on the device specified by CUDA_VISIBLE_DEVICES=&quot;1&quot;</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="n">tile_manifest</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="n">tile_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="n">label_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="n">using_ray</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>    <span class="p">):</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize BaseTileDataset</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">        Can accept either a tile dataframe or a path to tile data</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">            tile_manifest (pd.DataFrame): Dataframe of tile data</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">            tile_path (str): Base path of tile data</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="sd">            label_cols (list[str]): (Optional) label columns to return as tensors, e.g. for training</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="sd">            using_ray (bool): (Optional) Perform distributed dataloading with Ray for training</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="k">if</span> <span class="n">tile_manifest</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tile_manifest</span> <span class="o">=</span> <span class="n">tile_manifest</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="k">elif</span> <span class="n">tile_urlpath</span><span class="p">:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tile_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">tile_manifest</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;address&quot;</span><span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Must specifiy either tile_manifest or tile_path&quot;</span><span class="p">)</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">label_cols</span> <span class="o">=</span> <span class="n">label_cols</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">using_ray</span> <span class="o">=</span> <span class="n">using_ray</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_manifest</span><span class="p">)</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;TileDataset with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_manifest</span><span class="p">)</span><span class="si">}</span><span class="s2"> tiles, indexed by </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_manifest</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="si">}</span><span class="s2">, returning label columns: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label_cols</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Tile accessor</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">        Loads a tile image from the tile manifest.  Returns a batch of the indices of the input dataframe, the tile data always.</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="sd">        If label columns where specified, the 3rd position of the tuple is a tensor of the label data. If Ray is being used for</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">        model training, then only the image data and the label is returned.</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="sd">            idx (int): Integer index</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="sd">            (optional str, torch.tensor, optional torch.tensor): tuple of the tile index and corresponding tile as a torch tensor, and metadata labels if specified</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_manifest</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">get_tile_array</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_ray</span><span class="p">:</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_cols</span><span class="p">)):</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                    <span class="s2">&quot;If using Ray for training, you must provide a label column&quot;</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                <span class="p">)</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_cols</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_cols</span><span class="p">):</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>            <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>                <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">img</span><span class="p">),</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>                <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()),</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="p">)</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>            <span class="k">return</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set additional attributes for dataset class</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="sd">        Template/abstract method where a dataset is configured</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a><span class="sd">            kwargs: Keyword arguements passed onto the subclass method</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;setup() has not been implimented in the subclass!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_tile</span><span class="p">:</span> <span class="n">Image</span><span class="p">):</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Preprocessing method called for each tile patch</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="sd">        Loads a tile image from the tile manifest, must be manually implimented to accept a single PIL image and return a torch tensor.</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><span class="sd">            input_tile (Image): Integer index</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a><span class="sd">            torch.tensor: Output tile as preprocessed tensor</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>            <span class="s2">&quot;preprocess() has not been implimented in the subclass!&quot;</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h5 id="luna.pathology.analysis.ml.BaseTorchTileDataset.__getitem__" class="doc doc-heading">
          <code class="highlight language-python"><span class="fm">__getitem__</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span></code>

<a href="#luna.pathology.analysis.ml.BaseTorchTileDataset.__getitem__" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Tile accessor</p>
<p>Loads a tile image from the tile manifest.  Returns a batch of the indices of the input dataframe, the tile data always.
If label columns where specified, the 3rd position of the tuple is a tensor of the label data. If Ray is being used for
model training, then only the image data and the label is returned.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>idx</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Integer index</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>optional str, torch.tensor, optional torch.tensor</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>tuple of the tile index and corresponding tile as a torch tensor, and metadata labels if specified</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/analysis/ml.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Tile accessor</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">    Loads a tile image from the tile manifest.  Returns a batch of the indices of the input dataframe, the tile data always.</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="sd">    If label columns where specified, the 3rd position of the tuple is a tensor of the label data. If Ray is being used for</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">    model training, then only the image data and the label is returned.</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="sd">        idx (int): Integer index</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="sd">        (optional str, torch.tensor, optional torch.tensor): tuple of the tile index and corresponding tile as a torch tensor, and metadata labels if specified</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_manifest</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">get_tile_array</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_ray</span><span class="p">:</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_cols</span><span class="p">)):</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                <span class="s2">&quot;If using Ray for training, you must provide a label column&quot;</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>            <span class="p">)</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_cols</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_cols</span><span class="p">):</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>            <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">img</span><span class="p">),</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()),</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="p">)</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>        <span class="k">return</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h5 id="luna.pathology.analysis.ml.BaseTorchTileDataset.__init__" class="doc doc-heading">
          <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">tile_manifest</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tile_urlpath</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">label_cols</span><span class="o">=</span><span class="p">[],</span> <span class="n">using_ray</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#luna.pathology.analysis.ml.BaseTorchTileDataset.__init__" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Initialize BaseTileDataset</p>
<p>Can accept either a tile dataframe or a path to tile data</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>tile_manifest</code></td>
          <td>
                <code><span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dataframe of tile data</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>tile_path</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Base path of tile data</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>label_cols</code></td>
          <td>
                <code>list[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>(Optional) label columns to return as tensors, e.g. for training</p>
            </div>
          </td>
          <td>
                <code>[]</code>
          </td>
        </tr>
        <tr>
          <td><code>using_ray</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>(Optional) Perform distributed dataloading with Ray for training</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/analysis/ml.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="n">tile_manifest</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>    <span class="n">tile_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="n">label_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>    <span class="n">using_ray</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="p">):</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize BaseTileDataset</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">    Can accept either a tile dataframe or a path to tile data</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">        tile_manifest (pd.DataFrame): Dataframe of tile data</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">        tile_path (str): Base path of tile data</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="sd">        label_cols (list[str]): (Optional) label columns to return as tensors, e.g. for training</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="sd">        using_ray (bool): (Optional) Perform distributed dataloading with Ray for training</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>    <span class="k">if</span> <span class="n">tile_manifest</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile_manifest</span> <span class="o">=</span> <span class="n">tile_manifest</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="k">elif</span> <span class="n">tile_urlpath</span><span class="p">:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tile_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tile_manifest</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;address&quot;</span><span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Must specifiy either tile_manifest or tile_path&quot;</span><span class="p">)</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">label_cols</span> <span class="o">=</span> <span class="n">label_cols</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">using_ray</span> <span class="o">=</span> <span class="n">using_ray</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h5 id="luna.pathology.analysis.ml.BaseTorchTileDataset.preprocess" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">preprocess</span><span class="p">(</span><span class="n">input_tile</span><span class="p">)</span></code>

<a href="#luna.pathology.analysis.ml.BaseTorchTileDataset.preprocess" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Preprocessing method called for each tile patch</p>
<p>Loads a tile image from the tile manifest, must be manually implimented to accept a single PIL image and return a torch tensor.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_tile</code></td>
          <td>
                <code><span title="PIL.Image">Image</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Integer index</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>torch.tensor: Output tile as preprocessed tensor</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/analysis/ml.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-217" name="__codelineno-0-217"></a><span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_tile</span><span class="p">:</span> <span class="n">Image</span><span class="p">):</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Preprocessing method called for each tile patch</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="sd">    Loads a tile image from the tile manifest, must be manually implimented to accept a single PIL image and return a torch tensor.</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><span class="sd">        input_tile (Image): Integer index</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a><span class="sd">        torch.tensor: Output tile as preprocessed tensor</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>        <span class="s2">&quot;preprocess() has not been implimented in the subclass!&quot;</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h5 id="luna.pathology.analysis.ml.BaseTorchTileDataset.setup" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">setup</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#luna.pathology.analysis.ml.BaseTorchTileDataset.setup" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Set additional attributes for dataset class</p>
<p>Template/abstract method where a dataset is configured</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>kwargs</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Keyword arguements passed onto the subclass method</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/analysis/ml.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Set additional attributes for dataset class</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="sd">    Template/abstract method where a dataset is configured</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a><span class="sd">        kwargs: Keyword arguements passed onto the subclass method</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;setup() has not been implimented in the subclass!&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h4 id="luna.pathology.analysis.ml.HDF5Dataset" class="doc doc-heading">
          <code>HDF5Dataset</code>


<a href="#luna.pathology.analysis.ml.HDF5Dataset" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><span title="torch.utils.data.Dataset">Dataset</span></code></p>

  
      <p>General dataset that uses a HDF5 manifest convention</p>
<p>Applies preprocessing steps per instance, returning aggregate batches of data. Useful for training and inference.</p>

            <details class="quote">
              <summary>Source code in <code>src/luna/pathology/analysis/ml.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="k">class</span> <span class="nc">HDF5Dataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;General dataset that uses a HDF5 manifest convention</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">    Applies preprocessing steps per instance, returning aggregate batches of data. Useful for training and inference.</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="n">hdf5_manifest</span><span class="p">,</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="n">preprocess</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="n">label_cols</span><span class="o">=</span><span class="p">[],</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="n">using_ray</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="p">):</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize HD5FDataset</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">            hdf5_manifest (pd.DataFrame): Dataframe of H5 data</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">            preprocess (transform): Function to apply to every bit of data</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">            label_cols (list[str]): (Optional) label columns to return as tensors, e.g. for training</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">            using_ray (bool): (Optional) Perform distributed dataloading with Ray for training</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">hdf5_manifest</span> <span class="o">=</span> <span class="n">hdf5_manifest</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">label_cols</span> <span class="o">=</span> <span class="n">label_cols</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">using_ray</span> <span class="o">=</span> <span class="n">using_ray</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span> <span class="o">=</span> <span class="n">preprocess</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">storage_options</span> <span class="o">=</span> <span class="n">storage_options</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdf5_manifest</span><span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="k">def</span> <span class="nf">set_preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preprocess</span><span class="p">):</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="n">preprocess</span> <span class="o">=</span> <span class="n">preprocess</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;HD5FDataset with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hd5f_manifest</span><span class="p">)</span><span class="si">}</span><span class="s2"> tiles, indexed by </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hd5f_manifest</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="si">}</span><span class="s2">, returning label columns: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label_cols</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Tile accessor</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">        Loads a tile image from the tile manifest.  Returns a batch of the indices of the input dataframe, the tile data always.</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">        If label columns where specified, the 3rd position of the tuple is a tensor of the label data. If Ray is being used for</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">        model training, then only the image data and the label is returned.</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">            idx (int): Integer index</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">            (optional str, torch.tensor, optional torch.tensor): tuple of the tile index and corresponding tile as a torch tensor, and metadata labels if specified, else the index</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdf5_manifest</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">get_tile_array</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_options</span><span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_ray</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_cols</span><span class="p">)):</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>                <span class="s2">&quot;If using Ray for training, you must provide a label column&quot;</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_cols</span><span class="p">):</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_cols</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h5 id="luna.pathology.analysis.ml.HDF5Dataset.__getitem__" class="doc doc-heading">
          <code class="highlight language-python"><span class="fm">__getitem__</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span></code>

<a href="#luna.pathology.analysis.ml.HDF5Dataset.__getitem__" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Tile accessor</p>
<p>Loads a tile image from the tile manifest.  Returns a batch of the indices of the input dataframe, the tile data always.
If label columns where specified, the 3rd position of the tuple is a tensor of the label data. If Ray is being used for
model training, then only the image data and the label is returned.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>idx</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Integer index</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>optional str, torch.tensor, optional torch.tensor</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>tuple of the tile index and corresponding tile as a torch tensor, and metadata labels if specified, else the index</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/analysis/ml.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Tile accessor</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">    Loads a tile image from the tile manifest.  Returns a batch of the indices of the input dataframe, the tile data always.</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">    If label columns where specified, the 3rd position of the tuple is a tensor of the label data. If Ray is being used for</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">    model training, then only the image data and the label is returned.</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">        idx (int): Integer index</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">        (optional str, torch.tensor, optional torch.tensor): tuple of the tile index and corresponding tile as a torch tensor, and metadata labels if specified, else the index</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdf5_manifest</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="n">img</span> <span class="o">=</span> <span class="n">get_tile_array</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_options</span><span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_ray</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_cols</span><span class="p">)):</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="s2">&quot;If using Ray for training, you must provide a label column&quot;</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_cols</span><span class="p">):</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_cols</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h5 id="luna.pathology.analysis.ml.HDF5Dataset.__init__" class="doc doc-heading">
          <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">hdf5_manifest</span><span class="p">,</span> <span class="n">preprocess</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span> <span class="n">label_cols</span><span class="o">=</span><span class="p">[],</span> <span class="n">using_ray</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.analysis.ml.HDF5Dataset.__init__" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Initialize HD5FDataset</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>hdf5_manifest</code></td>
          <td>
                <code><span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dataframe of H5 data</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>preprocess</code></td>
          <td>
                <code>transform</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Function to apply to every bit of data</p>
            </div>
          </td>
          <td>
                <code><span title="torch.nn.Identity">Identity</span>()</code>
          </td>
        </tr>
        <tr>
          <td><code>label_cols</code></td>
          <td>
                <code>list[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>(Optional) label columns to return as tensors, e.g. for training</p>
            </div>
          </td>
          <td>
                <code>[]</code>
          </td>
        </tr>
        <tr>
          <td><code>using_ray</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>(Optional) Perform distributed dataloading with Ray for training</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/analysis/ml.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="n">hdf5_manifest</span><span class="p">,</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="n">preprocess</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="n">label_cols</span><span class="o">=</span><span class="p">[],</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="n">using_ray</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="p">):</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize HD5FDataset</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">        hdf5_manifest (pd.DataFrame): Dataframe of H5 data</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">        preprocess (transform): Function to apply to every bit of data</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">        label_cols (list[str]): (Optional) label columns to return as tensors, e.g. for training</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">        using_ray (bool): (Optional) Perform distributed dataloading with Ray for training</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">hdf5_manifest</span> <span class="o">=</span> <span class="n">hdf5_manifest</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">label_cols</span> <span class="o">=</span> <span class="n">label_cols</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">using_ray</span> <span class="o">=</span> <span class="n">using_ray</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span> <span class="o">=</span> <span class="n">preprocess</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">storage_options</span> <span class="o">=</span> <span class="n">storage_options</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h4 id="luna.pathology.analysis.ml.TorchTransformModel" class="doc doc-heading">
          <code>TorchTransformModel</code>


<a href="#luna.pathology.analysis.ml.TorchTransformModel" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>src/luna/pathology/analysis/ml.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="k">class</span> <span class="nc">TorchTransformModel</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="k">def</span> <span class="nf">get_preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The transform model&#39;s preprocessing code</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">            kwargs: Keyword arguements passed onto the subclass method</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>            <span class="s2">&quot;get_preprocess() has not been implimented in the subclass!&quot;</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>        <span class="p">)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Main transformer method, X -&gt; X&#39;</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">            X (torch.Tensor): input tensor</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">            torch.tensor: Output tile as preprocessed tensor</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>            <span class="s2">&quot;transform() has not been implimented in the subclass!&quot;</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="p">)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h5 id="luna.pathology.analysis.ml.TorchTransformModel.get_preprocess" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_preprocess</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#luna.pathology.analysis.ml.TorchTransformModel.get_preprocess" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>The transform model's preprocessing code</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>kwargs</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Keyword arguements passed onto the subclass method</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/analysis/ml.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="k">def</span> <span class="nf">get_preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;The transform model&#39;s preprocessing code</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">        kwargs: Keyword arguements passed onto the subclass method</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>        <span class="s2">&quot;get_preprocess() has not been implimented in the subclass!&quot;</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h5 id="luna.pathology.analysis.ml.TorchTransformModel.transform" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span></code>

<a href="#luna.pathology.analysis.ml.TorchTransformModel.transform" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Main transformer method, X -&gt; X'</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>X</code></td>
          <td>
                <code><span title="torch.Tensor">Tensor</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>input tensor</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>torch.tensor: Output tile as preprocessed tensor</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/analysis/ml.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Main transformer method, X -&gt; X&#39;</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        X (torch.Tensor): input tensor</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">        torch.tensor: Output tile as preprocessed tensor</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="s2">&quot;transform() has not been implimented in the subclass!&quot;</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>



<div class="doc doc-object doc-function">




<h4 id="luna.pathology.analysis.ml.get_group_stratified_sampler" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_group_stratified_sampler</span><span class="p">(</span><span class="n">df_nh</span><span class="p">,</span> <span class="n">label_col</span><span class="p">,</span> <span class="n">group_col</span><span class="p">,</span> <span class="n">num_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span></code>

<a href="#luna.pathology.analysis.ml.get_group_stratified_sampler" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Generates sampler indices for torch DataLoader object that are
stratified by a given group set (ie a column in a dataframe
corresponding to patient identifiers), and balanced between target
labels</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df_nh</code></td>
          <td>
                <code><span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A non-hierarchical/non-multi-indexed/flat dataframe</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>label_col</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The column name for the classes to balance across training and validation splits.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>group_col</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The column name used to stratify the data (ie patient ids).</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>num_splits</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>(Optional) The number of folds, must at least be 2.</p>
            </div>
          </td>
          <td>
                <code>5</code>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    Tuple(List, List): a tuple of indices that correspond to training and validation samplers</p>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/analysis/ml.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-312" name="__codelineno-0-312"></a><span class="k">def</span> <span class="nf">get_group_stratified_sampler</span><span class="p">(</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>    <span class="n">df_nh</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>    <span class="n">label_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>    <span class="n">group_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>    <span class="n">num_splits</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>    <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">List</span><span class="p">]:</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates sampler indices for torch DataLoader object that are</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a><span class="sd">    stratified by a given group set (ie a column in a dataframe</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a><span class="sd">    corresponding to patient identifiers), and balanced between target</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a><span class="sd">    labels</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a><span class="sd">        df_nh (pd.DataFrame): A non-hierarchical/non-multi-indexed/flat dataframe</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a><span class="sd">        label_col (str): The column name for the classes to balance across training and validation splits.</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a><span class="sd">        group_col (str): The column name used to stratify the data (ie patient ids).</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a><span class="sd">        num_splits (int): (Optional) The number of folds, must at least be 2.</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a><span class="sd">        Tuple(List, List): a tuple of indices that correspond to training and validation samplers</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>    <span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedGroupKFold</span><span class="p">(</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>        <span class="n">n_splits</span><span class="o">=</span><span class="n">num_splits</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>    <span class="p">)</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>    <span class="n">classes</span> <span class="o">=</span> <span class="n">df_nh</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>    <span class="n">groups</span> <span class="o">=</span> <span class="n">df_nh</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>    <span class="k">for</span> <span class="n">fold_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">train_indices</span><span class="p">,</span> <span class="n">val_indices</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>        <span class="n">cv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">df_nh</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">groups</span><span class="p">)</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>    <span class="p">):</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>        <span class="c1"># check integrity. asserts that same group (ie patients) aren&#39;t in both</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>        <span class="c1"># train and validation splits</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>        <span class="n">train_groups</span><span class="p">,</span> <span class="n">val_groups</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="n">train_indices</span><span class="p">],</span> <span class="n">groups</span><span class="p">[</span><span class="n">val_indices</span><span class="p">]</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">train_groups</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">val_groups</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>    <span class="n">train_sampler</span> <span class="o">=</span> <span class="n">SubsetRandomSampler</span><span class="p">(</span><span class="n">train_indices</span><span class="p">)</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>    <span class="n">val_sampler</span> <span class="o">=</span> <span class="n">SubsetRandomSampler</span><span class="p">(</span><span class="n">val_indices</span><span class="p">)</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">train_sampler</span><span class="p">,</span> <span class="n">val_sampler</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.analysis.ml.post_transform_to_2d" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">post_transform_to_2d</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span></code>

<a href="#luna.pathology.analysis.ml.post_transform_to_2d" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Convert input to a 2D numpy array on CPU</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input</code></td>
          <td>
                <code><span title="torch.tensor">tensor</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>tensor input of shape [B, *] where B is the batch dimension</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/analysis/ml.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="k">def</span> <span class="nf">post_transform_to_2d</span><span class="p">(</span><span class="nb">input</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert input to a 2D numpy array on CPU</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="sd">        input (torch.tensor): tensor input of shape [B, *] where B is the batch dimension</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">:</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reshaping model output (was </span><span class="si">{</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">) to 2D&quot;</span><span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="nb">input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>    <span class="k">return</span> <span class="nb">input</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>


  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h2 id="luna.pathology.cli" class="doc doc-heading">
          <code>cli</code>


<a href="#luna.pathology.cli" class="headerlink" title="Permanent link">&para;</a></h2>

  <div class="doc doc-contents ">
  
      <p>Created on April 27, 2021</p>
<p>@author: pashaa@mskcc.org</p>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-module">




<h3 id="luna.pathology.cli.create_wide_shape_features_query" class="doc doc-heading">
          <code>create_wide_shape_features_query</code>


<a href="#luna.pathology.cli.create_wide_shape_features_query" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.create_wide_shape_features_query.cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">cli</span><span class="p">(</span><span class="n">shape_features_urlpath</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.create_wide_shape_features_query.cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Prints wide shape features query for Dremio</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>shape_features_urlpaths</code></td>
          <td>
                <code>List[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path to shape features parquet files</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to reading functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/create_wide_shape_features_query.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="k">def</span> <span class="nf">cli</span><span class="p">(</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="n">shape_features_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="p">):</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Prints wide shape features query for Dremio</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">        shape_features_urlpaths (List[str]): URL/path to shape features parquet files</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        storage_options (dict): storage options to pass to reading functions</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="n">query</span> <span class="o">=</span> <span class="n">create_wide_shape_features_query</span><span class="p">(</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;shape_features_urlpath&#39;</span><span class="p">],</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;storage_options&#39;</span><span class="p">]</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.create_wide_shape_features_query.create_wide_shape_features_query" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">create_wide_shape_features_query</span><span class="p">(</span><span class="n">shape_features_urlpath</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.create_wide_shape_features_query.create_wide_shape_features_query" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Gets wide shape features query for dremio</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>shape_features_urlpaths</code></td>
          <td>
                <code>List[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path to shape feature parquet files</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to reading functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/create_wide_shape_features_query.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="k">def</span> <span class="nf">create_wide_shape_features_query</span><span class="p">(</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="n">shape_features_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="p">):</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets wide shape features query for dremio</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        shape_features_urlpaths (List[str]): URL/path to shape feature parquet files</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        storage_options (dict): storage options to pass to reading functions</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">shape_features_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="n">ShapeFeaturesSchema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;merged_variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">Parent</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">variable</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="k">return</span> <span class="n">create_query</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;merged_variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.cli.dsa_annotation_etl" class="doc doc-heading">
          <code>dsa_annotation_etl</code>


<a href="#luna.pathology.cli.dsa_annotation_etl" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">




<h4 id="luna.pathology.cli.dsa_annotation_etl.DsaAnnotationProcessor" class="doc doc-heading">
          <code>DsaAnnotationProcessor</code>


<a href="#luna.pathology.cli.dsa_annotation_etl.DsaAnnotationProcessor" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>src/luna/pathology/cli/dsa_annotation_etl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="k">class</span> <span class="nc">DsaAnnotationProcessor</span><span class="p">:</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">girder</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">storage_options</span><span class="p">):</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">girder</span> <span class="o">=</span> <span class="n">girder</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">annotation_name</span> <span class="o">=</span> <span class="n">annotation_name</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_urlpath</span> <span class="o">=</span> <span class="n">output_urlpath</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">storage_options</span> <span class="o">=</span> <span class="n">storage_options</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>    <span class="k">def</span> <span class="nf">histomics_annotation_table_to_geojson</span><span class="p">(</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">shape_type_col</span><span class="o">=</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="n">x_col</span><span class="o">=</span><span class="s2">&quot;x_coords&quot;</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s2">&quot;y_coords&quot;</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>    <span class="p">):</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Takes a table generated by histomicstk (parse_slide_annotations_into_tables) and creates a geojson&quot;&quot;&quot;</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>        <span class="n">df</span><span class="p">[</span><span class="n">properties</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">properties</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;None&quot;</span><span class="p">)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;About to turn </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> geometric annotations into a geojson!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">x_col</span><span class="p">]),</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">y_col</span><span class="p">])</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">shape_type_col</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;polyline&quot;</span><span class="p">:</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>                <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>                <span class="n">geometry</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                    <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))]</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                <span class="p">)</span>  <span class="c1"># Polygons are once nested to account for holes</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>            <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="n">shape_type_col</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;point&quot;</span><span class="p">:</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                <span class="n">geometry</span> <span class="o">=</span> <span class="n">Point</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>                <span class="k">continue</span>  <span class="c1"># don&#39;t process non-polyline(regional) or point annotations</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Created geometry </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">geometry</span><span class="p">))</span><span class="si">:</span><span class="s2">.40s</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="n">feature</span> <span class="o">=</span> <span class="n">Feature</span><span class="p">(</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>                <span class="n">geometry</span><span class="o">=</span><span class="n">geometry</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="n">prop</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">}</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="p">)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>            <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>        <span class="n">feature_collection</span> <span class="o">=</span> <span class="n">FeatureCollection</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="sa">f</span><span class="s2">&quot;Checking geojson, errors with geojson FeatureCollection: </span><span class="si">{</span><span class="n">feature_collection</span><span class="o">.</span><span class="n">errors</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="p">)</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="k">return</span> <span class="n">feature_collection</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>    <span class="k">def</span> <span class="nf">build_proxy_repr_dsa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Build a proxy table slice given, primarily, a DSA itemId (slide_item_uuid)&quot;&quot;&quot;</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="n">itemId</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">slide_item_uuid</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="n">slide_id</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">slide_id</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>            <span class="sa">f</span><span class="s2">&quot;Trying to process annotation for slide_id=</span><span class="si">{</span><span class="n">slide_id</span><span class="si">}</span><span class="s2">, item_id=</span><span class="si">{</span><span class="n">itemId</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="p">)</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>        <span class="n">annotation_uuids</span> <span class="o">=</span> <span class="n">get_annotation_uuid</span><span class="p">(</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">girder</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="n">itemId</span><span class="p">,</span> <span class="n">annotation_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_name</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="p">)</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>        <span class="k">if</span> <span class="n">annotation_uuids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>        <span class="c1"># need to loop through annotation uuids since the same annotation name</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>        <span class="c1"># can coorespond to multiple uuids (a &#39;Regional&#39; annotation on the same</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>        <span class="c1"># slide made two days apart)</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>        <span class="n">df_annotations</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>        <span class="k">for</span> <span class="n">annotation_uuid</span> <span class="ow">in</span> <span class="n">annotation_uuids</span><span class="p">:</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>            <span class="n">df_annotation</span> <span class="o">=</span> <span class="n">get_annotation_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">girder</span><span class="p">,</span> <span class="n">annotation_uuid</span><span class="p">)</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>            <span class="n">df_annotations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_annotation</span><span class="p">)</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>        <span class="n">df_annotations</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_annotations</span><span class="p">)</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="c1"># This turns the regional data into a nice geojson</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>        <span class="n">feature_collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">histomics_annotation_table_to_geojson</span><span class="p">(</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>            <span class="n">df_annotations</span><span class="p">,</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>            <span class="p">[</span><span class="s2">&quot;annotation_girder_id&quot;</span><span class="p">,</span> <span class="s2">&quot;element_girder_id&quot;</span><span class="p">,</span> <span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">],</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>            <span class="n">shape_type_col</span><span class="o">=</span><span class="s2">&quot;type&quot;</span><span class="p">,</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>            <span class="n">x_col</span><span class="o">=</span><span class="s2">&quot;x_coords&quot;</span><span class="p">,</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>            <span class="n">y_col</span><span class="o">=</span><span class="s2">&quot;y_coords&quot;</span><span class="p">,</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="p">)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>        <span class="n">fs</span><span class="p">,</span> <span class="n">urlpath</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_options</span><span class="p">)</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>        <span class="n">slide_geojson_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">urlpath</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">slide_id</span><span class="si">}</span><span class="s2">.annotation.geojson&quot;</span><span class="p">)</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>        <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">slide_geojson_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">feature_collection</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>  <span class="c1"># Finally, save it!</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="n">df_annotation_proxy</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>            <span class="p">[</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>                <span class="n">df_annotations</span><span class="p">,</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>                    <span class="p">[</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>                        <span class="p">{</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>                            <span class="s2">&quot;slide_item_uuid&quot;</span><span class="p">:</span> <span class="n">itemId</span><span class="p">,</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;geojson&quot;</span><span class="p">,</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>                            <span class="s2">&quot;slide_geojson&quot;</span><span class="p">:</span> <span class="n">slide_geojson_path</span><span class="p">,</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>                        <span class="p">}</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                    <span class="p">]</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>                <span class="p">),</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>            <span class="p">]</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>        <span class="p">)</span>  <span class="c1"># Add our geojson as a special type of annotation</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>        <span class="k">return</span> <span class="n">df_annotation_proxy</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run DsaAnnotationProcessor</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="sd">            row (string): row of a DSA slide table</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a><span class="sd">            pd.DataFrame: annotation metadata</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_proxy_repr_dsa</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>        <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h5 id="luna.pathology.cli.dsa_annotation_etl.DsaAnnotationProcessor.build_proxy_repr_dsa" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">build_proxy_repr_dsa</span><span class="p">(</span><span class="n">row</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.dsa_annotation_etl.DsaAnnotationProcessor.build_proxy_repr_dsa" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Build a proxy table slice given, primarily, a DSA itemId (slide_item_uuid)</p>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_annotation_etl.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-228" name="__codelineno-0-228"></a><span class="k">def</span> <span class="nf">build_proxy_repr_dsa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a proxy table slice given, primarily, a DSA itemId (slide_item_uuid)&quot;&quot;&quot;</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>    <span class="n">itemId</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">slide_item_uuid</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>    <span class="n">slide_id</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">slide_id</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="sa">f</span><span class="s2">&quot;Trying to process annotation for slide_id=</span><span class="si">{</span><span class="n">slide_id</span><span class="si">}</span><span class="s2">, item_id=</span><span class="si">{</span><span class="n">itemId</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>    <span class="p">)</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>    <span class="n">annotation_uuids</span> <span class="o">=</span> <span class="n">get_annotation_uuid</span><span class="p">(</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">girder</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="n">itemId</span><span class="p">,</span> <span class="n">annotation_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_name</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>    <span class="p">)</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>    <span class="k">if</span> <span class="n">annotation_uuids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>    <span class="c1"># need to loop through annotation uuids since the same annotation name</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>    <span class="c1"># can coorespond to multiple uuids (a &#39;Regional&#39; annotation on the same</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>    <span class="c1"># slide made two days apart)</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>    <span class="n">df_annotations</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>    <span class="k">for</span> <span class="n">annotation_uuid</span> <span class="ow">in</span> <span class="n">annotation_uuids</span><span class="p">:</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>        <span class="n">df_annotation</span> <span class="o">=</span> <span class="n">get_annotation_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">girder</span><span class="p">,</span> <span class="n">annotation_uuid</span><span class="p">)</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>        <span class="n">df_annotations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_annotation</span><span class="p">)</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>    <span class="n">df_annotations</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_annotations</span><span class="p">)</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>    <span class="c1"># This turns the regional data into a nice geojson</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>    <span class="n">feature_collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">histomics_annotation_table_to_geojson</span><span class="p">(</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>        <span class="n">df_annotations</span><span class="p">,</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="p">[</span><span class="s2">&quot;annotation_girder_id&quot;</span><span class="p">,</span> <span class="s2">&quot;element_girder_id&quot;</span><span class="p">,</span> <span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">],</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>        <span class="n">shape_type_col</span><span class="o">=</span><span class="s2">&quot;type&quot;</span><span class="p">,</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>        <span class="n">x_col</span><span class="o">=</span><span class="s2">&quot;x_coords&quot;</span><span class="p">,</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="n">y_col</span><span class="o">=</span><span class="s2">&quot;y_coords&quot;</span><span class="p">,</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>    <span class="p">)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>    <span class="n">fs</span><span class="p">,</span> <span class="n">urlpath</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_options</span><span class="p">)</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>    <span class="n">slide_geojson_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">urlpath</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">slide_id</span><span class="si">}</span><span class="s2">.annotation.geojson&quot;</span><span class="p">)</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>    <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">slide_geojson_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">feature_collection</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>  <span class="c1"># Finally, save it!</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>    <span class="n">df_annotation_proxy</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>        <span class="p">[</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>            <span class="n">df_annotations</span><span class="p">,</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>                <span class="p">[</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>                    <span class="p">{</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>                        <span class="s2">&quot;slide_item_uuid&quot;</span><span class="p">:</span> <span class="n">itemId</span><span class="p">,</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;geojson&quot;</span><span class="p">,</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>                        <span class="s2">&quot;slide_geojson&quot;</span><span class="p">:</span> <span class="n">slide_geojson_path</span><span class="p">,</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>                    <span class="p">}</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                <span class="p">]</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>            <span class="p">),</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>        <span class="p">]</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>    <span class="p">)</span>  <span class="c1"># Add our geojson as a special type of annotation</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>    <span class="k">return</span> <span class="n">df_annotation_proxy</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h5 id="luna.pathology.cli.dsa_annotation_etl.DsaAnnotationProcessor.histomics_annotation_table_to_geojson" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">histomics_annotation_table_to_geojson</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">shape_type_col</span><span class="o">=</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="n">x_col</span><span class="o">=</span><span class="s1">&#39;x_coords&#39;</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s1">&#39;y_coords&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.dsa_annotation_etl.DsaAnnotationProcessor.histomics_annotation_table_to_geojson" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Takes a table generated by histomicstk (parse_slide_annotations_into_tables) and creates a geojson</p>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_annotation_etl.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-192" name="__codelineno-0-192"></a><span class="k">def</span> <span class="nf">histomics_annotation_table_to_geojson</span><span class="p">(</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>    <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">shape_type_col</span><span class="o">=</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="n">x_col</span><span class="o">=</span><span class="s2">&quot;x_coords&quot;</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s2">&quot;y_coords&quot;</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a><span class="p">):</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Takes a table generated by histomicstk (parse_slide_annotations_into_tables) and creates a geojson&quot;&quot;&quot;</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>    <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>    <span class="n">df</span><span class="p">[</span><span class="n">properties</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">properties</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;None&quot;</span><span class="p">)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;About to turn </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> geometric annotations into a geojson!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">x_col</span><span class="p">]),</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">y_col</span><span class="p">])</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">shape_type_col</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;polyline&quot;</span><span class="p">:</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>            <span class="n">geometry</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))]</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>            <span class="p">)</span>  <span class="c1"># Polygons are once nested to account for holes</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>        <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="n">shape_type_col</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;point&quot;</span><span class="p">:</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>            <span class="n">geometry</span> <span class="o">=</span> <span class="n">Point</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>            <span class="k">continue</span>  <span class="c1"># don&#39;t process non-polyline(regional) or point annotations</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Created geometry </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">geometry</span><span class="p">))</span><span class="si">:</span><span class="s2">.40s</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>        <span class="n">feature</span> <span class="o">=</span> <span class="n">Feature</span><span class="p">(</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>            <span class="n">geometry</span><span class="o">=</span><span class="n">geometry</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="n">prop</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">}</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="p">)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>        <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>    <span class="n">feature_collection</span> <span class="o">=</span> <span class="n">FeatureCollection</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>        <span class="sa">f</span><span class="s2">&quot;Checking geojson, errors with geojson FeatureCollection: </span><span class="si">{</span><span class="n">feature_collection</span><span class="o">.</span><span class="n">errors</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>    <span class="p">)</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>    <span class="k">return</span> <span class="n">feature_collection</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h5 id="luna.pathology.cli.dsa_annotation_etl.DsaAnnotationProcessor.run" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">run</span><span class="p">(</span><span class="n">row</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.dsa_annotation_etl.DsaAnnotationProcessor.run" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Run DsaAnnotationProcessor</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>row</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>row of a DSA slide table</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>pd.DataFrame: annotation metadata</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_annotation_etl.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Run DsaAnnotationProcessor</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="sd">        row (string): row of a DSA slide table</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a><span class="sd">        pd.DataFrame: annotation metadata</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_proxy_repr_dsa</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>



<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_annotation_etl.cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">cli</span><span class="p">(</span><span class="n">dsa_endpoint</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">annotation_name</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;${oc.env:DSA_USERNAME}&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;${oc.env:DSA_PASSWORD}&#39;</span><span class="p">,</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.dsa_annotation_etl.cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>DSA annotation ETL
Args:
    dsa_endpoint (str): path to input data
    collection_name (str): collection name in DSA
    annotation_name (str): annotation name
    username (str): DSA username (defaults to environment variable DSA_USERNAME)
    password (str): DSA password (defaults to environment variable DSA_PASSWORD)
    local_config (str): local config yaml url/path
    output_urlpath (str): output/working url/path prefix
    storage_options (dict): options to pass to reading/writing functions</p>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>pd.DataFrame: metadata from function call</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_annotation_etl.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="nd">@timed</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="k">def</span> <span class="nf">cli</span><span class="p">(</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">dsa_endpoint</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;${oc.env:DSA_USERNAME}&quot;</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;${oc.env:DSA_PASSWORD}&quot;</span><span class="p">,</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="p">):</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;DSA annotation ETL</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">        dsa_endpoint (str): path to input data</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">        collection_name (str): collection name in DSA</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">        annotation_name (str): annotation name</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">        username (str): DSA username (defaults to environment variable DSA_USERNAME)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        password (str): DSA password (defaults to environment variable DSA_PASSWORD)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">        local_config (str): local config yaml url/path</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">        output_urlpath (str): output/working url/path prefix</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        storage_options (dict): options to pass to reading/writing functions</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">        pd.DataFrame: metadata from function call</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="n">configure_dask_client</span><span class="p">()</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="n">df_full_annotation_data</span> <span class="o">=</span> <span class="n">dsa_annotation_etl</span><span class="p">(</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;dsa_endpoint&quot;</span><span class="p">],</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;collection_name&quot;</span><span class="p">],</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;annotation_name&quot;</span><span class="p">],</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">],</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="p">)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="n">output_fs</span><span class="p">,</span> <span class="n">output_path</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">]</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="n">slide_annotation_dataset_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;slide_annotation_dataset_</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;collection_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;annotation_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.parquet&quot;</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="p">)</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_full_annotation_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="k">with</span> <span class="n">output_fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">slide_annotation_dataset_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>            <span class="n">df_full_annotation_data</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>            <span class="s2">&quot;slide_annotation_dataset&quot;</span><span class="p">:</span> <span class="n">slide_annotation_dataset_path</span><span class="p">,</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>            <span class="s2">&quot;segment_keys&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>                <span class="s2">&quot;dsa_collection_uuid&quot;</span><span class="p">:</span> <span class="n">df_full_annotation_data</span><span class="p">[</span><span class="s2">&quot;collection_uuid&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>            <span class="p">},</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="p">}</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="k">return</span> <span class="n">properties</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_annotation_etl.dsa_annotation_etl" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">dsa_annotation_etl</span><span class="p">(</span><span class="n">dsa_endpoint</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">storage_options</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.dsa_annotation_etl.dsa_annotation_etl" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>DSA annotation ETL</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>dsa_endpoint</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>path to input data</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>collection_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>collection name in DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>annotation name</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>username</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA username</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>password</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA password</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output/working url/path prefix</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>options to pass to reading/writing functions</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>pd.DataFrame: slide etl dataframe with annotation columns</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_annotation_etl.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="k">def</span> <span class="nf">dsa_annotation_etl</span><span class="p">(</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>    <span class="n">dsa_endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>    <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="p">):</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;DSA annotation ETL</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">        dsa_endpoint (str): path to input data</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">        collection_name (str): collection name in DSA</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">        annotation_name (str): annotation name</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">        username (str): DSA username</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">        password (str): DSA password</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">        output_urlpath (str): output/working url/path prefix</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">        storage_options (dict): options to pass to reading/writing functions</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">        pd.DataFrame: slide etl dataframe with annotation columns</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">get_or_create_dask_client</span><span class="p">()</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="c1"># girder = girder_client.GirderClient(apiUrl=dsa_endpoint)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="n">girder</span> <span class="o">=</span> <span class="n">girder_client</span><span class="o">.</span><span class="n">GirderClient</span><span class="p">(</span><span class="n">apiUrl</span><span class="o">=</span><span class="n">dsa_endpoint</span><span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="c1"># girder python client doesn&#39;t support turning off ssl verify.</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="c1"># can be removed once we replace the self-signed cert</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="n">session</span><span class="o">.</span><span class="n">verify</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="n">girder</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">session</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="n">girder</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="c1"># check DSA connection</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="n">system_check</span><span class="p">(</span><span class="n">girder</span><span class="p">)</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Error connecting to DSA API&quot;</span><span class="p">)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>    <span class="c1"># dsa_authenticate(girder, username, password)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>    <span class="n">collection_uuid</span> <span class="o">=</span> <span class="n">get_collection_uuid</span><span class="p">(</span><span class="n">girder</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">)</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="n">df_slide_items</span> <span class="o">=</span> <span class="n">get_slide_df</span><span class="p">(</span><span class="n">girder</span><span class="p">,</span> <span class="n">collection_uuid</span><span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_slide_items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No slides found, exitting!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="k">return</span> <span class="p">{}</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>    <span class="c1"># Initialize the DsaAnnotationProcessor</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="n">dap</span> <span class="o">=</span> <span class="n">DsaAnnotationProcessor</span><span class="p">(</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="n">girder</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">storage_options</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dashboard: &quot;</span> <span class="o">+</span> <span class="n">client</span><span class="o">.</span><span class="n">dashboard_link</span><span class="p">)</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>    <span class="n">df_polygon_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="p">[</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>            <span class="n">x</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                <span class="p">[</span><span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">dap</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_slide_items</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>            <span class="p">)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="p">]</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>    <span class="p">)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="c1"># Join the slide level data with the polygon level data, so this is a lot of information!</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="n">df_full_annotation_data</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="n">df_slide_items</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;slide_item_uuid&quot;</span><span class="p">)</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>            <span class="n">df_polygon_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;slide_item_uuid&quot;</span><span class="p">),</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>            <span class="n">rsuffix</span><span class="o">=</span><span class="s2">&quot;annotation&quot;</span><span class="p">,</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="p">)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;slide_id&quot;</span><span class="p">)</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>    <span class="p">)</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>    <span class="n">df_full_annotation_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;collection_uuid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collection_uuid</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>    <span class="n">df_full_annotation_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;collection_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collection_name</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>    <span class="n">df_full_annotation_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;annotation_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">annotation_name</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>    <span class="n">df_full_annotation_data</span> <span class="o">=</span> <span class="n">df_full_annotation_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">])</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>    <span class="n">df_full_annotation_data</span> <span class="o">=</span> <span class="n">df_full_annotation_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="s2">&quot;group_name&quot;</span><span class="p">}</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>    <span class="p">)</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">df_full_annotation_data</span><span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>    <span class="c1"># Our dataset is a combination of polyline, point, and geojson annotations!</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Created </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_full_annotation_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;type==&#39;geojson&#39;&quot;</span><span class="p">))</span><span class="si">}</span><span class="s2"> geojsons, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_full_annotation_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;type==&#39;point&#39;&quot;</span><span class="p">))</span><span class="si">}</span><span class="s2"> points, and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_full_annotation_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;type==&#39;polyline&#39;&quot;</span><span class="p">))</span><span class="si">}</span><span class="s2"> polygons&quot;&quot;&quot;</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>    <span class="p">)</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>    <span class="k">return</span> <span class="n">df_full_annotation_data</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.cli.dsa_upload" class="doc doc-heading">
          <code>dsa_upload</code>


<a href="#luna.pathology.cli.dsa_upload" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_upload.__upload_annotation_to_dsa" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">__upload_annotation_to_dsa</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">dsa_endpoint_url</span><span class="p">,</span> <span class="n">annotation_file_urlpath</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.dsa_upload.__upload_annotation_to_dsa" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Upload annotation to DSA</p>
<p>Upload json annotation file as a new annotation to the image in the DSA collection.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>dsa_endpoint_url</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA API endpoint e.g. http://localhost:8080/api/v1</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_file_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path to a DSA annotation json file</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>collection_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the collection in DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>image_filename</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the image file in DSA e.g. 123.svs</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>username</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA username</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>password</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA password</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>options to pass to reading functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>item_uuid. None if item doesn't exist</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_upload.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-202" name="__codelineno-0-202"></a><span class="k">def</span> <span class="nf">__upload_annotation_to_dsa</span><span class="p">(</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>    <span class="n">gc</span><span class="p">:</span> <span class="n">girder_client</span><span class="o">.</span><span class="n">GirderClient</span><span class="p">,</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>    <span class="n">dsa_endpoint_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>    <span class="n">annotation_file_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>    <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>    <span class="n">image_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="p">):</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Upload annotation to DSA</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a><span class="sd">    Upload json annotation file as a new annotation to the image in the DSA collection.</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="sd">        dsa_endpoint_url (string): DSA API endpoint e.g. http://localhost:8080/api/v1</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a><span class="sd">        annotation_file_urlpath (string): URL/path to a DSA annotation json file</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="sd">        collection_name (string): name of the collection in DSA</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a><span class="sd">        image_filename (string): name of the image file in DSA e.g. 123.svs</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="sd">        username (string): DSA username</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="sd">        password (string): DSA password</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="sd">        storage_options (dict): options to pass to reading functions</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a><span class="sd">        dict: item_uuid. None if item doesn&#39;t exist</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">annotation_file_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotation_json</span><span class="p">:</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>        <span class="n">dsa_annotation</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">annotation_json</span><span class="p">)</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="n">slide_annotation</span> <span class="o">=</span> <span class="n">get_slide_annotation</span><span class="p">(</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>            <span class="n">image_filename</span><span class="p">,</span> <span class="n">dsa_annotation</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">gc</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="p">)</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="k">if</span> <span class="n">slide_annotation</span><span class="p">:</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>                <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">slide_annotation</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;annotation_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: slide </span><span class="si">{</span><span class="n">image_filename</span><span class="si">}</span><span class="s2"> in collection </span><span class="si">{</span><span class="n">collection_name</span><span class="si">}</span><span class="s2"> already has an annotation named </span><span class="si">{</span><span class="n">dsa_annotation</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>            <span class="p">)</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>            <span class="k">return</span> <span class="n">slide_annotation</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;annotation_id&quot;</span><span class="p">]</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>    <span class="n">dsa_uuid</span> <span class="o">=</span> <span class="n">get_item_uuid</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">)</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>    <span class="k">if</span> <span class="n">dsa_uuid</span><span class="p">:</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="n">dsa_uuid</span> <span class="o">=</span> <span class="n">push_annotation_to_dsa_image</span><span class="p">(</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>            <span class="n">dsa_uuid</span><span class="p">,</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>            <span class="n">annotation_file_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>            <span class="n">dsa_endpoint_url</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">],</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>            <span class="n">gc</span><span class="p">,</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>            <span class="n">storage_options</span><span class="p">,</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>        <span class="p">)</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>    <span class="k">return</span> <span class="n">dsa_uuid</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_upload.cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">cli</span><span class="p">(</span><span class="n">dsa_endpoint_url</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">annotation_file_urlpath</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">annotation_file_list_urlpath</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">image_filename</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;${oc.env:DSA_USERNAME}&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;${oc.env:DSA_PASSWORD}&#39;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">insecure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.dsa_upload.cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Upload annotation to DSA</p>
<p>Upload json annotation file as a new annotation to the image in the DSA collection.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>dsa_endpoint_url</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA API endpoint e.g. http://localhost:8080/api/v1</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>annotation_file_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path to a DSA annotation json file</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>annotation_file_list_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path to a DSA annotation json file</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>collection_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the collection in DSA</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>image_filename</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the image file in DSA e.g. 123.svs. If not specified, infer from annotiaton_file_urpath</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>username</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA username (defaults to environment variable DSA_USERNAME)</p>
            </div>
          </td>
          <td>
                <code>&#39;${oc.env:DSA_USERNAME}&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>password</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA password (defaults to environment variable DSA_PASSWORD)</p>
            </div>
          </td>
          <td>
                <code>&#39;${oc.env:DSA_PASSWORD}&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>force</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>upload even if annotation with same name exists for the slide</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>insecure</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>insecure ssl</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>options to pass to reading functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>local_config</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>local config yaml url/path</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>metadata</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_upload.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="nd">@timed</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="k">def</span> <span class="nf">cli</span><span class="p">(</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="n">dsa_endpoint_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="n">annotation_file_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="n">annotation_file_list_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">image_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;${oc.env:DSA_USERNAME}&quot;</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;${oc.env:DSA_PASSWORD}&quot;</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="n">insecure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="p">):</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Upload annotation to DSA</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    Upload json annotation file as a new annotation to the image in the DSA collection.</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">        dsa_endpoint_url (string): DSA API endpoint e.g. http://localhost:8080/api/v1</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">        annotation_file_urlpath (string): URL/path to a DSA annotation json file</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        annotation_file_list_urlpath (string): URL/path to a DSA annotation json file</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">        collection_name (string): name of the collection in DSA</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">        image_filename (string): name of the image file in DSA e.g. 123.svs. If not specified, infer from annotiaton_file_urpath</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        username (string): DSA username (defaults to environment variable DSA_USERNAME)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">        password (string): DSA password (defaults to environment variable DSA_PASSWORD)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">        force (bool): upload even if annotation with same name exists for the slide</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">        insecure (bool): insecure ssl</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">        storage_options (dict): options to pass to reading functions</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">        local_config (string): local config yaml url/path</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">        dict: metadata</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="k">if</span> <span class="p">(</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;annotation_file_urlpath&quot;</span><span class="p">]</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="ow">and</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;annotation_file_list_urlpath&quot;</span><span class="p">]</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="p">):</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="k">raise</span> <span class="n">fire</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">FireError</span><span class="p">(</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>            <span class="s2">&quot;Specify either annotation_file_urlpath or annotation_file_list_urlpath&quot;</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="p">)</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="n">annotation_file_urlpaths</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;annotation_file_urlpath&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="n">annotation_file_urlpaths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;annotation_file_urlpath&quot;</span><span class="p">])</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;annotation_file_list_urlpath&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;annotation_file_list_urlpath&quot;</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">of</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>            <span class="n">annotation_file_urlpaths</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="n">uuids</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">annotation_file_urlpath</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">annotation_file_urlpaths</span><span class="p">):</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>            <span class="sa">f</span><span class="s2">&quot;Uploading </span><span class="si">{</span><span class="n">annotation_file_urlpath</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">annotation_file_urlpaths</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="p">)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="n">image_filename</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;image_filename&quot;</span><span class="p">]</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">image_filename</span><span class="p">:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>            <span class="n">image_filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">annotation_file_urlpath</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.svs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>            <span class="n">image_filename</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.*_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">)</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">image_filename</span><span class="p">:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>                    <span class="sa">f</span><span class="s2">&quot;Unable to infer image_filename from </span><span class="si">{</span><span class="n">annotation_file_urlpath</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>                <span class="p">)</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image filename inferred as </span><span class="si">{</span><span class="n">image_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="n">dsa_uuid</span> <span class="o">=</span> <span class="n">_upload_annotation_to_dsa</span><span class="p">(</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;dsa_endpoint_url&quot;</span><span class="p">],</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="n">annotation_file_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;collection_name&quot;</span><span class="p">],</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>            <span class="n">image_filename</span><span class="p">,</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">],</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;force&quot;</span><span class="p">],</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;insecure&quot;</span><span class="p">],</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="p">)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uploaded item to </span><span class="si">{</span><span class="n">dsa_uuid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="k">if</span> <span class="n">dsa_uuid</span><span class="p">:</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="n">uuids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dsa_uuid</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;item_uuids&quot;</span><span class="p">:</span> <span class="n">uuids</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_upload.upload_annotation_to_dsa" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">upload_annotation_to_dsa</span><span class="p">(</span><span class="n">dsa_endpoint_url</span><span class="p">,</span> <span class="n">slide_manifest</span><span class="p">,</span> <span class="n">annotation_column</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">insecure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.dsa_upload.upload_annotation_to_dsa" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Upload annotation to DSA</p>
<p>Upload json annotation file as a new annotation to the image in the DSA collection.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>dsa_endpoint_url</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA API endpoint e.g. http://localhost:8080/api/v1</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>slide_manifest</code></td>
          <td>
                <code><span title="pandera.typing.DataFrame">DataFrame</span>[<span title="luna.common.models.SlideSchema">SlideSchema</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slide manifest from slide_etl</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_column</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>annotation column of slide_manifest containing the dsa url</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>collection_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the collection in DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>image_filename</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the image file in DSA e.g. 123.svs. If not specified, infer from annotiaton_file_urpath</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>username</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA username (defaults to environment variable DSA_USERNAME)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>password</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA password (defaults to environment variable DSA_PASSWORD)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>force</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>upload even if annotation with same name exists for the slide</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>insecure</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>insecure ssl</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>options to pass to reading functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DataFrame[SlideSchema]: slide manifest</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_upload.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="k">def</span> <span class="nf">upload_annotation_to_dsa</span><span class="p">(</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="n">dsa_endpoint_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="n">slide_manifest</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">SlideSchema</span><span class="p">],</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="n">annotation_column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="n">image_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>    <span class="n">insecure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="p">):</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Upload annotation to DSA</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">    Upload json annotation file as a new annotation to the image in the DSA collection.</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">        dsa_endpoint_url (string): DSA API endpoint e.g. http://localhost:8080/api/v1</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">        slide_manifest (DataFrame[SlideSchema]): slide manifest from slide_etl</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">        annotation_column (string): annotation column of slide_manifest containing the dsa url</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">        collection_name (string): name of the collection in DSA</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">        image_filename (string): name of the image file in DSA e.g. 123.svs. If not specified, infer from annotiaton_file_urpath</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">        username (string): DSA username (defaults to environment variable DSA_USERNAME)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">        password (string): DSA password (defaults to environment variable DSA_PASSWORD)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">        force (bool): upload even if annotation with same name exists for the slide</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">        insecure (bool): insecure ssl</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">        storage_options (dict): options to pass to reading functions</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">        DataFrame[SlideSchema]: slide manifest</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="n">uuids</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="n">uuids</span> <span class="o">=</span> <span class="n">_upload_annotation_to_dsa</span><span class="p">(</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="n">dsa_endpoint_url</span><span class="p">,</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>            <span class="n">slide</span><span class="p">[</span><span class="n">annotation_column</span><span class="p">],</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>            <span class="n">collection_name</span><span class="p">,</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>            <span class="n">image_filename</span><span class="p">,</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>            <span class="n">username</span><span class="p">,</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>            <span class="n">password</span><span class="p">,</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>            <span class="n">force</span><span class="p">,</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>            <span class="n">insecure</span><span class="p">,</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>            <span class="n">storage_options</span><span class="p">,</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="n">uuids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uuids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>    <span class="k">return</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">annotation_column</span><span class="p">:</span> <span class="n">uuids</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.cli.dsa_viz" class="doc doc-heading">
          <code>dsa_viz</code>


<a href="#luna.pathology.cli.dsa_viz" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.__bmp_polygon" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">__bmp_polygon</span><span class="p">(</span><span class="n">input_urlpath</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">,</span> <span class="n">label_map</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.dsa_viz.__bmp_polygon" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Build DSA annotation json from a BMP with multiple labels.</p>
<p>Vectorizes and simplifies contours per label.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to bmp file</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>label_map</code></td>
          <td>
                <code>dict[int, str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>map of label number to label name</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the annotation to be displayed in DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code>dict[str, str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code>dict[str, str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>scale_factor</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>scale to match image DSA.</p>
            </div>
          </td>
          <td>
                <code>1</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to read functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to write functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA annotation</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1508">1508</a></span>
<span class="normal"><a href="#__codelineno-0-1509">1509</a></span>
<span class="normal"><a href="#__codelineno-0-1510">1510</a></span>
<span class="normal"><a href="#__codelineno-0-1511">1511</a></span>
<span class="normal"><a href="#__codelineno-0-1512">1512</a></span>
<span class="normal"><a href="#__codelineno-0-1513">1513</a></span>
<span class="normal"><a href="#__codelineno-0-1514">1514</a></span>
<span class="normal"><a href="#__codelineno-0-1515">1515</a></span>
<span class="normal"><a href="#__codelineno-0-1516">1516</a></span>
<span class="normal"><a href="#__codelineno-0-1517">1517</a></span>
<span class="normal"><a href="#__codelineno-0-1518">1518</a></span>
<span class="normal"><a href="#__codelineno-0-1519">1519</a></span>
<span class="normal"><a href="#__codelineno-0-1520">1520</a></span>
<span class="normal"><a href="#__codelineno-0-1521">1521</a></span>
<span class="normal"><a href="#__codelineno-0-1522">1522</a></span>
<span class="normal"><a href="#__codelineno-0-1523">1523</a></span>
<span class="normal"><a href="#__codelineno-0-1524">1524</a></span>
<span class="normal"><a href="#__codelineno-0-1525">1525</a></span>
<span class="normal"><a href="#__codelineno-0-1526">1526</a></span>
<span class="normal"><a href="#__codelineno-0-1527">1527</a></span>
<span class="normal"><a href="#__codelineno-0-1528">1528</a></span>
<span class="normal"><a href="#__codelineno-0-1529">1529</a></span>
<span class="normal"><a href="#__codelineno-0-1530">1530</a></span>
<span class="normal"><a href="#__codelineno-0-1531">1531</a></span>
<span class="normal"><a href="#__codelineno-0-1532">1532</a></span>
<span class="normal"><a href="#__codelineno-0-1533">1533</a></span>
<span class="normal"><a href="#__codelineno-0-1534">1534</a></span>
<span class="normal"><a href="#__codelineno-0-1535">1535</a></span>
<span class="normal"><a href="#__codelineno-0-1536">1536</a></span>
<span class="normal"><a href="#__codelineno-0-1537">1537</a></span>
<span class="normal"><a href="#__codelineno-0-1538">1538</a></span>
<span class="normal"><a href="#__codelineno-0-1539">1539</a></span>
<span class="normal"><a href="#__codelineno-0-1540">1540</a></span>
<span class="normal"><a href="#__codelineno-0-1541">1541</a></span>
<span class="normal"><a href="#__codelineno-0-1542">1542</a></span>
<span class="normal"><a href="#__codelineno-0-1543">1543</a></span>
<span class="normal"><a href="#__codelineno-0-1544">1544</a></span>
<span class="normal"><a href="#__codelineno-0-1545">1545</a></span>
<span class="normal"><a href="#__codelineno-0-1546">1546</a></span>
<span class="normal"><a href="#__codelineno-0-1547">1547</a></span>
<span class="normal"><a href="#__codelineno-0-1548">1548</a></span>
<span class="normal"><a href="#__codelineno-0-1549">1549</a></span>
<span class="normal"><a href="#__codelineno-0-1550">1550</a></span>
<span class="normal"><a href="#__codelineno-0-1551">1551</a></span>
<span class="normal"><a href="#__codelineno-0-1552">1552</a></span>
<span class="normal"><a href="#__codelineno-0-1553">1553</a></span>
<span class="normal"><a href="#__codelineno-0-1554">1554</a></span>
<span class="normal"><a href="#__codelineno-0-1555">1555</a></span>
<span class="normal"><a href="#__codelineno-0-1556">1556</a></span>
<span class="normal"><a href="#__codelineno-0-1557">1557</a></span>
<span class="normal"><a href="#__codelineno-0-1558">1558</a></span>
<span class="normal"><a href="#__codelineno-0-1559">1559</a></span>
<span class="normal"><a href="#__codelineno-0-1560">1560</a></span>
<span class="normal"><a href="#__codelineno-0-1561">1561</a></span>
<span class="normal"><a href="#__codelineno-0-1562">1562</a></span>
<span class="normal"><a href="#__codelineno-0-1563">1563</a></span>
<span class="normal"><a href="#__codelineno-0-1564">1564</a></span>
<span class="normal"><a href="#__codelineno-0-1565">1565</a></span>
<span class="normal"><a href="#__codelineno-0-1566">1566</a></span>
<span class="normal"><a href="#__codelineno-0-1567">1567</a></span>
<span class="normal"><a href="#__codelineno-0-1568">1568</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1508" name="__codelineno-0-1508"></a><span class="k">def</span> <span class="nf">__bmp_polygon</span><span class="p">(</span>
<a id="__codelineno-0-1509" name="__codelineno-0-1509"></a>    <span class="n">input_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1510" name="__codelineno-0-1510"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1511" name="__codelineno-0-1511"></a>    <span class="n">image_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1512" name="__codelineno-0-1512"></a>    <span class="n">label_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-1513" name="__codelineno-0-1513"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1514" name="__codelineno-0-1514"></a>    <span class="n">line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1515" name="__codelineno-0-1515"></a>    <span class="n">fill_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1516" name="__codelineno-0-1516"></a>    <span class="n">scale_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-1517" name="__codelineno-0-1517"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-1518" name="__codelineno-0-1518"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-1519" name="__codelineno-0-1519"></a><span class="p">):</span>
<a id="__codelineno-0-1520" name="__codelineno-0-1520"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build DSA annotation json from a BMP with multiple labels.</span>
<a id="__codelineno-0-1521" name="__codelineno-0-1521"></a>
<a id="__codelineno-0-1522" name="__codelineno-0-1522"></a><span class="sd">    Vectorizes and simplifies contours per label.</span>
<a id="__codelineno-0-1523" name="__codelineno-0-1523"></a>
<a id="__codelineno-0-1524" name="__codelineno-0-1524"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1525" name="__codelineno-0-1525"></a><span class="sd">        input_urlpath (string): url/path to bmp file</span>
<a id="__codelineno-0-1526" name="__codelineno-0-1526"></a><span class="sd">        label_map (dict[int,str]): map of label number to label name</span>
<a id="__codelineno-0-1527" name="__codelineno-0-1527"></a><span class="sd">        annotation_name (string): name of the annotation to be displayed in DSA</span>
<a id="__codelineno-0-1528" name="__codelineno-0-1528"></a><span class="sd">        line_colors (dict[str,str], optional): line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-1529" name="__codelineno-0-1529"></a><span class="sd">        fill_colors (dict[str,str], optional): fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-1530" name="__codelineno-0-1530"></a><span class="sd">        scale_factor (int, optional): scale to match image DSA.</span>
<a id="__codelineno-0-1531" name="__codelineno-0-1531"></a><span class="sd">        storage_options (dict): storage options to pass to read functions</span>
<a id="__codelineno-0-1532" name="__codelineno-0-1532"></a><span class="sd">        output_storage_options (dict): storage options to pass to write functions</span>
<a id="__codelineno-0-1533" name="__codelineno-0-1533"></a>
<a id="__codelineno-0-1534" name="__codelineno-0-1534"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1535" name="__codelineno-0-1535"></a><span class="sd">        dict: DSA annotation</span>
<a id="__codelineno-0-1536" name="__codelineno-0-1536"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1537" name="__codelineno-0-1537"></a>    <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1538" name="__codelineno-0-1538"></a>    <span class="n">Image</span><span class="o">.</span><span class="n">MAX_IMAGE_PIXELS</span> <span class="o">=</span> <span class="mi">5000000000</span>
<a id="__codelineno-0-1539" name="__codelineno-0-1539"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-1540" name="__codelineno-0-1540"></a>        <span class="n">annotation</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-1541" name="__codelineno-0-1541"></a>    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
<a id="__codelineno-0-1542" name="__codelineno-0-1542"></a>
<a id="__codelineno-0-1543" name="__codelineno-0-1543"></a>    <span class="k">for</span> <span class="n">label_num</span><span class="p">,</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="n">label_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-1544" name="__codelineno-0-1544"></a>        <span class="n">simplified_contours</span> <span class="o">=</span> <span class="n">vectorize_np_array_bitmask_by_pixel_value</span><span class="p">(</span>
<a id="__codelineno-0-1545" name="__codelineno-0-1545"></a>            <span class="n">arr</span><span class="p">,</span> <span class="n">label_num</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="n">scale_factor</span>
<a id="__codelineno-0-1546" name="__codelineno-0-1546"></a>        <span class="p">)</span>
<a id="__codelineno-0-1547" name="__codelineno-0-1547"></a>
<a id="__codelineno-0-1548" name="__codelineno-0-1548"></a>        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">contour</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">simplified_contours</span><span class="p">):</span>
<a id="__codelineno-0-1549" name="__codelineno-0-1549"></a>            <span class="n">element</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">base_dsa_polygon_element</span><span class="p">)</span>
<a id="__codelineno-0-1550" name="__codelineno-0-1550"></a>            <span class="n">element</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_name</span>
<a id="__codelineno-0-1551" name="__codelineno-0-1551"></a>            <span class="k">if</span> <span class="n">fill_colors</span> <span class="ow">and</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="n">fill_colors</span><span class="p">:</span>
<a id="__codelineno-0-1552" name="__codelineno-0-1552"></a>                <span class="n">element</span><span class="p">[</span><span class="s2">&quot;fillColor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill_colors</span><span class="p">[</span><span class="n">label_name</span><span class="p">]</span>
<a id="__codelineno-0-1553" name="__codelineno-0-1553"></a>            <span class="k">if</span> <span class="n">line_colors</span> <span class="ow">and</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="n">line_colors</span><span class="p">:</span>
<a id="__codelineno-0-1554" name="__codelineno-0-1554"></a>                <span class="n">element</span><span class="p">[</span><span class="s2">&quot;lineColor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_colors</span><span class="p">[</span><span class="n">label_name</span><span class="p">]</span>
<a id="__codelineno-0-1555" name="__codelineno-0-1555"></a>
<a id="__codelineno-0-1556" name="__codelineno-0-1556"></a>            <span class="n">coords</span> <span class="o">=</span> <span class="n">contour</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-0-1557" name="__codelineno-0-1557"></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
<a id="__codelineno-0-1558" name="__codelineno-0-1558"></a>                <span class="n">c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1559" name="__codelineno-0-1559"></a>            <span class="n">element</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span>
<a id="__codelineno-0-1560" name="__codelineno-0-1560"></a>            <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
<a id="__codelineno-0-1561" name="__codelineno-0-1561"></a>
<a id="__codelineno-0-1562" name="__codelineno-0-1562"></a>    <span class="n">dsa_annotation</span> <span class="o">=</span> <span class="n">get_dsa_annotation</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">)</span>
<a id="__codelineno-0-1563" name="__codelineno-0-1563"></a>    <span class="k">return</span> <span class="n">save_dsa_annotation</span><span class="p">(</span>
<a id="__codelineno-0-1564" name="__codelineno-0-1564"></a>        <span class="n">dsa_annotation</span><span class="p">,</span>
<a id="__codelineno-0-1565" name="__codelineno-0-1565"></a>        <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-1566" name="__codelineno-0-1566"></a>        <span class="n">image_filename</span><span class="p">,</span>
<a id="__codelineno-0-1567" name="__codelineno-0-1567"></a>        <span class="n">storage_options</span><span class="p">,</span>
<a id="__codelineno-0-1568" name="__codelineno-0-1568"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.__heatmap" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">__heatmap</span><span class="p">(</span><span class="n">input_urlpath</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.dsa_viz.__heatmap" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Generate heatmap based on the tile scores</p>
<p>Creates a heatmap for the given column, using the color palette <code>viridis</code>
to set a fill value
- the color ranges from purple to yellow, for scores from 0 to 1.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to parquet with tile scores</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the annotation to be displayed in DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>column</code></td>
          <td>
                <code>list[string]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>columns to visualize e.g. tile_score</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tile_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>size of tiles</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>scale_factor</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>scale to match the image on DSA.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[dict[str, str]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[dict[str, str]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to read functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to write functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA annotation</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1310">1310</a></span>
<span class="normal"><a href="#__codelineno-0-1311">1311</a></span>
<span class="normal"><a href="#__codelineno-0-1312">1312</a></span>
<span class="normal"><a href="#__codelineno-0-1313">1313</a></span>
<span class="normal"><a href="#__codelineno-0-1314">1314</a></span>
<span class="normal"><a href="#__codelineno-0-1315">1315</a></span>
<span class="normal"><a href="#__codelineno-0-1316">1316</a></span>
<span class="normal"><a href="#__codelineno-0-1317">1317</a></span>
<span class="normal"><a href="#__codelineno-0-1318">1318</a></span>
<span class="normal"><a href="#__codelineno-0-1319">1319</a></span>
<span class="normal"><a href="#__codelineno-0-1320">1320</a></span>
<span class="normal"><a href="#__codelineno-0-1321">1321</a></span>
<span class="normal"><a href="#__codelineno-0-1322">1322</a></span>
<span class="normal"><a href="#__codelineno-0-1323">1323</a></span>
<span class="normal"><a href="#__codelineno-0-1324">1324</a></span>
<span class="normal"><a href="#__codelineno-0-1325">1325</a></span>
<span class="normal"><a href="#__codelineno-0-1326">1326</a></span>
<span class="normal"><a href="#__codelineno-0-1327">1327</a></span>
<span class="normal"><a href="#__codelineno-0-1328">1328</a></span>
<span class="normal"><a href="#__codelineno-0-1329">1329</a></span>
<span class="normal"><a href="#__codelineno-0-1330">1330</a></span>
<span class="normal"><a href="#__codelineno-0-1331">1331</a></span>
<span class="normal"><a href="#__codelineno-0-1332">1332</a></span>
<span class="normal"><a href="#__codelineno-0-1333">1333</a></span>
<span class="normal"><a href="#__codelineno-0-1334">1334</a></span>
<span class="normal"><a href="#__codelineno-0-1335">1335</a></span>
<span class="normal"><a href="#__codelineno-0-1336">1336</a></span>
<span class="normal"><a href="#__codelineno-0-1337">1337</a></span>
<span class="normal"><a href="#__codelineno-0-1338">1338</a></span>
<span class="normal"><a href="#__codelineno-0-1339">1339</a></span>
<span class="normal"><a href="#__codelineno-0-1340">1340</a></span>
<span class="normal"><a href="#__codelineno-0-1341">1341</a></span>
<span class="normal"><a href="#__codelineno-0-1342">1342</a></span>
<span class="normal"><a href="#__codelineno-0-1343">1343</a></span>
<span class="normal"><a href="#__codelineno-0-1344">1344</a></span>
<span class="normal"><a href="#__codelineno-0-1345">1345</a></span>
<span class="normal"><a href="#__codelineno-0-1346">1346</a></span>
<span class="normal"><a href="#__codelineno-0-1347">1347</a></span>
<span class="normal"><a href="#__codelineno-0-1348">1348</a></span>
<span class="normal"><a href="#__codelineno-0-1349">1349</a></span>
<span class="normal"><a href="#__codelineno-0-1350">1350</a></span>
<span class="normal"><a href="#__codelineno-0-1351">1351</a></span>
<span class="normal"><a href="#__codelineno-0-1352">1352</a></span>
<span class="normal"><a href="#__codelineno-0-1353">1353</a></span>
<span class="normal"><a href="#__codelineno-0-1354">1354</a></span>
<span class="normal"><a href="#__codelineno-0-1355">1355</a></span>
<span class="normal"><a href="#__codelineno-0-1356">1356</a></span>
<span class="normal"><a href="#__codelineno-0-1357">1357</a></span>
<span class="normal"><a href="#__codelineno-0-1358">1358</a></span>
<span class="normal"><a href="#__codelineno-0-1359">1359</a></span>
<span class="normal"><a href="#__codelineno-0-1360">1360</a></span>
<span class="normal"><a href="#__codelineno-0-1361">1361</a></span>
<span class="normal"><a href="#__codelineno-0-1362">1362</a></span>
<span class="normal"><a href="#__codelineno-0-1363">1363</a></span>
<span class="normal"><a href="#__codelineno-0-1364">1364</a></span>
<span class="normal"><a href="#__codelineno-0-1365">1365</a></span>
<span class="normal"><a href="#__codelineno-0-1366">1366</a></span>
<span class="normal"><a href="#__codelineno-0-1367">1367</a></span>
<span class="normal"><a href="#__codelineno-0-1368">1368</a></span>
<span class="normal"><a href="#__codelineno-0-1369">1369</a></span>
<span class="normal"><a href="#__codelineno-0-1370">1370</a></span>
<span class="normal"><a href="#__codelineno-0-1371">1371</a></span>
<span class="normal"><a href="#__codelineno-0-1372">1372</a></span>
<span class="normal"><a href="#__codelineno-0-1373">1373</a></span>
<span class="normal"><a href="#__codelineno-0-1374">1374</a></span>
<span class="normal"><a href="#__codelineno-0-1375">1375</a></span>
<span class="normal"><a href="#__codelineno-0-1376">1376</a></span>
<span class="normal"><a href="#__codelineno-0-1377">1377</a></span>
<span class="normal"><a href="#__codelineno-0-1378">1378</a></span>
<span class="normal"><a href="#__codelineno-0-1379">1379</a></span>
<span class="normal"><a href="#__codelineno-0-1380">1380</a></span>
<span class="normal"><a href="#__codelineno-0-1381">1381</a></span>
<span class="normal"><a href="#__codelineno-0-1382">1382</a></span>
<span class="normal"><a href="#__codelineno-0-1383">1383</a></span>
<span class="normal"><a href="#__codelineno-0-1384">1384</a></span>
<span class="normal"><a href="#__codelineno-0-1385">1385</a></span>
<span class="normal"><a href="#__codelineno-0-1386">1386</a></span>
<span class="normal"><a href="#__codelineno-0-1387">1387</a></span>
<span class="normal"><a href="#__codelineno-0-1388">1388</a></span>
<span class="normal"><a href="#__codelineno-0-1389">1389</a></span>
<span class="normal"><a href="#__codelineno-0-1390">1390</a></span>
<span class="normal"><a href="#__codelineno-0-1391">1391</a></span>
<span class="normal"><a href="#__codelineno-0-1392">1392</a></span>
<span class="normal"><a href="#__codelineno-0-1393">1393</a></span>
<span class="normal"><a href="#__codelineno-0-1394">1394</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1310" name="__codelineno-0-1310"></a><span class="k">def</span> <span class="nf">__heatmap</span><span class="p">(</span>
<a id="__codelineno-0-1311" name="__codelineno-0-1311"></a>    <span class="n">input_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1312" name="__codelineno-0-1312"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1313" name="__codelineno-0-1313"></a>    <span class="n">image_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1314" name="__codelineno-0-1314"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1315" name="__codelineno-0-1315"></a>    <span class="n">column</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-1316" name="__codelineno-0-1316"></a>    <span class="n">tile_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-1317" name="__codelineno-0-1317"></a>    <span class="n">scale_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1318" name="__codelineno-0-1318"></a>    <span class="n">fill_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1319" name="__codelineno-0-1319"></a>    <span class="n">line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1320" name="__codelineno-0-1320"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-1321" name="__codelineno-0-1321"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-1322" name="__codelineno-0-1322"></a><span class="p">):</span>
<a id="__codelineno-0-1323" name="__codelineno-0-1323"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate heatmap based on the tile scores</span>
<a id="__codelineno-0-1324" name="__codelineno-0-1324"></a>
<a id="__codelineno-0-1325" name="__codelineno-0-1325"></a><span class="sd">    Creates a heatmap for the given column, using the color palette `viridis`</span>
<a id="__codelineno-0-1326" name="__codelineno-0-1326"></a><span class="sd">    to set a fill value</span>
<a id="__codelineno-0-1327" name="__codelineno-0-1327"></a><span class="sd">    - the color ranges from purple to yellow, for scores from 0 to 1.</span>
<a id="__codelineno-0-1328" name="__codelineno-0-1328"></a>
<a id="__codelineno-0-1329" name="__codelineno-0-1329"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1330" name="__codelineno-0-1330"></a><span class="sd">        input_urlpath (string): url/path to parquet with tile scores</span>
<a id="__codelineno-0-1331" name="__codelineno-0-1331"></a><span class="sd">        annotation_name (string): name of the annotation to be displayed in DSA</span>
<a id="__codelineno-0-1332" name="__codelineno-0-1332"></a><span class="sd">        column (list[string]): columns to visualize e.g. tile_score</span>
<a id="__codelineno-0-1333" name="__codelineno-0-1333"></a><span class="sd">        tile_size (int): size of tiles</span>
<a id="__codelineno-0-1334" name="__codelineno-0-1334"></a><span class="sd">        scale_factor (int, optional): scale to match the image on DSA.</span>
<a id="__codelineno-0-1335" name="__codelineno-0-1335"></a><span class="sd">        fill_colors (Optional[dict[str,str]]): fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-1336" name="__codelineno-0-1336"></a><span class="sd">        line_colors (Optional[dict[str,str]]): line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-1337" name="__codelineno-0-1337"></a><span class="sd">        storage_options (dict): storage options to pass to read functions</span>
<a id="__codelineno-0-1338" name="__codelineno-0-1338"></a><span class="sd">        output_storage_options (dict): storage options to pass to write functions</span>
<a id="__codelineno-0-1339" name="__codelineno-0-1339"></a>
<a id="__codelineno-0-1340" name="__codelineno-0-1340"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1341" name="__codelineno-0-1341"></a><span class="sd">        dict: DSA annotation</span>
<a id="__codelineno-0-1342" name="__codelineno-0-1342"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1343" name="__codelineno-0-1343"></a>    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-1344" name="__codelineno-0-1344"></a>        <span class="n">column</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span><span class="p">]</span>
<a id="__codelineno-0-1345" name="__codelineno-0-1345"></a>
<a id="__codelineno-0-1346" name="__codelineno-0-1346"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-1347" name="__codelineno-0-1347"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-0-1348" name="__codelineno-0-1348"></a>    <span class="n">scaled_tile_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tile_size</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">scale_factor</span> <span class="k">if</span> <span class="n">scale_factor</span> <span class="k">else</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-1349" name="__codelineno-0-1349"></a>
<a id="__codelineno-0-1350" name="__codelineno-0-1350"></a>    <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1351" name="__codelineno-0-1351"></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-1352" name="__codelineno-0-1352"></a>        <span class="n">element</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">base_dsa_polygon_element</span><span class="p">)</span>
<a id="__codelineno-0-1353" name="__codelineno-0-1353"></a>
<a id="__codelineno-0-1354" name="__codelineno-0-1354"></a>        <span class="c1"># get label specific color and add to elements</span>
<a id="__codelineno-0-1355" name="__codelineno-0-1355"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-1356" name="__codelineno-0-1356"></a>            <span class="n">label</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">column</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
<a id="__codelineno-0-1357" name="__codelineno-0-1357"></a>            <span class="n">element</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
<a id="__codelineno-0-1358" name="__codelineno-0-1358"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1359" name="__codelineno-0-1359"></a>            <span class="n">label</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">column</span><span class="p">])</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
<a id="__codelineno-0-1360" name="__codelineno-0-1360"></a>            <span class="n">element</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
<a id="__codelineno-0-1361" name="__codelineno-0-1361"></a>
<a id="__codelineno-0-1362" name="__codelineno-0-1362"></a>        <span class="k">if</span> <span class="n">fill_colors</span> <span class="ow">and</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">fill_colors</span><span class="p">:</span>
<a id="__codelineno-0-1363" name="__codelineno-0-1363"></a>            <span class="n">element</span><span class="p">[</span><span class="s2">&quot;fillColor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill_colors</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
<a id="__codelineno-0-1364" name="__codelineno-0-1364"></a>        <span class="k">if</span> <span class="n">line_colors</span> <span class="ow">and</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">line_colors</span><span class="p">:</span>
<a id="__codelineno-0-1365" name="__codelineno-0-1365"></a>            <span class="n">element</span><span class="p">[</span><span class="s2">&quot;lineColor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_colors</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
<a id="__codelineno-0-1366" name="__codelineno-0-1366"></a>
<a id="__codelineno-0-1367" name="__codelineno-0-1367"></a>        <span class="c1"># convert coordinate string to tuple using eval</span>
<a id="__codelineno-0-1368" name="__codelineno-0-1368"></a>        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">address_to_coord</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;address&quot;</span><span class="p">])</span>
<a id="__codelineno-0-1369" name="__codelineno-0-1369"></a>
<a id="__codelineno-0-1370" name="__codelineno-0-1370"></a>        <span class="n">pixel_x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">scaled_tile_size</span>
<a id="__codelineno-0-1371" name="__codelineno-0-1371"></a>        <span class="n">pixel_y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">scaled_tile_size</span>
<a id="__codelineno-0-1372" name="__codelineno-0-1372"></a>
<a id="__codelineno-0-1373" name="__codelineno-0-1373"></a>        <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-1374" name="__codelineno-0-1374"></a>            <span class="p">[</span><span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span><span class="p">],</span>
<a id="__codelineno-0-1375" name="__codelineno-0-1375"></a>            <span class="p">[</span><span class="n">pixel_x</span> <span class="o">+</span> <span class="n">scaled_tile_size</span><span class="p">,</span> <span class="n">pixel_y</span><span class="p">],</span>
<a id="__codelineno-0-1376" name="__codelineno-0-1376"></a>            <span class="p">[</span><span class="n">pixel_x</span> <span class="o">+</span> <span class="n">scaled_tile_size</span><span class="p">,</span> <span class="n">pixel_y</span> <span class="o">+</span> <span class="n">scaled_tile_size</span><span class="p">],</span>
<a id="__codelineno-0-1377" name="__codelineno-0-1377"></a>            <span class="p">[</span><span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span> <span class="o">+</span> <span class="n">scaled_tile_size</span><span class="p">],</span>
<a id="__codelineno-0-1378" name="__codelineno-0-1378"></a>            <span class="p">[</span><span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span><span class="p">],</span>
<a id="__codelineno-0-1379" name="__codelineno-0-1379"></a>        <span class="p">]</span>
<a id="__codelineno-0-1380" name="__codelineno-0-1380"></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
<a id="__codelineno-0-1381" name="__codelineno-0-1381"></a>            <span class="n">c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1382" name="__codelineno-0-1382"></a>        <span class="n">element</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span>
<a id="__codelineno-0-1383" name="__codelineno-0-1383"></a>        <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
<a id="__codelineno-0-1384" name="__codelineno-0-1384"></a>
<a id="__codelineno-0-1385" name="__codelineno-0-1385"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-1386" name="__codelineno-0-1386"></a>        <span class="n">annotation_name</span> <span class="o">=</span> <span class="n">column</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">annotation_name</span>
<a id="__codelineno-0-1387" name="__codelineno-0-1387"></a>
<a id="__codelineno-0-1388" name="__codelineno-0-1388"></a>    <span class="n">dsa_annotation</span> <span class="o">=</span> <span class="n">get_dsa_annotation</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">)</span>
<a id="__codelineno-0-1389" name="__codelineno-0-1389"></a>    <span class="k">return</span> <span class="n">save_dsa_annotation</span><span class="p">(</span>
<a id="__codelineno-0-1390" name="__codelineno-0-1390"></a>        <span class="n">dsa_annotation</span><span class="p">,</span>
<a id="__codelineno-0-1391" name="__codelineno-0-1391"></a>        <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-1392" name="__codelineno-0-1392"></a>        <span class="n">image_filename</span><span class="p">,</span>
<a id="__codelineno-0-1393" name="__codelineno-0-1393"></a>        <span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-1394" name="__codelineno-0-1394"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.__qupath_polygon" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">__qupath_polygon</span><span class="p">(</span><span class="n">input_urlpath</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">,</span> <span class="n">classes_to_include</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.dsa_viz.__qupath_polygon" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Build DSA annotation json from Qupath polygon geojson</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path of Qupath polygon geojson</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the annotation to be displayed in DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>classes_to_include</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>list of classification labels to visualize</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code>map</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code>map</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to read functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to write functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>dsa annotation</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-999"> 999</a></span>
<span class="normal"><a href="#__codelineno-0-1000">1000</a></span>
<span class="normal"><a href="#__codelineno-0-1001">1001</a></span>
<span class="normal"><a href="#__codelineno-0-1002">1002</a></span>
<span class="normal"><a href="#__codelineno-0-1003">1003</a></span>
<span class="normal"><a href="#__codelineno-0-1004">1004</a></span>
<span class="normal"><a href="#__codelineno-0-1005">1005</a></span>
<span class="normal"><a href="#__codelineno-0-1006">1006</a></span>
<span class="normal"><a href="#__codelineno-0-1007">1007</a></span>
<span class="normal"><a href="#__codelineno-0-1008">1008</a></span>
<span class="normal"><a href="#__codelineno-0-1009">1009</a></span>
<span class="normal"><a href="#__codelineno-0-1010">1010</a></span>
<span class="normal"><a href="#__codelineno-0-1011">1011</a></span>
<span class="normal"><a href="#__codelineno-0-1012">1012</a></span>
<span class="normal"><a href="#__codelineno-0-1013">1013</a></span>
<span class="normal"><a href="#__codelineno-0-1014">1014</a></span>
<span class="normal"><a href="#__codelineno-0-1015">1015</a></span>
<span class="normal"><a href="#__codelineno-0-1016">1016</a></span>
<span class="normal"><a href="#__codelineno-0-1017">1017</a></span>
<span class="normal"><a href="#__codelineno-0-1018">1018</a></span>
<span class="normal"><a href="#__codelineno-0-1019">1019</a></span>
<span class="normal"><a href="#__codelineno-0-1020">1020</a></span>
<span class="normal"><a href="#__codelineno-0-1021">1021</a></span>
<span class="normal"><a href="#__codelineno-0-1022">1022</a></span>
<span class="normal"><a href="#__codelineno-0-1023">1023</a></span>
<span class="normal"><a href="#__codelineno-0-1024">1024</a></span>
<span class="normal"><a href="#__codelineno-0-1025">1025</a></span>
<span class="normal"><a href="#__codelineno-0-1026">1026</a></span>
<span class="normal"><a href="#__codelineno-0-1027">1027</a></span>
<span class="normal"><a href="#__codelineno-0-1028">1028</a></span>
<span class="normal"><a href="#__codelineno-0-1029">1029</a></span>
<span class="normal"><a href="#__codelineno-0-1030">1030</a></span>
<span class="normal"><a href="#__codelineno-0-1031">1031</a></span>
<span class="normal"><a href="#__codelineno-0-1032">1032</a></span>
<span class="normal"><a href="#__codelineno-0-1033">1033</a></span>
<span class="normal"><a href="#__codelineno-0-1034">1034</a></span>
<span class="normal"><a href="#__codelineno-0-1035">1035</a></span>
<span class="normal"><a href="#__codelineno-0-1036">1036</a></span>
<span class="normal"><a href="#__codelineno-0-1037">1037</a></span>
<span class="normal"><a href="#__codelineno-0-1038">1038</a></span>
<span class="normal"><a href="#__codelineno-0-1039">1039</a></span>
<span class="normal"><a href="#__codelineno-0-1040">1040</a></span>
<span class="normal"><a href="#__codelineno-0-1041">1041</a></span>
<span class="normal"><a href="#__codelineno-0-1042">1042</a></span>
<span class="normal"><a href="#__codelineno-0-1043">1043</a></span>
<span class="normal"><a href="#__codelineno-0-1044">1044</a></span>
<span class="normal"><a href="#__codelineno-0-1045">1045</a></span>
<span class="normal"><a href="#__codelineno-0-1046">1046</a></span>
<span class="normal"><a href="#__codelineno-0-1047">1047</a></span>
<span class="normal"><a href="#__codelineno-0-1048">1048</a></span>
<span class="normal"><a href="#__codelineno-0-1049">1049</a></span>
<span class="normal"><a href="#__codelineno-0-1050">1050</a></span>
<span class="normal"><a href="#__codelineno-0-1051">1051</a></span>
<span class="normal"><a href="#__codelineno-0-1052">1052</a></span>
<span class="normal"><a href="#__codelineno-0-1053">1053</a></span>
<span class="normal"><a href="#__codelineno-0-1054">1054</a></span>
<span class="normal"><a href="#__codelineno-0-1055">1055</a></span>
<span class="normal"><a href="#__codelineno-0-1056">1056</a></span>
<span class="normal"><a href="#__codelineno-0-1057">1057</a></span>
<span class="normal"><a href="#__codelineno-0-1058">1058</a></span>
<span class="normal"><a href="#__codelineno-0-1059">1059</a></span>
<span class="normal"><a href="#__codelineno-0-1060">1060</a></span>
<span class="normal"><a href="#__codelineno-0-1061">1061</a></span>
<span class="normal"><a href="#__codelineno-0-1062">1062</a></span>
<span class="normal"><a href="#__codelineno-0-1063">1063</a></span>
<span class="normal"><a href="#__codelineno-0-1064">1064</a></span>
<span class="normal"><a href="#__codelineno-0-1065">1065</a></span>
<span class="normal"><a href="#__codelineno-0-1066">1066</a></span>
<span class="normal"><a href="#__codelineno-0-1067">1067</a></span>
<span class="normal"><a href="#__codelineno-0-1068">1068</a></span>
<span class="normal"><a href="#__codelineno-0-1069">1069</a></span>
<span class="normal"><a href="#__codelineno-0-1070">1070</a></span>
<span class="normal"><a href="#__codelineno-0-1071">1071</a></span>
<span class="normal"><a href="#__codelineno-0-1072">1072</a></span>
<span class="normal"><a href="#__codelineno-0-1073">1073</a></span>
<span class="normal"><a href="#__codelineno-0-1074">1074</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-999" name="__codelineno-0-999"></a><span class="k">def</span> <span class="nf">__qupath_polygon</span><span class="p">(</span>
<a id="__codelineno-0-1000" name="__codelineno-0-1000"></a>    <span class="n">input_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1001" name="__codelineno-0-1001"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1002" name="__codelineno-0-1002"></a>    <span class="n">image_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1003" name="__codelineno-0-1003"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1004" name="__codelineno-0-1004"></a>    <span class="n">classes_to_include</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
<a id="__codelineno-0-1005" name="__codelineno-0-1005"></a>    <span class="n">line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1006" name="__codelineno-0-1006"></a>    <span class="n">fill_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1007" name="__codelineno-0-1007"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-1008" name="__codelineno-0-1008"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-1009" name="__codelineno-0-1009"></a><span class="p">):</span>
<a id="__codelineno-0-1010" name="__codelineno-0-1010"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build DSA annotation json from Qupath polygon geojson</span>
<a id="__codelineno-0-1011" name="__codelineno-0-1011"></a>
<a id="__codelineno-0-1012" name="__codelineno-0-1012"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1013" name="__codelineno-0-1013"></a><span class="sd">        input_urlpath (string): url/path of Qupath polygon geojson</span>
<a id="__codelineno-0-1014" name="__codelineno-0-1014"></a><span class="sd">        annotation_name (string): name of the annotation to be displayed in DSA</span>
<a id="__codelineno-0-1015" name="__codelineno-0-1015"></a><span class="sd">        classes_to_include (list): list of classification labels to visualize</span>
<a id="__codelineno-0-1016" name="__codelineno-0-1016"></a><span class="sd">        e.g. [&quot;Tumor&quot;, &quot;Stroma&quot;, ...]</span>
<a id="__codelineno-0-1017" name="__codelineno-0-1017"></a><span class="sd">        line_colors (map, optional): line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-1018" name="__codelineno-0-1018"></a><span class="sd">        fill_colors (map, optional): fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-1019" name="__codelineno-0-1019"></a><span class="sd">        storage_options (dict): storage options to pass to read functions</span>
<a id="__codelineno-0-1020" name="__codelineno-0-1020"></a><span class="sd">        output_storage_options (dict): storage options to pass to write functions</span>
<a id="__codelineno-0-1021" name="__codelineno-0-1021"></a>
<a id="__codelineno-0-1022" name="__codelineno-0-1022"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1023" name="__codelineno-0-1023"></a><span class="sd">        dict: dsa annotation</span>
<a id="__codelineno-0-1024" name="__codelineno-0-1024"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1025" name="__codelineno-0-1025"></a>    <span class="n">regional_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_urlpath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span>
<a id="__codelineno-0-1026" name="__codelineno-0-1026"></a>    <span class="k">with</span> <span class="n">regional_file</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-1027" name="__codelineno-0-1027"></a>        <span class="n">pixel_clf_polygons</span> <span class="o">=</span> <span class="n">geojson</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-1028" name="__codelineno-0-1028"></a>
<a id="__codelineno-0-1029" name="__codelineno-0-1029"></a>    <span class="n">feature_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">pixel_clf_polygons</span><span class="p">)</span>
<a id="__codelineno-0-1030" name="__codelineno-0-1030"></a>    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pixel_clf_polygons</span><span class="p">)</span> <span class="o">==</span> <span class="n">geojson</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">FeatureCollection</span><span class="p">:</span>
<a id="__codelineno-0-1031" name="__codelineno-0-1031"></a>        <span class="n">feature_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">pixel_clf_polygons</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
<a id="__codelineno-0-1032" name="__codelineno-0-1032"></a>
<a id="__codelineno-0-1033" name="__codelineno-0-1033"></a>    <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1034" name="__codelineno-0-1034"></a>    <span class="k">for</span> <span class="n">polygon</span> <span class="ow">in</span> <span class="n">feature_iter</span><span class="p">:</span>
<a id="__codelineno-0-1035" name="__codelineno-0-1035"></a>        <span class="n">props</span> <span class="o">=</span> <span class="n">polygon</span><span class="o">.</span><span class="n">properties</span>
<a id="__codelineno-0-1036" name="__codelineno-0-1036"></a>        <span class="k">if</span> <span class="s2">&quot;classification&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">props</span><span class="p">:</span>
<a id="__codelineno-0-1037" name="__codelineno-0-1037"></a>            <span class="k">continue</span>
<a id="__codelineno-0-1038" name="__codelineno-0-1038"></a>
<a id="__codelineno-0-1039" name="__codelineno-0-1039"></a>        <span class="n">label_name</span> <span class="o">=</span> <span class="n">polygon</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;classification&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1040" name="__codelineno-0-1040"></a>        <span class="k">if</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="n">classes_to_include</span><span class="p">:</span>
<a id="__codelineno-0-1041" name="__codelineno-0-1041"></a>            <span class="n">element</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">base_dsa_polygon_element</span><span class="p">)</span>
<a id="__codelineno-0-1042" name="__codelineno-0-1042"></a>            <span class="n">element</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_name</span>
<a id="__codelineno-0-1043" name="__codelineno-0-1043"></a>            <span class="k">if</span> <span class="n">fill_colors</span> <span class="ow">and</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="n">fill_colors</span><span class="p">:</span>
<a id="__codelineno-0-1044" name="__codelineno-0-1044"></a>                <span class="n">element</span><span class="p">[</span><span class="s2">&quot;fillColor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill_colors</span><span class="p">[</span><span class="n">label_name</span><span class="p">]</span>
<a id="__codelineno-0-1045" name="__codelineno-0-1045"></a>            <span class="k">if</span> <span class="n">line_colors</span> <span class="ow">and</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="n">line_colors</span><span class="p">:</span>
<a id="__codelineno-0-1046" name="__codelineno-0-1046"></a>                <span class="n">element</span><span class="p">[</span><span class="s2">&quot;lineColor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_colors</span><span class="p">[</span><span class="n">label_name</span><span class="p">]</span>
<a id="__codelineno-0-1047" name="__codelineno-0-1047"></a>
<a id="__codelineno-0-1048" name="__codelineno-0-1048"></a>            <span class="n">coords</span> <span class="o">=</span> <span class="n">polygon</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">][</span><span class="s2">&quot;coordinates&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1049" name="__codelineno-0-1049"></a>
<a id="__codelineno-0-1050" name="__codelineno-0-1050"></a>            <span class="c1"># uneven nesting of connected components</span>
<a id="__codelineno-0-1051" name="__codelineno-0-1051"></a>            <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
<a id="__codelineno-0-1052" name="__codelineno-0-1052"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-1053" name="__codelineno-0-1053"></a>                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coord</span><span class="p">:</span>
<a id="__codelineno-0-1054" name="__codelineno-0-1054"></a>                        <span class="n">c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1055" name="__codelineno-0-1055"></a>                    <span class="n">element</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord</span>
<a id="__codelineno-0-1056" name="__codelineno-0-1056"></a>                    <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
<a id="__codelineno-0-1057" name="__codelineno-0-1057"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1058" name="__codelineno-0-1058"></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord</span><span class="p">)):</span>
<a id="__codelineno-0-1059" name="__codelineno-0-1059"></a>                        <span class="n">connected_component_coords</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-0-1060" name="__codelineno-0-1060"></a>                        <span class="n">connected_component_element</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
<a id="__codelineno-0-1061" name="__codelineno-0-1061"></a>                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">connected_component_coords</span><span class="p">:</span>
<a id="__codelineno-0-1062" name="__codelineno-0-1062"></a>                            <span class="n">c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1063" name="__codelineno-0-1063"></a>
<a id="__codelineno-0-1064" name="__codelineno-0-1064"></a>                        <span class="n">connected_component_element</span><span class="p">[</span>
<a id="__codelineno-0-1065" name="__codelineno-0-1065"></a>                            <span class="s2">&quot;points&quot;</span>
<a id="__codelineno-0-1066" name="__codelineno-0-1066"></a>                        <span class="p">]</span> <span class="o">=</span> <span class="n">connected_component_coords</span>
<a id="__codelineno-0-1067" name="__codelineno-0-1067"></a>                        <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">connected_component_element</span><span class="p">)</span>
<a id="__codelineno-0-1068" name="__codelineno-0-1068"></a>    <span class="n">dsa_annotation</span> <span class="o">=</span> <span class="n">get_dsa_annotation</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">)</span>
<a id="__codelineno-0-1069" name="__codelineno-0-1069"></a>    <span class="k">return</span> <span class="n">save_dsa_annotation</span><span class="p">(</span>
<a id="__codelineno-0-1070" name="__codelineno-0-1070"></a>        <span class="n">dsa_annotation</span><span class="p">,</span>
<a id="__codelineno-0-1071" name="__codelineno-0-1071"></a>        <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-1072" name="__codelineno-0-1072"></a>        <span class="n">image_filename</span><span class="p">,</span>
<a id="__codelineno-0-1073" name="__codelineno-0-1073"></a>        <span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-1074" name="__codelineno-0-1074"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.__regional_polygon" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">__regional_polygon</span><span class="p">(</span><span class="n">input_urlpath</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.dsa_viz.__regional_polygon" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Build DSA annotation json from regional annotation geojson</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>path to regional annotation geojson</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the annotation to be displayed in DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to read/write functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA annotation</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-831">831</a></span>
<span class="normal"><a href="#__codelineno-0-832">832</a></span>
<span class="normal"><a href="#__codelineno-0-833">833</a></span>
<span class="normal"><a href="#__codelineno-0-834">834</a></span>
<span class="normal"><a href="#__codelineno-0-835">835</a></span>
<span class="normal"><a href="#__codelineno-0-836">836</a></span>
<span class="normal"><a href="#__codelineno-0-837">837</a></span>
<span class="normal"><a href="#__codelineno-0-838">838</a></span>
<span class="normal"><a href="#__codelineno-0-839">839</a></span>
<span class="normal"><a href="#__codelineno-0-840">840</a></span>
<span class="normal"><a href="#__codelineno-0-841">841</a></span>
<span class="normal"><a href="#__codelineno-0-842">842</a></span>
<span class="normal"><a href="#__codelineno-0-843">843</a></span>
<span class="normal"><a href="#__codelineno-0-844">844</a></span>
<span class="normal"><a href="#__codelineno-0-845">845</a></span>
<span class="normal"><a href="#__codelineno-0-846">846</a></span>
<span class="normal"><a href="#__codelineno-0-847">847</a></span>
<span class="normal"><a href="#__codelineno-0-848">848</a></span>
<span class="normal"><a href="#__codelineno-0-849">849</a></span>
<span class="normal"><a href="#__codelineno-0-850">850</a></span>
<span class="normal"><a href="#__codelineno-0-851">851</a></span>
<span class="normal"><a href="#__codelineno-0-852">852</a></span>
<span class="normal"><a href="#__codelineno-0-853">853</a></span>
<span class="normal"><a href="#__codelineno-0-854">854</a></span>
<span class="normal"><a href="#__codelineno-0-855">855</a></span>
<span class="normal"><a href="#__codelineno-0-856">856</a></span>
<span class="normal"><a href="#__codelineno-0-857">857</a></span>
<span class="normal"><a href="#__codelineno-0-858">858</a></span>
<span class="normal"><a href="#__codelineno-0-859">859</a></span>
<span class="normal"><a href="#__codelineno-0-860">860</a></span>
<span class="normal"><a href="#__codelineno-0-861">861</a></span>
<span class="normal"><a href="#__codelineno-0-862">862</a></span>
<span class="normal"><a href="#__codelineno-0-863">863</a></span>
<span class="normal"><a href="#__codelineno-0-864">864</a></span>
<span class="normal"><a href="#__codelineno-0-865">865</a></span>
<span class="normal"><a href="#__codelineno-0-866">866</a></span>
<span class="normal"><a href="#__codelineno-0-867">867</a></span>
<span class="normal"><a href="#__codelineno-0-868">868</a></span>
<span class="normal"><a href="#__codelineno-0-869">869</a></span>
<span class="normal"><a href="#__codelineno-0-870">870</a></span>
<span class="normal"><a href="#__codelineno-0-871">871</a></span>
<span class="normal"><a href="#__codelineno-0-872">872</a></span>
<span class="normal"><a href="#__codelineno-0-873">873</a></span>
<span class="normal"><a href="#__codelineno-0-874">874</a></span>
<span class="normal"><a href="#__codelineno-0-875">875</a></span>
<span class="normal"><a href="#__codelineno-0-876">876</a></span>
<span class="normal"><a href="#__codelineno-0-877">877</a></span>
<span class="normal"><a href="#__codelineno-0-878">878</a></span>
<span class="normal"><a href="#__codelineno-0-879">879</a></span>
<span class="normal"><a href="#__codelineno-0-880">880</a></span>
<span class="normal"><a href="#__codelineno-0-881">881</a></span>
<span class="normal"><a href="#__codelineno-0-882">882</a></span>
<span class="normal"><a href="#__codelineno-0-883">883</a></span>
<span class="normal"><a href="#__codelineno-0-884">884</a></span>
<span class="normal"><a href="#__codelineno-0-885">885</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-831" name="__codelineno-0-831"></a><span class="k">def</span> <span class="nf">__regional_polygon</span><span class="p">(</span>
<a id="__codelineno-0-832" name="__codelineno-0-832"></a>    <span class="n">input_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-833" name="__codelineno-0-833"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-834" name="__codelineno-0-834"></a>    <span class="n">image_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-835" name="__codelineno-0-835"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-836" name="__codelineno-0-836"></a>    <span class="n">line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-837" name="__codelineno-0-837"></a>    <span class="n">fill_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-838" name="__codelineno-0-838"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-839" name="__codelineno-0-839"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-840" name="__codelineno-0-840"></a><span class="p">):</span>
<a id="__codelineno-0-841" name="__codelineno-0-841"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build DSA annotation json from regional annotation geojson</span>
<a id="__codelineno-0-842" name="__codelineno-0-842"></a>
<a id="__codelineno-0-843" name="__codelineno-0-843"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-844" name="__codelineno-0-844"></a><span class="sd">        input (string): path to regional annotation geojson</span>
<a id="__codelineno-0-845" name="__codelineno-0-845"></a><span class="sd">        annotation_name (string): name of the annotation to be displayed in DSA</span>
<a id="__codelineno-0-846" name="__codelineno-0-846"></a><span class="sd">        line_colors (dict, optional): line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-847" name="__codelineno-0-847"></a><span class="sd">        fill_colors (dict, optional): fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-848" name="__codelineno-0-848"></a><span class="sd">        storage_options (dict): storage options to pass to read/write functions</span>
<a id="__codelineno-0-849" name="__codelineno-0-849"></a>
<a id="__codelineno-0-850" name="__codelineno-0-850"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-851" name="__codelineno-0-851"></a><span class="sd">        dict: DSA annotation</span>
<a id="__codelineno-0-852" name="__codelineno-0-852"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-853" name="__codelineno-0-853"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">regional_file</span><span class="p">:</span>
<a id="__codelineno-0-854" name="__codelineno-0-854"></a>        <span class="n">regional_annotation</span> <span class="o">=</span> <span class="n">geojson</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">geojson</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">regional_file</span><span class="p">))</span>
<a id="__codelineno-0-855" name="__codelineno-0-855"></a>
<a id="__codelineno-0-856" name="__codelineno-0-856"></a>    <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-857" name="__codelineno-0-857"></a>    <span class="k">for</span> <span class="n">annot</span> <span class="ow">in</span> <span class="n">regional_annotation</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-858" name="__codelineno-0-858"></a>        <span class="c1"># get label name and add to element</span>
<a id="__codelineno-0-859" name="__codelineno-0-859"></a>        <span class="n">element</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">base_dsa_polygon_element</span><span class="p">)</span>
<a id="__codelineno-0-860" name="__codelineno-0-860"></a>        <span class="n">label_name</span> <span class="o">=</span> <span class="n">annot</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;label_name&quot;</span><span class="p">]</span>
<a id="__codelineno-0-861" name="__codelineno-0-861"></a>        <span class="n">element</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_name</span>
<a id="__codelineno-0-862" name="__codelineno-0-862"></a>        <span class="k">if</span> <span class="n">fill_colors</span> <span class="ow">and</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="n">fill_colors</span><span class="p">:</span>
<a id="__codelineno-0-863" name="__codelineno-0-863"></a>            <span class="n">element</span><span class="p">[</span><span class="s2">&quot;fillColor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill_colors</span><span class="p">[</span><span class="n">label_name</span><span class="p">]</span>
<a id="__codelineno-0-864" name="__codelineno-0-864"></a>        <span class="k">if</span> <span class="n">line_colors</span> <span class="ow">and</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="n">line_colors</span><span class="p">:</span>
<a id="__codelineno-0-865" name="__codelineno-0-865"></a>            <span class="n">element</span><span class="p">[</span><span class="s2">&quot;lineColor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_colors</span><span class="p">[</span><span class="n">label_name</span><span class="p">]</span>
<a id="__codelineno-0-866" name="__codelineno-0-866"></a>
<a id="__codelineno-0-867" name="__codelineno-0-867"></a>        <span class="c1"># add coordinates</span>
<a id="__codelineno-0-868" name="__codelineno-0-868"></a>        <span class="n">coords</span> <span class="o">=</span> <span class="n">annot</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">][</span><span class="s2">&quot;coordinates&quot;</span><span class="p">]</span>
<a id="__codelineno-0-869" name="__codelineno-0-869"></a>        <span class="c1"># if coordinates have extra nesting, set coordinates to 2d array.</span>
<a id="__codelineno-0-870" name="__codelineno-0-870"></a>        <span class="n">coords_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
<a id="__codelineno-0-871" name="__codelineno-0-871"></a>        <span class="k">if</span> <span class="n">coords_arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">coords_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-872" name="__codelineno-0-872"></a>            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">coords_arr</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-0-873" name="__codelineno-0-873"></a>
<a id="__codelineno-0-874" name="__codelineno-0-874"></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
<a id="__codelineno-0-875" name="__codelineno-0-875"></a>            <span class="n">c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-876" name="__codelineno-0-876"></a>        <span class="n">element</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span>
<a id="__codelineno-0-877" name="__codelineno-0-877"></a>        <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
<a id="__codelineno-0-878" name="__codelineno-0-878"></a>
<a id="__codelineno-0-879" name="__codelineno-0-879"></a>    <span class="n">dsa_annotation</span> <span class="o">=</span> <span class="n">get_dsa_annotation</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">)</span>
<a id="__codelineno-0-880" name="__codelineno-0-880"></a>    <span class="k">return</span> <span class="n">save_dsa_annotation</span><span class="p">(</span>
<a id="__codelineno-0-881" name="__codelineno-0-881"></a>        <span class="n">dsa_annotation</span><span class="p">,</span>
<a id="__codelineno-0-882" name="__codelineno-0-882"></a>        <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-883" name="__codelineno-0-883"></a>        <span class="n">image_filename</span><span class="p">,</span>
<a id="__codelineno-0-884" name="__codelineno-0-884"></a>        <span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-885" name="__codelineno-0-885"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.__stardist_cell" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">__stardist_cell</span><span class="p">(</span><span class="n">input_urlpath</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.dsa_viz.__stardist_cell" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Build DSA annotation json from TSV classification data generated by
stardist</p>
<p>Processes a cell classification data generated by Qupath/stardist and
adds the center coordinates of the cells
as annotation elements.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to TSV classification data generated by stardist</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the annotation to be displayed in DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to read/write functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>dsa annotation</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span>
<span class="normal"><a href="#__codelineno-0-679">679</a></span>
<span class="normal"><a href="#__codelineno-0-680">680</a></span>
<span class="normal"><a href="#__codelineno-0-681">681</a></span>
<span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span>
<span class="normal"><a href="#__codelineno-0-684">684</a></span>
<span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span>
<span class="normal"><a href="#__codelineno-0-692">692</a></span>
<span class="normal"><a href="#__codelineno-0-693">693</a></span>
<span class="normal"><a href="#__codelineno-0-694">694</a></span>
<span class="normal"><a href="#__codelineno-0-695">695</a></span>
<span class="normal"><a href="#__codelineno-0-696">696</a></span>
<span class="normal"><a href="#__codelineno-0-697">697</a></span>
<span class="normal"><a href="#__codelineno-0-698">698</a></span>
<span class="normal"><a href="#__codelineno-0-699">699</a></span>
<span class="normal"><a href="#__codelineno-0-700">700</a></span>
<span class="normal"><a href="#__codelineno-0-701">701</a></span>
<span class="normal"><a href="#__codelineno-0-702">702</a></span>
<span class="normal"><a href="#__codelineno-0-703">703</a></span>
<span class="normal"><a href="#__codelineno-0-704">704</a></span>
<span class="normal"><a href="#__codelineno-0-705">705</a></span>
<span class="normal"><a href="#__codelineno-0-706">706</a></span>
<span class="normal"><a href="#__codelineno-0-707">707</a></span>
<span class="normal"><a href="#__codelineno-0-708">708</a></span>
<span class="normal"><a href="#__codelineno-0-709">709</a></span>
<span class="normal"><a href="#__codelineno-0-710">710</a></span>
<span class="normal"><a href="#__codelineno-0-711">711</a></span>
<span class="normal"><a href="#__codelineno-0-712">712</a></span>
<span class="normal"><a href="#__codelineno-0-713">713</a></span>
<span class="normal"><a href="#__codelineno-0-714">714</a></span>
<span class="normal"><a href="#__codelineno-0-715">715</a></span>
<span class="normal"><a href="#__codelineno-0-716">716</a></span>
<span class="normal"><a href="#__codelineno-0-717">717</a></span>
<span class="normal"><a href="#__codelineno-0-718">718</a></span>
<span class="normal"><a href="#__codelineno-0-719">719</a></span>
<span class="normal"><a href="#__codelineno-0-720">720</a></span>
<span class="normal"><a href="#__codelineno-0-721">721</a></span>
<span class="normal"><a href="#__codelineno-0-722">722</a></span>
<span class="normal"><a href="#__codelineno-0-723">723</a></span>
<span class="normal"><a href="#__codelineno-0-724">724</a></span>
<span class="normal"><a href="#__codelineno-0-725">725</a></span>
<span class="normal"><a href="#__codelineno-0-726">726</a></span>
<span class="normal"><a href="#__codelineno-0-727">727</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-647" name="__codelineno-0-647"></a><span class="k">def</span> <span class="nf">__stardist_cell</span><span class="p">(</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a>    <span class="n">input_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>    <span class="n">image_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a>    <span class="n">line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>    <span class="n">fill_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a><span class="p">):</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build DSA annotation json from TSV classification data generated by</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a><span class="sd">    stardist</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a><span class="sd">    Processes a cell classification data generated by Qupath/stardist and</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a><span class="sd">    adds the center coordinates of the cells</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a><span class="sd">    as annotation elements.</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a><span class="sd">        input_urlpath (string): url/path to TSV classification data generated by stardist</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a><span class="sd">        annotation_name (string): name of the annotation to be displayed in DSA</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a><span class="sd">        line_colors (dict, optional): line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a><span class="sd">        fill_colors (dict, optional): fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a><span class="sd">        storage_options (dict): storage options to pass to read/write functions</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a><span class="sd">        dict: dsa annotation</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a>    <span class="c1"># qupath_stardist_cell_tsv can be quite large to load all columns</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a>    <span class="c1"># into memory (contains many feature columns),</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>    <span class="c1"># so only load baisc columns that are needed for now</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>    <span class="n">cols_to_load</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>        <span class="s2">&quot;Image&quot;</span><span class="p">,</span>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a>        <span class="s2">&quot;Name&quot;</span><span class="p">,</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a>        <span class="s2">&quot;Class&quot;</span><span class="p">,</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a>        <span class="s2">&quot;Centroid X m&quot;</span><span class="p">,</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a>        <span class="s2">&quot;Centroid Y m&quot;</span><span class="p">,</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a>    <span class="p">]</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a>        <span class="n">input_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a>        <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a>        <span class="n">usecols</span><span class="o">=</span><span class="n">cols_to_load</span><span class="p">,</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>        <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>        <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_options</span><span class="p">,</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>    <span class="p">)</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a>    <span class="c1"># do some preprocessing on the tsv -- e.g. stardist sometimes finds</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a>    <span class="c1"># cells in glass</span>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a>    <span class="c1"># df = df[df[&quot;Parent&quot;] != &quot;Glass&quot;]</span>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Centroid X m&quot;</span><span class="p">,</span> <span class="s2">&quot;Centroid Y m&quot;</span><span class="p">])</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a>    <span class="c1"># populate json elements</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a>    <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a>        <span class="n">elements_entry</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">base_dsa_point_element</span><span class="p">)</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a>        <span class="c1"># x,y coordinates from stardist are in microns so divide by</span>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a>        <span class="c1"># QUPATH_MAG_FACTOR = 0.5011 (exact 20x mag factor used by qupath</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a>        <span class="c1"># specifically)</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Centroid X m&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">QUPATH_MAG_FACTOR</span>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Centroid Y m&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">QUPATH_MAG_FACTOR</span>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a>        <span class="c1"># Get cell label and add to element</span>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a>        <span class="n">label_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Class&quot;</span><span class="p">]</span>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a>        <span class="n">elements_entry</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_name</span>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a>        <span class="k">if</span> <span class="n">fill_colors</span> <span class="ow">and</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="n">fill_colors</span><span class="p">:</span>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a>            <span class="n">elements_entry</span><span class="p">[</span><span class="s2">&quot;fillColor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill_colors</span><span class="p">[</span><span class="n">label_name</span><span class="p">]</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a>        <span class="k">if</span> <span class="n">line_colors</span> <span class="ow">and</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="n">line_colors</span><span class="p">:</span>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a>            <span class="n">elements_entry</span><span class="p">[</span><span class="s2">&quot;lineColor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_colors</span><span class="p">[</span><span class="n">label_name</span><span class="p">]</span>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a>        <span class="c1"># add centroid coordinate of cell to element</span>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a>        <span class="n">center</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a>        <span class="n">elements_entry</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">center</span>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a>        <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elements_entry</span><span class="p">)</span>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a>    <span class="n">dsa_annotation</span> <span class="o">=</span> <span class="n">get_dsa_annotation</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">)</span>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a>    <span class="k">return</span> <span class="n">save_dsa_annotation</span><span class="p">(</span>
<a id="__codelineno-0-723" name="__codelineno-0-723"></a>        <span class="n">dsa_annotation</span><span class="p">,</span>
<a id="__codelineno-0-724" name="__codelineno-0-724"></a>        <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-725" name="__codelineno-0-725"></a>        <span class="n">image_filename</span><span class="p">,</span>
<a id="__codelineno-0-726" name="__codelineno-0-726"></a>        <span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.__stardist_polygon" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">__stardist_polygon</span><span class="p">(</span><span class="n">input_urlpath</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.dsa_viz.__stardist_polygon" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Build DSA annotation from stardist geojson classification results</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path to stardist geojson classification results</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the annotation to be displayed in DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code>dict[str, str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>user-provided line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code>dict[str, str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>user-provided fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>dict[str,str]: annotation file path</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="k">def</span> <span class="nf">__stardist_polygon</span><span class="p">(</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>    <span class="n">input_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>    <span class="n">image_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>    <span class="n">line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>    <span class="n">fill_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a><span class="p">):</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build DSA annotation from stardist geojson classification results</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a><span class="sd">        input_urlpath (string): URL/path to stardist geojson classification results</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a><span class="sd">        json</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a><span class="sd">        annotation_name (string): name of the annotation to be displayed in DSA</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="sd">        line_colors (dict[str,str]): user-provided line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="sd">        fill_colors (dict[str,str]): user-provided fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="sd">        dict[str,str]: annotation file path</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>    <span class="c1"># TODO: find better fix</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="c1"># can&#39;t handle NaNs for vectors, do this to replace all NaNs</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>    <span class="c1"># for now: https://stackoverflow.com/questions/17140886/how-to-search</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>    <span class="c1"># -and-replace-text-in-a-file</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_urlpath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">input_file</span><span class="p">:</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>        <span class="n">filedata</span> <span class="o">=</span> <span class="n">input_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="n">newdata</span> <span class="o">=</span> <span class="n">filedata</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;NaN&quot;</span><span class="p">,</span> <span class="s2">&quot;-1&quot;</span><span class="p">)</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">ijson</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">newdata</span><span class="p">,</span> <span class="s2">&quot;item&quot;</span><span class="p">):</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>        <span class="n">label_name</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;classification&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>        <span class="n">coord_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">][</span><span class="s2">&quot;coordinates&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>        <span class="c1"># uneven nested list when iterative parsing of json --&gt; make sure</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>        <span class="c1"># to get the list of coords</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>        <span class="c1"># this can come as mixed types as well, so type checking needed</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>        <span class="k">while</span> <span class="p">(</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>            <span class="nb">isinstance</span><span class="p">(</span><span class="n">coord_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coord_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coord_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">))</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="p">):</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>            <span class="n">coord_list</span> <span class="o">=</span> <span class="n">coord_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>        <span class="n">coords</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coord_list</span><span class="p">]</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>        <span class="n">element</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">base_dsa_polygon_element</span><span class="p">)</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>        <span class="n">element</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">label_name</span><span class="p">)</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>        <span class="k">if</span> <span class="n">fill_colors</span> <span class="ow">and</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="n">fill_colors</span><span class="p">:</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>            <span class="n">element</span><span class="p">[</span><span class="s2">&quot;fillColor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill_colors</span><span class="p">[</span><span class="n">label_name</span><span class="p">]</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>        <span class="k">if</span> <span class="n">line_colors</span> <span class="ow">and</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="n">line_colors</span><span class="p">:</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>            <span class="n">element</span><span class="p">[</span><span class="s2">&quot;lineColor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_colors</span><span class="p">[</span><span class="n">label_name</span><span class="p">]</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="n">element</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>        <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>    <span class="n">dsa_annotation</span> <span class="o">=</span> <span class="n">get_dsa_annotation</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">)</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>    <span class="k">return</span> <span class="n">save_dsa_annotation</span><span class="p">(</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>        <span class="n">dsa_annotation</span><span class="p">,</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>        <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="n">image_filename</span><span class="p">,</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>        <span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.__stardist_polygon_tile" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">__stardist_polygon_tile</span><span class="p">(</span><span class="n">object_urlpath</span><span class="p">,</span> <span class="n">tiles_urlpath</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">,</span> <span class="n">annotation_name_prefix</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.dsa_viz.__stardist_polygon_tile" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Build DSA annotation json from stardist geojson classification and labeled tiles</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>object_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path to stardist geojson classification results</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tiles_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path to tiles manifest parquet</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path prefix to save annotations</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>image_filename</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the image file in DSA e.g. 123.svs</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name_prefix</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the annotation to be displayed in DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>user-provided line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>user-provided fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to read functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to write functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA annotations</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="k">def</span> <span class="nf">__stardist_polygon_tile</span><span class="p">(</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>    <span class="n">object_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>    <span class="n">tiles_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>    <span class="n">image_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>    <span class="n">annotation_name_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>    <span class="n">line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>    <span class="n">fill_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a><span class="p">):</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build DSA annotation json from stardist geojson classification and labeled tiles</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a><span class="sd">        object_urlpath (string): URL/path to stardist geojson classification results</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a><span class="sd">        tiles_urlpath (string): URL/path to tiles manifest parquet</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a><span class="sd">        output_urlpath (string): URL/path prefix to save annotations</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a><span class="sd">        image_filename (string): name of the image file in DSA e.g. 123.svs</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a><span class="sd">        annotation_name_prefix (string): name of the annotation to be displayed in DSA</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a><span class="sd">        line_colors (dict): user-provided line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a><span class="sd">        fill_colors (dict): user-provided fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a><span class="sd">        storage_options (dict): storage options to pass to read functions</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a><span class="sd">        output_storage_options (dict): storage options to pass to write functions</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a><span class="sd">        dict: DSA annotations</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tiles_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>        <span class="n">tiles_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>    <span class="n">LabeledTileSchema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">tiles_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">())</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Read tiles manifest with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tiles_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> tiles&quot;</span><span class="p">)</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">object_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>        <span class="n">object_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Read </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">object_gdf</span><span class="p">)</span><span class="si">}</span><span class="s2"> stardist objects&quot;</span><span class="p">)</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>    <span class="n">ann_region_polygons</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>        <span class="n">box</span><span class="p">(</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>            <span class="n">row</span><span class="o">.</span><span class="n">x_coord</span><span class="p">,</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>            <span class="n">row</span><span class="o">.</span><span class="n">y_coord</span><span class="p">,</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>            <span class="n">row</span><span class="o">.</span><span class="n">x_coord</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">xy_extent</span><span class="p">,</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>            <span class="n">row</span><span class="o">.</span><span class="n">y_coord</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">xy_extent</span><span class="p">,</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>        <span class="p">)</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tiles_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>    <span class="p">]</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>    <span class="n">tiles_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>        <span class="n">data</span><span class="o">=</span><span class="n">tiles_df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">ann_region_polygons</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;EPSG:4326&quot;</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>    <span class="p">)</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>    <span class="n">object_tiles</span> <span class="o">=</span> <span class="n">object_gdf</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">tiles_gdf</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;within&quot;</span><span class="p">)</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Spatially joined stardist objects with tiles manifest&quot;</span><span class="p">)</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>    <span class="n">tile_elements</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">object_tiles</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>        <span class="n">tile_label</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Classification&quot;</span><span class="p">]</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">tile_label</span><span class="p">):</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>            <span class="n">tile_label</span> <span class="o">=</span> <span class="s2">&quot;unclassified&quot;</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>        <span class="k">if</span> <span class="n">tile_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tile_elements</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>            <span class="n">tile_elements</span><span class="p">[</span><span class="n">tile_label</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>        <span class="n">label_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;classification&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>        <span class="n">multipolygon</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">multipolygon</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MultiPolygon</span><span class="p">:</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>            <span class="n">multipolygon</span> <span class="o">=</span> <span class="n">MultiPolygon</span><span class="p">([</span><span class="n">multipolygon</span><span class="p">])</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>        <span class="k">for</span> <span class="n">polygon</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">multipolygon</span><span class="o">.</span><span class="n">geoms</span><span class="p">):</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>            <span class="n">coord_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">polygon</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>            <span class="n">coords</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coord_list</span><span class="p">]</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>            <span class="n">element</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">base_dsa_polygon_element</span><span class="p">)</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>            <span class="n">element</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">label_name</span><span class="p">)</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>            <span class="k">if</span> <span class="n">fill_colors</span> <span class="ow">and</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="n">fill_colors</span><span class="p">:</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>                <span class="n">element</span><span class="p">[</span><span class="s2">&quot;fillColor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill_colors</span><span class="p">[</span><span class="n">label_name</span><span class="p">]</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>            <span class="k">if</span> <span class="n">line_colors</span> <span class="ow">and</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="n">line_colors</span><span class="p">:</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>                <span class="n">element</span><span class="p">[</span><span class="s2">&quot;lineColor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_colors</span><span class="p">[</span><span class="n">label_name</span><span class="p">]</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>            <span class="n">element</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>            <span class="n">tile_elements</span><span class="p">[</span><span class="n">tile_label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>    <span class="k">for</span> <span class="n">tile_label</span><span class="p">,</span> <span class="n">elements</span> <span class="ow">in</span> <span class="n">tile_elements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>        <span class="n">dsa_annotation</span> <span class="o">=</span> <span class="n">get_dsa_annotation</span><span class="p">(</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>            <span class="n">elements</span><span class="p">,</span> <span class="n">annotation_name_prefix</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">tile_label</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>        <span class="p">)</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>        <span class="n">annotation_filepath</span> <span class="o">=</span> <span class="n">save_dsa_annotation</span><span class="p">(</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>            <span class="n">dsa_annotation</span><span class="p">,</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>            <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>            <span class="n">image_filename</span><span class="p">,</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>            <span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>        <span class="p">)</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>        <span class="n">metadata</span><span class="p">[</span><span class="n">tile_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">annotation_filepath</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>    <span class="k">return</span> <span class="n">metadata</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.bitmask_polygon" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">bitmask_polygon</span><span class="p">(</span><span class="n">input_map</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.dsa_viz.bitmask_polygon" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Build DSA annotation json from bitmask PNGs</p>
<p>Vectorizes and simplifies contours from the bitmask.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input</code></td>
          <td>
                <code>map</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>map of {label:urlpath_to_bitmask_png}</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the annotation to be displayed in DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>scale_factor</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>scale to match the image on DSA.</p>
            </div>
          </td>
          <td>
                <code>1</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to read/write functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA annotation</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1126">1126</a></span>
<span class="normal"><a href="#__codelineno-0-1127">1127</a></span>
<span class="normal"><a href="#__codelineno-0-1128">1128</a></span>
<span class="normal"><a href="#__codelineno-0-1129">1129</a></span>
<span class="normal"><a href="#__codelineno-0-1130">1130</a></span>
<span class="normal"><a href="#__codelineno-0-1131">1131</a></span>
<span class="normal"><a href="#__codelineno-0-1132">1132</a></span>
<span class="normal"><a href="#__codelineno-0-1133">1133</a></span>
<span class="normal"><a href="#__codelineno-0-1134">1134</a></span>
<span class="normal"><a href="#__codelineno-0-1135">1135</a></span>
<span class="normal"><a href="#__codelineno-0-1136">1136</a></span>
<span class="normal"><a href="#__codelineno-0-1137">1137</a></span>
<span class="normal"><a href="#__codelineno-0-1138">1138</a></span>
<span class="normal"><a href="#__codelineno-0-1139">1139</a></span>
<span class="normal"><a href="#__codelineno-0-1140">1140</a></span>
<span class="normal"><a href="#__codelineno-0-1141">1141</a></span>
<span class="normal"><a href="#__codelineno-0-1142">1142</a></span>
<span class="normal"><a href="#__codelineno-0-1143">1143</a></span>
<span class="normal"><a href="#__codelineno-0-1144">1144</a></span>
<span class="normal"><a href="#__codelineno-0-1145">1145</a></span>
<span class="normal"><a href="#__codelineno-0-1146">1146</a></span>
<span class="normal"><a href="#__codelineno-0-1147">1147</a></span>
<span class="normal"><a href="#__codelineno-0-1148">1148</a></span>
<span class="normal"><a href="#__codelineno-0-1149">1149</a></span>
<span class="normal"><a href="#__codelineno-0-1150">1150</a></span>
<span class="normal"><a href="#__codelineno-0-1151">1151</a></span>
<span class="normal"><a href="#__codelineno-0-1152">1152</a></span>
<span class="normal"><a href="#__codelineno-0-1153">1153</a></span>
<span class="normal"><a href="#__codelineno-0-1154">1154</a></span>
<span class="normal"><a href="#__codelineno-0-1155">1155</a></span>
<span class="normal"><a href="#__codelineno-0-1156">1156</a></span>
<span class="normal"><a href="#__codelineno-0-1157">1157</a></span>
<span class="normal"><a href="#__codelineno-0-1158">1158</a></span>
<span class="normal"><a href="#__codelineno-0-1159">1159</a></span>
<span class="normal"><a href="#__codelineno-0-1160">1160</a></span>
<span class="normal"><a href="#__codelineno-0-1161">1161</a></span>
<span class="normal"><a href="#__codelineno-0-1162">1162</a></span>
<span class="normal"><a href="#__codelineno-0-1163">1163</a></span>
<span class="normal"><a href="#__codelineno-0-1164">1164</a></span>
<span class="normal"><a href="#__codelineno-0-1165">1165</a></span>
<span class="normal"><a href="#__codelineno-0-1166">1166</a></span>
<span class="normal"><a href="#__codelineno-0-1167">1167</a></span>
<span class="normal"><a href="#__codelineno-0-1168">1168</a></span>
<span class="normal"><a href="#__codelineno-0-1169">1169</a></span>
<span class="normal"><a href="#__codelineno-0-1170">1170</a></span>
<span class="normal"><a href="#__codelineno-0-1171">1171</a></span>
<span class="normal"><a href="#__codelineno-0-1172">1172</a></span>
<span class="normal"><a href="#__codelineno-0-1173">1173</a></span>
<span class="normal"><a href="#__codelineno-0-1174">1174</a></span>
<span class="normal"><a href="#__codelineno-0-1175">1175</a></span>
<span class="normal"><a href="#__codelineno-0-1176">1176</a></span>
<span class="normal"><a href="#__codelineno-0-1177">1177</a></span>
<span class="normal"><a href="#__codelineno-0-1178">1178</a></span>
<span class="normal"><a href="#__codelineno-0-1179">1179</a></span>
<span class="normal"><a href="#__codelineno-0-1180">1180</a></span>
<span class="normal"><a href="#__codelineno-0-1181">1181</a></span>
<span class="normal"><a href="#__codelineno-0-1182">1182</a></span>
<span class="normal"><a href="#__codelineno-0-1183">1183</a></span>
<span class="normal"><a href="#__codelineno-0-1184">1184</a></span>
<span class="normal"><a href="#__codelineno-0-1185">1185</a></span>
<span class="normal"><a href="#__codelineno-0-1186">1186</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1126" name="__codelineno-0-1126"></a><span class="k">def</span> <span class="nf">bitmask_polygon</span><span class="p">(</span>
<a id="__codelineno-0-1127" name="__codelineno-0-1127"></a>    <span class="n">input_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-1128" name="__codelineno-0-1128"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1129" name="__codelineno-0-1129"></a>    <span class="n">image_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1130" name="__codelineno-0-1130"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1131" name="__codelineno-0-1131"></a>    <span class="n">line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1132" name="__codelineno-0-1132"></a>    <span class="n">fill_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1133" name="__codelineno-0-1133"></a>    <span class="n">scale_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-1134" name="__codelineno-0-1134"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-1135" name="__codelineno-0-1135"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-1136" name="__codelineno-0-1136"></a><span class="p">):</span>
<a id="__codelineno-0-1137" name="__codelineno-0-1137"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build DSA annotation json from bitmask PNGs</span>
<a id="__codelineno-0-1138" name="__codelineno-0-1138"></a>
<a id="__codelineno-0-1139" name="__codelineno-0-1139"></a><span class="sd">    Vectorizes and simplifies contours from the bitmask.</span>
<a id="__codelineno-0-1140" name="__codelineno-0-1140"></a>
<a id="__codelineno-0-1141" name="__codelineno-0-1141"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1142" name="__codelineno-0-1142"></a><span class="sd">        input (map): map of {label:urlpath_to_bitmask_png}</span>
<a id="__codelineno-0-1143" name="__codelineno-0-1143"></a><span class="sd">        annotation_name (string): name of the annotation to be displayed in DSA</span>
<a id="__codelineno-0-1144" name="__codelineno-0-1144"></a><span class="sd">        line_colors (dict, optional): line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-1145" name="__codelineno-0-1145"></a><span class="sd">        fill_colors (dict, optional): fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-1146" name="__codelineno-0-1146"></a><span class="sd">        scale_factor (int, optional): scale to match the image on DSA.</span>
<a id="__codelineno-0-1147" name="__codelineno-0-1147"></a><span class="sd">        storage_options (dict): storage options to pass to read/write functions</span>
<a id="__codelineno-0-1148" name="__codelineno-0-1148"></a>
<a id="__codelineno-0-1149" name="__codelineno-0-1149"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1150" name="__codelineno-0-1150"></a><span class="sd">        dict: DSA annotation</span>
<a id="__codelineno-0-1151" name="__codelineno-0-1151"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1152" name="__codelineno-0-1152"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_filepaths_valid</span><span class="p">(</span><span class="n">input_map</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">storage_options</span><span class="p">):</span>
<a id="__codelineno-0-1153" name="__codelineno-0-1153"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid PNG masks found. Exiting..&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1154" name="__codelineno-0-1154"></a>
<a id="__codelineno-0-1155" name="__codelineno-0-1155"></a>    <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1156" name="__codelineno-0-1156"></a>    <span class="k">for</span> <span class="n">bitmask_label</span><span class="p">,</span> <span class="n">bitmask_filepath</span> <span class="ow">in</span> <span class="n">input_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-1157" name="__codelineno-0-1157"></a>        <span class="n">Image</span><span class="o">.</span><span class="n">MAX_IMAGE_PIXELS</span> <span class="o">=</span> <span class="mi">5000000000</span>
<a id="__codelineno-0-1158" name="__codelineno-0-1158"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">bitmask_filepath</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-1159" name="__codelineno-0-1159"></a>            <span class="n">annotation</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-1160" name="__codelineno-0-1160"></a>            <span class="n">bitmask_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
<a id="__codelineno-0-1161" name="__codelineno-0-1161"></a>        <span class="n">simplified_contours</span> <span class="o">=</span> <span class="n">vectorize_np_array_bitmask_by_pixel_value</span><span class="p">(</span>
<a id="__codelineno-0-1162" name="__codelineno-0-1162"></a>            <span class="n">bitmask_np</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="n">scale_factor</span>
<a id="__codelineno-0-1163" name="__codelineno-0-1163"></a>        <span class="p">)</span>
<a id="__codelineno-0-1164" name="__codelineno-0-1164"></a>
<a id="__codelineno-0-1165" name="__codelineno-0-1165"></a>        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">contour</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">simplified_contours</span><span class="p">):</span>
<a id="__codelineno-0-1166" name="__codelineno-0-1166"></a>            <span class="n">element</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">base_dsa_polygon_element</span><span class="p">)</span>
<a id="__codelineno-0-1167" name="__codelineno-0-1167"></a>            <span class="n">label_name</span> <span class="o">=</span> <span class="n">bitmask_label</span>
<a id="__codelineno-0-1168" name="__codelineno-0-1168"></a>            <span class="n">element</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_name</span>
<a id="__codelineno-0-1169" name="__codelineno-0-1169"></a>            <span class="k">if</span> <span class="n">fill_colors</span> <span class="ow">and</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="n">fill_colors</span><span class="p">:</span>
<a id="__codelineno-0-1170" name="__codelineno-0-1170"></a>                <span class="n">element</span><span class="p">[</span><span class="s2">&quot;fillColor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill_colors</span><span class="p">[</span><span class="n">label_name</span><span class="p">]</span>
<a id="__codelineno-0-1171" name="__codelineno-0-1171"></a>            <span class="k">if</span> <span class="n">line_colors</span> <span class="ow">and</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="n">line_colors</span><span class="p">:</span>
<a id="__codelineno-0-1172" name="__codelineno-0-1172"></a>                <span class="n">element</span><span class="p">[</span><span class="s2">&quot;lineColor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_colors</span><span class="p">[</span><span class="n">label_name</span><span class="p">]</span>
<a id="__codelineno-0-1173" name="__codelineno-0-1173"></a>
<a id="__codelineno-0-1174" name="__codelineno-0-1174"></a>            <span class="n">coords</span> <span class="o">=</span> <span class="n">contour</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-0-1175" name="__codelineno-0-1175"></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
<a id="__codelineno-0-1176" name="__codelineno-0-1176"></a>                <span class="n">c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1177" name="__codelineno-0-1177"></a>            <span class="n">element</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span>
<a id="__codelineno-0-1178" name="__codelineno-0-1178"></a>            <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
<a id="__codelineno-0-1179" name="__codelineno-0-1179"></a>
<a id="__codelineno-0-1180" name="__codelineno-0-1180"></a>    <span class="n">dsa_annotation</span> <span class="o">=</span> <span class="n">get_dsa_annotation</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">)</span>
<a id="__codelineno-0-1181" name="__codelineno-0-1181"></a>    <span class="k">return</span> <span class="n">save_dsa_annotation</span><span class="p">(</span>
<a id="__codelineno-0-1182" name="__codelineno-0-1182"></a>        <span class="n">dsa_annotation</span><span class="p">,</span>
<a id="__codelineno-0-1183" name="__codelineno-0-1183"></a>        <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-1184" name="__codelineno-0-1184"></a>        <span class="n">image_filename</span><span class="p">,</span>
<a id="__codelineno-0-1185" name="__codelineno-0-1185"></a>        <span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-1186" name="__codelineno-0-1186"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.bitmask_polygon_cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">bitmask_polygon_cli</span><span class="p">(</span><span class="n">input_map</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">image_filename</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">annotation_name</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.dsa_viz.bitmask_polygon_cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Build DSA annotation json from bitmask PNGs</p>
<p>Vectorizes and simplifies contours from the bitmask.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_map</code></td>
          <td>
                <code>map</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>map of {label:path_to_bitmask_png}</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to save the DSA compatible annotation</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>image_filename</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the image file in DSA e.g. 123.svs</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the annotation to be displayed in DSA</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>scale_factor</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>scale to match the image on DSA.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to read functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to write functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>local_config</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>local config yaml file</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>annotation file path</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1077">1077</a></span>
<span class="normal"><a href="#__codelineno-0-1078">1078</a></span>
<span class="normal"><a href="#__codelineno-0-1079">1079</a></span>
<span class="normal"><a href="#__codelineno-0-1080">1080</a></span>
<span class="normal"><a href="#__codelineno-0-1081">1081</a></span>
<span class="normal"><a href="#__codelineno-0-1082">1082</a></span>
<span class="normal"><a href="#__codelineno-0-1083">1083</a></span>
<span class="normal"><a href="#__codelineno-0-1084">1084</a></span>
<span class="normal"><a href="#__codelineno-0-1085">1085</a></span>
<span class="normal"><a href="#__codelineno-0-1086">1086</a></span>
<span class="normal"><a href="#__codelineno-0-1087">1087</a></span>
<span class="normal"><a href="#__codelineno-0-1088">1088</a></span>
<span class="normal"><a href="#__codelineno-0-1089">1089</a></span>
<span class="normal"><a href="#__codelineno-0-1090">1090</a></span>
<span class="normal"><a href="#__codelineno-0-1091">1091</a></span>
<span class="normal"><a href="#__codelineno-0-1092">1092</a></span>
<span class="normal"><a href="#__codelineno-0-1093">1093</a></span>
<span class="normal"><a href="#__codelineno-0-1094">1094</a></span>
<span class="normal"><a href="#__codelineno-0-1095">1095</a></span>
<span class="normal"><a href="#__codelineno-0-1096">1096</a></span>
<span class="normal"><a href="#__codelineno-0-1097">1097</a></span>
<span class="normal"><a href="#__codelineno-0-1098">1098</a></span>
<span class="normal"><a href="#__codelineno-0-1099">1099</a></span>
<span class="normal"><a href="#__codelineno-0-1100">1100</a></span>
<span class="normal"><a href="#__codelineno-0-1101">1101</a></span>
<span class="normal"><a href="#__codelineno-0-1102">1102</a></span>
<span class="normal"><a href="#__codelineno-0-1103">1103</a></span>
<span class="normal"><a href="#__codelineno-0-1104">1104</a></span>
<span class="normal"><a href="#__codelineno-0-1105">1105</a></span>
<span class="normal"><a href="#__codelineno-0-1106">1106</a></span>
<span class="normal"><a href="#__codelineno-0-1107">1107</a></span>
<span class="normal"><a href="#__codelineno-0-1108">1108</a></span>
<span class="normal"><a href="#__codelineno-0-1109">1109</a></span>
<span class="normal"><a href="#__codelineno-0-1110">1110</a></span>
<span class="normal"><a href="#__codelineno-0-1111">1111</a></span>
<span class="normal"><a href="#__codelineno-0-1112">1112</a></span>
<span class="normal"><a href="#__codelineno-0-1113">1113</a></span>
<span class="normal"><a href="#__codelineno-0-1114">1114</a></span>
<span class="normal"><a href="#__codelineno-0-1115">1115</a></span>
<span class="normal"><a href="#__codelineno-0-1116">1116</a></span>
<span class="normal"><a href="#__codelineno-0-1117">1117</a></span>
<span class="normal"><a href="#__codelineno-0-1118">1118</a></span>
<span class="normal"><a href="#__codelineno-0-1119">1119</a></span>
<span class="normal"><a href="#__codelineno-0-1120">1120</a></span>
<span class="normal"><a href="#__codelineno-0-1121">1121</a></span>
<span class="normal"><a href="#__codelineno-0-1122">1122</a></span>
<span class="normal"><a href="#__codelineno-0-1123">1123</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1077" name="__codelineno-0-1077"></a><span class="nd">@timed</span>
<a id="__codelineno-0-1078" name="__codelineno-0-1078"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-1079" name="__codelineno-0-1079"></a><span class="k">def</span> <span class="nf">bitmask_polygon_cli</span><span class="p">(</span>
<a id="__codelineno-0-1080" name="__codelineno-0-1080"></a>    <span class="n">input_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-1081" name="__codelineno-0-1081"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1082" name="__codelineno-0-1082"></a>    <span class="n">image_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1083" name="__codelineno-0-1083"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1084" name="__codelineno-0-1084"></a>    <span class="n">line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1085" name="__codelineno-0-1085"></a>    <span class="n">fill_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1086" name="__codelineno-0-1086"></a>    <span class="n">scale_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1087" name="__codelineno-0-1087"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-1088" name="__codelineno-0-1088"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-1089" name="__codelineno-0-1089"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1090" name="__codelineno-0-1090"></a><span class="p">):</span>
<a id="__codelineno-0-1091" name="__codelineno-0-1091"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build DSA annotation json from bitmask PNGs</span>
<a id="__codelineno-0-1092" name="__codelineno-0-1092"></a>
<a id="__codelineno-0-1093" name="__codelineno-0-1093"></a><span class="sd">    Vectorizes and simplifies contours from the bitmask.</span>
<a id="__codelineno-0-1094" name="__codelineno-0-1094"></a>
<a id="__codelineno-0-1095" name="__codelineno-0-1095"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1096" name="__codelineno-0-1096"></a><span class="sd">        input_map (map): map of {label:path_to_bitmask_png}</span>
<a id="__codelineno-0-1097" name="__codelineno-0-1097"></a><span class="sd">        output_urlpath (string): url/path to save the DSA compatible annotation</span>
<a id="__codelineno-0-1098" name="__codelineno-0-1098"></a><span class="sd">        json</span>
<a id="__codelineno-0-1099" name="__codelineno-0-1099"></a><span class="sd">        image_filename (string): name of the image file in DSA e.g. 123.svs</span>
<a id="__codelineno-0-1100" name="__codelineno-0-1100"></a><span class="sd">        annotation_name (string): name of the annotation to be displayed in DSA</span>
<a id="__codelineno-0-1101" name="__codelineno-0-1101"></a><span class="sd">        line_colors (dict, optional): line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-1102" name="__codelineno-0-1102"></a><span class="sd">        fill_colors (dict, optional): fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-1103" name="__codelineno-0-1103"></a><span class="sd">        scale_factor (int, optional): scale to match the image on DSA.</span>
<a id="__codelineno-0-1104" name="__codelineno-0-1104"></a><span class="sd">        storage_options (dict): storage options to pass to read functions</span>
<a id="__codelineno-0-1105" name="__codelineno-0-1105"></a><span class="sd">        output_storage_options (dict): storage options to pass to write functions</span>
<a id="__codelineno-0-1106" name="__codelineno-0-1106"></a><span class="sd">        local_config (string): local config yaml file</span>
<a id="__codelineno-0-1107" name="__codelineno-0-1107"></a>
<a id="__codelineno-0-1108" name="__codelineno-0-1108"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1109" name="__codelineno-0-1109"></a><span class="sd">        dict: annotation file path</span>
<a id="__codelineno-0-1110" name="__codelineno-0-1110"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1111" name="__codelineno-0-1111"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-1112" name="__codelineno-0-1112"></a>    <span class="n">annotation_filepath</span> <span class="o">=</span> <span class="n">bitmask_polygon</span><span class="p">(</span>
<a id="__codelineno-0-1113" name="__codelineno-0-1113"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;input_map&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1114" name="__codelineno-0-1114"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1115" name="__codelineno-0-1115"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;image_filename&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1116" name="__codelineno-0-1116"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;annotation_name&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1117" name="__codelineno-0-1117"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;line_colors&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1118" name="__codelineno-0-1118"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;fill_colors&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1119" name="__codelineno-0-1119"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;scale_factor&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1120" name="__codelineno-0-1120"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1121" name="__codelineno-0-1121"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1122" name="__codelineno-0-1122"></a>    <span class="p">)</span>
<a id="__codelineno-0-1123" name="__codelineno-0-1123"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;dsa_annotation&quot;</span><span class="p">:</span> <span class="n">annotation_filepath</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.bmp_polygon" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">bmp_polygon</span><span class="p">(</span><span class="n">slide_manifest</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">label_map</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">annotation_column</span><span class="o">=</span><span class="s1">&#39;bmp_polygon_url&#39;</span><span class="p">,</span> <span class="n">output_column</span><span class="o">=</span><span class="s1">&#39;bmp_polygon_dsa_url&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.dsa_viz.bmp_polygon" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Build DSA annotation json from a BMP with multiple labels.</p>
<p>Vectorizes and simplifies contours per label.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_manifest</code></td>
          <td>
                <code><span title="pandera.typing.DataFrame">DataFrame</span>[<span title="luna.common.models.SlideSchema">SlideSchema</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slide manifest from slide_etl</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path prefix to save the DSA compatible annotation</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>label_map</code></td>
          <td>
                <code>dict[int, str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>map of label number to label name</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the annotation to be displayed in DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code>dict[str, str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code>dict[str, str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>scale_factor</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>scale to match image DSA.</p>
            </div>
          </td>
          <td>
                <code>1</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to read functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to write functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>annotation_column</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>column containing url to BMP polygon</p>
            </div>
          </td>
          <td>
                <code>&#39;bmp_polygon_url&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_column_suffix</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>column suffix with result url to add to slide_manifest</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>annotation file path</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1449">1449</a></span>
<span class="normal"><a href="#__codelineno-0-1450">1450</a></span>
<span class="normal"><a href="#__codelineno-0-1451">1451</a></span>
<span class="normal"><a href="#__codelineno-0-1452">1452</a></span>
<span class="normal"><a href="#__codelineno-0-1453">1453</a></span>
<span class="normal"><a href="#__codelineno-0-1454">1454</a></span>
<span class="normal"><a href="#__codelineno-0-1455">1455</a></span>
<span class="normal"><a href="#__codelineno-0-1456">1456</a></span>
<span class="normal"><a href="#__codelineno-0-1457">1457</a></span>
<span class="normal"><a href="#__codelineno-0-1458">1458</a></span>
<span class="normal"><a href="#__codelineno-0-1459">1459</a></span>
<span class="normal"><a href="#__codelineno-0-1460">1460</a></span>
<span class="normal"><a href="#__codelineno-0-1461">1461</a></span>
<span class="normal"><a href="#__codelineno-0-1462">1462</a></span>
<span class="normal"><a href="#__codelineno-0-1463">1463</a></span>
<span class="normal"><a href="#__codelineno-0-1464">1464</a></span>
<span class="normal"><a href="#__codelineno-0-1465">1465</a></span>
<span class="normal"><a href="#__codelineno-0-1466">1466</a></span>
<span class="normal"><a href="#__codelineno-0-1467">1467</a></span>
<span class="normal"><a href="#__codelineno-0-1468">1468</a></span>
<span class="normal"><a href="#__codelineno-0-1469">1469</a></span>
<span class="normal"><a href="#__codelineno-0-1470">1470</a></span>
<span class="normal"><a href="#__codelineno-0-1471">1471</a></span>
<span class="normal"><a href="#__codelineno-0-1472">1472</a></span>
<span class="normal"><a href="#__codelineno-0-1473">1473</a></span>
<span class="normal"><a href="#__codelineno-0-1474">1474</a></span>
<span class="normal"><a href="#__codelineno-0-1475">1475</a></span>
<span class="normal"><a href="#__codelineno-0-1476">1476</a></span>
<span class="normal"><a href="#__codelineno-0-1477">1477</a></span>
<span class="normal"><a href="#__codelineno-0-1478">1478</a></span>
<span class="normal"><a href="#__codelineno-0-1479">1479</a></span>
<span class="normal"><a href="#__codelineno-0-1480">1480</a></span>
<span class="normal"><a href="#__codelineno-0-1481">1481</a></span>
<span class="normal"><a href="#__codelineno-0-1482">1482</a></span>
<span class="normal"><a href="#__codelineno-0-1483">1483</a></span>
<span class="normal"><a href="#__codelineno-0-1484">1484</a></span>
<span class="normal"><a href="#__codelineno-0-1485">1485</a></span>
<span class="normal"><a href="#__codelineno-0-1486">1486</a></span>
<span class="normal"><a href="#__codelineno-0-1487">1487</a></span>
<span class="normal"><a href="#__codelineno-0-1488">1488</a></span>
<span class="normal"><a href="#__codelineno-0-1489">1489</a></span>
<span class="normal"><a href="#__codelineno-0-1490">1490</a></span>
<span class="normal"><a href="#__codelineno-0-1491">1491</a></span>
<span class="normal"><a href="#__codelineno-0-1492">1492</a></span>
<span class="normal"><a href="#__codelineno-0-1493">1493</a></span>
<span class="normal"><a href="#__codelineno-0-1494">1494</a></span>
<span class="normal"><a href="#__codelineno-0-1495">1495</a></span>
<span class="normal"><a href="#__codelineno-0-1496">1496</a></span>
<span class="normal"><a href="#__codelineno-0-1497">1497</a></span>
<span class="normal"><a href="#__codelineno-0-1498">1498</a></span>
<span class="normal"><a href="#__codelineno-0-1499">1499</a></span>
<span class="normal"><a href="#__codelineno-0-1500">1500</a></span>
<span class="normal"><a href="#__codelineno-0-1501">1501</a></span>
<span class="normal"><a href="#__codelineno-0-1502">1502</a></span>
<span class="normal"><a href="#__codelineno-0-1503">1503</a></span>
<span class="normal"><a href="#__codelineno-0-1504">1504</a></span>
<span class="normal"><a href="#__codelineno-0-1505">1505</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1449" name="__codelineno-0-1449"></a><span class="k">def</span> <span class="nf">bmp_polygon</span><span class="p">(</span>
<a id="__codelineno-0-1450" name="__codelineno-0-1450"></a>    <span class="n">slide_manifest</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">SlideSchema</span><span class="p">],</span>
<a id="__codelineno-0-1451" name="__codelineno-0-1451"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1452" name="__codelineno-0-1452"></a>    <span class="n">label_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-1453" name="__codelineno-0-1453"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1454" name="__codelineno-0-1454"></a>    <span class="n">line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1455" name="__codelineno-0-1455"></a>    <span class="n">fill_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1456" name="__codelineno-0-1456"></a>    <span class="n">scale_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-1457" name="__codelineno-0-1457"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-1458" name="__codelineno-0-1458"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-1459" name="__codelineno-0-1459"></a>    <span class="n">annotation_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bmp_polygon_url&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1460" name="__codelineno-0-1460"></a>    <span class="n">output_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bmp_polygon_dsa_url&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1461" name="__codelineno-0-1461"></a><span class="p">):</span>
<a id="__codelineno-0-1462" name="__codelineno-0-1462"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build DSA annotation json from a BMP with multiple labels.</span>
<a id="__codelineno-0-1463" name="__codelineno-0-1463"></a>
<a id="__codelineno-0-1464" name="__codelineno-0-1464"></a><span class="sd">    Vectorizes and simplifies contours per label.</span>
<a id="__codelineno-0-1465" name="__codelineno-0-1465"></a>
<a id="__codelineno-0-1466" name="__codelineno-0-1466"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1467" name="__codelineno-0-1467"></a><span class="sd">        slide_manifest (DataFrame[SlideSchema]): slide manifest from slide_etl</span>
<a id="__codelineno-0-1468" name="__codelineno-0-1468"></a><span class="sd">        output_urlpath (string): url/path prefix to save the DSA compatible annotation</span>
<a id="__codelineno-0-1469" name="__codelineno-0-1469"></a><span class="sd">        json</span>
<a id="__codelineno-0-1470" name="__codelineno-0-1470"></a><span class="sd">        label_map (dict[int,str]): map of label number to label name</span>
<a id="__codelineno-0-1471" name="__codelineno-0-1471"></a><span class="sd">        annotation_name (string): name of the annotation to be displayed in DSA</span>
<a id="__codelineno-0-1472" name="__codelineno-0-1472"></a><span class="sd">        line_colors (dict[str,str], optional): line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-1473" name="__codelineno-0-1473"></a><span class="sd">        fill_colors (dict[str,str], optional): fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-1474" name="__codelineno-0-1474"></a><span class="sd">        scale_factor (int, optional): scale to match image DSA.</span>
<a id="__codelineno-0-1475" name="__codelineno-0-1475"></a><span class="sd">        storage_options (dict): storage options to pass to read functions</span>
<a id="__codelineno-0-1476" name="__codelineno-0-1476"></a><span class="sd">        output_storage_options (dict): storage options to pass to write functions</span>
<a id="__codelineno-0-1477" name="__codelineno-0-1477"></a><span class="sd">        annotation_column (string): column containing url to BMP polygon</span>
<a id="__codelineno-0-1478" name="__codelineno-0-1478"></a><span class="sd">        output_column_suffix (string): column suffix with result url to add to slide_manifest</span>
<a id="__codelineno-0-1479" name="__codelineno-0-1479"></a>
<a id="__codelineno-0-1480" name="__codelineno-0-1480"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1481" name="__codelineno-0-1481"></a><span class="sd">        dict: annotation file path</span>
<a id="__codelineno-0-1482" name="__codelineno-0-1482"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1483" name="__codelineno-0-1483"></a>    <span class="k">if</span> <span class="n">annotation_column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-1484" name="__codelineno-0-1484"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_column</span><span class="si">}</span><span class="s2"> not found in slide manifest&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1485" name="__codelineno-0-1485"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">get_or_create_dask_client</span><span class="p">()</span>
<a id="__codelineno-0-1486" name="__codelineno-0-1486"></a>    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1487" name="__codelineno-0-1487"></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-1488" name="__codelineno-0-1488"></a>        <span class="n">image_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">])</span>
<a id="__codelineno-0-1489" name="__codelineno-0-1489"></a>        <span class="n">future</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
<a id="__codelineno-0-1490" name="__codelineno-0-1490"></a>            <span class="n">__bmp_polygon</span><span class="p">,</span>
<a id="__codelineno-0-1491" name="__codelineno-0-1491"></a>            <span class="n">row</span><span class="p">[</span><span class="n">annotation_column</span><span class="p">],</span>
<a id="__codelineno-0-1492" name="__codelineno-0-1492"></a>            <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-1493" name="__codelineno-0-1493"></a>            <span class="n">image_filename</span><span class="p">,</span>
<a id="__codelineno-0-1494" name="__codelineno-0-1494"></a>            <span class="n">label_map</span><span class="p">,</span>
<a id="__codelineno-0-1495" name="__codelineno-0-1495"></a>            <span class="n">annotation_name</span><span class="p">,</span>
<a id="__codelineno-0-1496" name="__codelineno-0-1496"></a>            <span class="n">line_colors</span><span class="p">,</span>
<a id="__codelineno-0-1497" name="__codelineno-0-1497"></a>            <span class="n">fill_colors</span><span class="p">,</span>
<a id="__codelineno-0-1498" name="__codelineno-0-1498"></a>            <span class="n">scale_factor</span><span class="p">,</span>
<a id="__codelineno-0-1499" name="__codelineno-0-1499"></a>            <span class="n">storage_options</span><span class="p">,</span>
<a id="__codelineno-0-1500" name="__codelineno-0-1500"></a>            <span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-1501" name="__codelineno-0-1501"></a>        <span class="p">)</span>
<a id="__codelineno-0-1502" name="__codelineno-0-1502"></a>        <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
<a id="__codelineno-0-1503" name="__codelineno-0-1503"></a>    <span class="n">progress</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-1504" name="__codelineno-0-1504"></a>    <span class="n">dsa_annotation_urls</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-1505" name="__codelineno-0-1505"></a>    <span class="k">return</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">output_column</span><span class="p">:</span> <span class="n">dsa_annotation_urls</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.bmp_polygon_cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">bmp_polygon_cli</span><span class="p">(</span><span class="n">input_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">label_map</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">image_filename</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">annotation_name</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.dsa_viz.bmp_polygon_cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Build DSA annotation json from a BMP with multiple labels.</p>
<p>Vectorizes and simplifies contours per label.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to bmp file</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path prefix to save the DSA compatible annotation</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>label_map</code></td>
          <td>
                <code>dict[int, str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>map of label number to label name</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>image_filename</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the image file in DSA e.g. 123.svs</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the annotation to be displayed in DSA</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code>dict[str, str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code>dict[str, str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>scale_factor</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>scale to match image DSA.</p>
            </div>
          </td>
          <td>
                <code>1</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to read functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to write functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>annotation file path</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1397">1397</a></span>
<span class="normal"><a href="#__codelineno-0-1398">1398</a></span>
<span class="normal"><a href="#__codelineno-0-1399">1399</a></span>
<span class="normal"><a href="#__codelineno-0-1400">1400</a></span>
<span class="normal"><a href="#__codelineno-0-1401">1401</a></span>
<span class="normal"><a href="#__codelineno-0-1402">1402</a></span>
<span class="normal"><a href="#__codelineno-0-1403">1403</a></span>
<span class="normal"><a href="#__codelineno-0-1404">1404</a></span>
<span class="normal"><a href="#__codelineno-0-1405">1405</a></span>
<span class="normal"><a href="#__codelineno-0-1406">1406</a></span>
<span class="normal"><a href="#__codelineno-0-1407">1407</a></span>
<span class="normal"><a href="#__codelineno-0-1408">1408</a></span>
<span class="normal"><a href="#__codelineno-0-1409">1409</a></span>
<span class="normal"><a href="#__codelineno-0-1410">1410</a></span>
<span class="normal"><a href="#__codelineno-0-1411">1411</a></span>
<span class="normal"><a href="#__codelineno-0-1412">1412</a></span>
<span class="normal"><a href="#__codelineno-0-1413">1413</a></span>
<span class="normal"><a href="#__codelineno-0-1414">1414</a></span>
<span class="normal"><a href="#__codelineno-0-1415">1415</a></span>
<span class="normal"><a href="#__codelineno-0-1416">1416</a></span>
<span class="normal"><a href="#__codelineno-0-1417">1417</a></span>
<span class="normal"><a href="#__codelineno-0-1418">1418</a></span>
<span class="normal"><a href="#__codelineno-0-1419">1419</a></span>
<span class="normal"><a href="#__codelineno-0-1420">1420</a></span>
<span class="normal"><a href="#__codelineno-0-1421">1421</a></span>
<span class="normal"><a href="#__codelineno-0-1422">1422</a></span>
<span class="normal"><a href="#__codelineno-0-1423">1423</a></span>
<span class="normal"><a href="#__codelineno-0-1424">1424</a></span>
<span class="normal"><a href="#__codelineno-0-1425">1425</a></span>
<span class="normal"><a href="#__codelineno-0-1426">1426</a></span>
<span class="normal"><a href="#__codelineno-0-1427">1427</a></span>
<span class="normal"><a href="#__codelineno-0-1428">1428</a></span>
<span class="normal"><a href="#__codelineno-0-1429">1429</a></span>
<span class="normal"><a href="#__codelineno-0-1430">1430</a></span>
<span class="normal"><a href="#__codelineno-0-1431">1431</a></span>
<span class="normal"><a href="#__codelineno-0-1432">1432</a></span>
<span class="normal"><a href="#__codelineno-0-1433">1433</a></span>
<span class="normal"><a href="#__codelineno-0-1434">1434</a></span>
<span class="normal"><a href="#__codelineno-0-1435">1435</a></span>
<span class="normal"><a href="#__codelineno-0-1436">1436</a></span>
<span class="normal"><a href="#__codelineno-0-1437">1437</a></span>
<span class="normal"><a href="#__codelineno-0-1438">1438</a></span>
<span class="normal"><a href="#__codelineno-0-1439">1439</a></span>
<span class="normal"><a href="#__codelineno-0-1440">1440</a></span>
<span class="normal"><a href="#__codelineno-0-1441">1441</a></span>
<span class="normal"><a href="#__codelineno-0-1442">1442</a></span>
<span class="normal"><a href="#__codelineno-0-1443">1443</a></span>
<span class="normal"><a href="#__codelineno-0-1444">1444</a></span>
<span class="normal"><a href="#__codelineno-0-1445">1445</a></span>
<span class="normal"><a href="#__codelineno-0-1446">1446</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1397" name="__codelineno-0-1397"></a><span class="nd">@timed</span>
<a id="__codelineno-0-1398" name="__codelineno-0-1398"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-1399" name="__codelineno-0-1399"></a><span class="k">def</span> <span class="nf">bmp_polygon_cli</span><span class="p">(</span>
<a id="__codelineno-0-1400" name="__codelineno-0-1400"></a>    <span class="n">input_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1401" name="__codelineno-0-1401"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1402" name="__codelineno-0-1402"></a>    <span class="n">label_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-1403" name="__codelineno-0-1403"></a>    <span class="n">image_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1404" name="__codelineno-0-1404"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1405" name="__codelineno-0-1405"></a>    <span class="n">line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1406" name="__codelineno-0-1406"></a>    <span class="n">fill_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1407" name="__codelineno-0-1407"></a>    <span class="n">scale_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-1408" name="__codelineno-0-1408"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-1409" name="__codelineno-0-1409"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-1410" name="__codelineno-0-1410"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1411" name="__codelineno-0-1411"></a><span class="p">):</span>
<a id="__codelineno-0-1412" name="__codelineno-0-1412"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build DSA annotation json from a BMP with multiple labels.</span>
<a id="__codelineno-0-1413" name="__codelineno-0-1413"></a>
<a id="__codelineno-0-1414" name="__codelineno-0-1414"></a><span class="sd">    Vectorizes and simplifies contours per label.</span>
<a id="__codelineno-0-1415" name="__codelineno-0-1415"></a>
<a id="__codelineno-0-1416" name="__codelineno-0-1416"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1417" name="__codelineno-0-1417"></a><span class="sd">        input_urlpath (string): url/path to bmp file</span>
<a id="__codelineno-0-1418" name="__codelineno-0-1418"></a><span class="sd">        output_urlpath (string): url/path prefix to save the DSA compatible annotation</span>
<a id="__codelineno-0-1419" name="__codelineno-0-1419"></a><span class="sd">        json</span>
<a id="__codelineno-0-1420" name="__codelineno-0-1420"></a><span class="sd">        label_map (dict[int,str]): map of label number to label name</span>
<a id="__codelineno-0-1421" name="__codelineno-0-1421"></a><span class="sd">        image_filename (string): name of the image file in DSA e.g. 123.svs</span>
<a id="__codelineno-0-1422" name="__codelineno-0-1422"></a><span class="sd">        annotation_name (string): name of the annotation to be displayed in DSA</span>
<a id="__codelineno-0-1423" name="__codelineno-0-1423"></a><span class="sd">        line_colors (dict[str,str], optional): line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-1424" name="__codelineno-0-1424"></a><span class="sd">        fill_colors (dict[str,str], optional): fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-1425" name="__codelineno-0-1425"></a><span class="sd">        scale_factor (int, optional): scale to match image DSA.</span>
<a id="__codelineno-0-1426" name="__codelineno-0-1426"></a><span class="sd">        storage_options (dict): storage options to pass to read functions</span>
<a id="__codelineno-0-1427" name="__codelineno-0-1427"></a><span class="sd">        output_storage_options (dict): storage options to pass to write functions</span>
<a id="__codelineno-0-1428" name="__codelineno-0-1428"></a>
<a id="__codelineno-0-1429" name="__codelineno-0-1429"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1430" name="__codelineno-0-1430"></a><span class="sd">        dict: annotation file path</span>
<a id="__codelineno-0-1431" name="__codelineno-0-1431"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1432" name="__codelineno-0-1432"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-1433" name="__codelineno-0-1433"></a>    <span class="n">annotation_filepath</span> <span class="o">=</span> <span class="n">__bmp_polygon</span><span class="p">(</span>
<a id="__codelineno-0-1434" name="__codelineno-0-1434"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;input_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1435" name="__codelineno-0-1435"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1436" name="__codelineno-0-1436"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;image_filename&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1437" name="__codelineno-0-1437"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;label_map&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1438" name="__codelineno-0-1438"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;annotation_name&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1439" name="__codelineno-0-1439"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;line_colors&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1440" name="__codelineno-0-1440"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;fill_colors&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1441" name="__codelineno-0-1441"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;scale_factor&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1442" name="__codelineno-0-1442"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1443" name="__codelineno-0-1443"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1444" name="__codelineno-0-1444"></a>    <span class="p">)</span>
<a id="__codelineno-0-1445" name="__codelineno-0-1445"></a>
<a id="__codelineno-0-1446" name="__codelineno-0-1446"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;dsa_annotation&quot;</span><span class="p">:</span> <span class="n">annotation_filepath</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.check_filepaths_valid" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">check_filepaths_valid</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span> <span class="n">storage_options</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.dsa_viz.check_filepaths_valid" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Checks if all paths exist.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>filepaths</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>file paths</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>bool</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>True if all file paths exist, False otherwise</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span>
<span class="normal"><a href="#__codelineno-0-92">92</a></span>
<span class="normal"><a href="#__codelineno-0-93">93</a></span>
<span class="normal"><a href="#__codelineno-0-94">94</a></span>
<span class="normal"><a href="#__codelineno-0-95">95</a></span>
<span class="normal"><a href="#__codelineno-0-96">96</a></span>
<span class="normal"><a href="#__codelineno-0-97">97</a></span>
<span class="normal"><a href="#__codelineno-0-98">98</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="k">def</span> <span class="nf">check_filepaths_valid</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span> <span class="n">storage_options</span><span class="p">):</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if all paths exist.</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">        filepaths (list): file paths</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">        bool: True if all file paths exist, False otherwise</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>    <span class="n">all_files_found</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="n">fs</span><span class="p">,</span> <span class="n">urlpath</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">urlpath</span><span class="p">):</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;url in config: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>            <span class="n">all_files_found</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="k">return</span> <span class="n">all_files_found</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.get_dsa_annotation" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_dsa_annotation</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.dsa_viz.get_dsa_annotation" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Helper function to get dsa annotation</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>elements</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>list of annotation elements</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>annotation name for HistomicsUI</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>image_filename</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the image in DSA e.g. 123.svs</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>string</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>annotation file path. None if error in writing the file.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="k">def</span> <span class="nf">get_dsa_annotation</span><span class="p">(</span><span class="n">elements</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function to get dsa annotation</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">        elements (list): list of annotation elements</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">        annotation_name (string): annotation name for HistomicsUI</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">        image_filename (string): name of the image in DSA e.g. 123.svs</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">        string: annotation file path. None if error in writing the file.</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="n">dsa_annotation</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="s2">&quot;elements&quot;</span><span class="p">:</span> <span class="n">elements</span><span class="p">,</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">annotation_name</span><span class="p">,</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>    <span class="p">}</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>    <span class="n">dsa_annotation</span><span class="p">[</span><span class="s2">&quot;elements&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elements</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>    <span class="n">dsa_annotation</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">annotation_name</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>    <span class="k">return</span> <span class="n">dsa_annotation</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.heatmap" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">heatmap</span><span class="p">(</span><span class="n">slide_manifest</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_column</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.dsa_viz.heatmap" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Generate heatmap based on the tile scores</p>
<p>Creates a heatmap for the given column, using the color palette <code>viridis</code>
to set a fill value
- the color ranges from purple to yellow, for scores from 0 to 1.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_manifest</code></td>
          <td>
                <code><span title="pandera.typing.DataFrame">DataFrame</span>[<span title="luna.common.models.SlideSchema">SlideSchema</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slide manifest from slide_etl</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path prefix to save the DSA compatible annotation</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the annotation to be displayed in DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>column</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>column to visualize e.g. tile_score</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tile_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>size of tiles</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>scale_factor</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>scale to match the image on DSA.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to read functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to write functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>annotation file path. None if error in writing the file.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1246">1246</a></span>
<span class="normal"><a href="#__codelineno-0-1247">1247</a></span>
<span class="normal"><a href="#__codelineno-0-1248">1248</a></span>
<span class="normal"><a href="#__codelineno-0-1249">1249</a></span>
<span class="normal"><a href="#__codelineno-0-1250">1250</a></span>
<span class="normal"><a href="#__codelineno-0-1251">1251</a></span>
<span class="normal"><a href="#__codelineno-0-1252">1252</a></span>
<span class="normal"><a href="#__codelineno-0-1253">1253</a></span>
<span class="normal"><a href="#__codelineno-0-1254">1254</a></span>
<span class="normal"><a href="#__codelineno-0-1255">1255</a></span>
<span class="normal"><a href="#__codelineno-0-1256">1256</a></span>
<span class="normal"><a href="#__codelineno-0-1257">1257</a></span>
<span class="normal"><a href="#__codelineno-0-1258">1258</a></span>
<span class="normal"><a href="#__codelineno-0-1259">1259</a></span>
<span class="normal"><a href="#__codelineno-0-1260">1260</a></span>
<span class="normal"><a href="#__codelineno-0-1261">1261</a></span>
<span class="normal"><a href="#__codelineno-0-1262">1262</a></span>
<span class="normal"><a href="#__codelineno-0-1263">1263</a></span>
<span class="normal"><a href="#__codelineno-0-1264">1264</a></span>
<span class="normal"><a href="#__codelineno-0-1265">1265</a></span>
<span class="normal"><a href="#__codelineno-0-1266">1266</a></span>
<span class="normal"><a href="#__codelineno-0-1267">1267</a></span>
<span class="normal"><a href="#__codelineno-0-1268">1268</a></span>
<span class="normal"><a href="#__codelineno-0-1269">1269</a></span>
<span class="normal"><a href="#__codelineno-0-1270">1270</a></span>
<span class="normal"><a href="#__codelineno-0-1271">1271</a></span>
<span class="normal"><a href="#__codelineno-0-1272">1272</a></span>
<span class="normal"><a href="#__codelineno-0-1273">1273</a></span>
<span class="normal"><a href="#__codelineno-0-1274">1274</a></span>
<span class="normal"><a href="#__codelineno-0-1275">1275</a></span>
<span class="normal"><a href="#__codelineno-0-1276">1276</a></span>
<span class="normal"><a href="#__codelineno-0-1277">1277</a></span>
<span class="normal"><a href="#__codelineno-0-1278">1278</a></span>
<span class="normal"><a href="#__codelineno-0-1279">1279</a></span>
<span class="normal"><a href="#__codelineno-0-1280">1280</a></span>
<span class="normal"><a href="#__codelineno-0-1281">1281</a></span>
<span class="normal"><a href="#__codelineno-0-1282">1282</a></span>
<span class="normal"><a href="#__codelineno-0-1283">1283</a></span>
<span class="normal"><a href="#__codelineno-0-1284">1284</a></span>
<span class="normal"><a href="#__codelineno-0-1285">1285</a></span>
<span class="normal"><a href="#__codelineno-0-1286">1286</a></span>
<span class="normal"><a href="#__codelineno-0-1287">1287</a></span>
<span class="normal"><a href="#__codelineno-0-1288">1288</a></span>
<span class="normal"><a href="#__codelineno-0-1289">1289</a></span>
<span class="normal"><a href="#__codelineno-0-1290">1290</a></span>
<span class="normal"><a href="#__codelineno-0-1291">1291</a></span>
<span class="normal"><a href="#__codelineno-0-1292">1292</a></span>
<span class="normal"><a href="#__codelineno-0-1293">1293</a></span>
<span class="normal"><a href="#__codelineno-0-1294">1294</a></span>
<span class="normal"><a href="#__codelineno-0-1295">1295</a></span>
<span class="normal"><a href="#__codelineno-0-1296">1296</a></span>
<span class="normal"><a href="#__codelineno-0-1297">1297</a></span>
<span class="normal"><a href="#__codelineno-0-1298">1298</a></span>
<span class="normal"><a href="#__codelineno-0-1299">1299</a></span>
<span class="normal"><a href="#__codelineno-0-1300">1300</a></span>
<span class="normal"><a href="#__codelineno-0-1301">1301</a></span>
<span class="normal"><a href="#__codelineno-0-1302">1302</a></span>
<span class="normal"><a href="#__codelineno-0-1303">1303</a></span>
<span class="normal"><a href="#__codelineno-0-1304">1304</a></span>
<span class="normal"><a href="#__codelineno-0-1305">1305</a></span>
<span class="normal"><a href="#__codelineno-0-1306">1306</a></span>
<span class="normal"><a href="#__codelineno-0-1307">1307</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1246" name="__codelineno-0-1246"></a><span class="k">def</span> <span class="nf">heatmap</span><span class="p">(</span>
<a id="__codelineno-0-1247" name="__codelineno-0-1247"></a>    <span class="n">slide_manifest</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">SlideSchema</span><span class="p">],</span>
<a id="__codelineno-0-1248" name="__codelineno-0-1248"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1249" name="__codelineno-0-1249"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1250" name="__codelineno-0-1250"></a>    <span class="n">column</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-1251" name="__codelineno-0-1251"></a>    <span class="n">tile_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-1252" name="__codelineno-0-1252"></a>    <span class="n">scale_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1253" name="__codelineno-0-1253"></a>    <span class="n">fill_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1254" name="__codelineno-0-1254"></a>    <span class="n">line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1255" name="__codelineno-0-1255"></a>    <span class="n">output_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1256" name="__codelineno-0-1256"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-1257" name="__codelineno-0-1257"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-1258" name="__codelineno-0-1258"></a><span class="p">):</span>
<a id="__codelineno-0-1259" name="__codelineno-0-1259"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate heatmap based on the tile scores</span>
<a id="__codelineno-0-1260" name="__codelineno-0-1260"></a>
<a id="__codelineno-0-1261" name="__codelineno-0-1261"></a><span class="sd">    Creates a heatmap for the given column, using the color palette `viridis`</span>
<a id="__codelineno-0-1262" name="__codelineno-0-1262"></a><span class="sd">    to set a fill value</span>
<a id="__codelineno-0-1263" name="__codelineno-0-1263"></a><span class="sd">    - the color ranges from purple to yellow, for scores from 0 to 1.</span>
<a id="__codelineno-0-1264" name="__codelineno-0-1264"></a>
<a id="__codelineno-0-1265" name="__codelineno-0-1265"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1266" name="__codelineno-0-1266"></a><span class="sd">        slide_manifest (DataFrame[SlideSchema]): slide manifest from slide_etl</span>
<a id="__codelineno-0-1267" name="__codelineno-0-1267"></a><span class="sd">        output_urlpath (string): URL/path prefix to save the DSA compatible annotation</span>
<a id="__codelineno-0-1268" name="__codelineno-0-1268"></a><span class="sd">        json</span>
<a id="__codelineno-0-1269" name="__codelineno-0-1269"></a><span class="sd">        annotation_name (string): name of the annotation to be displayed in DSA</span>
<a id="__codelineno-0-1270" name="__codelineno-0-1270"></a><span class="sd">        column (string): column to visualize e.g. tile_score</span>
<a id="__codelineno-0-1271" name="__codelineno-0-1271"></a><span class="sd">        tile_size (int): size of tiles</span>
<a id="__codelineno-0-1272" name="__codelineno-0-1272"></a><span class="sd">        scale_factor (int, optional): scale to match the image on DSA.</span>
<a id="__codelineno-0-1273" name="__codelineno-0-1273"></a><span class="sd">        line_colors (dict, optional): line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-1274" name="__codelineno-0-1274"></a><span class="sd">        fill_colors (dict, optional): fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-1275" name="__codelineno-0-1275"></a><span class="sd">        storage_options (dict): storage options to pass to read functions</span>
<a id="__codelineno-0-1276" name="__codelineno-0-1276"></a><span class="sd">        output_storage_options (dict): storage options to pass to write functions</span>
<a id="__codelineno-0-1277" name="__codelineno-0-1277"></a>
<a id="__codelineno-0-1278" name="__codelineno-0-1278"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1279" name="__codelineno-0-1279"></a><span class="sd">        dict: annotation file path. None if error in writing the file.</span>
<a id="__codelineno-0-1280" name="__codelineno-0-1280"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1281" name="__codelineno-0-1281"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">output_column</span><span class="p">:</span>
<a id="__codelineno-0-1282" name="__codelineno-0-1282"></a>        <span class="n">output_column</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_name</span><span class="si">}</span><span class="s2">_dsa_url&quot;</span>
<a id="__codelineno-0-1283" name="__codelineno-0-1283"></a>    <span class="k">if</span> <span class="s2">&quot;tiles_url&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-1284" name="__codelineno-0-1284"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;tiles_url not found in slide manifest&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1285" name="__codelineno-0-1285"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">get_or_create_dask_client</span><span class="p">()</span>
<a id="__codelineno-0-1286" name="__codelineno-0-1286"></a>    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1287" name="__codelineno-0-1287"></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-1288" name="__codelineno-0-1288"></a>        <span class="n">image_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">])</span>
<a id="__codelineno-0-1289" name="__codelineno-0-1289"></a>        <span class="n">future</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
<a id="__codelineno-0-1290" name="__codelineno-0-1290"></a>            <span class="n">__heatmap</span><span class="p">,</span>
<a id="__codelineno-0-1291" name="__codelineno-0-1291"></a>            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;tiles_url&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1292" name="__codelineno-0-1292"></a>            <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-1293" name="__codelineno-0-1293"></a>            <span class="n">image_filename</span><span class="p">,</span>
<a id="__codelineno-0-1294" name="__codelineno-0-1294"></a>            <span class="n">annotation_name</span><span class="p">,</span>
<a id="__codelineno-0-1295" name="__codelineno-0-1295"></a>            <span class="n">column</span><span class="p">,</span>
<a id="__codelineno-0-1296" name="__codelineno-0-1296"></a>            <span class="n">tile_size</span><span class="p">,</span>
<a id="__codelineno-0-1297" name="__codelineno-0-1297"></a>            <span class="n">scale_factor</span><span class="p">,</span>
<a id="__codelineno-0-1298" name="__codelineno-0-1298"></a>            <span class="n">fill_colors</span><span class="p">,</span>
<a id="__codelineno-0-1299" name="__codelineno-0-1299"></a>            <span class="n">line_colors</span><span class="p">,</span>
<a id="__codelineno-0-1300" name="__codelineno-0-1300"></a>            <span class="n">storage_options</span><span class="p">,</span>
<a id="__codelineno-0-1301" name="__codelineno-0-1301"></a>            <span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-1302" name="__codelineno-0-1302"></a>        <span class="p">)</span>
<a id="__codelineno-0-1303" name="__codelineno-0-1303"></a>
<a id="__codelineno-0-1304" name="__codelineno-0-1304"></a>        <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
<a id="__codelineno-0-1305" name="__codelineno-0-1305"></a>    <span class="n">progress</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-1306" name="__codelineno-0-1306"></a>    <span class="n">dsa_annotation_urls</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-1307" name="__codelineno-0-1307"></a>    <span class="k">return</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">output_column</span><span class="p">:</span> <span class="n">dsa_annotation_urls</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.heatmap_cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">heatmap_cli</span><span class="p">(</span><span class="n">input_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">image_filename</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">annotation_name</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.dsa_viz.heatmap_cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Generate heatmap based on the tile scores</p>
<p>Creates a heatmap for the given column, using the color palette <code>viridis</code>
to set a fill value
- the color ranges from purple to yellow, for scores from 0 to 1.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path to parquet with tile scores</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path prefix to save the DSA compatible annotation</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>image_filename</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the image file in DSA e.g. 123.svs</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the annotation to be displayed in DSA</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>column</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>column to visualize e.g. tile_score</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>tile_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>size of tiles</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>scale_factor</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>scale to match the image on DSA.</p>
            </div>
          </td>
          <td>
                <code>1</code>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to write functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to write functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>local_config</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>local config yaml file</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>annotation file path. None if error in writing the file.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1189">1189</a></span>
<span class="normal"><a href="#__codelineno-0-1190">1190</a></span>
<span class="normal"><a href="#__codelineno-0-1191">1191</a></span>
<span class="normal"><a href="#__codelineno-0-1192">1192</a></span>
<span class="normal"><a href="#__codelineno-0-1193">1193</a></span>
<span class="normal"><a href="#__codelineno-0-1194">1194</a></span>
<span class="normal"><a href="#__codelineno-0-1195">1195</a></span>
<span class="normal"><a href="#__codelineno-0-1196">1196</a></span>
<span class="normal"><a href="#__codelineno-0-1197">1197</a></span>
<span class="normal"><a href="#__codelineno-0-1198">1198</a></span>
<span class="normal"><a href="#__codelineno-0-1199">1199</a></span>
<span class="normal"><a href="#__codelineno-0-1200">1200</a></span>
<span class="normal"><a href="#__codelineno-0-1201">1201</a></span>
<span class="normal"><a href="#__codelineno-0-1202">1202</a></span>
<span class="normal"><a href="#__codelineno-0-1203">1203</a></span>
<span class="normal"><a href="#__codelineno-0-1204">1204</a></span>
<span class="normal"><a href="#__codelineno-0-1205">1205</a></span>
<span class="normal"><a href="#__codelineno-0-1206">1206</a></span>
<span class="normal"><a href="#__codelineno-0-1207">1207</a></span>
<span class="normal"><a href="#__codelineno-0-1208">1208</a></span>
<span class="normal"><a href="#__codelineno-0-1209">1209</a></span>
<span class="normal"><a href="#__codelineno-0-1210">1210</a></span>
<span class="normal"><a href="#__codelineno-0-1211">1211</a></span>
<span class="normal"><a href="#__codelineno-0-1212">1212</a></span>
<span class="normal"><a href="#__codelineno-0-1213">1213</a></span>
<span class="normal"><a href="#__codelineno-0-1214">1214</a></span>
<span class="normal"><a href="#__codelineno-0-1215">1215</a></span>
<span class="normal"><a href="#__codelineno-0-1216">1216</a></span>
<span class="normal"><a href="#__codelineno-0-1217">1217</a></span>
<span class="normal"><a href="#__codelineno-0-1218">1218</a></span>
<span class="normal"><a href="#__codelineno-0-1219">1219</a></span>
<span class="normal"><a href="#__codelineno-0-1220">1220</a></span>
<span class="normal"><a href="#__codelineno-0-1221">1221</a></span>
<span class="normal"><a href="#__codelineno-0-1222">1222</a></span>
<span class="normal"><a href="#__codelineno-0-1223">1223</a></span>
<span class="normal"><a href="#__codelineno-0-1224">1224</a></span>
<span class="normal"><a href="#__codelineno-0-1225">1225</a></span>
<span class="normal"><a href="#__codelineno-0-1226">1226</a></span>
<span class="normal"><a href="#__codelineno-0-1227">1227</a></span>
<span class="normal"><a href="#__codelineno-0-1228">1228</a></span>
<span class="normal"><a href="#__codelineno-0-1229">1229</a></span>
<span class="normal"><a href="#__codelineno-0-1230">1230</a></span>
<span class="normal"><a href="#__codelineno-0-1231">1231</a></span>
<span class="normal"><a href="#__codelineno-0-1232">1232</a></span>
<span class="normal"><a href="#__codelineno-0-1233">1233</a></span>
<span class="normal"><a href="#__codelineno-0-1234">1234</a></span>
<span class="normal"><a href="#__codelineno-0-1235">1235</a></span>
<span class="normal"><a href="#__codelineno-0-1236">1236</a></span>
<span class="normal"><a href="#__codelineno-0-1237">1237</a></span>
<span class="normal"><a href="#__codelineno-0-1238">1238</a></span>
<span class="normal"><a href="#__codelineno-0-1239">1239</a></span>
<span class="normal"><a href="#__codelineno-0-1240">1240</a></span>
<span class="normal"><a href="#__codelineno-0-1241">1241</a></span>
<span class="normal"><a href="#__codelineno-0-1242">1242</a></span>
<span class="normal"><a href="#__codelineno-0-1243">1243</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1189" name="__codelineno-0-1189"></a><span class="nd">@timed</span>
<a id="__codelineno-0-1190" name="__codelineno-0-1190"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-1191" name="__codelineno-0-1191"></a><span class="k">def</span> <span class="nf">heatmap_cli</span><span class="p">(</span>
<a id="__codelineno-0-1192" name="__codelineno-0-1192"></a>    <span class="n">input_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1193" name="__codelineno-0-1193"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1194" name="__codelineno-0-1194"></a>    <span class="n">image_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1195" name="__codelineno-0-1195"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1196" name="__codelineno-0-1196"></a>    <span class="n">column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1197" name="__codelineno-0-1197"></a>    <span class="n">tile_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-1198" name="__codelineno-0-1198"></a>    <span class="n">scale_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-1199" name="__codelineno-0-1199"></a>    <span class="n">fill_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1200" name="__codelineno-0-1200"></a>    <span class="n">line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1201" name="__codelineno-0-1201"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-1202" name="__codelineno-0-1202"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-1203" name="__codelineno-0-1203"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1204" name="__codelineno-0-1204"></a><span class="p">):</span>
<a id="__codelineno-0-1205" name="__codelineno-0-1205"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate heatmap based on the tile scores</span>
<a id="__codelineno-0-1206" name="__codelineno-0-1206"></a>
<a id="__codelineno-0-1207" name="__codelineno-0-1207"></a><span class="sd">    Creates a heatmap for the given column, using the color palette `viridis`</span>
<a id="__codelineno-0-1208" name="__codelineno-0-1208"></a><span class="sd">    to set a fill value</span>
<a id="__codelineno-0-1209" name="__codelineno-0-1209"></a><span class="sd">    - the color ranges from purple to yellow, for scores from 0 to 1.</span>
<a id="__codelineno-0-1210" name="__codelineno-0-1210"></a>
<a id="__codelineno-0-1211" name="__codelineno-0-1211"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1212" name="__codelineno-0-1212"></a><span class="sd">        input_urlpath (string): URL/path to parquet with tile scores</span>
<a id="__codelineno-0-1213" name="__codelineno-0-1213"></a><span class="sd">        output_urlpath (string): URL/path prefix to save the DSA compatible annotation</span>
<a id="__codelineno-0-1214" name="__codelineno-0-1214"></a><span class="sd">        json</span>
<a id="__codelineno-0-1215" name="__codelineno-0-1215"></a><span class="sd">        image_filename (string): name of the image file in DSA e.g. 123.svs</span>
<a id="__codelineno-0-1216" name="__codelineno-0-1216"></a><span class="sd">        annotation_name (string): name of the annotation to be displayed in DSA</span>
<a id="__codelineno-0-1217" name="__codelineno-0-1217"></a><span class="sd">        column (string): column to visualize e.g. tile_score</span>
<a id="__codelineno-0-1218" name="__codelineno-0-1218"></a><span class="sd">        tile_size (int): size of tiles</span>
<a id="__codelineno-0-1219" name="__codelineno-0-1219"></a><span class="sd">        scale_factor (int, optional): scale to match the image on DSA.</span>
<a id="__codelineno-0-1220" name="__codelineno-0-1220"></a><span class="sd">        line_colors (dict, optional): line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-1221" name="__codelineno-0-1221"></a><span class="sd">        fill_colors (dict, optional): fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-1222" name="__codelineno-0-1222"></a><span class="sd">        storage_options (dict): storage options to pass to write functions</span>
<a id="__codelineno-0-1223" name="__codelineno-0-1223"></a><span class="sd">        output_storage_options (dict): storage options to pass to write functions</span>
<a id="__codelineno-0-1224" name="__codelineno-0-1224"></a><span class="sd">        local_config (string): local config yaml file</span>
<a id="__codelineno-0-1225" name="__codelineno-0-1225"></a>
<a id="__codelineno-0-1226" name="__codelineno-0-1226"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1227" name="__codelineno-0-1227"></a><span class="sd">        dict: annotation file path. None if error in writing the file.</span>
<a id="__codelineno-0-1228" name="__codelineno-0-1228"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1229" name="__codelineno-0-1229"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-1230" name="__codelineno-0-1230"></a>    <span class="n">annotation_filepath</span> <span class="o">=</span> <span class="n">__heatmap</span><span class="p">(</span>
<a id="__codelineno-0-1231" name="__codelineno-0-1231"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;input_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1232" name="__codelineno-0-1232"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1233" name="__codelineno-0-1233"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;image_filename&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1234" name="__codelineno-0-1234"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;annotation_name&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1235" name="__codelineno-0-1235"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;column&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1236" name="__codelineno-0-1236"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tile_size&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1237" name="__codelineno-0-1237"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;scale_factor&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1238" name="__codelineno-0-1238"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;fill_colors&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1239" name="__codelineno-0-1239"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;line_colors&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1240" name="__codelineno-0-1240"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1241" name="__codelineno-0-1241"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1242" name="__codelineno-0-1242"></a>    <span class="p">)</span>
<a id="__codelineno-0-1243" name="__codelineno-0-1243"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;dsa_annotation&quot;</span><span class="p">:</span> <span class="n">annotation_filepath</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.qupath_polygon" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">qupath_polygon</span><span class="p">(</span><span class="n">slide_manifest</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">,</span> <span class="n">classes_to_include</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">annotation_column</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">output_column</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.dsa_viz.qupath_polygon" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Build DSA annotation json from Qupath polygon geojson</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_manifest</code></td>
          <td>
                <code><span title="pandera.typing.DataFrame">DataFrame</span>[<span title="luna.common.models.SlideSchema">SlideSchema</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slide manifest from slide_etl</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path prefix for saving the DSA compatible annotation</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>image_filename</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the image file in DSA e.g. 123.svs</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the annotation to be displayed in DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>classes_to_include</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>list of classification labels to visualize</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to read functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to write functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>annotation_column</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>column containing url to qupath geojson</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_column_suffix</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>column suffix with result url to add to slide_manifest</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DataFrame[SlideSchema]: slide manifest</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-937">937</a></span>
<span class="normal"><a href="#__codelineno-0-938">938</a></span>
<span class="normal"><a href="#__codelineno-0-939">939</a></span>
<span class="normal"><a href="#__codelineno-0-940">940</a></span>
<span class="normal"><a href="#__codelineno-0-941">941</a></span>
<span class="normal"><a href="#__codelineno-0-942">942</a></span>
<span class="normal"><a href="#__codelineno-0-943">943</a></span>
<span class="normal"><a href="#__codelineno-0-944">944</a></span>
<span class="normal"><a href="#__codelineno-0-945">945</a></span>
<span class="normal"><a href="#__codelineno-0-946">946</a></span>
<span class="normal"><a href="#__codelineno-0-947">947</a></span>
<span class="normal"><a href="#__codelineno-0-948">948</a></span>
<span class="normal"><a href="#__codelineno-0-949">949</a></span>
<span class="normal"><a href="#__codelineno-0-950">950</a></span>
<span class="normal"><a href="#__codelineno-0-951">951</a></span>
<span class="normal"><a href="#__codelineno-0-952">952</a></span>
<span class="normal"><a href="#__codelineno-0-953">953</a></span>
<span class="normal"><a href="#__codelineno-0-954">954</a></span>
<span class="normal"><a href="#__codelineno-0-955">955</a></span>
<span class="normal"><a href="#__codelineno-0-956">956</a></span>
<span class="normal"><a href="#__codelineno-0-957">957</a></span>
<span class="normal"><a href="#__codelineno-0-958">958</a></span>
<span class="normal"><a href="#__codelineno-0-959">959</a></span>
<span class="normal"><a href="#__codelineno-0-960">960</a></span>
<span class="normal"><a href="#__codelineno-0-961">961</a></span>
<span class="normal"><a href="#__codelineno-0-962">962</a></span>
<span class="normal"><a href="#__codelineno-0-963">963</a></span>
<span class="normal"><a href="#__codelineno-0-964">964</a></span>
<span class="normal"><a href="#__codelineno-0-965">965</a></span>
<span class="normal"><a href="#__codelineno-0-966">966</a></span>
<span class="normal"><a href="#__codelineno-0-967">967</a></span>
<span class="normal"><a href="#__codelineno-0-968">968</a></span>
<span class="normal"><a href="#__codelineno-0-969">969</a></span>
<span class="normal"><a href="#__codelineno-0-970">970</a></span>
<span class="normal"><a href="#__codelineno-0-971">971</a></span>
<span class="normal"><a href="#__codelineno-0-972">972</a></span>
<span class="normal"><a href="#__codelineno-0-973">973</a></span>
<span class="normal"><a href="#__codelineno-0-974">974</a></span>
<span class="normal"><a href="#__codelineno-0-975">975</a></span>
<span class="normal"><a href="#__codelineno-0-976">976</a></span>
<span class="normal"><a href="#__codelineno-0-977">977</a></span>
<span class="normal"><a href="#__codelineno-0-978">978</a></span>
<span class="normal"><a href="#__codelineno-0-979">979</a></span>
<span class="normal"><a href="#__codelineno-0-980">980</a></span>
<span class="normal"><a href="#__codelineno-0-981">981</a></span>
<span class="normal"><a href="#__codelineno-0-982">982</a></span>
<span class="normal"><a href="#__codelineno-0-983">983</a></span>
<span class="normal"><a href="#__codelineno-0-984">984</a></span>
<span class="normal"><a href="#__codelineno-0-985">985</a></span>
<span class="normal"><a href="#__codelineno-0-986">986</a></span>
<span class="normal"><a href="#__codelineno-0-987">987</a></span>
<span class="normal"><a href="#__codelineno-0-988">988</a></span>
<span class="normal"><a href="#__codelineno-0-989">989</a></span>
<span class="normal"><a href="#__codelineno-0-990">990</a></span>
<span class="normal"><a href="#__codelineno-0-991">991</a></span>
<span class="normal"><a href="#__codelineno-0-992">992</a></span>
<span class="normal"><a href="#__codelineno-0-993">993</a></span>
<span class="normal"><a href="#__codelineno-0-994">994</a></span>
<span class="normal"><a href="#__codelineno-0-995">995</a></span>
<span class="normal"><a href="#__codelineno-0-996">996</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-937" name="__codelineno-0-937"></a><span class="k">def</span> <span class="nf">qupath_polygon</span><span class="p">(</span>
<a id="__codelineno-0-938" name="__codelineno-0-938"></a>    <span class="n">slide_manifest</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">SlideSchema</span><span class="p">],</span>
<a id="__codelineno-0-939" name="__codelineno-0-939"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-940" name="__codelineno-0-940"></a>    <span class="n">image_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-941" name="__codelineno-0-941"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-942" name="__codelineno-0-942"></a>    <span class="n">classes_to_include</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
<a id="__codelineno-0-943" name="__codelineno-0-943"></a>    <span class="n">line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-944" name="__codelineno-0-944"></a>    <span class="n">fill_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-945" name="__codelineno-0-945"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-946" name="__codelineno-0-946"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-947" name="__codelineno-0-947"></a>    <span class="n">annotation_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-948" name="__codelineno-0-948"></a>    <span class="n">output_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-949" name="__codelineno-0-949"></a><span class="p">):</span>
<a id="__codelineno-0-950" name="__codelineno-0-950"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build DSA annotation json from Qupath polygon geojson</span>
<a id="__codelineno-0-951" name="__codelineno-0-951"></a>
<a id="__codelineno-0-952" name="__codelineno-0-952"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-953" name="__codelineno-0-953"></a><span class="sd">        slide_manifest (DataFrame[SlideSchema]): slide manifest from slide_etl</span>
<a id="__codelineno-0-954" name="__codelineno-0-954"></a><span class="sd">        output_urlpath (string): URL/path prefix for saving the DSA compatible annotation</span>
<a id="__codelineno-0-955" name="__codelineno-0-955"></a><span class="sd">        json</span>
<a id="__codelineno-0-956" name="__codelineno-0-956"></a><span class="sd">        image_filename (string): name of the image file in DSA e.g. 123.svs</span>
<a id="__codelineno-0-957" name="__codelineno-0-957"></a><span class="sd">        annotation_name (string): name of the annotation to be displayed in DSA</span>
<a id="__codelineno-0-958" name="__codelineno-0-958"></a><span class="sd">        classes_to_include (list): list of classification labels to visualize</span>
<a id="__codelineno-0-959" name="__codelineno-0-959"></a><span class="sd">        e.g. [&quot;Tumor&quot;, &quot;Stroma&quot;, ...]</span>
<a id="__codelineno-0-960" name="__codelineno-0-960"></a><span class="sd">        line_colors (dict, optional): line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-961" name="__codelineno-0-961"></a><span class="sd">        fill_colors (dict, optional): fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-962" name="__codelineno-0-962"></a><span class="sd">        storage_options (dict): storage options to pass to read functions</span>
<a id="__codelineno-0-963" name="__codelineno-0-963"></a><span class="sd">        output_storage_options (dict): storage options to pass to write functions</span>
<a id="__codelineno-0-964" name="__codelineno-0-964"></a><span class="sd">        annotation_column (string): column containing url to qupath geojson</span>
<a id="__codelineno-0-965" name="__codelineno-0-965"></a><span class="sd">        output_column_suffix (string): column suffix with result url to add to slide_manifest</span>
<a id="__codelineno-0-966" name="__codelineno-0-966"></a>
<a id="__codelineno-0-967" name="__codelineno-0-967"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-968" name="__codelineno-0-968"></a><span class="sd">        DataFrame[SlideSchema]: slide manifest</span>
<a id="__codelineno-0-969" name="__codelineno-0-969"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-970" name="__codelineno-0-970"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">annotation_column</span><span class="p">:</span>
<a id="__codelineno-0-971" name="__codelineno-0-971"></a>        <span class="n">annotation_column</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_name</span><span class="si">}</span><span class="s2">_geojson_url&quot;</span>
<a id="__codelineno-0-972" name="__codelineno-0-972"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">output_column</span><span class="p">:</span>
<a id="__codelineno-0-973" name="__codelineno-0-973"></a>        <span class="n">output_column</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_name</span><span class="si">}</span><span class="s2">_dsa_url&quot;</span>
<a id="__codelineno-0-974" name="__codelineno-0-974"></a>    <span class="k">if</span> <span class="n">annotation_column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-975" name="__codelineno-0-975"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_column</span><span class="si">}</span><span class="s2"> not found in slide manifest&quot;</span><span class="p">)</span>
<a id="__codelineno-0-976" name="__codelineno-0-976"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">get_or_create_dask_client</span><span class="p">()</span>
<a id="__codelineno-0-977" name="__codelineno-0-977"></a>    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-978" name="__codelineno-0-978"></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-979" name="__codelineno-0-979"></a>        <span class="n">image_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">])</span>
<a id="__codelineno-0-980" name="__codelineno-0-980"></a>        <span class="n">future</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
<a id="__codelineno-0-981" name="__codelineno-0-981"></a>            <span class="n">__qupath_polygon</span><span class="p">,</span>
<a id="__codelineno-0-982" name="__codelineno-0-982"></a>            <span class="n">row</span><span class="p">[</span><span class="n">annotation_column</span><span class="p">],</span>
<a id="__codelineno-0-983" name="__codelineno-0-983"></a>            <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-984" name="__codelineno-0-984"></a>            <span class="n">image_filename</span><span class="p">,</span>
<a id="__codelineno-0-985" name="__codelineno-0-985"></a>            <span class="n">annotation_name</span><span class="p">,</span>
<a id="__codelineno-0-986" name="__codelineno-0-986"></a>            <span class="n">classes_to_include</span><span class="p">,</span>
<a id="__codelineno-0-987" name="__codelineno-0-987"></a>            <span class="n">line_colors</span><span class="p">,</span>
<a id="__codelineno-0-988" name="__codelineno-0-988"></a>            <span class="n">fill_colors</span><span class="p">,</span>
<a id="__codelineno-0-989" name="__codelineno-0-989"></a>            <span class="n">storage_options</span><span class="p">,</span>
<a id="__codelineno-0-990" name="__codelineno-0-990"></a>            <span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-991" name="__codelineno-0-991"></a>        <span class="p">)</span>
<a id="__codelineno-0-992" name="__codelineno-0-992"></a>
<a id="__codelineno-0-993" name="__codelineno-0-993"></a>        <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
<a id="__codelineno-0-994" name="__codelineno-0-994"></a>    <span class="n">progress</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-995" name="__codelineno-0-995"></a>    <span class="n">dsa_annotation_urls</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-996" name="__codelineno-0-996"></a>    <span class="k">return</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">output_column</span><span class="p">:</span> <span class="n">dsa_annotation_urls</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.qupath_polygon_cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">qupath_polygon_cli</span><span class="p">(</span><span class="n">input_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">image_filename</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">annotation_name</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">classes_to_include</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.dsa_viz.qupath_polygon_cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Build DSA annotation json from Qupath polygon geojson</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path of Qupath polygon geojson</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path prefix for saving the DSA compatible annotation</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>image_filename</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the image file in DSA e.g. 123.svs</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the annotation to be displayed in DSA</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>classes_to_include</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>list of classification labels to visualize</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to read functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to write functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>local_config</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>local config yaml file</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>annotation file path</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-888">888</a></span>
<span class="normal"><a href="#__codelineno-0-889">889</a></span>
<span class="normal"><a href="#__codelineno-0-890">890</a></span>
<span class="normal"><a href="#__codelineno-0-891">891</a></span>
<span class="normal"><a href="#__codelineno-0-892">892</a></span>
<span class="normal"><a href="#__codelineno-0-893">893</a></span>
<span class="normal"><a href="#__codelineno-0-894">894</a></span>
<span class="normal"><a href="#__codelineno-0-895">895</a></span>
<span class="normal"><a href="#__codelineno-0-896">896</a></span>
<span class="normal"><a href="#__codelineno-0-897">897</a></span>
<span class="normal"><a href="#__codelineno-0-898">898</a></span>
<span class="normal"><a href="#__codelineno-0-899">899</a></span>
<span class="normal"><a href="#__codelineno-0-900">900</a></span>
<span class="normal"><a href="#__codelineno-0-901">901</a></span>
<span class="normal"><a href="#__codelineno-0-902">902</a></span>
<span class="normal"><a href="#__codelineno-0-903">903</a></span>
<span class="normal"><a href="#__codelineno-0-904">904</a></span>
<span class="normal"><a href="#__codelineno-0-905">905</a></span>
<span class="normal"><a href="#__codelineno-0-906">906</a></span>
<span class="normal"><a href="#__codelineno-0-907">907</a></span>
<span class="normal"><a href="#__codelineno-0-908">908</a></span>
<span class="normal"><a href="#__codelineno-0-909">909</a></span>
<span class="normal"><a href="#__codelineno-0-910">910</a></span>
<span class="normal"><a href="#__codelineno-0-911">911</a></span>
<span class="normal"><a href="#__codelineno-0-912">912</a></span>
<span class="normal"><a href="#__codelineno-0-913">913</a></span>
<span class="normal"><a href="#__codelineno-0-914">914</a></span>
<span class="normal"><a href="#__codelineno-0-915">915</a></span>
<span class="normal"><a href="#__codelineno-0-916">916</a></span>
<span class="normal"><a href="#__codelineno-0-917">917</a></span>
<span class="normal"><a href="#__codelineno-0-918">918</a></span>
<span class="normal"><a href="#__codelineno-0-919">919</a></span>
<span class="normal"><a href="#__codelineno-0-920">920</a></span>
<span class="normal"><a href="#__codelineno-0-921">921</a></span>
<span class="normal"><a href="#__codelineno-0-922">922</a></span>
<span class="normal"><a href="#__codelineno-0-923">923</a></span>
<span class="normal"><a href="#__codelineno-0-924">924</a></span>
<span class="normal"><a href="#__codelineno-0-925">925</a></span>
<span class="normal"><a href="#__codelineno-0-926">926</a></span>
<span class="normal"><a href="#__codelineno-0-927">927</a></span>
<span class="normal"><a href="#__codelineno-0-928">928</a></span>
<span class="normal"><a href="#__codelineno-0-929">929</a></span>
<span class="normal"><a href="#__codelineno-0-930">930</a></span>
<span class="normal"><a href="#__codelineno-0-931">931</a></span>
<span class="normal"><a href="#__codelineno-0-932">932</a></span>
<span class="normal"><a href="#__codelineno-0-933">933</a></span>
<span class="normal"><a href="#__codelineno-0-934">934</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-888" name="__codelineno-0-888"></a><span class="nd">@timed</span>
<a id="__codelineno-0-889" name="__codelineno-0-889"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-890" name="__codelineno-0-890"></a><span class="k">def</span> <span class="nf">qupath_polygon_cli</span><span class="p">(</span>
<a id="__codelineno-0-891" name="__codelineno-0-891"></a>    <span class="n">input_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-892" name="__codelineno-0-892"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-893" name="__codelineno-0-893"></a>    <span class="n">image_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-894" name="__codelineno-0-894"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-895" name="__codelineno-0-895"></a>    <span class="n">classes_to_include</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-896" name="__codelineno-0-896"></a>    <span class="n">line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-897" name="__codelineno-0-897"></a>    <span class="n">fill_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-898" name="__codelineno-0-898"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-899" name="__codelineno-0-899"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-900" name="__codelineno-0-900"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-901" name="__codelineno-0-901"></a><span class="p">):</span>
<a id="__codelineno-0-902" name="__codelineno-0-902"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build DSA annotation json from Qupath polygon geojson</span>
<a id="__codelineno-0-903" name="__codelineno-0-903"></a>
<a id="__codelineno-0-904" name="__codelineno-0-904"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-905" name="__codelineno-0-905"></a><span class="sd">        input_urlpath (string): URL/path of Qupath polygon geojson</span>
<a id="__codelineno-0-906" name="__codelineno-0-906"></a><span class="sd">        output_urlpath (string): URL/path prefix for saving the DSA compatible annotation</span>
<a id="__codelineno-0-907" name="__codelineno-0-907"></a><span class="sd">        json</span>
<a id="__codelineno-0-908" name="__codelineno-0-908"></a><span class="sd">        image_filename (string): name of the image file in DSA e.g. 123.svs</span>
<a id="__codelineno-0-909" name="__codelineno-0-909"></a><span class="sd">        annotation_name (string): name of the annotation to be displayed in DSA</span>
<a id="__codelineno-0-910" name="__codelineno-0-910"></a><span class="sd">        classes_to_include (list): list of classification labels to visualize</span>
<a id="__codelineno-0-911" name="__codelineno-0-911"></a><span class="sd">        e.g. [&quot;Tumor&quot;, &quot;Stroma&quot;, ...]</span>
<a id="__codelineno-0-912" name="__codelineno-0-912"></a><span class="sd">        line_colors (dict, optional): line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-913" name="__codelineno-0-913"></a><span class="sd">        fill_colors (dict, optional): fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-914" name="__codelineno-0-914"></a><span class="sd">        storage_options (dict): storage options to pass to read functions</span>
<a id="__codelineno-0-915" name="__codelineno-0-915"></a><span class="sd">        output_storage_options (dict): storage options to pass to write functions</span>
<a id="__codelineno-0-916" name="__codelineno-0-916"></a><span class="sd">        local_config (string): local config yaml file</span>
<a id="__codelineno-0-917" name="__codelineno-0-917"></a>
<a id="__codelineno-0-918" name="__codelineno-0-918"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-919" name="__codelineno-0-919"></a><span class="sd">        dict: annotation file path</span>
<a id="__codelineno-0-920" name="__codelineno-0-920"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-921" name="__codelineno-0-921"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-922" name="__codelineno-0-922"></a>    <span class="n">annotation_filepath</span> <span class="o">=</span> <span class="n">__qupath_polygon</span><span class="p">(</span>
<a id="__codelineno-0-923" name="__codelineno-0-923"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;input_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-924" name="__codelineno-0-924"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-925" name="__codelineno-0-925"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;image_filename&quot;</span><span class="p">],</span>
<a id="__codelineno-0-926" name="__codelineno-0-926"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;annotation_name&quot;</span><span class="p">],</span>
<a id="__codelineno-0-927" name="__codelineno-0-927"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;classes_to_include&quot;</span><span class="p">],</span>
<a id="__codelineno-0-928" name="__codelineno-0-928"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;line_colors&quot;</span><span class="p">],</span>
<a id="__codelineno-0-929" name="__codelineno-0-929"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;fill_colors&quot;</span><span class="p">],</span>
<a id="__codelineno-0-930" name="__codelineno-0-930"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-931" name="__codelineno-0-931"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-932" name="__codelineno-0-932"></a>    <span class="p">)</span>
<a id="__codelineno-0-933" name="__codelineno-0-933"></a>
<a id="__codelineno-0-934" name="__codelineno-0-934"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;dsa_annotation&quot;</span><span class="p">:</span> <span class="n">annotation_filepath</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.regional_polygon" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">regional_polygon</span><span class="p">(</span><span class="n">slide_manifest</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">annotation_column</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">output_column</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.dsa_viz.regional_polygon" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Build DSA annotation json from regional annotation geojson</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_manifest</code></td>
          <td>
                <code><span title="pandera.typing.DataFrame">DataFrame</span>[<span title="luna.common.models.SlideSchema">SlideSchema</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slide manifest</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path prefix for saving dsa annotation json</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the annotation to be displayed in DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to read functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to write functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>annotation_column</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>column containing url to regional geojson</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_column_suffix</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>column suffix with result url to add to slide_manifest</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DataFrame[SlideSchema]: slide schema</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-775">775</a></span>
<span class="normal"><a href="#__codelineno-0-776">776</a></span>
<span class="normal"><a href="#__codelineno-0-777">777</a></span>
<span class="normal"><a href="#__codelineno-0-778">778</a></span>
<span class="normal"><a href="#__codelineno-0-779">779</a></span>
<span class="normal"><a href="#__codelineno-0-780">780</a></span>
<span class="normal"><a href="#__codelineno-0-781">781</a></span>
<span class="normal"><a href="#__codelineno-0-782">782</a></span>
<span class="normal"><a href="#__codelineno-0-783">783</a></span>
<span class="normal"><a href="#__codelineno-0-784">784</a></span>
<span class="normal"><a href="#__codelineno-0-785">785</a></span>
<span class="normal"><a href="#__codelineno-0-786">786</a></span>
<span class="normal"><a href="#__codelineno-0-787">787</a></span>
<span class="normal"><a href="#__codelineno-0-788">788</a></span>
<span class="normal"><a href="#__codelineno-0-789">789</a></span>
<span class="normal"><a href="#__codelineno-0-790">790</a></span>
<span class="normal"><a href="#__codelineno-0-791">791</a></span>
<span class="normal"><a href="#__codelineno-0-792">792</a></span>
<span class="normal"><a href="#__codelineno-0-793">793</a></span>
<span class="normal"><a href="#__codelineno-0-794">794</a></span>
<span class="normal"><a href="#__codelineno-0-795">795</a></span>
<span class="normal"><a href="#__codelineno-0-796">796</a></span>
<span class="normal"><a href="#__codelineno-0-797">797</a></span>
<span class="normal"><a href="#__codelineno-0-798">798</a></span>
<span class="normal"><a href="#__codelineno-0-799">799</a></span>
<span class="normal"><a href="#__codelineno-0-800">800</a></span>
<span class="normal"><a href="#__codelineno-0-801">801</a></span>
<span class="normal"><a href="#__codelineno-0-802">802</a></span>
<span class="normal"><a href="#__codelineno-0-803">803</a></span>
<span class="normal"><a href="#__codelineno-0-804">804</a></span>
<span class="normal"><a href="#__codelineno-0-805">805</a></span>
<span class="normal"><a href="#__codelineno-0-806">806</a></span>
<span class="normal"><a href="#__codelineno-0-807">807</a></span>
<span class="normal"><a href="#__codelineno-0-808">808</a></span>
<span class="normal"><a href="#__codelineno-0-809">809</a></span>
<span class="normal"><a href="#__codelineno-0-810">810</a></span>
<span class="normal"><a href="#__codelineno-0-811">811</a></span>
<span class="normal"><a href="#__codelineno-0-812">812</a></span>
<span class="normal"><a href="#__codelineno-0-813">813</a></span>
<span class="normal"><a href="#__codelineno-0-814">814</a></span>
<span class="normal"><a href="#__codelineno-0-815">815</a></span>
<span class="normal"><a href="#__codelineno-0-816">816</a></span>
<span class="normal"><a href="#__codelineno-0-817">817</a></span>
<span class="normal"><a href="#__codelineno-0-818">818</a></span>
<span class="normal"><a href="#__codelineno-0-819">819</a></span>
<span class="normal"><a href="#__codelineno-0-820">820</a></span>
<span class="normal"><a href="#__codelineno-0-821">821</a></span>
<span class="normal"><a href="#__codelineno-0-822">822</a></span>
<span class="normal"><a href="#__codelineno-0-823">823</a></span>
<span class="normal"><a href="#__codelineno-0-824">824</a></span>
<span class="normal"><a href="#__codelineno-0-825">825</a></span>
<span class="normal"><a href="#__codelineno-0-826">826</a></span>
<span class="normal"><a href="#__codelineno-0-827">827</a></span>
<span class="normal"><a href="#__codelineno-0-828">828</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-775" name="__codelineno-0-775"></a><span class="k">def</span> <span class="nf">regional_polygon</span><span class="p">(</span>
<a id="__codelineno-0-776" name="__codelineno-0-776"></a>    <span class="n">slide_manifest</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">SlideSchema</span><span class="p">],</span>
<a id="__codelineno-0-777" name="__codelineno-0-777"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-778" name="__codelineno-0-778"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a>    <span class="n">line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a>    <span class="n">fill_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a>    <span class="n">annotation_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-784" name="__codelineno-0-784"></a>    <span class="n">output_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-785" name="__codelineno-0-785"></a><span class="p">):</span>
<a id="__codelineno-0-786" name="__codelineno-0-786"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build DSA annotation json from regional annotation geojson</span>
<a id="__codelineno-0-787" name="__codelineno-0-787"></a>
<a id="__codelineno-0-788" name="__codelineno-0-788"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-789" name="__codelineno-0-789"></a><span class="sd">        slide_manifest (DataFrame[SlideSchema]): slide manifest</span>
<a id="__codelineno-0-790" name="__codelineno-0-790"></a><span class="sd">        output_urlpath (string): URL/path prefix for saving dsa annotation json</span>
<a id="__codelineno-0-791" name="__codelineno-0-791"></a><span class="sd">        annotation_name (string): name of the annotation to be displayed in DSA</span>
<a id="__codelineno-0-792" name="__codelineno-0-792"></a><span class="sd">        line_colors (dict, optional): line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-793" name="__codelineno-0-793"></a><span class="sd">        fill_colors (dict, optional): fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-794" name="__codelineno-0-794"></a><span class="sd">        storage_options (dict): storage options to pass to read functions</span>
<a id="__codelineno-0-795" name="__codelineno-0-795"></a><span class="sd">        output_storage_options (dict): storage options to pass to write functions</span>
<a id="__codelineno-0-796" name="__codelineno-0-796"></a><span class="sd">        annotation_column (string): column containing url to regional geojson</span>
<a id="__codelineno-0-797" name="__codelineno-0-797"></a><span class="sd">        output_column_suffix (string): column suffix with result url to add to slide_manifest</span>
<a id="__codelineno-0-798" name="__codelineno-0-798"></a>
<a id="__codelineno-0-799" name="__codelineno-0-799"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-800" name="__codelineno-0-800"></a><span class="sd">        DataFrame[SlideSchema]: slide schema</span>
<a id="__codelineno-0-801" name="__codelineno-0-801"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-802" name="__codelineno-0-802"></a>
<a id="__codelineno-0-803" name="__codelineno-0-803"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">annotation_column</span><span class="p">:</span>
<a id="__codelineno-0-804" name="__codelineno-0-804"></a>        <span class="n">annotation_column</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_name</span><span class="si">}</span><span class="s2">_geojson_url&quot;</span>
<a id="__codelineno-0-805" name="__codelineno-0-805"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">output_column</span><span class="p">:</span>
<a id="__codelineno-0-806" name="__codelineno-0-806"></a>        <span class="n">output_column</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_name</span><span class="si">}</span><span class="s2">_dsa_url&quot;</span>
<a id="__codelineno-0-807" name="__codelineno-0-807"></a>    <span class="k">if</span> <span class="n">annotation_column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-808" name="__codelineno-0-808"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_column</span><span class="si">}</span><span class="s2"> not found in slide manifest&quot;</span><span class="p">)</span>
<a id="__codelineno-0-809" name="__codelineno-0-809"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">get_or_create_dask_client</span><span class="p">()</span>
<a id="__codelineno-0-810" name="__codelineno-0-810"></a>    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-811" name="__codelineno-0-811"></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-812" name="__codelineno-0-812"></a>        <span class="n">image_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">])</span>
<a id="__codelineno-0-813" name="__codelineno-0-813"></a>        <span class="n">future</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
<a id="__codelineno-0-814" name="__codelineno-0-814"></a>            <span class="n">__regional_polygon</span><span class="p">,</span>
<a id="__codelineno-0-815" name="__codelineno-0-815"></a>            <span class="n">row</span><span class="p">[</span><span class="n">annotation_column</span><span class="p">],</span>
<a id="__codelineno-0-816" name="__codelineno-0-816"></a>            <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-817" name="__codelineno-0-817"></a>            <span class="n">image_filename</span><span class="p">,</span>
<a id="__codelineno-0-818" name="__codelineno-0-818"></a>            <span class="n">annotation_name</span><span class="p">,</span>
<a id="__codelineno-0-819" name="__codelineno-0-819"></a>            <span class="n">fill_colors</span><span class="p">,</span>
<a id="__codelineno-0-820" name="__codelineno-0-820"></a>            <span class="n">line_colors</span><span class="p">,</span>
<a id="__codelineno-0-821" name="__codelineno-0-821"></a>            <span class="n">storage_options</span><span class="p">,</span>
<a id="__codelineno-0-822" name="__codelineno-0-822"></a>            <span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-823" name="__codelineno-0-823"></a>        <span class="p">)</span>
<a id="__codelineno-0-824" name="__codelineno-0-824"></a>
<a id="__codelineno-0-825" name="__codelineno-0-825"></a>        <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
<a id="__codelineno-0-826" name="__codelineno-0-826"></a>    <span class="n">progress</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-827" name="__codelineno-0-827"></a>    <span class="n">dsa_annotation_urls</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-828" name="__codelineno-0-828"></a>    <span class="k">return</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">output_column</span><span class="p">:</span> <span class="n">dsa_annotation_urls</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.regional_polygon_cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">regional_polygon_cli</span><span class="p">(</span><span class="n">input_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">image_filename</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">annotation_name</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.dsa_viz.regional_polygon_cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Build DSA annotation json from regional annotation geojson</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path of to regional annotation geojson</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path prefix for saving dsa annotation json</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the annotation to be displayed in DSA</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to read functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to write functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>local_config</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>local config yaml file</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>annotation file path</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-730">730</a></span>
<span class="normal"><a href="#__codelineno-0-731">731</a></span>
<span class="normal"><a href="#__codelineno-0-732">732</a></span>
<span class="normal"><a href="#__codelineno-0-733">733</a></span>
<span class="normal"><a href="#__codelineno-0-734">734</a></span>
<span class="normal"><a href="#__codelineno-0-735">735</a></span>
<span class="normal"><a href="#__codelineno-0-736">736</a></span>
<span class="normal"><a href="#__codelineno-0-737">737</a></span>
<span class="normal"><a href="#__codelineno-0-738">738</a></span>
<span class="normal"><a href="#__codelineno-0-739">739</a></span>
<span class="normal"><a href="#__codelineno-0-740">740</a></span>
<span class="normal"><a href="#__codelineno-0-741">741</a></span>
<span class="normal"><a href="#__codelineno-0-742">742</a></span>
<span class="normal"><a href="#__codelineno-0-743">743</a></span>
<span class="normal"><a href="#__codelineno-0-744">744</a></span>
<span class="normal"><a href="#__codelineno-0-745">745</a></span>
<span class="normal"><a href="#__codelineno-0-746">746</a></span>
<span class="normal"><a href="#__codelineno-0-747">747</a></span>
<span class="normal"><a href="#__codelineno-0-748">748</a></span>
<span class="normal"><a href="#__codelineno-0-749">749</a></span>
<span class="normal"><a href="#__codelineno-0-750">750</a></span>
<span class="normal"><a href="#__codelineno-0-751">751</a></span>
<span class="normal"><a href="#__codelineno-0-752">752</a></span>
<span class="normal"><a href="#__codelineno-0-753">753</a></span>
<span class="normal"><a href="#__codelineno-0-754">754</a></span>
<span class="normal"><a href="#__codelineno-0-755">755</a></span>
<span class="normal"><a href="#__codelineno-0-756">756</a></span>
<span class="normal"><a href="#__codelineno-0-757">757</a></span>
<span class="normal"><a href="#__codelineno-0-758">758</a></span>
<span class="normal"><a href="#__codelineno-0-759">759</a></span>
<span class="normal"><a href="#__codelineno-0-760">760</a></span>
<span class="normal"><a href="#__codelineno-0-761">761</a></span>
<span class="normal"><a href="#__codelineno-0-762">762</a></span>
<span class="normal"><a href="#__codelineno-0-763">763</a></span>
<span class="normal"><a href="#__codelineno-0-764">764</a></span>
<span class="normal"><a href="#__codelineno-0-765">765</a></span>
<span class="normal"><a href="#__codelineno-0-766">766</a></span>
<span class="normal"><a href="#__codelineno-0-767">767</a></span>
<span class="normal"><a href="#__codelineno-0-768">768</a></span>
<span class="normal"><a href="#__codelineno-0-769">769</a></span>
<span class="normal"><a href="#__codelineno-0-770">770</a></span>
<span class="normal"><a href="#__codelineno-0-771">771</a></span>
<span class="normal"><a href="#__codelineno-0-772">772</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-730" name="__codelineno-0-730"></a><span class="nd">@timed</span>
<a id="__codelineno-0-731" name="__codelineno-0-731"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a><span class="k">def</span> <span class="nf">regional_polygon_cli</span><span class="p">(</span>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a>    <span class="n">input_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a>    <span class="n">image_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a>    <span class="n">line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a>    <span class="n">fill_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a><span class="p">):</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build DSA annotation json from regional annotation geojson</span>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a><span class="sd">        input_urlpath (string): URL/path of to regional annotation geojson</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a><span class="sd">        output_urlpath (string): URL/path prefix for saving dsa annotation json</span>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a><span class="sd">        annotation_name (string): name of the annotation to be displayed in DSA</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a><span class="sd">        line_colors (dict, optional): line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a><span class="sd">        fill_colors (dict, optional): fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a><span class="sd">        storage_options (dict): storage options to pass to read functions</span>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a><span class="sd">        output_storage_options (dict): storage options to pass to write functions</span>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a><span class="sd">        local_config (string): local config yaml file</span>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-756" name="__codelineno-0-756"></a><span class="sd">        dict: annotation file path</span>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a>    <span class="n">annotation_filepath</span> <span class="o">=</span> <span class="n">__regional_polygon</span><span class="p">(</span>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;input_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;image_filename&quot;</span><span class="p">],</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;annotation_name&quot;</span><span class="p">],</span>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;line_colors&quot;</span><span class="p">],</span>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;fill_colors&quot;</span><span class="p">],</span>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a>    <span class="p">)</span>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;dsa_annotation&quot;</span><span class="p">:</span> <span class="n">annotation_filepath</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.save_dsa_annotation" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">save_dsa_annotation</span><span class="p">(</span><span class="n">dsa_annotation</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.dsa_viz.save_dsa_annotation" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Helper function to save annotation elements to a json file.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>dsa_annotation</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA annotations</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to a directory to save the annotation file</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>image_filename</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the image in DSA e.g. 123.svs</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>options for storage functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>string</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>annotation file path. None if error in writing the file.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="k">def</span> <span class="nf">save_dsa_annotation</span><span class="p">(</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="n">dsa_annotation</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="n">image_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="p">):</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function to save annotation elements to a json file.</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">        dsa_annotation (dict): DSA annotations</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">        output_urlpath (string): url/path to a directory to save the annotation file</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">        image_filename (string): name of the image in DSA e.g. 123.svs</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">        storage_options (dict): options for storage functions</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="sd">        string: annotation file path. None if error in writing the file.</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">image_id_regex</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">)</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="n">image_id</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="k">raise</span> <span class="n">InvalidImageIdException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid image filename: </span><span class="si">{</span><span class="n">image_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="n">annotation_name_replaced</span> <span class="o">=</span> <span class="n">dsa_annotation</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>    <span class="n">fs</span><span class="p">,</span> <span class="n">output_urlpath_prefix</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span><span class="n">output_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="n">output_path</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="n">Path</span><span class="p">(</span><span class="n">output_urlpath_prefix</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_name_replaced</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2">.json&quot;</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>    <span class="p">)</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_urlpath_prefix</span><span class="p">):</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="n">fs</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_urlpath_prefix</span><span class="p">)</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>    <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dsa_annotation</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>        <span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dsa_annotation</span><span class="p">[</span><span class="s1">&#39;elements&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">fs</span><span class="o">.</span><span class="n">unstrip_protocol</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>    <span class="p">)</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>    <span class="k">return</span> <span class="n">fs</span><span class="o">.</span><span class="n">unstrip_protocol</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.stardist_cell" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">stardist_cell</span><span class="p">(</span><span class="n">slide_manifest</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">annotation_column</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">output_column</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.dsa_viz.stardist_cell" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Build DSA annotation json from TSV classification data generated by
stardist</p>
<p>Processes a cell classification data generated by Qupath/stardist and
adds the center coordinates of the cells
as annotation elements.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path to TSV classification data generated by stardist</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path prefix for saving dsa annotation json</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the annotation to be displayed in DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to read functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to write functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>annotation_column</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>column containing url to stardist polygon geojson</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_column_suffix</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>column suffix with result url to add to slide_manifest</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DataFrame[SlideSchema]: slide manifest</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-587" name="__codelineno-0-587"></a><span class="k">def</span> <span class="nf">stardist_cell</span><span class="p">(</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>    <span class="n">slide_manifest</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">SlideSchema</span><span class="p">],</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a>    <span class="n">line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a>    <span class="n">fill_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>    <span class="n">annotation_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>    <span class="n">output_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a><span class="p">):</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build DSA annotation json from TSV classification data generated by</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a><span class="sd">    stardist</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a><span class="sd">    Processes a cell classification data generated by Qupath/stardist and</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a><span class="sd">    adds the center coordinates of the cells</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a><span class="sd">    as annotation elements.</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a><span class="sd">        input_urlpath (string): URL/path to TSV classification data generated by stardist</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a><span class="sd">        output_urlpath (string): URL/path prefix for saving dsa annotation json</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a><span class="sd">        annotation_name (string): name of the annotation to be displayed in DSA</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a><span class="sd">        line_colors (dict, optional): line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a><span class="sd">        fill_colors (dict, optional): fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a><span class="sd">        storage_options (dict): storage options to pass to read functions</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a><span class="sd">        output_storage_options (dict): storage options to pass to write functions</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a><span class="sd">        annotation_column (string): column containing url to stardist polygon geojson</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a><span class="sd">        output_column_suffix (string): column suffix with result url to add to slide_manifest</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a><span class="sd">        DataFrame[SlideSchema]: slide manifest</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">annotation_column</span><span class="p">:</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>        <span class="n">annotation_column</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_name</span><span class="si">}</span><span class="s2">_tsv_url&quot;</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">output_column</span><span class="p">:</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>        <span class="n">output_column</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_name</span><span class="si">}</span><span class="s2">_dsa_url&quot;</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>    <span class="k">if</span> <span class="n">annotation_column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_column</span><span class="si">}</span><span class="s2"> not found in slide manifest&quot;</span><span class="p">)</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">get_or_create_dask_client</span><span class="p">()</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>        <span class="n">image_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">])</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>        <span class="n">future</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a>            <span class="n">__stardist_cell</span><span class="p">,</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a>            <span class="n">row</span><span class="p">[</span><span class="n">annotation_column</span><span class="p">],</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a>            <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a>            <span class="n">image_filename</span><span class="p">,</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a>            <span class="n">annotation_name</span><span class="p">,</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a>            <span class="n">line_colors</span><span class="p">,</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a>            <span class="n">fill_colors</span><span class="p">,</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a>            <span class="n">storage_options</span><span class="p">,</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a>            <span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a>        <span class="p">)</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>        <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a>    <span class="n">progress</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a>    <span class="n">dsa_annotation_urls</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a>    <span class="k">return</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">output_column</span><span class="p">:</span> <span class="n">dsa_annotation_urls</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.stardist_cell_cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">stardist_cell_cli</span><span class="p">(</span><span class="n">input_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">image_filename</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">annotation_name</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.dsa_viz.stardist_cell_cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Build DSA annotation json from TSV classification data generated by
stardist</p>
<p>Processes a cell classification data generated by Qupath/stardist and
adds the center coordinates of the cells
as annotation elements.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path to TSV classification data generated by stardist</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path prefix for saving dsa annotation json</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>image_filename</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the image file in DSA e.g. 123.svs</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the annotation to be displayed in DSA</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to read functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to write functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>local_config</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>local config YAML file</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>dict[str,str]: annotation file path</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-539" name="__codelineno-0-539"></a><span class="nd">@timed</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a><span class="k">def</span> <span class="nf">stardist_cell_cli</span><span class="p">(</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>    <span class="n">input_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>    <span class="n">image_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>    <span class="n">line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>    <span class="n">fill_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a><span class="p">):</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build DSA annotation json from TSV classification data generated by</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a><span class="sd">    stardist</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a><span class="sd">    Processes a cell classification data generated by Qupath/stardist and</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a><span class="sd">    adds the center coordinates of the cells</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a><span class="sd">    as annotation elements.</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a><span class="sd">        input_urlpath (string): URL/path to TSV classification data generated by stardist</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a><span class="sd">        output_urlpath (string): URL/path prefix for saving dsa annotation json</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a><span class="sd">        image_filename (string): name of the image file in DSA e.g. 123.svs</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a><span class="sd">        annotation_name (string): name of the annotation to be displayed in DSA</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a><span class="sd">        line_colors (dict, optional): line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a><span class="sd">        fill_colors (dict, optional): fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a><span class="sd">        storage_options (dict): storage options to pass to read functions</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a><span class="sd">        output_storage_options (dict): storage options to pass to write functions</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a><span class="sd">        local_config (string): local config YAML file</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a><span class="sd">        dict[str,str]: annotation file path</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>    <span class="n">annotation_filepath</span> <span class="o">=</span> <span class="n">__stardist_cell</span><span class="p">(</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;input_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;image_filename&quot;</span><span class="p">],</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;annotation_name&quot;</span><span class="p">],</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;line_colors&quot;</span><span class="p">],</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;fill_colors&quot;</span><span class="p">],</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>    <span class="p">)</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;dsa_annotation&quot;</span><span class="p">:</span> <span class="n">annotation_filepath</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.stardist_polygon" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">stardist_polygon</span><span class="p">(</span><span class="n">slide_manifest</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">annotation_column</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">output_column</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.dsa_viz.stardist_polygon" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Build DSA annotation json from stardist geojson classification results</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_manifest</code></td>
          <td>
                <code><span title="pandera.typing.DataFrame">DataFrame</span>[<span title="luna.common.models.SlideSchema">SlideSchema</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slide manifest from slide_etl</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path prefix to save annotations</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the annotation to be displayed in DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>user-provided line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>user-provided fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to read functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to write functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>annotation_column</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>column containing url to stardist polygon geojson</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_column</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>column with result url to add to slide_manifest</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DataFrame[SlideSchema]: slide manifest</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="k">def</span> <span class="nf">stardist_polygon</span><span class="p">(</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>    <span class="n">slide_manifest</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">SlideSchema</span><span class="p">],</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>    <span class="n">line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>    <span class="n">fill_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>    <span class="n">annotation_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>    <span class="n">output_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="p">):</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build DSA annotation json from stardist geojson classification results</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="sd">        slide_manifest (DataFrame[SlideSchema]): slide manifest from slide_etl</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><span class="sd">        output_urlpath (string): URL/path prefix to save annotations</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a><span class="sd">        annotation_name (string): name of the annotation to be displayed in DSA</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a><span class="sd">        line_colors (dict): user-provided line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a><span class="sd">        fill_colors (dict): user-provided fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a><span class="sd">        storage_options (dict): storage options to pass to read functions</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a><span class="sd">        output_storage_options (dict): storage options to pass to write functions</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a><span class="sd">        annotation_column (string): column containing url to stardist polygon geojson</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a><span class="sd">        output_column (string): column with result url to add to slide_manifest</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a><span class="sd">        DataFrame[SlideSchema]: slide manifest</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">annotation_column</span><span class="p">:</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="n">annotation_column</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_name</span><span class="si">}</span><span class="s2">_geojson_url&quot;</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">output_column</span><span class="p">:</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>        <span class="n">output_column</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_name</span><span class="si">}</span><span class="s2">_dsa_url&quot;</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>    <span class="k">if</span> <span class="n">annotation_column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_column</span><span class="si">}</span><span class="s2"> not found in slide manifest&quot;</span><span class="p">)</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">get_or_create_dask_client</span><span class="p">()</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>        <span class="n">image_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">])</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>        <span class="n">future</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>            <span class="n">__stardist_polygon</span><span class="p">,</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>            <span class="n">row</span><span class="p">[</span><span class="n">annotation_column</span><span class="p">],</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>            <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>            <span class="n">image_filename</span><span class="p">,</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>            <span class="n">annotation_name</span><span class="p">,</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>            <span class="n">line_colors</span><span class="p">,</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>            <span class="n">fill_colors</span><span class="p">,</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>            <span class="n">storage_options</span><span class="p">,</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>            <span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>        <span class="p">)</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>    <span class="n">progress</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>    <span class="n">dsa_annotation_urls</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">dsa_annotation_url</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dsa_annotation_urls</span><span class="p">):</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="n">slide_manifest</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">output_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsa_annotation_url</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>    <span class="k">return</span> <span class="n">slide_manifest</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.stardist_polygon_cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">stardist_polygon_cli</span><span class="p">(</span><span class="n">input_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">image_filename</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">annotation_name</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.dsa_viz.stardist_polygon_cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Build DSA annotation json from stardist geojson classification results</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path to stardist geojson classification results json</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>image_filename</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the image file in DSA e.g. 123.svs</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the annotation to be displayed in DSA</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path prefix to save annotations</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>user-provided line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>user-provided fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to read/write functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>local_config</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>local config YAML file</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>dict[str,str]: annotation file path</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="nd">@timed</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="k">def</span> <span class="nf">stardist_polygon_cli</span><span class="p">(</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>    <span class="n">input_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>    <span class="n">image_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>    <span class="n">line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>    <span class="n">fill_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="p">):</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build DSA annotation json from stardist geojson classification results</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="sd">        input_urlpath (string): URL/path to stardist geojson classification results json</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="sd">        image_filename (string): name of the image file in DSA e.g. 123.svs</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a><span class="sd">        annotation_name (string): name of the annotation to be displayed in DSA</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="sd">        output_urlpath (string): URL/path prefix to save annotations</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a><span class="sd">        line_colors (dict): user-provided line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a><span class="sd">        fill_colors (dict): user-provided fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a><span class="sd">        storage_options (dict): storage options to pass to read/write functions</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a><span class="sd">        local_config (string): local config YAML file</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a><span class="sd">        dict[str,str]: annotation file path</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>    <span class="n">annotation_filepath</span> <span class="o">=</span> <span class="n">__stardist_polygon</span><span class="p">(</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;input_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;image_filename&quot;</span><span class="p">],</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;annotation_name&quot;</span><span class="p">],</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;line_colors&quot;</span><span class="p">],</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;fill_colors&quot;</span><span class="p">],</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>    <span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;dsa_annotation&quot;</span><span class="p">:</span> <span class="n">annotation_filepath</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.stardist_polygon_tile" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">stardist_polygon_tile</span><span class="p">(</span><span class="n">slide_manifest</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">annotation_name_prefix</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">annotation_column</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">output_column_suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.dsa_viz.stardist_polygon_tile" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Build DSA annotation json from stardist geojson classification and labeled tiles</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_manifest</code></td>
          <td>
                <code><span title="pandera.typing.DataFrame">DataFrame</span>[<span title="luna.common.models.SlideSchema">SlideSchema</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slide manifest</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name_prefix</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the annotation to be displayed in DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path prefix to save annotations</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>user-provided line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>user-provided fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to read functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to write functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>annotation_column</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>column containing url to stardist polygon geojson</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_column_suffix</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>column suffix with result url to add to slide_manifest</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>dict[str,str]: annotation file path</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-379" name="__codelineno-0-379"></a><span class="k">def</span> <span class="nf">stardist_polygon_tile</span><span class="p">(</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>    <span class="n">slide_manifest</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">SlideSchema</span><span class="p">],</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>    <span class="n">annotation_name_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>    <span class="n">line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>    <span class="n">fill_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>    <span class="n">annotation_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>    <span class="n">output_column_suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a><span class="p">):</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build DSA annotation json from stardist geojson classification and labeled tiles</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a><span class="sd">        slide_manifest (DataFrame[SlideSchema]): slide manifest</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a><span class="sd">        annotation_name_prefix (string): name of the annotation to be displayed in DSA</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a><span class="sd">        output_urlpath (string): URL/path prefix to save annotations</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a><span class="sd">        line_colors (dict): user-provided line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a><span class="sd">        fill_colors (dict): user-provided fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a><span class="sd">        storage_options (dict): storage options to pass to read functions</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a><span class="sd">        output_storage_options (dict): storage options to pass to write functions</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a><span class="sd">        annotation_column (string): column containing url to stardist polygon geojson</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a><span class="sd">        output_column_suffix (string): column suffix with result url to add to slide_manifest</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a><span class="sd">        dict[str,str]: annotation file path</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">annotation_column</span><span class="p">:</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>        <span class="n">annotation_column</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_name_prefix</span><span class="si">}</span><span class="s2">_geojson_url&quot;</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">output_column_suffix</span><span class="p">:</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>        <span class="n">output_column_suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_name_prefix</span><span class="si">}</span><span class="s2">_dsa_url&quot;</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>    <span class="k">if</span> <span class="n">annotation_column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_column</span><span class="si">}</span><span class="s2"> not found in slide manifest&quot;</span><span class="p">)</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">get_or_create_dask_client</span><span class="p">()</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>        <span class="n">image_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">])</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>        <span class="n">future</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>            <span class="n">__stardist_polygon_tile</span><span class="p">,</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>            <span class="n">row</span><span class="p">[</span><span class="n">annotation_column</span><span class="p">],</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;tiles_url&quot;</span><span class="p">],</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>            <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>            <span class="n">image_filename</span><span class="p">,</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>            <span class="n">annotation_name_prefix</span><span class="p">,</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>            <span class="n">line_colors</span><span class="p">,</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>            <span class="n">fill_colors</span><span class="p">,</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>            <span class="n">storage_options</span><span class="p">,</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>            <span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>        <span class="p">)</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>        <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>    <span class="n">progress</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>    <span class="n">dsa_annotation_url_maps</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>    <span class="n">tile_labels</span> <span class="o">=</span> <span class="n">dsa_annotation_url_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>    <span class="k">return</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>        <span class="o">**</span><span class="p">{</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tile_label</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">output_column_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>                <span class="n">x</span><span class="p">[</span><span class="n">tile_label</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dsa_annotation_url_maps</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>            <span class="p">]</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>            <span class="k">for</span> <span class="n">tile_label</span> <span class="ow">in</span> <span class="n">tile_labels</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>        <span class="p">}</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.dsa_viz.stardist_polygon_tile_cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">stardist_polygon_tile_cli</span><span class="p">(</span><span class="n">object_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">tiles_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">image_filename</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">annotation_name_prefix</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.dsa_viz.stardist_polygon_tile_cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Build DSA annotation json from stardist geojson classification and labeled tiles</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>object_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path to object geojson classification results</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>tiles_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path to tiles manifest parquet</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>image_filename</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the image file in DSA e.g. 123.svs</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name_prefix</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the annotation to be displayed in DSA</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path prefix to save annotations</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>user-provided line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>user-provided fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to read functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to write functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>local_config</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>local config YAML file</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>dict[str,str]: annotation file path</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/dsa_viz.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-333" name="__codelineno-0-333"></a><span class="nd">@timed</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a><span class="k">def</span> <span class="nf">stardist_polygon_tile_cli</span><span class="p">(</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>    <span class="n">object_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>    <span class="n">tiles_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>    <span class="n">image_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>    <span class="n">annotation_name_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>    <span class="n">line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>    <span class="n">fill_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a><span class="p">):</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build DSA annotation json from stardist geojson classification and labeled tiles</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a><span class="sd">        object_urlpath (string): URL/path to object geojson classification results</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a><span class="sd">        tiles_urlpath (string): URL/path to tiles manifest parquet</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a><span class="sd">        image_filename (string): name of the image file in DSA e.g. 123.svs</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a><span class="sd">        annotation_name_prefix (string): name of the annotation to be displayed in DSA</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a><span class="sd">        output_urlpath (string): URL/path prefix to save annotations</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a><span class="sd">        line_colors (dict): user-provided line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a><span class="sd">        fill_colors (dict): user-provided fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a><span class="sd">        storage_options (dict): storage options to pass to read functions</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a><span class="sd">        output_storage_options (dict): storage options to pass to write functions</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a><span class="sd">        local_config (string): local config YAML file</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><span class="sd">        dict[str,str]: annotation file path</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>    <span class="n">metadata</span> <span class="o">=</span> <span class="n">__stardist_polygon_tile</span><span class="p">(</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;object_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tiles_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;image_filename&quot;</span><span class="p">],</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;annotation_name_prefix&quot;</span><span class="p">],</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;line_colors&quot;</span><span class="p">],</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;fill_colors&quot;</span><span class="p">],</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>    <span class="p">)</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>    <span class="k">return</span> <span class="n">metadata</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.cli.extract_kfunction_statistics" class="doc doc-heading">
          <code>extract_kfunction_statistics</code>


<a href="#luna.pathology.cli.extract_kfunction_statistics" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.extract_kfunction_statistics.cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">cli</span><span class="p">(</span><span class="n">input_cell_objects_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">intensity_label</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">tile_stride</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.extract_kfunction_statistics.cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Run k function using a sliding window approach, where the k-function is computed locally in a smaller window, and aggregated across the entire slide.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_cell_objects_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to cell objects (.csv)</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>tile_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>size of tiles to use (at the requested magnification)</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>tile_stride</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>spacing between tiles</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>intensity_label</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Columns of cell object to use for intensity calculations (for I-K function - spatial + some scalar value clustering)</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>radius</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>the radius to consider</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output URL/path prefix</p>
            </div>
          </td>
          <td>
                <code>&#39;.&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options for reading the cell objects</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>pd.DataFrame: metadata about function call</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/extract_kfunction_statistics.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="nd">@timed</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="k">def</span> <span class="nf">cli</span><span class="p">(</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="n">input_cell_objects_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="n">tile_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="n">intensity_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="n">tile_stride</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="p">):</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Run k function using a sliding window approach, where the k-function is computed locally in a smaller window, and aggregated across the entire slide.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        input_cell_objects_urlpath (str): url/path to cell objects (.csv)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        tile_size (int): size of tiles to use (at the requested magnification)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        tile_stride (int): spacing between tiles</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">        intensity_label (str): Columns of cell object to use for intensity calculations (for I-K function - spatial + some scalar value clustering)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">        radius (float):  the radius to consider</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">        output_urlpath (str): output URL/path prefix</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">        storage_options (dict): storage options for reading the cell objects</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">        pd.DataFrame: metadata about function call</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="n">configure_dask_client</span><span class="p">()</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="n">df_stats</span> <span class="o">=</span> <span class="n">extract_kfunction</span><span class="p">(</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;input_cell_objects_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tile_size&quot;</span><span class="p">],</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;intensity_label&quot;</span><span class="p">],</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tile_stride&quot;</span><span class="p">],</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">],</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="n">fs</span><span class="p">,</span> <span class="n">output_urlpath_prefix</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">]</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="n">output_tile_header</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_urlpath_prefix</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;input_cell_objects_urlpath&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="o">+</span> <span class="s2">&quot;_kfunction_supertiles.parquet&quot;</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="p">)</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_tile_header</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="n">df_stats</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="s2">&quot;slide_tiles&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_tile_header</span><span class="p">),</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="p">}</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="k">return</span> <span class="n">properties</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.extract_kfunction_statistics.extract_kfunction" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">extract_kfunction</span><span class="p">(</span><span class="n">input_cell_objects_urlpath</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">intensity_label</span><span class="p">,</span> <span class="n">tile_stride</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.extract_kfunction_statistics.extract_kfunction" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Run k function using a sliding window approach, where the k-function is computed locally in a smaller window, and aggregated across the entire slide.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_cell_objects</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path to cell objects (.csv)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tile_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>size of tiles to use (at the requested magnification)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>intensity_label</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Columns of cell object to use for intensity calculations (for I-K function - spatial + some scalar value clustering)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tile_stride</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>spacing between tiles</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>radius</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>the radius to consider</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options for reading the cell objects</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>metadata about function call</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/extract_kfunction_statistics.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="k">def</span> <span class="nf">extract_kfunction</span><span class="p">(</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="n">input_cell_objects_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="n">tile_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="n">intensity_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="n">tile_stride</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="p">):</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Run k function using a sliding window approach, where the k-function is computed locally in a smaller window, and aggregated across the entire slide.</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">        input_cell_objects (str): URL/path to cell objects (.csv)</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">        tile_size (int): size of tiles to use (at the requested magnification)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">        intensity_label (str): Columns of cell object to use for intensity calculations (for I-K function - spatial + some scalar value clustering)</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">        tile_stride (int): spacing between tiles</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">        radius (float):  the radius to consider</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">        storage_options (dict): storage options for reading the cell objects</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">        dict: metadata about function call</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">get_or_create_dask_client</span><span class="p">()</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">input_cell_objects_urlpath</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_options</span><span class="p">)</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="n">l_address</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="n">l_k_function_futures</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="n">l_x_coord</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="n">l_y_coord</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="n">feature_name</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="sa">f</span><span class="s2">&quot;ikfunction_r</span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">_stain</span><span class="si">{</span><span class="n">intensity_label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>    <span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="n">coords</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;x_coord&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="nb">int</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;x_coord&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="n">tile_stride</span><span class="p">),</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;y_coord&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="nb">int</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;y_coord&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="n">tile_stride</span><span class="p">),</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="p">)</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Submitting tasks...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="n">df_tile</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="sa">f</span><span class="s2">&quot;x_coord &gt;= </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2"> and x_coord &lt;= </span><span class="si">{</span><span class="n">x</span><span class="o">+</span><span class="n">tile_size</span><span class="si">}</span><span class="s2"> and y_coord &gt;=</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2"> and y_coord &lt;= </span><span class="si">{</span><span class="n">y</span><span class="o">+</span><span class="n">tile_size</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_tile</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="k">continue</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="n">future</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="n">Kfunction</span><span class="p">,</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="n">df_tile</span><span class="p">[[</span><span class="s2">&quot;x_coord&quot;</span><span class="p">,</span> <span class="s2">&quot;y_coord&quot;</span><span class="p">]],</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>            <span class="n">df_tile</span><span class="p">[[</span><span class="s2">&quot;x_coord&quot;</span><span class="p">,</span> <span class="s2">&quot;y_coord&quot;</span><span class="p">]],</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>            <span class="n">intensity</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_tile</span><span class="p">[</span><span class="n">intensity_label</span><span class="p">]),</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>            <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="n">l_address</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coord_to_address</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="n">l_k_function_futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="n">l_x_coord</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="n">l_y_coord</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for all tasks to complete...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="n">progress</span><span class="p">(</span><span class="n">l_k_function_futures</span><span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="n">l_k_function</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">l_k_function_futures</span><span class="p">)</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>    <span class="n">df_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="p">{</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="n">l_address</span><span class="p">,</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="s2">&quot;x_coord&quot;</span><span class="p">:</span> <span class="n">l_x_coord</span><span class="p">,</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="s2">&quot;y_coord&quot;</span><span class="p">:</span> <span class="n">l_y_coord</span><span class="p">,</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>            <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="n">l_k_function</span><span class="p">,</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="p">}</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;address&quot;</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="n">df_stats</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;xy_extent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile_size</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>    <span class="n">df_stats</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;tile_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile_size</span>  <span class="c1"># Same, 1 to 1</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="n">df_stats</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;tile_units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;um&quot;</span>  <span class="c1"># Same, 1 to 1</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>    <span class="n">df_stats</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_stats</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">])</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="n">df_stats</span><span class="p">[</span><span class="n">feature_name</span> <span class="o">+</span> <span class="s2">&quot;_norm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="n">df_stats</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span> <span class="o">/</span> <span class="n">df_stats</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>    <span class="p">)</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>    <span class="n">df_stats</span> <span class="o">=</span> <span class="n">df_stats</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generated k-function feature data:&quot;</span><span class="p">)</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">df_stats</span><span class="p">)</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>    <span class="k">return</span> <span class="n">df_stats</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.cli.extract_shape_features" class="doc doc-heading">
          <code>extract_shape_features</code>


<a href="#luna.pathology.cli.extract_shape_features" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.extract_shape_features.cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">cli</span><span class="p">(</span><span class="n">slide_mask_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">label_cols</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">include_smaller_regions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.extract_shape_features.cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Extracts shape and spatial features (HIF features) from a slide mask.
This CLI extracts two sets of features. The first set are 'whole slide features', where
the entire mask label is considred as a single region and features are extracted. These features
are useful for determining things like total area of x tissue.</p>
<p>The second set of features are 'regional features', where each label is split up according to
their connectivity and features are extracted from these smaller regions.
These features are useful for determining things like solidity of the top ten largest
regions of tissue y. Pixel intensity values from the WSI are unused. In order to generate
connected regions, skimage generates a mask itself where different values coorespond
to different regions, which removes the tissue type information from the original mask.
So, the original mask is passed as an intensity image to ensure that each region can be
associated with a tissue type.</p>
<p>Args:
    slide_mask_urlpath (str): URL/path to slide mask (*.tif)
    label_cols (List[str]): list of labels that coorespond to those in slide_mask_urlpath
    output_urlpath (str): output URL/path prefix
    include_smaller_regions (bool): include the smaller regions (not just larget)
    storage_options (dict): storage options to pass to read functions
    output_storage_options (dict): storage options to pass to write functions
    local_config (str): local config YAML file</p>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output .tif path and the number of shapes for which features were generated</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/extract_shape_features.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="nd">@timed</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="k">def</span> <span class="nf">cli</span><span class="p">(</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="n">slide_mask_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="n">label_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="n">include_smaller_regions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="p">):</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Extracts shape and spatial features (HIF features) from a slide mask.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    This CLI extracts two sets of features. The first set are &#39;whole slide features&#39;, where</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">    the entire mask label is considred as a single region and features are extracted. These features</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">    are useful for determining things like total area of x tissue.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    The second set of features are &#39;regional features&#39;, where each label is split up according to</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">    their connectivity and features are extracted from these smaller regions.</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">    These features are useful for determining things like solidity of the top ten largest</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">    regions of tissue y. Pixel intensity values from the WSI are unused. In order to generate</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">    connected regions, skimage generates a mask itself where different values coorespond</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">    to different regions, which removes the tissue type information from the original mask.</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">    So, the original mask is passed as an intensity image to ensure that each region can be</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    associated with a tissue type.</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">     Args:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">        slide_mask_urlpath (str): URL/path to slide mask (*.tif)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">        label_cols (List[str]): list of labels that coorespond to those in slide_mask_urlpath</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        output_urlpath (str): output URL/path prefix</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">        include_smaller_regions (bool): include the smaller regions (not just larget)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">        storage_options (dict): storage options to pass to read functions</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        output_storage_options (dict): storage options to pass to write functions</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">        local_config (str): local config YAML file</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">        dict: output .tif path and the number of shapes for which features were generated</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_mask_urlpath&quot;</span><span class="p">],</span> <span class="s2">&quot;rb&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">])</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="n">mask_values</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;label_cols&quot;</span><span class="p">])}</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="n">result_df</span> <span class="o">=</span> <span class="n">extract_shape_features</span><span class="p">(</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="n">mask</span><span class="p">,</span> <span class="n">mask_values</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;include_smaller_regions&quot;</span><span class="p">]</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="p">)</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="n">fs</span><span class="p">,</span> <span class="n">urlpath</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">]</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="n">output_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">urlpath</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;shape_features.csv&quot;</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>    <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_fpath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="n">result_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;shape_features&quot;</span><span class="p">:</span> <span class="n">output_fpath</span><span class="p">,</span> <span class="s2">&quot;num_shapes&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">)}</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="k">return</span> <span class="n">properties</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.extract_shape_features.extract_shape_features" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">extract_shape_features</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask_values</span><span class="p">,</span> <span class="n">include_smaller_regions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="s1">&#39;bbox&#39;</span><span class="p">,</span> <span class="s1">&#39;bbox_area&#39;</span><span class="p">,</span> <span class="s1">&#39;centroid&#39;</span><span class="p">,</span> <span class="s1">&#39;convex_area&#39;</span><span class="p">,</span> <span class="s1">&#39;convex_image&#39;</span><span class="p">,</span> <span class="s1">&#39;coords&#39;</span><span class="p">,</span> <span class="s1">&#39;eccentricity&#39;</span><span class="p">,</span> <span class="s1">&#39;equivalent_diameter&#39;</span><span class="p">,</span> <span class="s1">&#39;euler_number&#39;</span><span class="p">,</span> <span class="s1">&#39;extent&#39;</span><span class="p">,</span> <span class="s1">&#39;filled_area&#39;</span><span class="p">,</span> <span class="s1">&#39;filled_image&#39;</span><span class="p">,</span> <span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;inertia_tensor&#39;</span><span class="p">,</span> <span class="s1">&#39;inertia_tensor_eigvals&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;local_centroid&#39;</span><span class="p">,</span> <span class="s1">&#39;major_axis_length&#39;</span><span class="p">,</span> <span class="s1">&#39;minor_axis_length&#39;</span><span class="p">,</span> <span class="s1">&#39;moments&#39;</span><span class="p">,</span> <span class="s1">&#39;moments_central&#39;</span><span class="p">,</span> <span class="s1">&#39;moments_hu&#39;</span><span class="p">,</span> <span class="s1">&#39;moments_normalized&#39;</span><span class="p">,</span> <span class="s1">&#39;orientation&#39;</span><span class="p">,</span> <span class="s1">&#39;perimeter&#39;</span><span class="p">,</span> <span class="s1">&#39;slice&#39;</span><span class="p">,</span> <span class="s1">&#39;solidity&#39;</span><span class="p">])</span></code>

<a href="#luna.pathology.cli.extract_shape_features.extract_shape_features" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Extracts shape and spatial features (HIF features) from a slide mask</p>
<p>Args:
    slide_mask_urlpath (str): url/path to slide mask (*.tif)
    label_cols (List[str]): list of labels that coorespond to those in slide_mask_urlpath</p>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>pd.DataFrame: shape and spatial features</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/extract_shape_features.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="k">def</span> <span class="nf">extract_shape_features</span><span class="p">(</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>    <span class="n">mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>    <span class="n">mask_values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>    <span class="n">include_smaller_regions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>    <span class="n">properties</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>        <span class="s2">&quot;area&quot;</span><span class="p">,</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>        <span class="s2">&quot;bbox&quot;</span><span class="p">,</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="s2">&quot;bbox_area&quot;</span><span class="p">,</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>        <span class="s2">&quot;centroid&quot;</span><span class="p">,</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>        <span class="s2">&quot;convex_area&quot;</span><span class="p">,</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>        <span class="s2">&quot;convex_image&quot;</span><span class="p">,</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>        <span class="s2">&quot;coords&quot;</span><span class="p">,</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>        <span class="s2">&quot;eccentricity&quot;</span><span class="p">,</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="s2">&quot;equivalent_diameter&quot;</span><span class="p">,</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>        <span class="s2">&quot;euler_number&quot;</span><span class="p">,</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="s2">&quot;extent&quot;</span><span class="p">,</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="s2">&quot;filled_area&quot;</span><span class="p">,</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="s2">&quot;filled_image&quot;</span><span class="p">,</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>        <span class="s2">&quot;image&quot;</span><span class="p">,</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="s2">&quot;inertia_tensor&quot;</span><span class="p">,</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="s2">&quot;inertia_tensor_eigvals&quot;</span><span class="p">,</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="s2">&quot;label&quot;</span><span class="p">,</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>        <span class="s2">&quot;local_centroid&quot;</span><span class="p">,</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="s2">&quot;major_axis_length&quot;</span><span class="p">,</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="s2">&quot;minor_axis_length&quot;</span><span class="p">,</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="s2">&quot;moments&quot;</span><span class="p">,</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>        <span class="s2">&quot;moments_central&quot;</span><span class="p">,</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>        <span class="s2">&quot;moments_hu&quot;</span><span class="p">,</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>        <span class="s2">&quot;moments_normalized&quot;</span><span class="p">,</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="s2">&quot;orientation&quot;</span><span class="p">,</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="s2">&quot;perimeter&quot;</span><span class="p">,</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>        <span class="s2">&quot;slice&quot;</span><span class="p">,</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>        <span class="s2">&quot;solidity&quot;</span><span class="p">,</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>    <span class="p">],</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><span class="p">):</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Extracts shape and spatial features (HIF features) from a slide mask</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">     Args:</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">        slide_mask_urlpath (str): url/path to slide mask (*.tif)</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">        label_cols (List[str]): list of labels that coorespond to those in slide_mask_urlpath</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="sd">        pd.DataFrame: shape and spatial features</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mask shape=</span><span class="si">{</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Extracting regional features based on connectivity&quot;</span><span class="p">)</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>    <span class="n">whole_slide_features_df</span> <span class="o">=</span> <span class="n">extract_whole_slide_features</span><span class="p">(</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>        <span class="n">mask</span><span class="p">,</span> <span class="n">mask_values</span><span class="p">,</span> <span class="n">properties</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>    <span class="p">)</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>    <span class="n">whole_slide_features_df</span><span class="p">[</span><span class="s2">&quot;Parent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;whole_region&quot;</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>    <span class="n">whole_slide_features_df</span> <span class="o">=</span> <span class="n">whole_slide_features_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Class&quot;</span><span class="p">)</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>    <span class="n">whole_slide_features_df</span><span class="p">[</span><span class="s2">&quot;area_fraction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="n">whole_slide_features_df</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">whole_slide_features_df</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>    <span class="p">)</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>    <span class="n">whole_slide_features_mdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="n">whole_slide_features_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Parent&quot;</span><span class="p">,</span> <span class="s2">&quot;Class&quot;</span><span class="p">]</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>    <span class="p">)</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>    <span class="n">area_col</span> <span class="o">=</span> <span class="n">whole_slide_features_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s2">&quot;area&quot;</span><span class="p">)</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>    <span class="n">idx0</span><span class="p">,</span> <span class="n">idx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">whole_slide_features_df</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>    <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>    <span class="n">whole_slide_ratio_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>            <span class="s2">&quot;Parent&quot;</span><span class="p">:</span> <span class="s2">&quot;whole_region&quot;</span><span class="p">,</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>            <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>                <span class="p">[</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>                    <span class="sa">f</span><span class="s2">&quot;area_log_ratio_to_</span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">whole_slide_features_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>                <span class="p">]</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>            <span class="p">)[</span><span class="n">idx1</span><span class="p">],</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">whole_slide_features_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx0</span><span class="p">,</span> <span class="n">area_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>            <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">whole_slide_features_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx1</span><span class="p">,</span> <span class="n">area_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>        <span class="p">},</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>        <span class="n">index</span><span class="o">=</span><span class="n">whole_slide_features_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">idx0</span><span class="p">],</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>    <span class="p">)</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>    <span class="n">whole_slide_ratio_df</span> <span class="o">=</span> <span class="n">whole_slide_ratio_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="n">regional_features_df</span> <span class="o">=</span> <span class="n">extract_regional_features</span><span class="p">(</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>        <span class="n">mask</span><span class="p">,</span> <span class="n">mask_values</span><span class="p">,</span> <span class="n">properties</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;min_intensity&quot;</span><span class="p">,</span> <span class="s2">&quot;max_intensity&quot;</span><span class="p">]</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>    <span class="p">)</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>    <span class="n">regional_features_df</span> <span class="o">=</span> <span class="n">regional_features_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>        <span class="n">Parent</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;region_</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">regional_features_df</span><span class="p">))]</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="p">)</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>    <span class="n">regional_features_df</span> <span class="o">=</span> <span class="n">regional_features_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;Parent&quot;</span><span class="p">,</span> <span class="s2">&quot;Class&quot;</span><span class="p">])</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="n">regional_features_df</span><span class="p">[</span><span class="s2">&quot;area_fraction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="n">regional_features_df</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">whole_slide_features_df</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>    <span class="p">)</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>    <span class="n">regional_features_mdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>        <span class="n">regional_features_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Parent&quot;</span><span class="p">,</span> <span class="s2">&quot;Class&quot;</span><span class="p">]</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>    <span class="p">)</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>    <span class="n">regional_features_df</span> <span class="o">=</span> <span class="n">regional_features_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>    <span class="n">largest_regional_features_df</span> <span class="o">=</span> <span class="n">regional_features_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>        <span class="n">regional_features_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Class&quot;</span><span class="p">)[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>    <span class="p">]</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>    <span class="n">largest_regional_features_df</span><span class="p">[</span><span class="s2">&quot;Parent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;largest_region&quot;</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>    <span class="n">largest_regional_features_df</span> <span class="o">=</span> <span class="n">largest_regional_features_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Class&quot;</span><span class="p">)</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>    <span class="n">largest_regional_features_mdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>        <span class="n">largest_regional_features_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Parent&quot;</span><span class="p">,</span> <span class="s2">&quot;Class&quot;</span><span class="p">]</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>    <span class="p">)</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>    <span class="n">area_col</span> <span class="o">=</span> <span class="n">largest_regional_features_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s2">&quot;area&quot;</span><span class="p">)</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>    <span class="n">idx0</span><span class="p">,</span> <span class="n">idx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">largest_regional_features_df</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>    <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>    <span class="n">ratio_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>            <span class="s2">&quot;Parent&quot;</span><span class="p">:</span> <span class="s2">&quot;largest_region&quot;</span><span class="p">,</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>            <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>                <span class="p">[</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>                    <span class="sa">f</span><span class="s2">&quot;area_log_ratio_to_</span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">largest_regional_features_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>                <span class="p">]</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>            <span class="p">)[</span><span class="n">idx1</span><span class="p">],</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">largest_regional_features_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx0</span><span class="p">,</span> <span class="n">area_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>            <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">largest_regional_features_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx1</span><span class="p">,</span> <span class="n">area_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="p">},</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>        <span class="n">index</span><span class="o">=</span><span class="n">largest_regional_features_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">idx0</span><span class="p">],</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>    <span class="p">)</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>    <span class="n">ratio_df</span> <span class="o">=</span> <span class="n">ratio_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>    <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>        <span class="p">[</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>            <span class="n">whole_slide_features_mdf</span><span class="p">,</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>            <span class="n">whole_slide_ratio_df</span><span class="p">,</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>            <span class="n">largest_regional_features_mdf</span><span class="p">,</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>            <span class="n">ratio_df</span><span class="p">,</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>        <span class="p">]</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>    <span class="p">)</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>    <span class="k">if</span> <span class="n">include_smaller_regions</span><span class="p">:</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>        <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">result_df</span><span class="p">,</span> <span class="n">regional_features_mdf</span><span class="p">])</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>    <span class="k">return</span> <span class="n">result_df</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.cli.extract_stain_texture" class="doc doc-heading">
          <code>extract_stain_texture</code>


<a href="#luna.pathology.cli.extract_stain_texture" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.extract_stain_texture.cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">cli</span><span class="p">(</span><span class="n">slide_image_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">slide_mask_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">stain_sample_factor</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">stain_channel</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.extract_stain_texture.cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Compute GLCM texture features on a de-convolved slide image</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_image_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>slide_mask_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to slide mask (.tif)</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>stain_sample_factor</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>downsample factor to use for stain vector estimation</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>stain_channel</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>which channel of the deconvovled image to use for texture analysis</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>tile_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>size of tiles to use (at the requested magnification) (500-1000 recommended)</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output/working directory</p>
            </div>
          </td>
          <td>
                <code>&#39;.&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>metadata about function call</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/extract_stain_texture.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="nd">@timed</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="k">def</span> <span class="nf">cli</span><span class="p">(</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">slide_image_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="n">slide_mask_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="n">stain_sample_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="n">stain_channel</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="n">tile_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="p">):</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute GLCM texture features on a de-convolved slide image</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">        slide_image_urlpath (str): url/path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">        slide_mask_urlpath (str): url/path to slide mask (.tif)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        stain_sample_factor (float): downsample factor to use for stain vector estimation</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">        stain_channel (int): which channel of the deconvovled image to use for texture analysis</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">        tile_size (int): size of tiles to use (at the requested magnification) (500-1000 recommended)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        output_urlpath (str): output/working directory</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">        dict: metadata about function call</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="n">df_result</span> <span class="o">=</span> <span class="n">extract_stain_texture</span><span class="p">(</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_image_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_mask_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;stain_sample_factor&quot;</span><span class="p">],</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;stain_channel&quot;</span><span class="p">],</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tile_size&quot;</span><span class="p">],</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="n">fs</span><span class="p">,</span> <span class="n">urlpath_prefix</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">]</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="p">)</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="n">output_filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">urlpath_prefix</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;stainomics.parquet&quot;</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>    <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="n">df_result</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="c1"># &quot;num_pixel_observations&quot;: n,</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="s2">&quot;feature_data&quot;</span><span class="p">:</span> <span class="n">output_filename</span><span class="p">,</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="p">}</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="k">return</span> <span class="n">properties</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.extract_stain_texture.extract_stain_texture" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">extract_stain_texture</span><span class="p">(</span><span class="n">slide_image_urlpath</span><span class="p">,</span> <span class="n">slide_mask_urlpath</span><span class="p">,</span> <span class="n">stain_sample_factor</span><span class="p">,</span> <span class="n">stain_channel</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">storage_options</span><span class="p">,</span> <span class="n">output_storage_options</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.extract_stain_texture.extract_stain_texture" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Compute GLCM texture after automatically deconvolving the image into stain channels, using tile-based processing</p>
<p>Runs statistics on distribution.</p>
<p>Save a feature csv file at the output directory.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_image_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>slide_mask_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to slide mask (.tif)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>stain_sample_factor</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>downsample factor to use for stain vector estimation</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>stain_channel</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>which channel of the deconvovled image to use for texture analysis</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tile_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>size of tiles to use (at the requested magnification) (500-1000 recommended)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output/working URL/path prefix</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to reading functions</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to writing functions</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>metadata about function call</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/extract_stain_texture.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="k">def</span> <span class="nf">extract_stain_texture</span><span class="p">(</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>    <span class="n">slide_image_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>    <span class="n">slide_mask_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="n">stain_sample_factor</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>    <span class="n">stain_channel</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="n">tile_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="p">):</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute GLCM texture after automatically deconvolving the image into stain channels, using tile-based processing</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">    Runs statistics on distribution.</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">    Save a feature csv file at the output directory.</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">        slide_image_urlpath (str): url/path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">        slide_mask_urlpath (str): url/path to slide mask (.tif)</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">        stain_sample_factor (float): downsample factor to use for stain vector estimation</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">        stain_channel (int): which channel of the deconvovled image to use for texture analysis</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">        tile_size (int): size of tiles to use (at the requested magnification) (500-1000 recommended)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">        output_urlpath (str): output/working URL/path prefix</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">        storage_options (dict): storage options to pass to reading functions</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">        output_storage_options (dict): storage options to pass to writing functions</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">        dict: metadata about function call</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">slide_image_urlpath</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span> <span class="k">as</span> <span class="n">slide_file</span><span class="p">:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="n">slide</span> <span class="o">=</span> <span class="n">tiffslide</span><span class="o">.</span><span class="n">TiffSlide</span><span class="p">(</span><span class="n">slide_file</span><span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="c1"># oslide = openslide.OpenSlide(slide_image_urlpath)</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slide dimensions </span><span class="si">{</span><span class="n">slide</span><span class="o">.</span><span class="n">dimensions</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="n">sample_arr</span> <span class="o">=</span> <span class="n">get_downscaled_thumbnail</span><span class="p">(</span><span class="n">slide</span><span class="p">,</span> <span class="n">stain_sample_factor</span><span class="p">)</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>    <span class="n">slide_full_generator</span><span class="p">,</span> <span class="n">slide_full_level</span> <span class="o">=</span> <span class="n">get_full_resolution_generator</span><span class="p">(</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="n">slide_image_urlpath</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="n">tile_size</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_options</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>    <span class="p">)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>    <span class="n">mask_full_generator</span><span class="p">,</span> <span class="n">mask_full_level</span> <span class="o">=</span> <span class="n">get_full_resolution_generator</span><span class="p">(</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="n">slide_mask_urlpath</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="n">tile_size</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_options</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>    <span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="n">stain_vectors</span> <span class="o">=</span> <span class="n">get_stain_vectors_macenko</span><span class="p">(</span><span class="n">sample_arr</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stain vectors=</span><span class="si">{</span><span class="n">stain_vectors</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="n">tile_x_count</span><span class="p">,</span> <span class="n">tile_y_count</span> <span class="o">=</span> <span class="n">slide_full_generator</span><span class="o">.</span><span class="n">level_tiles</span><span class="p">[</span><span class="n">slide_full_level</span><span class="p">]</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Tiles x </span><span class="si">%s</span><span class="s2">, Tiles y </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tile_x_count</span><span class="p">,</span> <span class="n">tile_y_count</span><span class="p">)</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="c1"># populate address, coordinates</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="n">address_raster</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="n">address</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">tile_x_count</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">tile_y_count</span><span class="p">))</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="p">]</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Number of tiles in raster: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">address_raster</span><span class="p">))</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="n">features</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="n">N_tiles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">address_raster</span><span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="k">for</span> <span class="n">n_tile</span><span class="p">,</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">address_raster</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="n">mask_patch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask_full_generator</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">mask_full_level</span><span class="p">,</span> <span class="n">address</span><span class="p">))</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">mask_patch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>            <span class="k">continue</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="n">image_patch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">slide_full_generator</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">slide_full_level</span><span class="p">,</span> <span class="n">address</span><span class="p">))</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="n">texture_values</span> <span class="o">=</span> <span class="n">extract_patch_texture_features</span><span class="p">(</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>            <span class="n">image_patch</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>            <span class="n">mask_patch</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>            <span class="n">stain_vectors</span><span class="p">,</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="n">stain_channel</span><span class="p">,</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>        <span class="k">if</span> <span class="n">texture_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">texture_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>                <span class="n">features</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed Tile [</span><span class="si">{</span><span class="n">n_tile</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">N_tiles</span><span class="si">}</span><span class="s2">] at </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>        <span class="n">features</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>    <span class="n">hist_features</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>    <span class="n">fs</span><span class="p">,</span> <span class="n">output_urlpath_prefix</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="n">output_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">output_storage_options</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>    <span class="p">)</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="n">output_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_urlpath_prefix</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;feature_vector_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.npy&quot;</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>            <span class="k">continue</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="n">smin</span><span class="p">,</span> <span class="n">smax</span><span class="p">),</span> <span class="n">sm</span><span class="p">,</span> <span class="n">sv</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">sk</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>            <span class="n">ln_params</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">floc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>            <span class="n">ln_params</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="n">fx_name_prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_channel_</span><span class="si">{</span><span class="n">stain_channel</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>        <span class="n">hist_features</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>            <span class="p">{</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fx_name_prefix</span><span class="si">}</span><span class="s2">_nobs&quot;</span><span class="p">:</span> <span class="n">n</span><span class="p">,</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fx_name_prefix</span><span class="si">}</span><span class="s2">_min&quot;</span><span class="p">:</span> <span class="n">smin</span><span class="p">,</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fx_name_prefix</span><span class="si">}</span><span class="s2">_max&quot;</span><span class="p">:</span> <span class="n">smax</span><span class="p">,</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fx_name_prefix</span><span class="si">}</span><span class="s2">_mean&quot;</span><span class="p">:</span> <span class="n">sm</span><span class="p">,</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fx_name_prefix</span><span class="si">}</span><span class="s2">_variance&quot;</span><span class="p">:</span> <span class="n">sv</span><span class="p">,</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fx_name_prefix</span><span class="si">}</span><span class="s2">_skewness&quot;</span><span class="p">:</span> <span class="n">ss</span><span class="p">,</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fx_name_prefix</span><span class="si">}</span><span class="s2">_kurtosis&quot;</span><span class="p">:</span> <span class="n">sk</span><span class="p">,</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fx_name_prefix</span><span class="si">}</span><span class="s2">_lognorm_fit_p0&quot;</span><span class="p">:</span> <span class="n">ln_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fx_name_prefix</span><span class="si">}</span><span class="s2">_lognorm_fit_p2&quot;</span><span class="p">:</span> <span class="n">ln_params</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>            <span class="p">}</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>    <span class="c1"># The fit may fail sometimes, replace inf with 0</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>    <span class="n">df_result</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">hist_features</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>        <span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>        <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>    <span class="p">)</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">df_result</span><span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>    <span class="k">return</span> <span class="n">df_result</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.cli.extract_tile_shape_features" class="doc doc-heading">
          <code>extract_tile_shape_features</code>


<a href="#luna.pathology.cli.extract_tile_shape_features" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.extract_tile_shape_features.__extract_tile_shape_features" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">__extract_tile_shape_features</span><span class="p">(</span><span class="n">objects_urlpath</span><span class="p">,</span> <span class="n">tiles_urlpath</span><span class="p">,</span> <span class="n">slide_urlpath</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">resize_factor</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">detection_probability_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">slide_id</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">statistical_descriptors</span><span class="o">=</span><span class="n">StatisticalDescriptors</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">cellular_features</span><span class="o">=</span><span class="n">CellularFeatures</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">property_type</span><span class="o">=</span><span class="n">PropertyType</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">include_smaller_regions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">properties</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="s1">&#39;convex_area&#39;</span><span class="p">,</span> <span class="s1">&#39;eccentricity&#39;</span><span class="p">,</span> <span class="s1">&#39;equivalent_diameter&#39;</span><span class="p">,</span> <span class="s1">&#39;euler_number&#39;</span><span class="p">,</span> <span class="s1">&#39;extent&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;major_axis_length&#39;</span><span class="p">,</span> <span class="s1">&#39;minor_axis_length&#39;</span><span class="p">,</span> <span class="s1">&#39;perimeter&#39;</span><span class="p">,</span> <span class="s1">&#39;solidity&#39;</span><span class="p">])</span></code>

<a href="#luna.pathology.cli.extract_tile_shape_features.__extract_tile_shape_features" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Extracts shape and spatial features (HIF features) from a slide mask.</p>
<p>Args:
    objects_urlpath (str): URL/path to object file (geopandas supported formats)
    tiles_urlpath (str): URL/path to tiles manifest (parquet)
    slide_urlpath (str): URL/path to slide (tiffslide supported formats)
    output_urlpath (str): output URL/path
    resize_factor (int): factor to downsample slide image
    detection_probability_threshold (Optional[float]): detection
        probability threshold
    slide_id (str): Slide ID to add to dataframes
    statistical_descriptors (StatisticalDescriptors): statistical descriptors to calculate
    cellular_features (CellularFeatures): cellular features to include
    property_type (PropertyType): properties to include
    include_smaller_regions (bool): include smaller regions
    label_cols (List[str]): list of score columns to use for the classification. Tile is classified as the column with the max score
    storage_options (dict): storage options to pass to reading functions
    output_storage_options (dict): storage options to pass to writing functions
    properties (List[str]): list of whole slide image properties to
        extract. Needs to be parquet compatible (numeric).
Returns:
    dict: output paths and the number of features generated</p>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/extract_tile_shape_features.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="k">def</span> <span class="nf">__extract_tile_shape_features</span><span class="p">(</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>    <span class="n">objects_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>    <span class="n">tiles_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>    <span class="n">slide_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>    <span class="n">resize_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>    <span class="n">detection_probability_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>    <span class="n">slide_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>    <span class="n">statistical_descriptors</span><span class="p">:</span> <span class="n">StatisticalDescriptors</span> <span class="o">=</span> <span class="n">StatisticalDescriptors</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>    <span class="n">cellular_features</span><span class="p">:</span> <span class="n">CellularFeatures</span> <span class="o">=</span> <span class="n">CellularFeatures</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>    <span class="n">property_type</span><span class="p">:</span> <span class="n">PropertyType</span> <span class="o">=</span> <span class="n">PropertyType</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>    <span class="n">include_smaller_regions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>    <span class="n">label_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>    <span class="n">properties</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="s2">&quot;area&quot;</span><span class="p">,</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="s2">&quot;convex_area&quot;</span><span class="p">,</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="s2">&quot;eccentricity&quot;</span><span class="p">,</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>        <span class="s2">&quot;equivalent_diameter&quot;</span><span class="p">,</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>        <span class="s2">&quot;euler_number&quot;</span><span class="p">,</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>        <span class="s2">&quot;extent&quot;</span><span class="p">,</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="s2">&quot;label&quot;</span><span class="p">,</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="s2">&quot;major_axis_length&quot;</span><span class="p">,</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>        <span class="s2">&quot;minor_axis_length&quot;</span><span class="p">,</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>        <span class="s2">&quot;perimeter&quot;</span><span class="p">,</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="s2">&quot;solidity&quot;</span><span class="p">,</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>    <span class="p">],</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="p">):</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Extracts shape and spatial features (HIF features) from a slide mask.</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">     Args:</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">        objects_urlpath (str): URL/path to object file (geopandas supported formats)</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="sd">        tiles_urlpath (str): URL/path to tiles manifest (parquet)</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">        slide_urlpath (str): URL/path to slide (tiffslide supported formats)</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="sd">        output_urlpath (str): output URL/path</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="sd">        resize_factor (int): factor to downsample slide image</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="sd">        detection_probability_threshold (Optional[float]): detection</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="sd">            probability threshold</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="sd">        slide_id (str): Slide ID to add to dataframes</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="sd">        statistical_descriptors (StatisticalDescriptors): statistical descriptors to calculate</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a><span class="sd">        cellular_features (CellularFeatures): cellular features to include</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">        property_type (PropertyType): properties to include</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">        include_smaller_regions (bool): include smaller regions</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="sd">        label_cols (List[str]): list of score columns to use for the classification. Tile is classified as the column with the max score</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a><span class="sd">        storage_options (dict): storage options to pass to reading functions</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="sd">        output_storage_options (dict): storage options to pass to writing functions</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="sd">        properties (List[str]): list of whole slide image properties to</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="sd">            extract. Needs to be parquet compatible (numeric).</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a><span class="sd">        dict: output paths and the number of features generated</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>    <span class="n">ofs</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>        <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>        <span class="o">**</span><span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>    <span class="p">)</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>    <span class="n">output_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;shape_features.parquet&quot;</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>    <span class="k">if</span> <span class="n">ofs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_fpath</span><span class="p">)):</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>            <span class="sa">f</span><span class="s2">&quot;Output file already exist: </span><span class="si">{</span><span class="n">ofs</span><span class="o">.</span><span class="n">unstrip_protocol</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_fpath</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="p">)</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>        <span class="k">return</span> <span class="p">{}</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tiles_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>        <span class="n">tiles_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">objects_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="n">object_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>        <span class="n">slide</span> <span class="o">=</span> <span class="n">tiffslide</span><span class="o">.</span><span class="n">TiffSlide</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>        <span class="n">slide_width</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>        <span class="n">slide_height</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="k">if</span> <span class="n">label_cols</span><span class="p">:</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>        <span class="n">tiles_df</span><span class="p">[</span><span class="s2">&quot;Classification&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tiles_df</span><span class="p">[</span><span class="n">label_cols</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="n">LabeledTileSchema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">tiles_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">())</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>    <span class="n">tile_area</span> <span class="o">=</span> <span class="n">tiles_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tile_size</span> <span class="o">**</span> <span class="mi">2</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>    <span class="n">counts</span> <span class="o">=</span> <span class="n">tiles_df</span><span class="o">.</span><span class="n">Classification</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>    <span class="n">combis</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>    <span class="n">joint_entropy</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">combis</span><span class="p">:</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>        <span class="n">ent</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>        <span class="n">ent</span><span class="p">[</span><span class="s2">&quot;Parent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;whole_region&quot;</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>        <span class="n">ent</span><span class="p">[</span><span class="s2">&quot;Class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="n">ent</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Joint Entropy to </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>        <span class="n">ent</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entropy</span><span class="p">(</span><span class="n">counts</span><span class="p">[[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]],</span> <span class="n">base</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>        <span class="n">joint_entropy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ent</span><span class="p">)</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>    <span class="n">entropy_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">joint_entropy</span><span class="p">)</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>    <span class="n">shannon_entropy</span> <span class="o">=</span> <span class="n">entropy</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>    <span class="n">entropy_df</span> <span class="o">=</span> <span class="n">entropy_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>        <span class="p">{</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>            <span class="s2">&quot;Parent&quot;</span><span class="p">:</span> <span class="s2">&quot;whole_region&quot;</span><span class="p">,</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>            <span class="s2">&quot;Class&quot;</span><span class="p">:</span> <span class="s2">&quot;All&quot;</span><span class="p">,</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>            <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="s2">&quot;Entropy&quot;</span><span class="p">,</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">shannon_entropy</span><span class="p">,</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>        <span class="p">},</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>        <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>    <span class="p">)</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>    <span class="n">slide_area</span> <span class="o">=</span> <span class="n">counts</span> <span class="o">*</span> <span class="n">tile_area</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>    <span class="n">slide_area</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Parent&quot;</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>    <span class="n">mask</span><span class="p">,</span> <span class="n">mask_values</span> <span class="o">=</span> <span class="n">convert_tiles_to_mask</span><span class="p">(</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>        <span class="n">tiles_df</span><span class="p">,</span> <span class="n">slide_width</span><span class="p">,</span> <span class="n">slide_height</span><span class="p">,</span> <span class="s2">&quot;Classification&quot;</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>    <span class="p">)</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>    <span class="n">resized_mask</span> <span class="o">=</span> <span class="n">resize_array</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">resize_factor</span><span class="p">)</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>    <span class="n">shape_features_df</span> <span class="o">=</span> <span class="n">extract_shape_features</span><span class="p">(</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>        <span class="n">resized_mask</span><span class="p">,</span> <span class="n">mask_values</span><span class="p">,</span> <span class="n">include_smaller_regions</span><span class="p">,</span> <span class="n">properties</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>    <span class="p">)</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>    <span class="n">ann_region_polygons</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>        <span class="n">box</span><span class="p">(</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>            <span class="n">row</span><span class="o">.</span><span class="n">x_coord</span><span class="p">,</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>            <span class="n">row</span><span class="o">.</span><span class="n">y_coord</span><span class="p">,</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>            <span class="n">row</span><span class="o">.</span><span class="n">x_coord</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">xy_extent</span><span class="p">,</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>            <span class="n">row</span><span class="o">.</span><span class="n">y_coord</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">xy_extent</span><span class="p">,</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>        <span class="p">)</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tiles_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>    <span class="p">]</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>    <span class="n">tiles_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>        <span class="n">data</span><span class="o">=</span><span class="n">tiles_df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">ann_region_polygons</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;EPSG:4326&quot;</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>    <span class="p">)</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Spatially joining tiles and objects&quot;</span><span class="p">)</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>    <span class="n">gdf</span> <span class="o">=</span> <span class="n">object_gdf</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">tiles_gdf</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;within&quot;</span><span class="p">)</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No objects found within tiles&quot;</span><span class="p">)</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>        <span class="n">measurement_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>        <span class="n">measurements</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>        <span class="p">)</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>        <span class="n">measurement_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">measurements</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">measurements</span><span class="p">)</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">classification</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Class&quot;</span><span class="p">,</span> <span class="s2">&quot;Classification&quot;</span><span class="p">:</span> <span class="s2">&quot;Parent&quot;</span><span class="p">})</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>    <span class="n">gdf</span><span class="o">.</span><span class="n">Parent</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">Parent</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>    <span class="n">gdf</span><span class="o">.</span><span class="n">Class</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>    <span class="k">if</span> <span class="n">detection_probability_threshold</span><span class="p">:</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`Detection probability` &gt; </span><span class="si">{</span><span class="n">detection_probability_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>    <span class="n">agg_keys</span> <span class="o">=</span> <span class="n">measurement_keys</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>    <span class="n">agg_keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;Detection probability&quot;</span><span class="p">)</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating object measurement statistics&quot;</span><span class="p">)</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>    <span class="n">gb</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Parent&quot;</span><span class="p">,</span> <span class="s2">&quot;Class&quot;</span><span class="p">])[</span><span class="n">agg_keys</span><span class="p">]</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>    <span class="n">agg_funs</span> <span class="o">=</span> <span class="n">STATISTICAL_DESCRIPTOR_MAP</span><span class="p">[</span><span class="n">statistical_descriptors</span><span class="p">]</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>    <span class="n">agg_df</span> <span class="o">=</span> <span class="n">gb</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg_funs</span><span class="p">)</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>    <span class="n">agg_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">agg_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>    <span class="n">cell_density</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>    <span class="k">if</span> <span class="s2">&quot;Cell: Area m^2 sum&quot;</span> <span class="ow">in</span> <span class="n">agg_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>        <span class="n">cell_density</span> <span class="o">=</span> <span class="n">agg_df</span><span class="p">[</span><span class="s2">&quot;Cell: Area m^2 sum&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">slide_area</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>    <span class="k">if</span> <span class="n">cellular_features</span> <span class="o">!=</span> <span class="n">CellularFeatures</span><span class="o">.</span><span class="n">ALL</span><span class="p">:</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>        <span class="n">agg_df</span> <span class="o">=</span> <span class="n">agg_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="n">cellular_features</span><span class="p">)</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>    <span class="k">if</span> <span class="n">property_type</span> <span class="o">!=</span> <span class="n">PropertyType</span><span class="o">.</span><span class="n">ALL</span><span class="p">:</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>        <span class="n">property_types</span> <span class="o">=</span> <span class="n">PROPERTY_TYPE_MAP</span><span class="p">[</span><span class="n">property_type</span><span class="p">]</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>        <span class="n">agg_df</span> <span class="o">=</span> <span class="n">agg_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">property_types</span><span class="p">))</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>    <span class="n">agg_df</span><span class="p">[</span><span class="s2">&quot;Object Counts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gb</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>    <span class="n">agg_df</span><span class="p">[</span><span class="s2">&quot;Normalized Cell Density&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg_df</span><span class="p">[</span><span class="s2">&quot;Object Counts&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">slide_area</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>    <span class="k">if</span> <span class="n">cell_density</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>        <span class="n">agg_df</span><span class="p">[</span><span class="s2">&quot;Cell Density&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_density</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>        <span class="s2">&quot;Calculating obj count log ratios between all tile label obj classification groups&quot;</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>    <span class="p">)</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>    <span class="n">count_col</span> <span class="o">=</span> <span class="n">agg_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s2">&quot;Object Counts&quot;</span><span class="p">)</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>    <span class="n">idx0</span><span class="p">,</span> <span class="n">idx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">agg_df</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>    <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>    <span class="n">ratio_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>            <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>                <span class="p">[</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>                    <span class="s2">&quot;Object Count Log Ratio to &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">agg_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>                <span class="p">]</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>            <span class="p">)[</span><span class="n">idx1</span><span class="p">],</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">agg_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx0</span><span class="p">,</span> <span class="n">count_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>            <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">agg_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx1</span><span class="p">,</span> <span class="n">count_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>        <span class="p">},</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>        <span class="n">index</span><span class="o">=</span><span class="n">agg_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">idx0</span><span class="p">],</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>    <span class="p">)</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>    <span class="n">mdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">agg_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Parent&quot;</span><span class="p">,</span> <span class="s2">&quot;Class&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>    <span class="n">mdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">mdf</span><span class="p">,</span> <span class="n">ratio_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="n">shape_features_df</span><span class="p">,</span> <span class="n">entropy_df</span><span class="p">])</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>    <span class="k">if</span> <span class="n">slide_id</span><span class="p">:</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>        <span class="n">mdf</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s2">&quot;slide_id&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">slide_id</span><span class="p">)</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>    <span class="n">mdf</span><span class="p">[[</span><span class="s2">&quot;Parent&quot;</span><span class="p">,</span> <span class="s2">&quot;Class&quot;</span><span class="p">,</span> <span class="s2">&quot;variable&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mdf</span><span class="p">[[</span><span class="s2">&quot;Parent&quot;</span><span class="p">,</span> <span class="s2">&quot;Class&quot;</span><span class="p">,</span> <span class="s2">&quot;variable&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>        <span class="sa">r</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>    <span class="p">)</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>    <span class="k">with</span> <span class="n">ofs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_fpath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>        <span class="n">mdf</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>    <span class="n">props</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>        <span class="s2">&quot;shape_features_url&quot;</span><span class="p">:</span> <span class="n">ofs</span><span class="o">.</span><span class="n">unstrip_protocol</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_fpath</span><span class="p">)),</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>        <span class="s2">&quot;num_features&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">mdf</span><span class="p">),</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>    <span class="p">}</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>    <span class="k">return</span> <span class="n">props</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.extract_tile_shape_features.cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">cli</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">object_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">tiles_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">resize_factor</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">detection_probability_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">statistical_descriptors</span><span class="o">=</span><span class="n">StatisticalDescriptors</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">cellular_features</span><span class="o">=</span><span class="n">CellularFeatures</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">property_type</span><span class="o">=</span><span class="n">PropertyType</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">include_smaller_regions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.extract_tile_shape_features.cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Extracts shape and spatial features (HIF features) from a slide mask.</p>
<p>Args:
    slide_urlpath (str): URL/path to slide (tiffslide supported formats)
    object_urlpath (str): URL/path to object file (geopandas supported formats)
    tiles_urlpath (str): URL/path to tiles manifest (parquet)
    output_urlpath (str): URL/path to output parquet file
    resize_factor (int): factor to downsample slide image
    detection_probability_threshold (Optional[float]): detection probability threshold
    statistical_descriptors (str): statistical descriptors to calculate. One of All, Quantiles, Stats, or Density
    cellular_features (str): cellular features to include. One of All, Nucleus, Cell, Cytoplasm, and Membrane
    property_type (str): properties to include. One of All, Geometric, or Stain
    include_smaller_regions (bool): include smaller regions in output
    label_cols (List[str]): list of score columns to use for the classification. Tile is classified as the column with the max score
    storage_options (dict): storage options to pass to reading functions
    output_storage_options (dict): storage options to pass to writing functions
    local_config (str): local config yaml file</p>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output paths and the number of features generated</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/extract_tile_shape_features.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="nd">@timed</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="k">def</span> <span class="nf">cli</span><span class="p">(</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="n">slide_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="n">object_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="n">tiles_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="n">resize_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="n">detection_probability_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="n">statistical_descriptors</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">StatisticalDescriptors</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="n">cellular_features</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">CellularFeatures</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="n">property_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PropertyType</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="n">include_smaller_regions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="n">label_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="p">):</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Extracts shape and spatial features (HIF features) from a slide mask.</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">     Args:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">        slide_urlpath (str): URL/path to slide (tiffslide supported formats)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">        object_urlpath (str): URL/path to object file (geopandas supported formats)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">        tiles_urlpath (str): URL/path to tiles manifest (parquet)</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">        output_urlpath (str): URL/path to output parquet file</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">        resize_factor (int): factor to downsample slide image</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">        detection_probability_threshold (Optional[float]): detection probability threshold</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">        statistical_descriptors (str): statistical descriptors to calculate. One of All, Quantiles, Stats, or Density</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">        cellular_features (str): cellular features to include. One of All, Nucleus, Cell, Cytoplasm, and Membrane</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">        property_type (str): properties to include. One of All, Geometric, or Stain</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="sd">        include_smaller_regions (bool): include smaller regions in output</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">        label_cols (List[str]): list of score columns to use for the classification. Tile is classified as the column with the max score</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">        storage_options (dict): storage options to pass to reading functions</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">        output_storage_options (dict): storage options to pass to writing functions</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">        local_config (str): local config yaml file</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">        dict: output paths and the number of features generated</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="n">slide_id</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_urlpath&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">stem</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="n">statistical_descriptors</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;statistical_descriptors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="n">cellular_features</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;cellular_features&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>    <span class="n">property_type</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;property_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>    <span class="n">properties</span> <span class="o">=</span> <span class="n">__extract_tile_shape_features</span><span class="p">(</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;object_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tiles_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;resize_factor&quot;</span><span class="p">],</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;detection_probability_threshold&quot;</span><span class="p">],</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="n">slide_id</span><span class="p">,</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="n">statistical_descriptors</span><span class="p">,</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="n">cellular_features</span><span class="p">,</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="n">property_type</span><span class="p">,</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;include_smaller_regions&quot;</span><span class="p">],</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;label_cols&quot;</span><span class="p">],</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="p">)</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>    <span class="k">return</span> <span class="n">properties</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.extract_tile_shape_features.extract_tile_shape_features" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">extract_tile_shape_features</span><span class="p">(</span><span class="n">slide_manifest</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">resize_factor</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">detection_probability_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">statistical_descriptors</span><span class="o">=</span><span class="n">StatisticalDescriptors</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">cellular_features</span><span class="o">=</span><span class="n">CellularFeatures</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">property_type</span><span class="o">=</span><span class="n">PropertyType</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">include_smaller_regions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">objects_column</span><span class="o">=</span><span class="s1">&#39;stardist_geojson_url&#39;</span><span class="p">,</span> <span class="n">annotation_column</span><span class="o">=</span><span class="s1">&#39;tile_shape_features_url&#39;</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="s1">&#39;convex_area&#39;</span><span class="p">,</span> <span class="s1">&#39;eccentricity&#39;</span><span class="p">,</span> <span class="s1">&#39;equivalent_diameter&#39;</span><span class="p">,</span> <span class="s1">&#39;euler_number&#39;</span><span class="p">,</span> <span class="s1">&#39;extent&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;major_axis_length&#39;</span><span class="p">,</span> <span class="s1">&#39;minor_axis_length&#39;</span><span class="p">,</span> <span class="s1">&#39;perimeter&#39;</span><span class="p">,</span> <span class="s1">&#39;solidity&#39;</span><span class="p">])</span></code>

<a href="#luna.pathology.cli.extract_tile_shape_features.extract_tile_shape_features" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Extracts shape and spatial features (HIF features) from a slide mask.</p>
<p>Args:
    slide_manifest (DataFrame[SlideSchema]): slide manifest from slide_etl
    output_urlpath (str): output URL/path
    resize_factor (int): factor to downsample slide image
    detection_probability_threshold (Optional[float]): detection probability threshold
    statistical_descriptors (str): statistical descriptors to calculate. One of All, Quantiles, Stats, or Density
    cellular_features (str): cellular features to include. One of All, Nucleus, Cell, Cytoplasm, and Membrane
    property_type (str): properties to include. One of All, Geometric, or Stain
    include_smaller_regions (bool): include smaller regions in output
    label_cols (List[str]): list of score columns to use for the classification. Tile is classified as the column with the max score
    storage_options (dict): storage options to pass to reading functions
    output_storage_options (dict): storage options to pass to writing functions
    local_config (str): local config yaml file
    objects_column (str): slide manifest column name with stardist geoJSON URLs
    annotation_column (str): column to add to slide manifest with url to extracted features
    properties (List[str]): properties to extract</p>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DataFrame[SlideSchema]: slide manifest</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/extract_tile_shape_features.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="k">def</span> <span class="nf">extract_tile_shape_features</span><span class="p">(</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="n">slide_manifest</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">SlideSchema</span><span class="p">],</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="n">resize_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>    <span class="n">detection_probability_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>    <span class="n">statistical_descriptors</span><span class="p">:</span> <span class="n">StatisticalDescriptors</span> <span class="o">=</span> <span class="n">StatisticalDescriptors</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="n">cellular_features</span><span class="p">:</span> <span class="n">CellularFeatures</span> <span class="o">=</span> <span class="n">CellularFeatures</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>    <span class="n">property_type</span><span class="p">:</span> <span class="n">PropertyType</span> <span class="o">=</span> <span class="n">PropertyType</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="n">include_smaller_regions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="n">label_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="n">objects_column</span><span class="o">=</span><span class="s2">&quot;stardist_geojson_url&quot;</span><span class="p">,</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="n">annotation_column</span><span class="o">=</span><span class="s2">&quot;tile_shape_features_url&quot;</span><span class="p">,</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>    <span class="n">properties</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="s2">&quot;area&quot;</span><span class="p">,</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="s2">&quot;convex_area&quot;</span><span class="p">,</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="s2">&quot;eccentricity&quot;</span><span class="p">,</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="s2">&quot;equivalent_diameter&quot;</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="s2">&quot;euler_number&quot;</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="s2">&quot;extent&quot;</span><span class="p">,</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="s2">&quot;label&quot;</span><span class="p">,</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="s2">&quot;major_axis_length&quot;</span><span class="p">,</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="s2">&quot;minor_axis_length&quot;</span><span class="p">,</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="s2">&quot;perimeter&quot;</span><span class="p">,</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>        <span class="s2">&quot;solidity&quot;</span><span class="p">,</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>    <span class="p">],</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="p">):</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Extracts shape and spatial features (HIF features) from a slide mask.</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">     Args:</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">        slide_manifest (DataFrame[SlideSchema]): slide manifest from slide_etl</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">        output_urlpath (str): output URL/path</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">        resize_factor (int): factor to downsample slide image</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">        detection_probability_threshold (Optional[float]): detection probability threshold</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">        statistical_descriptors (str): statistical descriptors to calculate. One of All, Quantiles, Stats, or Density</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">        cellular_features (str): cellular features to include. One of All, Nucleus, Cell, Cytoplasm, and Membrane</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">        property_type (str): properties to include. One of All, Geometric, or Stain</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="sd">        include_smaller_regions (bool): include smaller regions in output</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="sd">        label_cols (List[str]): list of score columns to use for the classification. Tile is classified as the column with the max score</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">        storage_options (dict): storage options to pass to reading functions</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">        output_storage_options (dict): storage options to pass to writing functions</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="sd">        local_config (str): local config yaml file</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">        objects_column (str): slide manifest column name with stardist geoJSON URLs</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="sd">        annotation_column (str): column to add to slide manifest with url to extracted features</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">        properties (List[str]): properties to extract</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a><span class="sd">        DataFrame[SlideSchema]: slide manifest</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">get_or_create_dask_client</span><span class="p">()</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="n">future</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="n">__extract_tile_shape_features</span><span class="p">,</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>            <span class="n">row</span><span class="p">[</span><span class="n">objects_column</span><span class="p">],</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;tiles_url&quot;</span><span class="p">],</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">],</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>            <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>            <span class="n">resize_factor</span><span class="p">,</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>            <span class="n">detection_probability_threshold</span><span class="p">,</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>            <span class="n">statistical_descriptors</span><span class="p">,</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>            <span class="n">cellular_features</span><span class="p">,</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>            <span class="n">property_type</span><span class="p">,</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>            <span class="n">include_smaller_regions</span><span class="p">,</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="n">label_cols</span><span class="p">,</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>            <span class="n">storage_options</span><span class="p">,</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>            <span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>            <span class="n">properties</span><span class="p">,</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>        <span class="p">)</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>        <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>    <span class="n">progress</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>    <span class="k">return</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>        <span class="o">**</span><span class="p">{</span><span class="n">annotation_column</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;shape_features_url&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]}</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.cli.extract_tile_statistics" class="doc doc-heading">
          <code>extract_tile_statistics</code>


<a href="#luna.pathology.cli.extract_tile_statistics" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.extract_tile_statistics.cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">cli</span><span class="p">(</span><span class="n">tiles_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.extract_tile_statistics.cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Extracts statistics over tiles</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>tiles_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Tiles parquet file for slide(s). Absolute or relative filepath. Prefix with protocol to read from alternative filesystems</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Output prefix. Absolute or relative filepath. Prefix with protocol to write to alternative filesystems</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>extra options that make sense for reading from a particular storage connection</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>extra options that make sense for writing to a particular storage connection</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>local_config</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>local config yaml file</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/extract_tile_statistics.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="nd">@timed</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="k">def</span> <span class="nf">cli</span><span class="p">(</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="n">tiles_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="p">):</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Extracts statistics over tiles</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">        tiles_urlpath (str): Tiles parquet file for slide(s). Absolute or relative filepath. Prefix with protocol to read from alternative filesystems</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">        output_urlpath (str): Output prefix. Absolute or relative filepath. Prefix with protocol to write to alternative filesystems</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">        storage_options (dict): extra options that make sense for reading from a particular storage connection</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        output_storage_options (dict): extra options that make sense for writing to a particular storage connection</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        local_config (str): local config yaml file</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="n">df_feature_data</span> <span class="o">=</span> <span class="n">extract_tile_statistics</span><span class="p">(</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tiles_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="n">fs</span><span class="p">,</span> <span class="n">output_path_prefix</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">]</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="p">)</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="n">o</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tiles_urlpath&quot;</span><span class="p">])</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="nb">id</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="n">output_feature_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_path_prefix</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">_tile_stats.parquet&quot;</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">df_feature_data</span><span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_feature_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="n">df_feature_data</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;feature_data&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_feature_file</span><span class="p">)}</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="k">return</span> <span class="n">properties</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.extract_tile_statistics.extract_tile_statistics" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">extract_tile_statistics</span><span class="p">(</span><span class="n">tiles_urlpath</span><span class="p">,</span> <span class="n">storage_options</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.extract_tile_statistics.extract_tile_statistics" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Extracts statistics over tiles</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>tiles_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Tiles parquet file for slide(s). Absolute or relative filepath. Prefix with protocol to read from alternative filesystems</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Output prefix. Absolute or relative filepath. Prefix with protocol to write to alternative filesystems</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>extra options that make sense for reading from a particular storage connection</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>extra options that make sense for writing to a particular storage connection</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>pd.DataFrame: metadata about function call</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/extract_tile_statistics.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span>
<span class="normal"><a href="#__codelineno-0-92">92</a></span>
<span class="normal"><a href="#__codelineno-0-93">93</a></span>
<span class="normal"><a href="#__codelineno-0-94">94</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="k">def</span> <span class="nf">extract_tile_statistics</span><span class="p">(</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="n">tiles_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="p">):</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Extracts statistics over tiles</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">        tiles_urlpath (str): Tiles parquet file for slide(s). Absolute or relative filepath. Prefix with protocol to read from alternative filesystems</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">        output_urlpath (str): Output prefix. Absolute or relative filepath. Prefix with protocol to write to alternative filesystems</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">        storage_options (dict): extra options that make sense for reading from a particular storage connection</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">        output_storage_options (dict): extra options that make sense for writing to a particular storage connection</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">        pd.DataFrame: metadata about function call</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">tiles_urlpath</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_options</span><span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;address&quot;</span><span class="p">)</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="o">.</span><span class="n">drop</span><span class="p">(</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x_coord&quot;</span><span class="p">,</span> <span class="s2">&quot;y_coord&quot;</span><span class="p">,</span> <span class="s2">&quot;tile_size&quot;</span><span class="p">,</span> <span class="s2">&quot;xy_extent&quot;</span><span class="p">,</span> <span class="s2">&quot;tile_units&quot;</span><span class="p">],</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>            <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="p">)</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>    <span class="n">dict_feature_data</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="n">dict_feature_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>            <span class="n">luna</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">compute_stats_1d</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]),</span> <span class="n">col</span><span class="p">)</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="p">)</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>    <span class="n">df_feature_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">dict_feature_data</span><span class="p">])</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="k">return</span> <span class="n">df_feature_data</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.cli.generate_mask" class="doc doc-heading">
          <code>generate_mask</code>


<a href="#luna.pathology.cli.generate_mask" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.generate_mask.cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">cli</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">roi_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">annotation_name</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.generate_mask.cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Generate a full resolution mask image (.tif) from vector annotations (polygons, shapes)</p>
<p>
Inputs:
    input_slide_image: slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)
    input_slide_roi: roi containing vector shapes (<em>.annotations, </em>.json)

Outputs:
    slide_mask

Example:
    generate_mask ./slides/10001.svs ./halo/10001.job18484.annotations
        -an Tumor
        -o ./masks/10001/</p>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/generate_mask.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="nd">@timed</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="k">def</span> <span class="nf">cli</span><span class="p">(</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="n">slide_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="n">roi_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="p">):</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a full resolution mask image (.tif) from vector annotations (polygons, shapes)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    \b</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">    Inputs:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        input_slide_image: slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        input_slide_roi: roi containing vector shapes (*.annotations, *.json)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">    \b</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">    Outputs:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">        slide_mask</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    \b</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">        generate_mask ./slides/10001.svs ./halo/10001.job18484.annotations</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">            -an Tumor</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">            -o ./masks/10001/</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">generate_mask</span><span class="p">(</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;roi_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;annotation_name&quot;</span><span class="p">],</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="n">fs</span><span class="p">,</span> <span class="n">output_urlpath_prefix</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">]</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="p">)</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="n">output_filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_urlpath_prefix</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;mask_data.parquet&quot;</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="n">slide_id</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;roi_urlpath&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">stem</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="s2">&quot;slide_mask&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_urlpath_prefix</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;mask_full_res.tif&quot;</span><span class="p">,</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="s2">&quot;feature_data&quot;</span><span class="p">:</span> <span class="n">output_filename</span><span class="p">,</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="s2">&quot;mask_size&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mask_size&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="s2">&quot;segment_keys&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;slide_id&quot;</span><span class="p">:</span> <span class="n">slide_id</span><span class="p">},</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="p">}</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="k">return</span> <span class="n">properties</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.generate_mask.generate_mask" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">generate_mask</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="p">,</span> <span class="n">roi_urlpath</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">,</span> <span class="n">storage_options</span><span class="p">,</span> <span class="n">output_storage_options</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.generate_mask.generate_mask" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Generate a full resolution mask image (.tif) from vector annotations (polygons, shapes)</p>
<p>Take into account positive and negative spaces.  Essentially rasterizes a polygon file.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...) absolute or relative path. prefix with scheme to use alternative file systems.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>roi_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>halo or other polygonal annotation file (.xml, .geojson) absolute or relative path. prefix with scheme to use alternative file systems.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output/working absolute or relative path. prefix with scheme to use alternative file systems.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of annotation layer to use</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options that make sense for the file storage used</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>DataFrame</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>mask properties</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/generate_mask.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="nd">@local_cache_urlpath</span><span class="p">(</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="n">dir_key_write_mode</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="s2">&quot;output_urlpath&quot;</span><span class="p">:</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="p">}</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="k">def</span> <span class="nf">generate_mask</span><span class="p">(</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="n">slide_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="n">roi_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="p">):</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a full resolution mask image (.tif) from vector annotations (polygons, shapes)</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">    Take into account positive and negative spaces.  Essentially rasterizes a polygon file.</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">        slide_urlpath (str): slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...) absolute or relative path. prefix with scheme to use alternative file systems.</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">        roi_urlpath (str):  halo or other polygonal annotation file (.xml, .geojson) absolute or relative path. prefix with scheme to use alternative file systems.</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">        output_urlpath (str): output/working absolute or relative path. prefix with scheme to use alternative file systems.</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">        annotation_name (str): name of annotation layer to use</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">        storage_options (dict): storage options that make sense for the file storage used</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">        DataFrame: mask properties</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="n">mask_properties</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="n">slide</span> <span class="o">=</span> <span class="n">tiffslide</span><span class="o">.</span><span class="n">TiffSlide</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="n">thumbnail</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">get_thumbnail</span><span class="p">((</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">output_urlpath</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;slide_thumbnail.png&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="n">thumbnail</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;PNG&quot;</span><span class="p">)</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="n">wsi_shape</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="n">slide</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="n">slide</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="p">)</span>  <span class="c1"># Annotation file has flipped dimensions w.r.t openslide conventions</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slide shape=</span><span class="si">{</span><span class="n">wsi_shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>    <span class="n">layer_names</span> <span class="o">=</span> <span class="n">get_layer_names</span><span class="p">(</span><span class="n">roi_urlpath</span><span class="p">,</span> <span class="n">storage_options</span><span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Available layer names=</span><span class="si">{</span><span class="n">layer_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>    <span class="n">mask_properties</span><span class="p">[</span><span class="s2">&quot;layer_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">layer_names</span><span class="p">)</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>    <span class="n">mask_properties</span><span class="p">[</span><span class="s2">&quot;mask_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">wsi_shape</span><span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>    <span class="n">mask_arr</span><span class="p">,</span> <span class="n">xml_region_properties</span> <span class="o">=</span> <span class="n">convert_xml_to_mask</span><span class="p">(</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="n">roi_urlpath</span><span class="p">,</span> <span class="n">wsi_shape</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_options</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>    <span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>    <span class="n">mask_properties</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">xml_region_properties</span><span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating mask thumbnail, mask size=</span><span class="si">{</span><span class="n">mask_arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="n">mask_thumbnail</span> <span class="o">=</span> <span class="n">openslide</span><span class="o">.</span><span class="n">ImageSlide</span><span class="p">(</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>            <span class="mi">255</span> <span class="o">*</span> <span class="n">block_reduce</span><span class="p">(</span><span class="n">mask_arr</span><span class="p">,</span> <span class="n">block_size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">cval</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="p">)</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>    <span class="p">)</span><span class="o">.</span><span class="n">get_thumbnail</span><span class="p">((</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">output_urlpath</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;mask_thumbnail.png&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="n">mask_thumbnail</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;PNG&quot;</span><span class="p">)</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>    <span class="n">slide_mask_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_urlpath</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;mask_full_res.tif&quot;</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">slide_mask_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">mask_arr</span><span class="p">)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mask_properties</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.cli.generate_tile_labels" class="doc doc-heading">
          <code>generate_tile_labels</code>


<a href="#luna.pathology.cli.generate_tile_labels" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.generate_tile_labels.cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">cli</span><span class="p">(</span><span class="n">annotation_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">tiles_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">slide_id</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.generate_tile_labels.cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Queries the dataset at input_slide_annotation_dataset for a slide_id matching input_slide_tiles</p>
<p>Adds regional_label, intersection_area columns to slide tiles, where the former is the annotation label, and the latter the fraction of intersecting area between the tile and annotation regions</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>annotation_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to parquet annotation dataset</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>tiles_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to a slide-tile manifest file (.tiles.parquet)</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>slide_id</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slide ID</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output url/path prefix</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>options to pass to reading functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>options to pass to writing functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>local_config</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to local config YAML file</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    dict: metadata</p>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/generate_tile_labels.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="nd">@timed</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="k">def</span> <span class="nf">cli</span><span class="p">(</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="n">annotation_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="n">tiles_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="n">slide_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="p">):</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Queries the dataset at input_slide_annotation_dataset for a slide_id matching input_slide_tiles</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    Adds regional_label, intersection_area columns to slide tiles, where the former is the annotation label, and the latter the fraction of intersecting area between the tile and annotation regions</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        annotation_urlpath (str): url/path to parquet annotation dataset</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">        tiles_urlpath (str): url/path to a slide-tile manifest file (.tiles.parquet)</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        slide_id (str): slide ID</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        output_urlpath (str): output url/path prefix</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        storage_options (dict): options to pass to reading functions</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">        output_storage_options (dict): options to pass to writing functions</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">        local_config (str): url/path to local config YAML file</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">        dict: metadata</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="n">df_tiles</span> <span class="o">=</span> <span class="n">generate_tile_labels</span><span class="p">(</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;annotation_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tiles_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">],</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="n">fs</span><span class="p">,</span> <span class="n">output_urlpath_prefix</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">]</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="n">output_header_file</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="n">Path</span><span class="p">(</span><span class="n">output_urlpath_prefix</span><span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;slide_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.regional_label.tiles.parquet&quot;</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="p">)</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_header_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="n">df_tiles</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="s2">&quot;slide_tiles&quot;</span><span class="p">:</span> <span class="n">output_header_file</span><span class="p">,</span>  <span class="c1"># &quot;Tiles&quot; are the metadata that describe them</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="p">}</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="k">return</span> <span class="n">properties</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.generate_tile_labels.generate_tile_labels" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">generate_tile_labels</span><span class="p">(</span><span class="n">annotation_urlpath</span><span class="p">,</span> <span class="n">tiles_urlpath</span><span class="p">,</span> <span class="n">slide_id</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.generate_tile_labels.generate_tile_labels" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Queries the dataset at input_slide_annotation_dataset for a slide_id matching input_slide_tiles</p>
<p>Adds regional_label, intersection_area columns to slide tiles, where the former is the annotation label, and the latter the fraction of intersecting area between the tile and annotation regions</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>annotation_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to parquet annotation dataset</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tiles_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to a slide-tile manifest file (.tiles.parquet)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>slide_id</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slide ID</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>options to pass to reading functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    pd.DataFrame: tile dataframe with regional_label, and intersection_area columns</p>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/generate_tile_labels.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="k">def</span> <span class="nf">generate_tile_labels</span><span class="p">(</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>    <span class="n">annotation_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="n">tiles_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="n">slide_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="p">):</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Queries the dataset at input_slide_annotation_dataset for a slide_id matching input_slide_tiles</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">    Adds regional_label, intersection_area columns to slide tiles, where the former is the annotation label, and the latter the fraction of intersecting area between the tile and annotation regions</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">        annotation_urlpath (str): url/path to parquet annotation dataset</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">        tiles_urlpath (str): url/path to a slide-tile manifest file (.tiles.parquet)</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">        slide_id (str): slide ID</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">        storage_options (dict): options to pass to reading functions</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">        pd.DataFrame: tile dataframe with regional_label, and intersection_area columns</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="n">slide_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">slide_id</span><span class="p">)</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;slide_id=</span><span class="si">{</span><span class="n">slide_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">annotation_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="n">df_annotation</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="k">if</span> <span class="n">slide_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_annotation</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No matching annotations found for slide!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="n">df_annotation</span> <span class="o">=</span> <span class="n">df_annotation</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">slide_id</span><span class="p">]]</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;type==&#39;geojson&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_annotation</span><span class="p">):</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No matching geojson annotations found!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="n">slide_geojson</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">annotation_name</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="n">df_annotation</span><span class="o">.</span><span class="n">slide_geojson</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="n">df_annotation</span><span class="o">.</span><span class="n">collection_name</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="n">df_annotation</span><span class="o">.</span><span class="n">annotation_name</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>    <span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">slide_geojson</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">slide_geojson</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="n">features</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="s2">&quot;features&quot;</span><span class="p">]</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="n">d_collections</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="n">label</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d_collections</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="n">d_collections</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="n">d_collections</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">feature</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">d_collections</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="n">d_collections</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">GeometryCollection</span><span class="p">(</span><span class="n">d_collections</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tiles_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="n">df_tiles</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;address&quot;</span><span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="n">l_regional_labels</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="n">l_intersection_areas</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">df_tiles</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df_tiles</span><span class="p">)):</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="n">tile_x</span><span class="p">,</span> <span class="n">tile_y</span><span class="p">,</span> <span class="n">tile_extent</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">x_coord</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">y_coord</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">xy_extent</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="n">tile_polygon</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>            <span class="p">[</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>                <span class="p">(</span><span class="n">tile_x</span><span class="p">,</span> <span class="n">tile_y</span><span class="p">),</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>                <span class="p">(</span><span class="n">tile_x</span><span class="p">,</span> <span class="n">tile_y</span> <span class="o">+</span> <span class="n">tile_extent</span><span class="p">),</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                <span class="p">(</span><span class="n">tile_x</span> <span class="o">+</span> <span class="n">tile_extent</span><span class="p">,</span> <span class="n">tile_y</span> <span class="o">+</span> <span class="n">tile_extent</span><span class="p">),</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>                <span class="p">(</span><span class="n">tile_x</span> <span class="o">+</span> <span class="n">tile_extent</span><span class="p">,</span> <span class="n">tile_y</span><span class="p">),</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>            <span class="p">]</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="p">)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="n">tile_label</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="n">max_overlap</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">d_collections</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>            <span class="n">intersection_area</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>                <span class="n">d_collections</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">tile_polygon</span><span class="p">)</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">tile_polygon</span><span class="o">.</span><span class="n">area</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>            <span class="p">)</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>            <span class="k">if</span> <span class="n">intersection_area</span> <span class="o">&gt;</span> <span class="n">max_overlap</span><span class="p">:</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                <span class="n">tile_label</span><span class="p">,</span> <span class="n">max_overlap</span> <span class="o">=</span> <span class="n">label</span><span class="p">,</span> <span class="n">intersection_area</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="n">l_regional_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tile_label</span><span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="n">l_intersection_areas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_overlap</span><span class="p">)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>    <span class="n">df_tiles</span><span class="p">[</span><span class="s2">&quot;regional_label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_regional_labels</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>    <span class="n">df_tiles</span><span class="p">[</span><span class="s2">&quot;intersection_area&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_intersection_areas</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">df_tiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_tiles</span><span class="o">.</span><span class="n">intersection_area</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>    <span class="k">return</span> <span class="n">df_tiles</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.cli.generate_tile_mask" class="doc doc-heading">
          <code>generate_tile_mask</code>


<a href="#luna.pathology.cli.generate_tile_mask" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.generate_tile_mask.cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">cli</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">tiles_urlpath</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">label_cols</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.generate_tile_mask.cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Converts categorical tile labels to a slide image mask. This mask can be used for feature extraction and spatial analysis.</p>
<p>Args:
    slide_urlpath (str): url/path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)
    tiles_urlpath (str): url/path to valid SlideTiles table
    label_cols (List[str]): list of label columns in the input_slide_tiles table to generate the mask with
    output_urlpath (str): output url/path prefix
    storage_options (dict): storage options to pass to reading functions
    output_storage_options (dict): storage options to pass to writing functions</p>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output properties</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/generate_tile_mask.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="nd">@timed</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="k">def</span> <span class="nf">cli</span><span class="p">(</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="n">slide_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="n">tiles_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="n">label_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="p">):</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts categorical tile labels to a slide image mask. This mask can be used for feature extraction and spatial analysis.</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">     Args:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        slide_urlpath (str): url/path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">        tiles_urlpath (str): url/path to valid SlideTiles table</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        label_cols (List[str]): list of label columns in the input_slide_tiles table to generate the mask with</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        output_urlpath (str): output url/path prefix</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        storage_options (dict): storage options to pass to reading functions</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">        output_storage_options (dict): storage options to pass to writing functions</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">        dict: output properties</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading SlideTiles&quot;</span><span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tiles_urlpath&quot;</span><span class="p">],</span> <span class="s2">&quot;rb&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">])</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="n">tiles_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;address&quot;</span><span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_urlpath&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">])</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="n">slide</span> <span class="o">=</span> <span class="n">tiffslide</span><span class="o">.</span><span class="n">TiffSlide</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="n">slide_width</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="n">slide_height</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="n">mask_arr</span><span class="p">,</span> <span class="n">mask_values</span> <span class="o">=</span> <span class="n">convert_tiles_to_mask</span><span class="p">(</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="n">tiles_df</span><span class="p">,</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="n">slide_width</span><span class="p">,</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="n">slide_height</span><span class="p">,</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;label_cols&quot;</span><span class="p">],</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="p">)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="n">fs</span><span class="p">,</span> <span class="n">output_path</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">])</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="n">slide_mask</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;tile_mask.tif&quot;</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="s2">&quot;slide_mask&quot;</span><span class="p">:</span> <span class="n">fs</span><span class="o">.</span><span class="n">unstrip_protocol</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">slide_mask</span><span class="p">)),</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="s2">&quot;mask_values&quot;</span><span class="p">:</span> <span class="n">mask_values</span><span class="p">,</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="s2">&quot;mask_size&quot;</span><span class="p">:</span> <span class="n">mask_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>    <span class="p">}</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="k">return</span> <span class="n">properties</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.generate_tile_mask.convert_tiles_to_mask" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">convert_tiles_to_mask</span><span class="p">(</span><span class="n">tiles_df</span><span class="p">,</span> <span class="n">slide_width</span><span class="p">,</span> <span class="n">slide_height</span><span class="p">,</span> <span class="n">label_cols</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.generate_tile_mask.convert_tiles_to_mask" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Converts categorical tile labels to a slide image mask. This mask can be used for feature extraction and spatial analysis.</p>
<p>Args:
    tiles_df (pd.DataFrame): url/path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)
    slide_width (int): slide width
    slide_height (int): slide height
    label_cols (Union[str, List[str]]): column with labels or list of label columns in the tiles_urlpath table to generate the mask with</p>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>np.ndarray, Dict[int, str]: image mask, mask value mapping</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/generate_tile_mask.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="nd">@multimethod</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="nd">@local_cache_urlpath</span><span class="p">(</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="n">dir_key_write_mode</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">:</span> <span class="s2">&quot;w&quot;</span><span class="p">},</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="p">)</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="k">def</span> <span class="nf">convert_tiles_to_mask</span><span class="p">(</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="n">tiles_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="n">slide_width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="n">slide_height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>    <span class="n">label_cols</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="p">):</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts categorical tile labels to a slide image mask. This mask can be used for feature extraction and spatial analysis.</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="sd">     Args:</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">        tiles_df (pd.DataFrame): url/path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">        slide_width (int): slide width</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">        slide_height (int): slide height</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">        label_cols (Union[str, List[str]]): column with labels or list of label columns in the tiles_urlpath table to generate the mask with</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">        np.ndarray, Dict[int, str]: image mask, mask value mapping</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="n">TileSchema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">tiles_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">())</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>    <span class="n">mask_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">slide_height</span><span class="p">,</span> <span class="n">slide_width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">label_cols</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="n">uniques</span> <span class="o">=</span> <span class="n">tiles_df</span><span class="p">[</span><span class="n">label_cols</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="n">tiles_df</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tiles_df</span><span class="p">[</span><span class="n">label_cols</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="n">mask_values</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">uniques</span><span class="p">)}</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="n">tiles_df</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tiles_df</span><span class="p">[</span><span class="n">label_cols</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="n">tiles_df</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tiles_df</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>    <span class="n">mask_values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">tiles_df</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">],</span> <span class="n">tiles_df</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mapping label column to mask values: </span><span class="si">{</span><span class="n">mask_values</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>    <span class="k">for</span> <span class="n">address</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tiles_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">extent</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">x_coord</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">y_coord</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">xy_extent</span><span class="p">)</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="n">value</span> <span class="o">=</span> <span class="n">mask_values</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]]</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="c1"># permuted rows and columns due to differences in indexing between openslide and skimage/numpy</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="n">mask_arr</span><span class="p">[</span><span class="n">y</span> <span class="p">:</span> <span class="n">y</span> <span class="o">+</span> <span class="n">extent</span><span class="p">,</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">extent</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="k">if</span> <span class="n">output_urlpath</span><span class="p">:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="n">slide_mask</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_urlpath</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;tile_mask.tif&quot;</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving output mask to </span><span class="si">{</span><span class="n">slide_mask</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">slide_mask</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>            <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">mask_arr</span><span class="p">)</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>    <span class="k">return</span> <span class="n">mask_arr</span><span class="p">,</span> <span class="n">mask_values</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.cli.generate_tiles" class="doc doc-heading">
          <code>generate_tiles</code>


<a href="#luna.pathology.cli.generate_tiles" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.generate_tiles.__generate_tiles" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">__generate_tiles</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">requested_magnification</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.generate_tiles.__generate_tiles" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Rasterize a slide into smaller tiles</p>
<p>Tiles addresses and arrays are saved as key-value pairs in (tiles.h5),
and the corresponding manifest/header file (tiles.csv) is also generated</p>
<p>Necessary data for the manifest file are:
address, tile_image_file, full_resolution_tile_size, tile_image_size_xy</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slide url/path</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tile_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>size of tiles to use (at the requested magnification)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>requested_magnification</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Magnification scale at which to perform computation</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DataFrame[TileSchema]: tile manifest</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/generate_tiles.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="k">def</span> <span class="nf">__generate_tiles</span><span class="p">(</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="n">slide_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="n">tile_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="n">requested_magnification</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Rasterize a slide into smaller tiles</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">    Tiles addresses and arrays are saved as key-value pairs in (tiles.h5),</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">    and the corresponding manifest/header file (tiles.csv) is also generated</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">    Necessary data for the manifest file are:</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="sd">    address, tile_image_file, full_resolution_tile_size, tile_image_size_xy</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="sd">        slide_urlpath (str): slide url/path</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="sd">        tile_size (int): size of tiles to use (at the requested magnification)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">        requested_magnification (float): Magnification scale at which to perform computation</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="sd">        DataFrame[TileSchema]: tile manifest</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>    <span class="n">slide_id</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>    <span class="n">ofs</span><span class="p">,</span> <span class="n">output_path</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span><span class="n">output_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">output_storage_options</span><span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>    <span class="n">output_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">slide_id</span><span class="si">}</span><span class="s2">.tiles.parquet&quot;</span><span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="n">ofs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_file</span><span class="p">):</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Output file exists: {ofs.unstrip_protocol(output_file)}&quot;</span><span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="k">return</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="k">with</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="n">slide</span> <span class="o">=</span> <span class="n">TiffSlide</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slide size = [</span><span class="si">{</span><span class="n">slide</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">slide</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="n">to_mag_scale_factor</span> <span class="o">=</span> <span class="n">get_scale_factor_at_magnification</span><span class="p">(</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>            <span class="n">slide</span><span class="p">,</span> <span class="n">requested_magnification</span><span class="o">=</span><span class="n">requested_magnification</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>        <span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">to_mag_scale_factor</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bad magnfication scale factor = </span><span class="si">{</span><span class="n">to_mag_scale_factor</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                <span class="s2">&quot;You chose a combination of requested tile sizes and magnification that resulted in non-integer tile sizes at different scales&quot;</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="p">)</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="n">full_resolution_tile_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tile_size</span> <span class="o">*</span> <span class="n">to_mag_scale_factor</span><span class="p">)</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>            <span class="sa">f</span><span class="s2">&quot;Normalized magnification scale factor for </span><span class="si">{</span><span class="n">requested_magnification</span><span class="si">}</span><span class="s2">x is </span><span class="si">{</span><span class="n">to_mag_scale_factor</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="p">)</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>            <span class="sa">f</span><span class="s2">&quot;Requested tile size=</span><span class="si">{</span><span class="n">tile_size</span><span class="si">}</span><span class="s2">, tile size at full magnification=</span><span class="si">{</span><span class="n">full_resolution_tile_size</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="p">)</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="c1"># get DeepZoomGenerator, level</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="n">full_generator</span><span class="p">,</span> <span class="n">full_level</span> <span class="o">=</span> <span class="n">get_full_resolution_generator</span><span class="p">(</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="n">slide_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="n">tile_size</span><span class="o">=</span><span class="n">full_resolution_tile_size</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_options</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="p">)</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="n">tile_x_count</span><span class="p">,</span> <span class="n">tile_y_count</span> <span class="o">=</span> <span class="n">full_generator</span><span class="o">.</span><span class="n">level_tiles</span><span class="p">[</span><span class="n">full_level</span><span class="p">]</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tiles x </span><span class="si">{</span><span class="n">tile_x_count</span><span class="si">}</span><span class="s2">, tiles y </span><span class="si">{</span><span class="n">tile_y_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>    <span class="c1"># populate address, coordinates</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>    <span class="n">tiles</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">TileSchema</span><span class="p">](</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>        <span class="p">[</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>            <span class="n">Tile</span><span class="p">(</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>                <span class="n">address</span><span class="o">=</span><span class="n">coord_to_address</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">requested_magnification</span><span class="p">),</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                <span class="n">x_coord</span><span class="o">=</span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">full_resolution_tile_size</span><span class="p">,</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                <span class="n">y_coord</span><span class="o">=</span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">full_resolution_tile_size</span><span class="p">,</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                <span class="n">xy_extent</span><span class="o">=</span><span class="n">full_resolution_tile_size</span><span class="p">,</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                <span class="n">tile_size</span><span class="o">=</span><span class="n">tile_size</span><span class="p">,</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                <span class="n">tile_units</span><span class="o">=</span><span class="s2">&quot;px&quot;</span><span class="p">,</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>            <span class="p">)</span><span class="o">.</span><span class="vm">__dict__</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>            <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tile_x_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tile_y_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>            <span class="p">)</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="p">]</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of tiles in raster: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tiles</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="c1">#    logger.info(&quot;Creating lazy tiles&quot;)</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>    <span class="c1">#    lazy_tiles = [</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>    <span class="c1">#            [dask.delayed(get_tile_from_slide)(tiles_df(x, y),</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>    <span class="c1">#                                               full_resolution_tile_size,</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>    <span class="c1">#                                               tile_size,</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>    <span class="c1">#                                               slide)</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>    <span class="c1">#             for y in range(1, tile_y_count - 1)]</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>    <span class="c1">#            for x in range(1, tile_x_count - 1)]</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="c1">#    sample = lazy_tiles[0][0].compute()</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>    <span class="c1">#</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="c1">#    lazy_arrays = da.stack([</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="c1">#        da.stack([da.from_delayed(lazy_tile, dtype=sample.dtype, shape=sample.shape)</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>    <span class="c1">#                        for lazy_tile in inner] )</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>    <span class="c1">#        for inner in lazy_tiles</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>    <span class="c1">#        ])</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>    <span class="c1">#    logger.info(f&quot;lazy tiles: {lazy_arrays.shape}&quot;)</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>    <span class="k">with</span> <span class="n">ofs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="n">tiles</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>    <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="s2">&quot;tiles_url&quot;</span><span class="p">:</span> <span class="n">ofs</span><span class="o">.</span><span class="n">unstrip_protocol</span><span class="p">(</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>            <span class="n">output_file</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="p">),</span>  <span class="c1"># &quot;Tiles&quot; are the metadata that describe them</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="s2">&quot;total_tiles&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">tiles</span><span class="p">),</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>    <span class="p">}</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>    <span class="k">return</span> <span class="n">properties</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.generate_tiles.cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">cli</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">requested_magnification</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">dask_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.generate_tiles.cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Rasterize a slide into smaller tiles, saving tile metadata as rows in a csv file</p>
<p>Necessary data for the manifest file are:
address, x_coord, y_coord, xy_extent, tile_size, tile_units</p>
<p>
Inputs:
    input_slide_image: slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)
Outputs:
    slide_tiles

Example:
    generate_tiles 10001.svs
        -rts 244 -rmg 10
        -o 10001/tiles</p>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/generate_tiles.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="nd">@timed</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="k">def</span> <span class="nf">cli</span><span class="p">(</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="n">slide_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="n">tile_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="n">requested_magnification</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="n">dask_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Rasterize a slide into smaller tiles, saving tile metadata as rows in a csv file</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">    Necessary data for the manifest file are:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">    address, x_coord, y_coord, xy_extent, tile_size, tile_units</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">    \b</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">    Inputs:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">        input_slide_image: slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">    Outputs:</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        slide_tiles</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">    \b</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        generate_tiles 10001.svs</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">            -rts 244 -rmg 10</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">            -o 10001/tiles</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="n">configure_dask_client</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dask_options&quot;</span><span class="p">])</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="n">properties</span> <span class="o">=</span> <span class="n">__generate_tiles</span><span class="p">(</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tile_size&quot;</span><span class="p">],</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;force&quot;</span><span class="p">],</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;requested_magnification&quot;</span><span class="p">],</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="k">return</span> <span class="n">properties</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.cli.infer_tile_labels" class="doc doc-heading">
          <code>infer_tile_labels</code>


<a href="#luna.pathology.cli.infer_tile_labels" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.infer_tile_labels.__infer_tile_labels" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">__infer_tile_labels</span><span class="p">(</span><span class="n">tiles_urlpath</span><span class="p">,</span> <span class="n">slide_id</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">torch_model_repo_or_dir</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">num_cores</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">use_gpu</span><span class="p">,</span> <span class="n">insecure</span><span class="p">,</span> <span class="n">storage_options</span><span class="p">,</span> <span class="n">output_storage_options</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.infer_tile_labels.__infer_tile_labels" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Run inference using a model and transform definition (either local or using torch.hub)</p>
<p>Decorates existing slide_tiles with additional columns corresponding to class prediction/scores from the model</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>tiles_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>path to a slide-tile manifest file (.tiles.parquet)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>slide_id</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slide ID</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output/working directory</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>torch_model_repo_or_dir</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>repository root name like (namespace/repo) at github.com to serve torch.hub models. Or path to a local model (e.g. msk-mind/luna-ml)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>model_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>torch hub model name (a nn.Module at the repo repo_name)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>num_cores</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Number of cores to use for CPU parallelization</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>batch_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>size in batch dimension to chuck inference (8-256 recommended, depending on memory usage)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>kwargs</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>additional keywords to pass to model initialization</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>use_gpu</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>use GPU if available</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>insecure</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>insecure SSL</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to reading functions</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to writing functions</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>metadata</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/infer_tile_labels.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-238" name="__codelineno-0-238"></a><span class="k">def</span> <span class="nf">__infer_tile_labels</span><span class="p">(</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>    <span class="n">tiles_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>    <span class="n">slide_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>    <span class="n">torch_model_repo_or_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>    <span class="n">num_cores</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>    <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>    <span class="n">use_gpu</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>    <span class="n">insecure</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="p">):</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Run inference using a model and transform definition (either local or using torch.hub)</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="sd">    Decorates existing slide_tiles with additional columns corresponding to class prediction/scores from the model</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="sd">        tiles_urlpath (str): path to a slide-tile manifest file (.tiles.parquet)</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a><span class="sd">        slide_id (str): slide ID</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">        output_urlpath (str): output/working directory</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">        torch_model_repo_or_dir (str): repository root name like (namespace/repo) at github.com to serve torch.hub models. Or path to a local model (e.g. msk-mind/luna-ml)</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="sd">        model_name (str): torch hub model name (a nn.Module at the repo repo_name)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a><span class="sd">        num_cores (int): Number of cores to use for CPU parallelization</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="sd">        batch_size (int): size in batch dimension to chuck inference (8-256 recommended, depending on memory usage)</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="sd">        kwargs (dict): additional keywords to pass to model initialization</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="sd">        use_gpu (bool): use GPU if available</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="sd">        insecure (bool): insecure SSL</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a><span class="sd">        storage_options (dict): storage options to pass to reading functions</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a><span class="sd">        output_storage_options (dict): storage options to pass to writing functions</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a><span class="sd">        dict: metadata</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>    <span class="k">if</span> <span class="n">insecure</span><span class="p">:</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="n">ssl</span><span class="o">.</span><span class="n">_create_default_https_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_create_unverified_context</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>    <span class="n">ofs</span><span class="p">,</span> <span class="n">output_path_prefix</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>        <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>        <span class="o">**</span><span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>    <span class="p">)</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>    <span class="n">output_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">output_path_prefix</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">slide_id</span><span class="si">}</span><span class="s2">.tiles.parquet&quot;</span><span class="p">)</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="n">ofs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_file</span><span class="p">):</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;outputs already exist: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>        <span class="k">return</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>    <span class="n">tiles_df</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>        <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">tiles_urlpath</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_options</span><span class="p">)</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>        <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;address&quot;</span><span class="p">)</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>    <span class="p">)</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="c1"># Get our model and transforms and construct the Tile Dataset and Classifier</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">torch_model_repo_or_dir</span><span class="p">):</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>        <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;local&quot;</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;github&quot;</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Torch hub source = </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">torch_model_repo_or_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>    <span class="c1"># if source == &quot;github&quot;:</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>    <span class="c1"># logger.info(f&quot;Available models: {torch.hub.list(torch_model_repo_or_dir, trust_repo=False)}&quot;)</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>    <span class="n">ttm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">hub</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>        <span class="n">torch_model_repo_or_dir</span><span class="p">,</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>        <span class="n">model_name</span><span class="p">,</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>        <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>        <span class="n">force_reload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>        <span class="n">trust_repo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>    <span class="p">)</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ttm</span><span class="p">,</span> <span class="n">TorchTransformModel</span><span class="p">):</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not a valid model, loaded model was of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ttm</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>    <span class="n">pin_memory</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>    <span class="k">if</span> <span class="n">use_gpu</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>        <span class="n">pin_memory</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using device = </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>    <span class="n">preprocess</span> <span class="o">=</span> <span class="n">ttm</span><span class="o">.</span><span class="n">get_preprocess</span><span class="p">()</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>    <span class="n">transform</span> <span class="o">=</span> <span class="n">ttm</span><span class="o">.</span><span class="n">transform</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>    <span class="n">ttm</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>    <span class="n">ds</span> <span class="o">=</span> <span class="n">HDF5Dataset</span><span class="p">(</span><span class="n">tiles_df</span><span class="p">,</span> <span class="n">preprocess</span><span class="o">=</span><span class="n">preprocess</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_options</span><span class="p">)</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>    <span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>        <span class="n">ds</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">num_cores</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="n">pin_memory</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>    <span class="p">)</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>    <span class="c1"># Generate aggregate dataframe</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>        <span class="n">df_scores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>            <span class="p">[</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>                    <span class="n">post_transform_to_2d</span><span class="p">(</span><span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))),</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>                <span class="p">)</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>                <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>            <span class="p">]</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>        <span class="p">)</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ttm</span><span class="p">,</span> <span class="s2">&quot;column_labels&quot;</span><span class="p">):</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mapping column labels -&gt; </span><span class="si">{</span><span class="n">ttm</span><span class="o">.</span><span class="n">column_labels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>        <span class="n">df_scores</span> <span class="o">=</span> <span class="n">df_scores</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">ttm</span><span class="o">.</span><span class="n">column_labels</span><span class="p">)</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>    <span class="n">df_output</span> <span class="o">=</span> <span class="n">tiles_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_scores</span><span class="p">)</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>    <span class="n">df_output</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df_output</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>    <span class="n">df_output</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;address&quot;</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">df_output</span><span class="p">)</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>    <span class="k">with</span> <span class="n">ofs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>        <span class="n">df_output</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>    <span class="c1"># Save our properties and params</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>    <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>        <span class="s2">&quot;tiles_url&quot;</span><span class="p">:</span> <span class="n">ofs</span><span class="o">.</span><span class="n">unstrip_protocol</span><span class="p">(</span><span class="n">output_file</span><span class="p">),</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>        <span class="s2">&quot;total_tiles&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_output</span><span class="p">),</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>        <span class="s2">&quot;available_labels&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_output</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>    <span class="p">}</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>    <span class="k">return</span> <span class="n">properties</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.infer_tile_labels.cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">cli</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tiles_urlpath</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_query</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">requested_magnification</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">torch_model_repo_or_dir</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">num_cores</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{},</span> <span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dask_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">insecure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.infer_tile_labels.cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Run inference using a model and transform definition (either local or using torch.hub)</p>
<p>Decorates existing slide_tiles with additional columns corresponding to class prediction/scores from the model</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to slide image (virtual slide formats compatible with TiffSlide, .svs, .tif, .scn, ...)</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>tiles_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>path to a slide-tile manifest file (.tiles.csv)</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>tile_size</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>size of tiles to use (at the requested magnification)</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>filter_query</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>pandas query by which to filter tiles based on their various tissue detection scores</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>requested_magnification</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Magnification scale at which to perform computation</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>torch_model_repo_or_dir</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>repository root name like (namespace/repo) at github.com to serve torch.hub models. Or path to a local model (e.g. msk-mind/luna-ml)</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>model_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>torch hub model name (a nn.Module at the repo repo_name)</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>num_cores</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Number of cores to use for CPU parallelization</p>
            </div>
          </td>
          <td>
                <code>4</code>
          </td>
        </tr>
        <tr>
          <td><code>batch_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>size in batch dimension to chuck inference (8-256 recommended, depending on memory usage)</p>
            </div>
          </td>
          <td>
                <code>8</code>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output/working directory</p>
            </div>
          </td>
          <td>
                <code>&#39;.&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>force</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>overwrite outputs if they exist</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>kwargs</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>additional keywords to pass to model initialization</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>use_gpu</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>use GPU if available</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>dask_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>options to pass to dask client</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>insecure</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>insecure SSL</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to reading functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to writing functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>metadata</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/infer_tile_labels.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="nd">@timed</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="k">def</span> <span class="nf">cli</span><span class="p">(</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="n">slide_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="n">tiles_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="n">tile_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="n">filter_query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="n">requested_magnification</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="n">torch_model_repo_or_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="n">num_cores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="n">use_gpu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="n">dask_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="n">insecure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="p">):</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Run inference using a model and transform definition (either local or using torch.hub)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">    Decorates existing slide_tiles with additional columns corresponding to class prediction/scores from the model</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">        slide_urlpath (str): url/path to slide image (virtual slide formats compatible with TiffSlide, .svs, .tif, .scn, ...)</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">        tiles_urlpath (str): path to a slide-tile manifest file (.tiles.csv)</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">        tile_size (Optional[int]): size of tiles to use (at the requested magnification)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">        filter_query (str): pandas query by which to filter tiles based on their various tissue detection scores</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">        requested_magnification (Optional[int]): Magnification scale at which to perform computation</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">        torch_model_repo_or_dir (str): repository root name like (namespace/repo) at github.com to serve torch.hub models. Or path to a local model (e.g. msk-mind/luna-ml)</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">        model_name (str): torch hub model name (a nn.Module at the repo repo_name)</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">        num_cores (int): Number of cores to use for CPU parallelization</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">        batch_size (int): size in batch dimension to chuck inference (8-256 recommended, depending on memory usage)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">        output_urlpath (str): output/working directory</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">        force (bool): overwrite outputs if they exist</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">        kwargs (dict): additional keywords to pass to model initialization</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">        use_gpu (bool): use GPU if available</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">        dask_options (dict): options to pass to dask client</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">        insecure (bool): insecure SSL</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">        storage_options (dict): storage options to pass to reading functions</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">        output_storage_options (dict): storage options to pass to writing functions</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">        dict: metadata</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="n">configure_dask_client</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dask_options&quot;</span><span class="p">])</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_urlpath&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tiles_urlpath&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="k">raise</span> <span class="n">fire</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">FireError</span><span class="p">(</span><span class="s2">&quot;Specify either tiles_urlpath or slide_urlpath&quot;</span><span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tile_size&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tiles_urlpath&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="k">raise</span> <span class="n">fire</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">FireError</span><span class="p">(</span><span class="s2">&quot;Specify either tiles_urlpath or tile_size&quot;</span><span class="p">)</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_urlpath&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="n">slide_id</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_urlpath&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">stem</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="n">slide_id</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tiles_urlpath&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">removesuffix</span><span class="p">(</span><span class="s2">&quot;.tiles&quot;</span><span class="p">)</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>    <span class="n">tiles_urlpath</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tiles_urlpath&quot;</span><span class="p">]</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="k">with</span> <span class="n">make_temp_directory</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_dir</span><span class="p">:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">tiles_urlpath</span><span class="p">:</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>            <span class="n">tiles_result</span> <span class="o">=</span> <span class="n">__generate_tiles</span><span class="p">(</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tile_size&quot;</span><span class="p">],</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>                <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;generate_tiles&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">as_uri</span><span class="p">(),</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;force&quot;</span><span class="p">],</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tile_magnification&quot;</span><span class="p">],</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="p">)</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="n">detect_tissue_result</span> <span class="o">=</span> <span class="n">__detect_tissue</span><span class="p">(</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                <span class="n">tiles_result</span><span class="p">[</span><span class="s2">&quot;tiles_url&quot;</span><span class="p">],</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>                <span class="n">slide_id</span><span class="p">,</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;thumbnail_magnification&quot;</span><span class="p">],</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;filter_query&quot;</span><span class="p">],</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">],</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;detect_tissue&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">as_uri</span><span class="p">(),</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;force&quot;</span><span class="p">],</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="n">save_tiles_result</span> <span class="o">=</span> <span class="n">_save_tiles</span><span class="p">(</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                <span class="n">detect_tissue_result</span><span class="p">[</span><span class="s2">&quot;tiles_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;save_tiles&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">as_uri</span><span class="p">(),</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;force&quot;</span><span class="p">],</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">],</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>            <span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="n">tiles_urlpath</span> <span class="o">=</span> <span class="n">save_tiles_result</span><span class="p">[</span><span class="s2">&quot;tiles_url&quot;</span><span class="p">]</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="k">return</span> <span class="n">__infer_tile_labels</span><span class="p">(</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>            <span class="n">tiles_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>            <span class="n">slide_id</span><span class="p">,</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;force&quot;</span><span class="p">],</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;torch_model_repo_or_dir&quot;</span><span class="p">],</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;model_name&quot;</span><span class="p">],</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;num_cores&quot;</span><span class="p">],</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">],</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;kwargs&quot;</span><span class="p">],</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;use_gpu&quot;</span><span class="p">],</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;insecure&quot;</span><span class="p">],</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.infer_tile_labels.infer_tile_labels" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">infer_tile_labels</span><span class="p">(</span><span class="n">slide_manifest</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_query</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">thumbnail_magnification</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tile_magnification</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">torch_model_repo_or_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">num_cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{},</span> <span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">insecure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.infer_tile_labels.infer_tile_labels" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Run inference using a model and transform definition (either local or using torch.hub)</p>
<p>Decorates existing tiles manifests with additional columns corresponding to class prediction/scores from the model</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_manifest</code></td>
          <td>
                <code><span title="pandera.typing.DataFrame">DataFrame</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slide manifest from slide_etl</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tile_size</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>size of tiles to use (at the requested magnification)</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>filter_query</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>pandas query by which to filter tiles based on their various tissue detection scores</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>thumbnail_magnification</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Magnification scale at which to detect tissue</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>tile_magnification</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Magnification scale at which to generate tiles</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>torch_model_repo_or_dir</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>repository root name like (namespace/repo) at github.com to serve torch.hub models. Or path to a local model (e.g. msk-mind/luna-ml)</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>model_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>torch hub model name (a nn.Module at the repo repo_name)</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>num_cores</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Number of cores to use for CPU parallelization</p>
            </div>
          </td>
          <td>
                <code>1</code>
          </td>
        </tr>
        <tr>
          <td><code>batch_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>size in batch dimension to chuck inference (8-256 recommended, depending on memory usage)</p>
            </div>
          </td>
          <td>
                <code>2000</code>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output/working directory</p>
            </div>
          </td>
          <td>
                <code>&#39;.&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>force</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>overwrite outputs if they exist</p>
            </div>
          </td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>kwargs</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>additional keywords to pass to model initialization</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>use_gpu</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>use GPU if available</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>insecure</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>insecure SSL</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to reading functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to writing functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="pandera.typing.DataFrame">DataFrame</span>[<span title="luna.common.models.SlideSchema">SlideSchema</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>pd.DataFrame: slide manifest</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/infer_tile_labels.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="k">def</span> <span class="nf">infer_tile_labels</span><span class="p">(</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="n">slide_manifest</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">SlideSchema</span><span class="p">],</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>    <span class="n">tile_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="n">filter_query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="n">thumbnail_magnification</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="n">tile_magnification</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>    <span class="n">torch_model_repo_or_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="n">num_cores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>    <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>    <span class="n">use_gpu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>    <span class="n">insecure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">SlideSchema</span><span class="p">]:</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Run inference using a model and transform definition (either local or using torch.hub)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">    Decorates existing tiles manifests with additional columns corresponding to class prediction/scores from the model</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">        slide_manifest (DataFrame): slide manifest from slide_etl</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">        tile_size (Optional[int]): size of tiles to use (at the requested magnification)</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">        filter_query (str): pandas query by which to filter tiles based on their various tissue detection scores</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">        thumbnail_magnification (Optional[int]): Magnification scale at which to detect tissue</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">        tile_magnification (Optional[int]): Magnification scale at which to generate tiles</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">        torch_model_repo_or_dir (str): repository root name like (namespace/repo) at github.com to serve torch.hub models. Or path to a local model (e.g. msk-mind/luna-ml)</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">        model_name (str): torch hub model name (a nn.Module at the repo repo_name)</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">        num_cores (int): Number of cores to use for CPU parallelization</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">        batch_size (int): size in batch dimension to chuck inference (8-256 recommended, depending on memory usage)</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">        output_urlpath (str): output/working directory</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="sd">        force (bool): overwrite outputs if they exist</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="sd">        kwargs (dict): additional keywords to pass to model initialization</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">        use_gpu (bool): use GPU if available</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">        insecure (bool): insecure SSL</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="sd">        storage_options (dict): storage options to pass to reading functions</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">        output_storage_options (dict): storage options to pass to writing functions</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="sd">        pd.DataFrame: slide manifest</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">get_or_create_dask_client</span><span class="p">()</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="k">if</span> <span class="s2">&quot;tiles_url&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="k">if</span> <span class="n">tile_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Need to have generated tiles or specify tile_size&quot;</span><span class="p">)</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>        <span class="c1"># generate tiles</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="n">slide_manifest</span> <span class="o">=</span> <span class="n">detect_tissue</span><span class="p">(</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="n">slide_manifest</span><span class="p">,</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>            <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>            <span class="n">tile_size</span><span class="o">=</span><span class="n">tile_size</span><span class="p">,</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>            <span class="n">thumbnail_magnification</span><span class="o">=</span><span class="n">thumbnail_magnification</span><span class="p">,</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>            <span class="n">tile_magnification</span><span class="o">=</span><span class="n">tile_magnification</span><span class="p">,</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>            <span class="n">filter_query</span><span class="o">=</span><span class="n">filter_query</span><span class="p">,</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>            <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_options</span><span class="p">,</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>            <span class="n">output_urlpath</span><span class="o">=</span><span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>            <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>            <span class="n">output_storage_options</span><span class="o">=</span><span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="p">)</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>        <span class="n">slide_manifest</span> <span class="o">=</span> <span class="n">save_tiles</span><span class="p">(</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>            <span class="n">slide_manifest</span><span class="p">,</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>            <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>            <span class="n">force</span><span class="p">,</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>            <span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>            <span class="n">storage_options</span><span class="p">,</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>            <span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Slide&quot;</span><span class="p">):</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>        <span class="n">future</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="n">__infer_tile_labels</span><span class="p">,</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>            <span class="n">row</span><span class="o">.</span><span class="n">tiles_url</span><span class="p">,</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>            <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>            <span class="n">force</span><span class="p">,</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>            <span class="n">torch_model_repo_or_dir</span><span class="p">,</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="n">model_name</span><span class="p">,</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="n">num_cores</span><span class="p">,</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>            <span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>            <span class="n">kwargs</span><span class="p">,</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>            <span class="n">use_gpu</span><span class="p">,</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>            <span class="n">insecure</span><span class="p">,</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>            <span class="n">storage_options</span><span class="p">,</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>            <span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="p">)</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>    <span class="n">progress</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>    <span class="k">return</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tiles_url</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;tiles_url&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.cli.merge_shape_features" class="doc doc-heading">
          <code>merge_shape_features</code>


<a href="#luna.pathology.cli.merge_shape_features" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.merge_shape_features.cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">cli</span><span class="p">(</span><span class="n">shape_features_urlpaths</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">flatten_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fraction_not_null</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.merge_shape_features.cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Merges shape features dataframes</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>shape_features_urlpaths</code></td>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/paths to shape featurs parquet files</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>URL/path to output parquet file</p>
            </div>
          </td>
          <td>
                <code>&#39;.&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>fraction_not_null</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>fraction not null to keep column to keep in wide format</p>
            </div>
          </td>
          <td>
                <code>0.5</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to reading functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to writing functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>local_config</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>local config yaml file</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output paths and the number of features generated</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/merge_shape_features.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="nd">@timed</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="k">def</span> <span class="nf">cli</span><span class="p">(</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="n">shape_features_urlpaths</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>    <span class="n">flatten_index</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="n">fraction_not_null</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="p">):</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Merges shape features dataframes</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">        shape_features_urlpaths (List[str]): URL/paths to shape featurs parquet files</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">        output_urlpath (str): URL/path to output parquet file</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">        fraction_not_null (float): fraction not null to keep column to keep in wide format</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">        storage_options (dict): storage options to pass to reading functions</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        output_storage_options (dict): storage options to pass to writing functions</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        local_config (str): local config yaml file</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">        dict: output paths and the number of features generated</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: list[str]</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;shape_features_urlpaths&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="k">for</span> <span class="n">urlpath</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;shape_features_urlpaths&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>            <span class="n">fs</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span><span class="n">urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">])</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>            <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>            <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="n">fs</span><span class="p">,</span> <span class="n">path_prefix</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;shape_features_urlpaths&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">]</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">fs</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path_prefix</span><span class="si">}</span><span class="s2">/**/shape_features.parquet&quot;</span><span class="p">):</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>            <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>            <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="n">fs</span><span class="p">,</span> <span class="n">path_prefix</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">]</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path_prefix</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;long_shape_features.parquet&quot;</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">])</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="n">df</span><span class="o">.</span><span class="n">variable</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="n">df</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">)</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(: |:)&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[^a-zA-Z0-9 </span><span class="se">\n</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="p">)</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="n">wide_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path_prefix</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;wide_shape_features.parquet&quot;</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="n">wide_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="n">index</span><span class="o">=</span><span class="s2">&quot;slide_id&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Parent&quot;</span><span class="p">,</span> <span class="s2">&quot;Class&quot;</span><span class="p">,</span> <span class="s2">&quot;variable&quot;</span><span class="p">],</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;value&quot;</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>    <span class="p">)</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="n">wide_df</span> <span class="o">=</span> <span class="n">wide_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="p">:,</span> <span class="n">wide_df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">wide_df</span><span class="p">)</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;fraction_not_null&quot;</span><span class="p">]</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="p">]</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;flatten_index&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="n">wide_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">wide_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="n">wide_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">wide_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">wide_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">])</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="n">wide_df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="s2">&quot;long_shape_features&quot;</span><span class="p">:</span> <span class="n">fs</span><span class="o">.</span><span class="n">unstrip_protocol</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)),</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="s2">&quot;wide_shape_features&quot;</span><span class="p">:</span> <span class="n">fs</span><span class="o">.</span><span class="n">unstrip_protocol</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">wide_path</span><span class="p">)),</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="s2">&quot;num_features&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">wide_df</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.cli.run_stardist_cell_detection" class="doc doc-heading">
          <code>run_stardist_cell_detection</code>


<a href="#luna.pathology.cli.run_stardist_cell_detection" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.run_stardist_cell_detection.__stardist_cell_lymphocyte" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">__stardist_cell_lymphocyte</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">slide_id</span><span class="p">,</span> <span class="n">num_cores</span><span class="p">,</span> <span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="s1">&#39;mskmind/qupath-stardist:0.4.3&#39;</span><span class="p">,</span> <span class="n">use_singularity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_heap_size</span><span class="o">=</span><span class="s1">&#39;64G&#39;</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.run_stardist_cell_detection.__stardist_cell_lymphocyte" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Run stardist using qupath CLI</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output url/path</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>num_cores</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Number of cores to use for CPU parallelization</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>use_gpu</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>use GPU</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>image</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>docker/singularity image</p>
            </div>
          </td>
          <td>
                <code>&#39;mskmind/qupath-stardist:0.4.3&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>use_singularity</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>use singularity instead of docker</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>max_heap_size</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>maximum heap size to pass to java options</p>
            </div>
          </td>
          <td>
                <code>&#39;64G&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to reading functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>run metadata</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/run_stardist_cell_detection.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-344" name="__codelineno-0-344"></a><span class="nd">@local_cache_urlpath</span><span class="p">(</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>    <span class="n">file_key_write_mode</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;slide_urlpath&quot;</span><span class="p">:</span> <span class="s2">&quot;r&quot;</span><span class="p">},</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>    <span class="n">dir_key_write_mode</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">:</span> <span class="s2">&quot;w&quot;</span><span class="p">},</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a><span class="p">)</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a><span class="k">def</span> <span class="nf">__stardist_cell_lymphocyte</span><span class="p">(</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>    <span class="n">slide_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>    <span class="n">slide_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>    <span class="n">num_cores</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>    <span class="n">use_gpu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>    <span class="n">image</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mskmind/qupath-stardist:0.4.3&quot;</span><span class="p">,</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>    <span class="n">use_singularity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>    <span class="n">max_heap_size</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;64G&quot;</span><span class="p">,</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Run stardist using qupath CLI</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a><span class="sd">        slide_urlpath (str): url/path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a><span class="sd">        output_urlpath (str): output url/path</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a><span class="sd">        num_cores (int): Number of cores to use for CPU parallelization</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a><span class="sd">        use_gpu (bool): use GPU</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a><span class="sd">        image (str): docker/singularity image</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a><span class="sd">        use_singularity (bool): use singularity instead of docker</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a><span class="sd">        max_heap_size (str): maximum heap size to pass to java options</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a><span class="sd">        storage_options (dict): storage options to pass to reading functions</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a><span class="sd">        dict: run metadata</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>    <span class="n">fs</span><span class="p">,</span> <span class="n">slide_path</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>    <span class="n">ofs</span><span class="p">,</span> <span class="n">output_path</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span><span class="n">output_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">output_storage_options</span><span class="p">)</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>    <span class="n">output_header_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">slide_id</span><span class="si">}</span><span class="s2">_cell_objects.parquet&quot;</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>    <span class="k">if</span> <span class="n">ofs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_header_file</span><span class="p">):</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;outputs already exist: </span><span class="si">{</span><span class="n">output_header_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>        <span class="k">return</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>    <span class="k">if</span> <span class="n">ofs</span><span class="o">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ofs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>        <span class="n">ofs</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>    <span class="n">qupath_cmd</span> <span class="o">=</span> <span class="s2">&quot;QuPath-cpu&quot;</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>    <span class="k">if</span> <span class="n">use_gpu</span><span class="p">:</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>        <span class="n">qupath_cmd</span> <span class="o">=</span> <span class="s2">&quot;QuPath-gpu&quot;</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>    <span class="n">runner_type</span> <span class="o">=</span> <span class="s2">&quot;DOCKER&quot;</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>    <span class="k">if</span> <span class="n">use_singularity</span><span class="p">:</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>        <span class="n">runner_type</span> <span class="o">=</span> <span class="s2">&quot;SINGULARITY&quot;</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>    <span class="n">slide_filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">slide_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>    <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">qupath_cmd</span><span class="si">}</span><span class="s2"> script --image /inputs/</span><span class="si">{</span><span class="n">slide_filename</span><span class="si">}</span><span class="s2"> /scripts/stardist_nuclei_and_lymphocytes.groovy&quot;</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Launching </span><span class="si">{</span><span class="n">runner_type</span><span class="si">}</span><span class="s2"> container:&quot;</span><span class="p">)</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">volumes=</span><span class="si">{</span><span class="n">slide_path</span><span class="si">}</span><span class="s2">:&#39;/inputs/</span><span class="si">{</span><span class="n">slide_filename</span><span class="si">}</span><span class="s2">&#39;, </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">:&#39;/output_dir&#39;&quot;</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>    <span class="p">)</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">nano_cpus=</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">num_cores</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e9</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">image=&#39;</span><span class="si">{</span><span class="n">image</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">command=</span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>    <span class="n">volumes_map</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>        <span class="n">slide_path</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;/inputs/</span><span class="si">{</span><span class="n">slide_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>        <span class="n">output_path</span><span class="p">:</span> <span class="s2">&quot;/output_dir&quot;</span><span class="p">,</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>    <span class="p">}</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>    <span class="n">runner_config</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>        <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">image</span><span class="p">,</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>        <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="n">command</span><span class="p">,</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>        <span class="s2">&quot;num_cores&quot;</span><span class="p">:</span> <span class="n">num_cores</span><span class="p">,</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>        <span class="s2">&quot;max_heap_size&quot;</span><span class="p">:</span> <span class="n">max_heap_size</span><span class="p">,</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>        <span class="s2">&quot;volumes_map&quot;</span><span class="p">:</span> <span class="n">volumes_map</span><span class="p">,</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>        <span class="s2">&quot;use_gpu&quot;</span><span class="p">:</span> <span class="n">use_gpu</span><span class="p">,</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>    <span class="p">}</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>    <span class="n">runner</span> <span class="o">=</span> <span class="n">runner_provider</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">runner_type</span><span class="p">,</span> <span class="o">**</span><span class="n">runner_config</span><span class="p">)</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>    <span class="n">executor</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">executor</span><span class="p">:</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">executor</span><span class="p">,</span> <span class="s2">&quot;is not iterable&quot;</span><span class="p">)</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>    <span class="n">stardist_output</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;cell_detections.tsv&quot;</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">stardist_output</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="s2">&quot;cell-&quot;</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>    <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;cell_id&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Centroid X m&quot;</span><span class="p">:</span> <span class="s2">&quot;x_coord&quot;</span><span class="p">,</span> <span class="s2">&quot;Centroid Y m&quot;</span><span class="p">:</span> <span class="s2">&quot;y_coord&quot;</span><span class="p">}</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>    <span class="p">)</span>  <span class="c1"># x,ys follow this convention</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>    <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_header_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>        <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;generated cell data:&quot;</span><span class="p">)</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>    <span class="n">output_geojson_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;cell_detections.geojson&quot;</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>    <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>        <span class="s2">&quot;geojson_url&quot;</span><span class="p">:</span> <span class="n">ofs</span><span class="o">.</span><span class="n">unstrip_protocol</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_geojson_file</span><span class="p">)),</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>        <span class="s2">&quot;tsv_url&quot;</span><span class="p">:</span> <span class="n">ofs</span><span class="o">.</span><span class="n">unstrip_protocol</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">stardist_output</span><span class="p">)),</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>        <span class="s2">&quot;parquet_url&quot;</span><span class="p">:</span> <span class="n">ofs</span><span class="o">.</span><span class="n">unstrip_protocol</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_header_file</span><span class="p">)),</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>        <span class="s2">&quot;spatial&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>        <span class="s2">&quot;total_cells&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>    <span class="p">}</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>    <span class="k">return</span> <span class="n">properties</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.run_stardist_cell_detection.__stardist_simple" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">__stardist_simple</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="p">,</span> <span class="n">cell_expansion_size</span><span class="p">,</span> <span class="n">image_type</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">debug_opts</span><span class="p">,</span> <span class="n">num_cores</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">use_singularity</span><span class="p">,</span> <span class="n">max_heap_size</span><span class="p">,</span> <span class="n">storage_options</span><span class="p">,</span> <span class="n">output_storage_options</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.run_stardist_cell_detection.__stardist_simple" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Run stardist using qupath CLI on slides in a slide manifest from
slide_etl. URIs to resulting GeoJSON will be stored in a specified column
of the returned slide manifest.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>cell_expansion_size</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>size in pixels to expand cell cytoplasm</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>num_cores</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Number of cores to use for CPU parallelization</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>image_type</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>qupath image type (BRIGHTFIELD_H_DAB)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output url/path</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>debug_opts</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>debug options passed as arguments to groovy script</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>image</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>docker/singularity image</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>use_singularity</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>use singularity instead of docker</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>max_heap_size</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>maximum heap size to pass to java options</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to reading functions</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to writing functions</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>run metadata</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/run_stardist_cell_detection.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="nd">@local_cache_urlpath</span><span class="p">(</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>    <span class="n">file_key_write_mode</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;slide_urlpath&quot;</span><span class="p">:</span> <span class="s2">&quot;r&quot;</span><span class="p">},</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="n">dir_key_write_mode</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">:</span> <span class="s2">&quot;w&quot;</span><span class="p">},</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="p">)</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="k">def</span> <span class="nf">__stardist_simple</span><span class="p">(</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="n">slide_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="n">cell_expansion_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="n">image_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="n">debug_opts</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>    <span class="n">num_cores</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>    <span class="n">image</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="n">use_singularity</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>    <span class="n">max_heap_size</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Run stardist using qupath CLI on slides in a slide manifest from</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="sd">    slide_etl. URIs to resulting GeoJSON will be stored in a specified column</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">    of the returned slide manifest.</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="sd">        slide_urlpath (str): path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">        cell_expansion_size (float): size in pixels to expand cell cytoplasm</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="sd">        num_cores (int): Number of cores to use for CPU parallelization</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="sd">        image_type (str): qupath image type (BRIGHTFIELD_H_DAB)</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="sd">        output_urlpath (str): output url/path</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">        debug_opts (str): debug options passed as arguments to groovy script</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">        image (str): docker/singularity image</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">        use_singularity (bool): use singularity instead of docker</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">        max_heap_size (str): maximum heap size to pass to java options</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">        storage_options (dict): storage options to pass to reading functions</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">        output_storage_options (dict): storage options to pass to writing functions</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">        dict: run metadata</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>    <span class="n">fs</span><span class="p">,</span> <span class="n">slide_path</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>    <span class="n">ofs</span><span class="p">,</span> <span class="n">output_path</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span><span class="n">output_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">output_storage_options</span><span class="p">)</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>    <span class="n">slide_id</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>    <span class="n">output_header_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">slide_id</span><span class="si">}</span><span class="s2">_cell_objects.parquet&quot;</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>    <span class="k">if</span> <span class="n">ofs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_header_file</span><span class="p">):</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;outputs already exist: </span><span class="si">{</span><span class="n">output_header_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="k">return</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>    <span class="k">if</span> <span class="n">ofs</span><span class="o">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ofs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="n">ofs</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>    <span class="n">runner_type</span> <span class="o">=</span> <span class="s2">&quot;DOCKER&quot;</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>    <span class="k">if</span> <span class="n">use_singularity</span><span class="p">:</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="n">runner_type</span> <span class="o">=</span> <span class="s2">&quot;SINGULARITY&quot;</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>    <span class="n">slide_filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">slide_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>    <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;echo QuPath script --image /inputs/</span><span class="si">{</span><span class="n">slide_filename</span><span class="si">}</span><span class="s2"> --args [cellSize=</span><span class="si">{</span><span class="n">cell_expansion_size</span><span class="si">}</span><span class="s2">,imageType=</span><span class="si">{</span><span class="n">image_type</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">debug_opts</span><span class="si">}</span><span class="s2">] /scripts/stardist_simple.groovy&quot;</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Launching QuPath via </span><span class="si">{</span><span class="n">runner_type</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">image</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">volumes=</span><span class="si">{</span><span class="n">slide_urlpath</span><span class="si">}</span><span class="s2">:&#39;/inputs/</span><span class="si">{</span><span class="n">slide_filename</span><span class="si">}</span><span class="s2">&#39;, </span><span class="si">{</span><span class="n">slide_path</span><span class="si">}</span><span class="s2">:&#39;/output_dir&#39;&quot;</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="p">)</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">nano_cpus=</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">num_cores</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e9</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">image=&#39;</span><span class="si">{</span><span class="n">image</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">command=</span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>    <span class="n">volumes_map</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="n">slide_path</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;/inputs/</span><span class="si">{</span><span class="n">slide_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="n">output_path</span><span class="p">:</span> <span class="s2">&quot;/output_dir&quot;</span><span class="p">,</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>    <span class="p">}</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>    <span class="n">runner_config</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">image</span><span class="p">,</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>        <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="n">command</span><span class="p">,</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="s2">&quot;num_cores&quot;</span><span class="p">:</span> <span class="n">num_cores</span><span class="p">,</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="s2">&quot;max_heap_size&quot;</span><span class="p">:</span> <span class="n">max_heap_size</span><span class="p">,</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="s2">&quot;volumes_map&quot;</span><span class="p">:</span> <span class="n">volumes_map</span><span class="p">,</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>    <span class="p">}</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>    <span class="n">runner</span> <span class="o">=</span> <span class="n">runner_provider</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">runner_type</span><span class="p">,</span> <span class="o">**</span><span class="n">runner_config</span><span class="p">)</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>    <span class="n">executor</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">executor</span><span class="p">:</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">executor</span><span class="p">,</span> <span class="s2">&quot;is not iterable&quot;</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>    <span class="n">stardist_output</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;cell_detections.tsv&quot;</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">stardist_output</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="s2">&quot;cell-&quot;</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>    <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;cell_id&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Centroid X m&quot;</span><span class="p">:</span> <span class="s2">&quot;x_coord&quot;</span><span class="p">,</span> <span class="s2">&quot;Centroid Y m&quot;</span><span class="p">:</span> <span class="s2">&quot;y_coord&quot;</span><span class="p">}</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>    <span class="p">)</span>  <span class="c1"># x,ys follow this convention</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>    <span class="k">with</span> <span class="n">ofs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_header_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;generated cell data:&quot;</span><span class="p">)</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>    <span class="n">output_geojson_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;cell_detections.geojson&quot;</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>    <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="s2">&quot;geojson_url&quot;</span><span class="p">:</span> <span class="n">ofs</span><span class="o">.</span><span class="n">unstrip_protocol</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_geojson_file</span><span class="p">)),</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>        <span class="s2">&quot;tsv_url&quot;</span><span class="p">:</span> <span class="n">ofs</span><span class="o">.</span><span class="n">unstrip_protocol</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">stardist_output</span><span class="p">)),</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="s2">&quot;parquet_url&quot;</span><span class="p">:</span> <span class="n">ofs</span><span class="o">.</span><span class="n">unstrip_protocol</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_header_file</span><span class="p">)),</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="s2">&quot;spatial&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="s2">&quot;total_cells&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>    <span class="p">}</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>    <span class="k">return</span> <span class="n">properties</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.run_stardist_cell_detection.stardist_cell_lymphocyte" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">stardist_cell_lymphocyte</span><span class="p">(</span><span class="n">slide_manifest</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">num_cores</span><span class="p">,</span> <span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="s1">&#39;mskmind/qupath-stardist:0.4.3&#39;</span><span class="p">,</span> <span class="n">use_singularity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_heap_size</span><span class="o">=</span><span class="s1">&#39;64G&#39;</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">annotation_column</span><span class="o">=</span><span class="s1">&#39;lymphocyte_geojson_url&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.run_stardist_cell_detection.stardist_cell_lymphocyte" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Run stardist using qupath CLI</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_manifest</code></td>
          <td>
                <code><span title="pandera.typing.DataFrame">DataFrame</span>[<span title="luna.common.models.SlideSchema">SlideSchema</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slide manifest from slide_etl</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output url/path</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>num_cores</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Number of cores to use for CPU parallelization</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>use_gpu</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>use GPU</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>image</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>docker/singularity image</p>
            </div>
          </td>
          <td>
                <code>&#39;mskmind/qupath-stardist:0.4.3&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>use_singularity</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>use singularity instead of docker</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>max_heap_size</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>maximum heap size to pass to java options</p>
            </div>
          </td>
          <td>
                <code>&#39;64G&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to reading functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to writing functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>annotation_column</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of column in resulting slide manifest to store GeoJson URIs</p>
            </div>
          </td>
          <td>
                <code>&#39;lymphocyte_geojson_url&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="pandera.typing.DataFrame">DataFrame</span>[<span title="luna.common.models.SlideSchema">SlideSchema</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DataFrame[SlideSchema]: slide manifest</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/run_stardist_cell_detection.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="k">def</span> <span class="nf">stardist_cell_lymphocyte</span><span class="p">(</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>    <span class="n">slide_manifest</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">SlideSchema</span><span class="p">],</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>    <span class="n">num_cores</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>    <span class="n">use_gpu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>    <span class="n">image</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mskmind/qupath-stardist:0.4.3&quot;</span><span class="p">,</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="n">use_singularity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="n">max_heap_size</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;64G&quot;</span><span class="p">,</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>    <span class="n">annotation_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;lymphocyte_geojson_url&quot;</span><span class="p">,</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">SlideSchema</span><span class="p">]:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Run stardist using qupath CLI</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="sd">        slide_manifest (DataFrame[SlideSchema]): slide manifest from slide_etl</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a><span class="sd">        output_urlpath (str): output url/path</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a><span class="sd">        num_cores (int): Number of cores to use for CPU parallelization</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a><span class="sd">        use_gpu (bool): use GPU</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a><span class="sd">        image (str): docker/singularity image</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a><span class="sd">        use_singularity (bool): use singularity instead of docker</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a><span class="sd">        max_heap_size (str): maximum heap size to pass to java options</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a><span class="sd">        storage_options (dict): storage options to pass to reading functions</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a><span class="sd">        output_storage_options (dict): storage options to pass to writing functions</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a><span class="sd">        annotation_column (str): name of column in resulting slide manifest to store GeoJson URIs</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a><span class="sd">        DataFrame[SlideSchema]: slide manifest</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">get_or_create_dask_client</span><span class="p">()</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Slide&quot;</span><span class="p">):</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>        <span class="n">fs</span><span class="p">,</span> <span class="n">output_path</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>            <span class="n">output_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">output_storage_options</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>        <span class="p">)</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>        <span class="n">future</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>            <span class="n">__stardist_cell_lymphocyte</span><span class="p">,</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>            <span class="n">row</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>            <span class="n">fs</span><span class="o">.</span><span class="n">unstrip_protocol</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="o">/</span> <span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">)),</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>            <span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>            <span class="n">num_cores</span><span class="p">,</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>            <span class="n">use_gpu</span><span class="p">,</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>            <span class="n">image</span><span class="p">,</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>            <span class="n">use_singularity</span><span class="p">,</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="n">max_heap_size</span><span class="p">,</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>            <span class="n">storage_options</span><span class="p">,</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>            <span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>        <span class="p">)</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>        <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>    <span class="k">return</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>        <span class="o">**</span><span class="p">{</span><span class="n">annotation_column</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;geojson_url&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]}</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.run_stardist_cell_detection.stardist_cell_lymphocyte_cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">stardist_cell_lymphocyte_cli</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">num_cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="s1">&#39;mskmind/qupath-stardist:0.4.3&#39;</span><span class="p">,</span> <span class="n">use_singularity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_heap_size</span><span class="o">=</span><span class="s1">&#39;64G&#39;</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.run_stardist_cell_detection.stardist_cell_lymphocyte_cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Run stardist using qupath CLI</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output url/path</p>
            </div>
          </td>
          <td>
                <code>&#39;.&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>num_cores</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Number of cores to use for CPU parallelization</p>
            </div>
          </td>
          <td>
                <code>1</code>
          </td>
        </tr>
        <tr>
          <td><code>use_gpu</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>use GPU</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>image</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>docker/singularity image</p>
            </div>
          </td>
          <td>
                <code>&#39;mskmind/qupath-stardist:0.4.3&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>use_singularity</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>use singularity instead of docker</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>max_heap_size</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>maximum heap size to pass to java options</p>
            </div>
          </td>
          <td>
                <code>&#39;64G&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to reading functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to writing functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>run metadata</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/run_stardist_cell_detection.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="nd">@timed</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><span class="k">def</span> <span class="nf">stardist_cell_lymphocyte_cli</span><span class="p">(</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>    <span class="n">slide_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>    <span class="n">num_cores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>    <span class="n">use_gpu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>    <span class="n">image</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mskmind/qupath-stardist:0.4.3&quot;</span><span class="p">,</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>    <span class="n">use_singularity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>    <span class="n">max_heap_size</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;64G&quot;</span><span class="p">,</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Run stardist using qupath CLI</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="sd">        slide_urlpath (str): url/path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a><span class="sd">        output_urlpath (str): output url/path</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">        num_cores (int): Number of cores to use for CPU parallelization</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">        use_gpu (bool): use GPU</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="sd">        image (str): docker/singularity image</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a><span class="sd">        use_singularity (bool): use singularity instead of docker</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="sd">        max_heap_size (str): maximum heap size to pass to java options</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="sd">        storage_options (dict): storage options to pass to reading functions</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="sd">        output_storage_options (dict): storage options to pass to writing functions</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a><span class="sd">        dict: run metadata</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>    <span class="n">slide_id</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_urlpath&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">stem</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>    <span class="n">properties</span> <span class="o">=</span> <span class="n">__stardist_cell_lymphocyte</span><span class="p">(</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="n">slide_id</span><span class="p">,</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;num_cores&quot;</span><span class="p">],</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;use_gpu&quot;</span><span class="p">],</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;use_singularity&quot;</span><span class="p">],</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;max_heap_size&quot;</span><span class="p">],</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>    <span class="p">)</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>    <span class="k">return</span> <span class="n">properties</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.run_stardist_cell_detection.stardist_simple" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">stardist_simple</span><span class="p">(</span><span class="n">slide_manifest</span><span class="p">,</span> <span class="n">cell_expansion_size</span><span class="p">,</span> <span class="n">image_type</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">debug_opts</span><span class="p">,</span> <span class="n">num_cores</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">use_singularity</span><span class="p">,</span> <span class="n">max_heap_size</span><span class="p">,</span> <span class="n">storage_options</span><span class="p">,</span> <span class="n">output_storage_options</span><span class="p">,</span> <span class="n">annotation_column</span><span class="o">=</span><span class="s1">&#39;stardist_geojson_url&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.run_stardist_cell_detection.stardist_simple" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Run stardist using qupath CLI on slides in a slide manifest from
slide_etl. URIs to resulting GeoJSON will be stored in a specified column
of the returned slide manifest.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_manifest</code></td>
          <td>
                <code><span title="pandera.typing.DataFrame">DataFrame</span>[<span title="luna.common.models.SlideSchema">SlideSchema</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slide manifest from slide_etl</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>cell_expansion_size</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>size in pixels to expand cell cytoplasm</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>image_type</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>qupath image type (BRIGHTFIELD_H_DAB)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output url/path</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>debug_opts</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>debug options passed as arguments to groovy script</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>num_cores</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Number of cores to use for CPU parallelization</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>image</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>docker/singularity image</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>use_singularity</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>use singularity instead of docker</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>max_heap_size</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>maximum heap size to pass to java options</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to reading functions</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to writing functions</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_column</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of column in resulting slide manifest to store GeoJson URIs</p>
            </div>
          </td>
          <td>
                <code>&#39;stardist_geojson_url&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="pandera.typing.DataFrame">DataFrame</span>[<span title="luna.common.models.SlideSchema">SlideSchema</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DataFrame[SlideSchema]: slide manifest</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/run_stardist_cell_detection.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="k">def</span> <span class="nf">stardist_simple</span><span class="p">(</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>    <span class="n">slide_manifest</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">SlideSchema</span><span class="p">],</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="n">cell_expansion_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="n">image_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="n">debug_opts</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="n">num_cores</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="n">image</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="n">use_singularity</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="n">max_heap_size</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="n">annotation_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;stardist_geojson_url&quot;</span><span class="p">,</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">SlideSchema</span><span class="p">]:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Run stardist using qupath CLI on slides in a slide manifest from</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">    slide_etl. URIs to resulting GeoJSON will be stored in a specified column</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">    of the returned slide manifest.</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">        slide_manifest (DataFrame[SlideSchema]): slide manifest from slide_etl</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">        cell_expansion_size (float): size in pixels to expand cell cytoplasm</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">        image_type (str): qupath image type (BRIGHTFIELD_H_DAB)</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">        output_urlpath (str): output url/path</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">        debug_opts (str): debug options passed as arguments to groovy script</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">        num_cores (int): Number of cores to use for CPU parallelization</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">        image (str): docker/singularity image</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">        use_singularity (bool): use singularity instead of docker</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">        max_heap_size (str): maximum heap size to pass to java options</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">        storage_options (dict): storage options to pass to reading functions</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">        output_storage_options (dict): storage options to pass to writing functions</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">        annotation_column (str): name of column in resulting slide manifest to store GeoJson URIs</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">        DataFrame[SlideSchema]: slide manifest</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">get_or_create_dask_client</span><span class="p">()</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Slide&quot;</span><span class="p">):</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="n">future</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="n">__stardist_simple</span><span class="p">,</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="n">row</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="n">cell_expansion_size</span><span class="p">,</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="n">image_type</span><span class="p">,</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="n">debug_opts</span><span class="p">,</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="n">num_cores</span><span class="p">,</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="n">image</span><span class="p">,</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="n">use_singularity</span><span class="p">,</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="n">max_heap_size</span><span class="p">,</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="n">storage_options</span><span class="p">,</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>            <span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="p">)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="k">return</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="o">**</span><span class="p">{</span><span class="n">annotation_column</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;geojson_url&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]}</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.run_stardist_cell_detection.stardist_simple_cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">stardist_simple_cli</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">cell_expansion_size</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">image_type</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">debug_opts</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">num_cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="s1">&#39;mskmind/qupath-stardist:0.4.3&#39;</span><span class="p">,</span> <span class="n">use_singularity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_heap_size</span><span class="o">=</span><span class="s1">&#39;64G&#39;</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.run_stardist_cell_detection.stardist_simple_cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Run stardist using qupath CLI</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_slide_image</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>cell_expansion_size</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>size in pixels to expand cell cytoplasm</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>num_cores</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Number of cores to use for CPU parallelization</p>
            </div>
          </td>
          <td>
                <code>1</code>
          </td>
        </tr>
        <tr>
          <td><code>image_type</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>qupath image type (BRIGHTFIELD_H_DAB)</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output url/path</p>
            </div>
          </td>
          <td>
                <code>&#39;.&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>debug_opts</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>debug options passed as arguments to groovy script</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>image</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>docker/singularity image</p>
            </div>
          </td>
          <td>
                <code>&#39;mskmind/qupath-stardist:0.4.3&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>use_singularity</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>use singularity instead of docker</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>max_heap_size</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>maximum heap size to pass to java options</p>
            </div>
          </td>
          <td>
                <code>&#39;64G&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to reading functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to writing functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>local_config</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>local config yaml file</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>metadata about function call</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/run_stardist_cell_detection.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="nd">@timed</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="k">def</span> <span class="nf">stardist_simple_cli</span><span class="p">(</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="n">slide_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="n">cell_expansion_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="n">image_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="n">debug_opts</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="n">num_cores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="n">image</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mskmind/qupath-stardist:0.4.3&quot;</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="n">use_singularity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="n">max_heap_size</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;64G&quot;</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="p">):</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Run stardist using qupath CLI</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        input_slide_image (str): path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        cell_expansion_size (float): size in pixels to expand cell cytoplasm</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">        num_cores (int): Number of cores to use for CPU parallelization</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">        image_type (str): qupath image type (BRIGHTFIELD_H_DAB)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">        output_urlpath (str): output url/path</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">        debug_opts (str): debug options passed as arguments to groovy script</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">        image (str): docker/singularity image</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">        use_singularity (bool): use singularity instead of docker</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">        max_heap_size (str): maximum heap size to pass to java options</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">        storage_options (dict): storage options to pass to reading functions</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        output_storage_options (dict): storage options to pass to writing functions</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">        local_config (str): local config yaml file</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">        dict: metadata about function call</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="k">return</span> <span class="n">__stardist_simple</span><span class="p">(</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;cell_expansion_size&quot;</span><span class="p">],</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;image_type&quot;</span><span class="p">],</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;debug_opts&quot;</span><span class="p">],</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;num_cores&quot;</span><span class="p">],</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;use_singularity&quot;</span><span class="p">],</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;max_heap_size&quot;</span><span class="p">],</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.cli.run_tissue_detection" class="doc doc-heading">
          <code>run_tissue_detection</code>


<a href="#luna.pathology.cli.run_tissue_detection" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.run_tissue_detection.cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">cli</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">tiles_urlpath</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">filter_query</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thumbnail_magnification</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tile_magnification</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dask_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.run_tissue_detection.cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Run simple/deterministic tissue detection algorithms based on a filter query, to reduce tiles to those (likely) to contain actual tissue
Args:
    slide_urlpath (str): url/path to slide image (virtual slide formats compatible with pyvips, .svs, .tif, .scn, ...)
    tiles_urlpath (str): url/path to tiles manifest (parquet)
    filter_query (str): pandas query by which to filter tiles based on their various tissue detection scores
    tile_size (int): size of tiles to use (at the requested magnification)
    thumbnail_magnification (Optional[int]): Magnification scale at which to create thumbnail for tissue detection
    tile_magnification (Optional[int]): Magnification scale at which to generate tiles
    batch_size (int): batch size for processing
    output_urlpath (str): Output url/path
    force (bool): overwrite outputs if they exist
    dask_options (dict): dask options
    storage_options (dict): storage options to pass to reading functions
    output_storage_options (dict): storage options to pass to writing functions
    local_config (str): local config file
Returns:
    dict: metadata about cli function call</p>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/run_tissue_detection.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="nd">@timed</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="k">def</span> <span class="nf">cli</span><span class="p">(</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="n">slide_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="n">tiles_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="n">filter_query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="n">tile_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="n">thumbnail_magnification</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="n">tile_magnification</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>    <span class="n">dask_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Run simple/deterministic tissue detection algorithms based on a filter query, to reduce tiles to those (likely) to contain actual tissue</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="sd">        slide_urlpath (str): url/path to slide image (virtual slide formats compatible with pyvips, .svs, .tif, .scn, ...)</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="sd">        tiles_urlpath (str): url/path to tiles manifest (parquet)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">        filter_query (str): pandas query by which to filter tiles based on their various tissue detection scores</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="sd">        tile_size (int): size of tiles to use (at the requested magnification)</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">        thumbnail_magnification (Optional[int]): Magnification scale at which to create thumbnail for tissue detection</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="sd">        tile_magnification (Optional[int]): Magnification scale at which to generate tiles</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="sd">        batch_size (int): batch size for processing</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">        output_urlpath (str): Output url/path</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">        force (bool): overwrite outputs if they exist</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">        dask_options (dict): dask options</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">        storage_options (dict): storage options to pass to reading functions</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">        output_storage_options (dict): storage options to pass to writing functions</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">        local_config (str): local config file</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">        dict: metadata about cli function call</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>    <span class="n">configure_dask_client</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dask_options&quot;</span><span class="p">])</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tile_size&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tiles_urlpath&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="k">raise</span> <span class="n">fire</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">FireError</span><span class="p">(</span><span class="s2">&quot;Specify either tiles_urlpath or tile_size&quot;</span><span class="p">)</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="n">slide_id</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_urlpath&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">stem</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>    <span class="n">tiles_urlpath</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tiles_urlpath&quot;</span><span class="p">]</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>    <span class="k">with</span> <span class="n">make_temp_directory</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_dir</span><span class="p">:</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">tiles_urlpath</span><span class="p">:</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">__generate_tiles</span><span class="p">(</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tile_size&quot;</span><span class="p">],</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                <span class="n">temp_dir</span><span class="p">,</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;force&quot;</span><span class="p">],</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tile_magnification&quot;</span><span class="p">],</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>            <span class="p">)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>            <span class="n">tiles_urlpath</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;tiles_url&quot;</span><span class="p">]</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="n">properties</span> <span class="o">=</span> <span class="n">__detect_tissue</span><span class="p">(</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="n">tiles_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="n">slide_id</span><span class="p">,</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;thumbnail_magnification&quot;</span><span class="p">],</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;filter_query&quot;</span><span class="p">],</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">],</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;force&quot;</span><span class="p">],</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>        <span class="p">)</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>    <span class="k">return</span> <span class="n">properties</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.run_tissue_detection.compute_otsu_score" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">compute_otsu_score</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span> <span class="n">slide_path</span><span class="p">,</span> <span class="n">otsu_threshold</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.run_tissue_detection.compute_otsu_score" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Return otsu score for the tile.
Args:
    row (pd.Series): row with tile metadata
    slide_path (str): path to slide
    otsu_threshold (float): otsu threshold value</p>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/run_tissue_detection.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="k">def</span> <span class="nf">compute_otsu_score</span><span class="p">(</span><span class="n">tile</span><span class="p">:</span> <span class="n">Tile</span><span class="p">,</span> <span class="n">slide_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">otsu_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    Return otsu score for the tile.</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">        row (pd.Series): row with tile metadata</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">        slide_path (str): path to slide</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">        otsu_threshold (float): otsu threshold value</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="k">with</span> <span class="n">TiffSlide</span><span class="p">(</span><span class="n">slide_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">slide</span><span class="p">:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="n">tile_arr</span> <span class="o">=</span> <span class="n">get_array_from_tile</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span> <span class="n">slide</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">rgb2gray</span><span class="p">(</span><span class="n">tile_arr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">otsu_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="k">return</span> <span class="n">score</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.run_tissue_detection.compute_purple_score" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">compute_purple_score</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span> <span class="n">slide_path</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.run_tissue_detection.compute_purple_score" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Return purple score for the tile.
Args:
    row (pd.Series): row with tile metadata
    slide_url (str): path to slide</p>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/run_tissue_detection.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="k">def</span> <span class="nf">compute_purple_score</span><span class="p">(</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="n">tile</span><span class="p">:</span> <span class="n">Tile</span><span class="p">,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="n">slide_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">    Return purple score for the tile.</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">        row (pd.Series): row with tile metadata</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">        slide_url (str): path to slide</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="k">with</span> <span class="n">TiffSlide</span><span class="p">(</span><span class="n">slide_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">slide</span><span class="p">:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="n">tile_arr</span> <span class="o">=</span> <span class="n">get_array_from_tile</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span> <span class="n">slide</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>    <span class="k">return</span> <span class="n">get_purple_score</span><span class="p">(</span><span class="n">tile_arr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.run_tissue_detection.compute_stain_score" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">compute_stain_score</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span> <span class="n">slide_path</span><span class="p">,</span> <span class="n">vectors</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">stain_threshold</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.run_tissue_detection.compute_stain_score" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Returns stain score for the tile
Args:
    row (pd.Series): row with tile metadata
    slide_url (str): path to slide
    vectors (np.ndarray): stain vectors
    channel (int): stain channel
    stain_threshold (float): stain threshold value</p>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/run_tissue_detection.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span>
<span class="normal"><a href="#__codelineno-0-92">92</a></span>
<span class="normal"><a href="#__codelineno-0-93">93</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="k">def</span> <span class="nf">compute_stain_score</span><span class="p">(</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="n">tile</span><span class="p">:</span> <span class="n">Tile</span><span class="p">,</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="n">slide_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="n">vectors</span><span class="p">,</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="n">channel</span><span class="p">,</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="n">stain_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">:</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">    Returns stain score for the tile</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">        row (pd.Series): row with tile metadata</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">        slide_url (str): path to slide</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">        vectors (np.ndarray): stain vectors</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">        channel (int): stain channel</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">        stain_threshold (float): stain threshold value</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="k">with</span> <span class="n">TiffSlide</span><span class="p">(</span><span class="n">slide_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">slide</span><span class="p">:</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="n">tile_arr</span> <span class="o">=</span> <span class="n">get_array_from_tile</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span> <span class="n">slide</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>    <span class="n">stain</span> <span class="o">=</span> <span class="n">pull_stain_channel</span><span class="p">(</span><span class="n">tile_arr</span><span class="p">,</span> <span class="n">vectors</span><span class="o">=</span><span class="n">vectors</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>    <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">stain</span> <span class="o">&gt;</span> <span class="n">stain_threshold</span><span class="p">)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="k">return</span> <span class="n">score</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.run_tissue_detection.detect_tissue" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">detect_tissue</span><span class="p">(</span><span class="n">slide_manifest</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thumbnail_magnification</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tile_magnification</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_query</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.run_tissue_detection.detect_tissue" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Run simple/deterministic tissue detection algorithms based on a filter query, to reduce tiles to those (likely) to contain actual tissue
Args:
    slide_manifest (DataFrame[SlideSchema]): slide manifest from slide_etl
    tile_size (int): size of tiles to use (at the requested magnification)
    thumbnail_magnification (Optional[int]): Magnification scale at which to create thumbnail for tissue detection
    tile_magnification (Optional[int]): Magnification scale at which to generate tiles
    filter_query (str): pandas query by which to filter tiles based on their various tissue detection scores
    batch_size (int): batch size for processing
    force (bool): overwite outputs if they exist
    storage_options (dict): storage options to pass to reading functions
    output_urlpath (str): Output url/path
    output_storage_options (dict): storage options to pass to writing functions
Returns:
    DataFrame[SlideSchema]: slide manifest</p>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/run_tissue_detection.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="k">def</span> <span class="nf">detect_tissue</span><span class="p">(</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>    <span class="n">slide_manifest</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">SlideSchema</span><span class="p">],</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>    <span class="n">tile_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>    <span class="n">thumbnail_magnification</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="n">tile_magnification</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>    <span class="n">filter_query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">SlideSchema</span><span class="p">]:</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Run simple/deterministic tissue detection algorithms based on a filter query, to reduce tiles to those (likely) to contain actual tissue</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="sd">        slide_manifest (DataFrame[SlideSchema]): slide manifest from slide_etl</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a><span class="sd">        tile_size (int): size of tiles to use (at the requested magnification)</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a><span class="sd">        thumbnail_magnification (Optional[int]): Magnification scale at which to create thumbnail for tissue detection</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a><span class="sd">        tile_magnification (Optional[int]): Magnification scale at which to generate tiles</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a><span class="sd">        filter_query (str): pandas query by which to filter tiles based on their various tissue detection scores</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a><span class="sd">        batch_size (int): batch size for processing</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a><span class="sd">        force (bool): overwite outputs if they exist</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a><span class="sd">        storage_options (dict): storage options to pass to reading functions</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a><span class="sd">        output_urlpath (str): Output url/path</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a><span class="sd">        output_storage_options (dict): storage options to pass to writing functions</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a><span class="sd">        DataFrame[SlideSchema]: slide manifest</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">get_or_create_dask_client</span><span class="p">()</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>    <span class="k">with</span> <span class="n">make_temp_directory</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_dir</span><span class="p">:</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="k">if</span> <span class="s2">&quot;tiles_url&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="n">slide_manifest</span> <span class="o">=</span> <span class="n">generate_tiles</span><span class="p">(</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>                <span class="n">slide_manifest</span><span class="p">,</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>                <span class="n">tile_size</span><span class="p">,</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>                <span class="n">temp_dir</span><span class="p">,</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                <span class="n">tile_magnification</span><span class="p">,</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                <span class="n">storage_options</span><span class="p">,</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>            <span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Slide&quot;</span><span class="p">):</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>            <span class="n">future</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>                <span class="n">__detect_tissue</span><span class="p">,</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>                <span class="n">slide</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>                <span class="n">slide</span><span class="o">.</span><span class="n">tiles_url</span><span class="p">,</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>                <span class="n">slide</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>                <span class="n">thumbnail_magnification</span><span class="p">,</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>                <span class="n">filter_query</span><span class="p">,</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>                <span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>                <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>                <span class="n">force</span><span class="p">,</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>                <span class="n">storage_options</span><span class="p">,</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                <span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>            <span class="p">)</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>            <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="n">progress</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>        <span class="n">results</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="n">slide_manifest</span> <span class="o">=</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>            <span class="n">tiles_url</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;tiles_url&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>        <span class="p">)</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>    <span class="k">return</span> <span class="n">slide_manifest</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.cli.save_tiles" class="doc doc-heading">
          <code>save_tiles</code>


<a href="#luna.pathology.cli.save_tiles" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.save_tiles.__save_tiles" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">__save_tiles</span><span class="p">(</span><span class="n">tiles_urlpath</span><span class="p">,</span> <span class="n">slide_urlpath</span><span class="p">,</span> <span class="n">output_h5_path</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.save_tiles.__save_tiles" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Saves tiles to disk</p>
<p>Tiles addresses and arrays are saved as key-value pairs in (tiles.h5),
and the corresponding manifest/header file (tiles.parquet) is also generated</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>tiles_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>tile manifest</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>slide_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output url/path</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>batch_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>size in batch dimension to chuck jobs</p>
            </div>
          </td>
          <td>
                <code>2000</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to writing functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>metadata about function call</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/save_tiles.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="nd">@local_cache_urlpath</span><span class="p">(</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>    <span class="n">file_key_write_mode</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="s2">&quot;slide_urlpath&quot;</span><span class="p">:</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="s2">&quot;output_h5_path&quot;</span><span class="p">:</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>    <span class="p">},</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="p">)</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="k">def</span> <span class="nf">__save_tiles</span><span class="p">(</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>    <span class="n">tiles_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>    <span class="n">slide_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="n">output_h5_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="p">):</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Saves tiles to disk</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="sd">    Tiles addresses and arrays are saved as key-value pairs in (tiles.h5),</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a><span class="sd">    and the corresponding manifest/header file (tiles.parquet) is also generated</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a><span class="sd">        tiles_urlpath (str): tile manifest</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a><span class="sd">        slide_urlpath (str): url/path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a><span class="sd">        output_urlpath (str): output url/path</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a><span class="sd">        batch_size (int): size in batch dimension to chuck jobs</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a><span class="sd">        output_storage_options (dict): storage options to writing functions</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a><span class="sd">        dict: metadata about function call</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>    <span class="n">tiles_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">tiles_urlpath</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_options</span><span class="p">)</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>    <span class="n">get_or_create_dask_client</span><span class="p">()</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>    <span class="k">def</span> <span class="nf">f_many</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>        <span class="k">with</span> <span class="n">TiffSlide</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="p">)</span> <span class="k">as</span> <span class="n">slide</span><span class="p">:</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>            <span class="k">return</span> <span class="p">[(</span><span class="n">x</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">get_array_from_tile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">slide</span><span class="o">=</span><span class="n">slide</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">]</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>    <span class="n">chunks</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">from_sequence</span><span class="p">(</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>        <span class="n">tiles_df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Tile&quot;</span><span class="p">),</span> <span class="n">partition_size</span><span class="o">=</span><span class="n">batch_size</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>    <span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>    <span class="n">ProgressBar</span><span class="p">()</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">chunks</span><span class="o">.</span><span class="n">map_partitions</span><span class="p">(</span><span class="n">f_many</span><span class="p">)</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">output_h5_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hfile</span><span class="p">:</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">compute</span><span class="p">():</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>            <span class="n">address</span><span class="p">,</span> <span class="n">tile_arr</span> <span class="o">=</span> <span class="n">result</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="n">hfile</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">tile_arr</span><span class="p">)</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>    <span class="k">return</span> <span class="n">tiles_df</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.save_tiles.cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">cli</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">tiles_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">dask_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.save_tiles.cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Saves tiles to disk</p>
<p>Tiles addresses and arrays are saved as key-value pairs in (tiles.h5),
and the corresponding manifest/header file (tiles.parquet) is also generated</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>tiles_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to tile manifest (.parquet)</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>batch_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>size in batch dimension to chuck jobs</p>
            </div>
          </td>
          <td>
                <code>2000</code>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output url/path prefix</p>
            </div>
          </td>
          <td>
                <code>&#39;.&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>force</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>overwrite outputs if they exist</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to reading functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to writing functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>dask_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>dask options</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>local_config</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to local config yaml file</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>metadata about function call</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/save_tiles.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="nd">@timed</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="k">def</span> <span class="nf">cli</span><span class="p">(</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="n">slide_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="n">tiles_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">dask_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="p">):</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Saves tiles to disk</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">    Tiles addresses and arrays are saved as key-value pairs in (tiles.h5),</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">    and the corresponding manifest/header file (tiles.parquet) is also generated</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">        slide_urlpath (str): url/path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">        tiles_urlpath (str): url/path to tile manifest (.parquet)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">        batch_size (int): size in batch dimension to chuck jobs</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">        output_urlpath (str): output url/path prefix</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">        force (bool): overwrite outputs if they exist</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">        storage_options (dict): storage options to reading functions</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        output_storage_options (dict): storage options to writing functions</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">        dask_options (dict): dask options</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">        local_config (str): url/path to local config yaml file</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">        dict: metadata about function call</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="n">configure_dask_client</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dask_options&quot;</span><span class="p">])</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="n">properties</span> <span class="o">=</span> <span class="n">_save_tiles</span><span class="p">(</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tiles_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;force&quot;</span><span class="p">],</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">],</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="k">return</span> <span class="n">properties</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.save_tiles.save_tiles" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">save_tiles</span><span class="p">(</span><span class="n">slide_manifest</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.save_tiles.save_tiles" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Saves tiles to disk</p>
<p>Tiles addresses and arrays are saved as key-value pairs in (tiles.h5),
and the corresponding manifest/header file (tiles.parquet) is also generated</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_manifest</code></td>
          <td>
                <code><span title="pandera.typing.DataFrame">DataFrame</span>[<span title="luna.common.models.SlideSchema">SlideSchema</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slide manifest from slide_etl</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output url/path prefix</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>force</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>overwrite outputs if they exist</p>
            </div>
          </td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>batch_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>size in batch dimension to chuck jobs</p>
            </div>
          </td>
          <td>
                <code>2000</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to reading functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to writing functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="pandera.typing.DataFrame">DataFrame</span>[<span title="luna.common.models.SlideSchema">SlideSchema</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DataFrame[SlideSchema]: slide manifest</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/save_tiles.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="k">def</span> <span class="nf">save_tiles</span><span class="p">(</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>    <span class="n">slide_manifest</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">SlideSchema</span><span class="p">],</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">SlideSchema</span><span class="p">]:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Saves tiles to disk</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">    Tiles addresses and arrays are saved as key-value pairs in (tiles.h5),</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">    and the corresponding manifest/header file (tiles.parquet) is also generated</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">        slide_manifest (DataFrame[SlideSchema]): slide manifest from slide_etl</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">        output_urlpath (str): output url/path prefix</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">        force (bool): overwrite outputs if they exist</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">        batch_size (int): size in batch dimension to chuck jobs</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">        storage_options (dict): storage options to reading functions</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">        output_storage_options (dict): storage options to writing functions</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">        DataFrame[SlideSchema]: slide manifest</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">get_or_create_dask_client</span><span class="p">()</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="k">if</span> <span class="s2">&quot;tiles_url&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Generate tiles first&quot;</span><span class="p">)</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="n">output_filesystem</span><span class="p">,</span> <span class="n">output_path_prefix</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="n">output_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">output_storage_options</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="p">)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">output_filesystem</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_urlpath</span><span class="p">):</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="n">output_filesystem</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_urlpath</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>    <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Slide&quot;</span><span class="p">):</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="n">future</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="n">_save_tiles</span><span class="p">,</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="n">slide</span><span class="o">.</span><span class="n">tiles_url</span><span class="p">,</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="n">slide</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="n">force</span><span class="p">,</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="n">storage_options</span><span class="p">,</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="n">output_storage_options</span><span class="p">,</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>    <span class="k">return</span> <span class="n">slide_manifest</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tiles_url</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;tiles_url&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.cli.slide_etl" class="doc doc-heading">
          <code>slide_etl</code>


<a href="#luna.pathology.cli.slide_etl" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">




<h4 id="luna.pathology.cli.slide_etl.SlideBuilder" class="doc doc-heading">
          <code>SlideBuilder</code>


<a href="#luna.pathology.cli.slide_etl.SlideBuilder" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>src/luna/pathology/cli/slide_etl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="k">class</span> <span class="nc">SlideBuilder</span><span class="p">:</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}):</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">storage_options</span> <span class="o">=</span> <span class="n">storage_options</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_storage_options</span> <span class="o">=</span> <span class="n">output_storage_options</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>    <span class="k">def</span> <span class="nf">__generate_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slide</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_options</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>            <span class="n">s</span> <span class="o">=</span> <span class="n">TiffSlide</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>            <span class="n">slide</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">properties</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                <span class="n">to_mag_scale_factor</span> <span class="o">=</span> <span class="n">get_scale_factor_at_magnification</span><span class="p">(</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                    <span class="n">s</span><span class="p">,</span> <span class="n">requested_magnification</span><span class="o">=</span><span class="mi">1</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                <span class="p">)</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>                <span class="n">sample_arr</span> <span class="o">=</span> <span class="n">get_downscaled_thumbnail</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">to_mag_scale_factor</span><span class="p">)</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>                <span class="n">stain_vectors</span> <span class="o">=</span> <span class="n">get_stain_vectors_macenko</span><span class="p">(</span><span class="n">sample_arr</span><span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>                <span class="n">slide</span><span class="o">.</span><span class="n">channel0_R</span> <span class="o">=</span> <span class="n">stain_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>                <span class="n">slide</span><span class="o">.</span><span class="n">channel0_G</span> <span class="o">=</span> <span class="n">stain_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>                <span class="n">slide</span><span class="o">.</span><span class="n">channel0_B</span> <span class="o">=</span> <span class="n">stain_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>                <span class="n">slide</span><span class="o">.</span><span class="n">channel1_R</span> <span class="o">=</span> <span class="n">stain_vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>                <span class="n">slide</span><span class="o">.</span><span class="n">channel1_G</span> <span class="o">=</span> <span class="n">stain_vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>                <span class="n">slide</span><span class="o">.</span><span class="n">channel1_B</span> <span class="o">=</span> <span class="n">stain_vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Couldn&#39;t get stain vectors: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>    <span class="k">def</span> <span class="nf">copy_slide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slide</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">50000000</span><span class="p">):</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="n">new_slide</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="n">name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">slide</span><span class="o">.</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="n">fs</span><span class="p">,</span> <span class="n">output_path</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>            <span class="n">output_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">output_storage_options</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="o">/</span> <span class="n">name</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">slide</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_options</span><span class="p">)</span> <span class="k">as</span> <span class="n">f1</span><span class="p">:</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>            <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f2</span><span class="p">:</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                    <span class="n">data</span> <span class="o">=</span> <span class="n">f1</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">chunksize</span><span class="p">)</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>                        <span class="k">break</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                    <span class="n">f2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="n">new_slide</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">unstrip_protocol</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>        <span class="k">return</span> <span class="n">new_slide</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>    <span class="k">def</span> <span class="nf">get_slide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">project_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Slide</span><span class="p">:</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract openslide properties and write slide to storage location</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="sd">            path (string): path to slide image</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">            slide (Slide): slide object</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="n">fs</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_options</span><span class="p">)</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>        <span class="nb">id</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>        <span class="n">size</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">du</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>        <span class="n">slide</span> <span class="o">=</span> <span class="n">Slide</span><span class="p">(</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>            <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="n">project_name</span><span class="o">=</span><span class="n">project_name</span><span class="p">,</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>            <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>            <span class="n">slide_size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="n">uuid</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid3</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">NAMESPACE_URL</span><span class="p">,</span> <span class="n">url</span><span class="p">)),</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>        <span class="p">)</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__generate_properties</span><span class="p">(</span><span class="n">slide</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="k">return</span> <span class="n">slide</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h5 id="luna.pathology.cli.slide_etl.SlideBuilder.get_slide" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_slide</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">project_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.slide_etl.SlideBuilder.get_slide" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Extract openslide properties and write slide to storage location</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>path</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>path to slide image</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>slide</code></td>          <td>
                <code><span title="luna.common.models.Slide">Slide</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slide object</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/slide_etl.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-202" name="__codelineno-0-202"></a><span class="k">def</span> <span class="nf">get_slide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">project_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Slide</span><span class="p">:</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract openslide properties and write slide to storage location</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="sd">        path (string): path to slide image</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">        slide (Slide): slide object</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>    <span class="n">fs</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_options</span><span class="p">)</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>    <span class="nb">id</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>    <span class="n">size</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">du</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>    <span class="n">slide</span> <span class="o">=</span> <span class="n">Slide</span><span class="p">(</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>        <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="n">project_name</span><span class="o">=</span><span class="n">project_name</span><span class="p">,</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>        <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>        <span class="n">slide_size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>        <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>        <span class="n">uuid</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid3</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">NAMESPACE_URL</span><span class="p">,</span> <span class="n">url</span><span class="p">)),</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>    <span class="p">)</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">__generate_properties</span><span class="p">(</span><span class="n">slide</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>    <span class="k">return</span> <span class="n">slide</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>



<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.slide_etl.cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">cli</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">project_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">subset_csv_urlpath</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">debug_limit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">no_copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">metadata_extension</span><span class="o">=</span><span class="s1">&#39;parquet&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.slide_etl.cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Ingest slide by adding them to a file or s3 based storage location and generating metadata about them</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>path to slide image</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>project_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>project name underwhich the slides should reside</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>comment</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>comment and description of dataset</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>subset_csv_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to subset csv</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>debug_limit</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>limit number of slides</p>
            </div>
          </td>
          <td>
                <code>0</code>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to output table</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to reading functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to writing functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>local_config</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to YAML config file</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>no_copy</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>determines whether we copy slides to output_urlpath</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>metadata_extension(str)</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>file extension of generated metadata file (either 'csv' or 'parquet')</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/slide_etl.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="nd">@timed</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="k">def</span> <span class="nf">cli</span><span class="p">(</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">slide_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">project_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="n">subset_csv_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="n">debug_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="n">no_copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="n">metadata_extension</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;parquet&quot;</span><span class="p">,</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="p">):</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Ingest slide by adding them to a file or s3 based storage location and generating metadata about them</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        slide_urlpath (str): path to slide image</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">        project_name (str): project name underwhich the slides should reside</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">        comment (str): comment and description of dataset</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        subset_csv_urlpath (str): url/path to subset csv</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">        debug_limit (int): limit number of slides</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">        output_urlpath (str): url/path to output table</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">        storage_options (dict): storage options to pass to reading functions</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">        output_storage_options (dict): storage options to pass to writing functions</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">        local_config (str): url/path to YAML config file</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">        no_copy (bool): determines whether we copy slides to output_urlpath</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">        metadata_extension(str): file extension of generated metadata file (either &#39;csv&#39; or &#39;parquet&#39;)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="n">filesystem</span><span class="p">,</span> <span class="n">slide_path</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_urlpath&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">]</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="p">)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="n">slide_paths</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: list[str]</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">slide_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">VALID_SLIDE_EXTENSIONS</span><span class="p">]):</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="n">slide_paths</span> <span class="o">+=</span> <span class="n">slide_path</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">VALID_SLIDE_EXTENSIONS</span><span class="p">:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>            <span class="n">slide_paths</span> <span class="o">+=</span> <span class="n">filesystem</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">slide_path</span><span class="si">}</span><span class="s2">/*</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;metadata_extension&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="n">extension</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;metadata_extension&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;subset_csv_urlpath&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="n">slide_paths</span> <span class="o">=</span> <span class="n">apply_csv_filter</span><span class="p">(</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>            <span class="n">slide_paths</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;subset_csv_urlpath&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">]</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;debug_limit&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="n">slide_paths</span> <span class="o">=</span> <span class="n">slide_paths</span><span class="p">[:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;debug_limit&quot;</span><span class="p">]]</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="n">configure_dask_client</span><span class="p">()</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">slide_paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="n">slide_urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">filesystem</span><span class="o">.</span><span class="n">unstrip_protocol</span><span class="p">(</span><span class="n">slide_path</span><span class="p">)</span> <span class="k">for</span> <span class="n">slide_path</span> <span class="ow">in</span> <span class="n">slide_paths</span><span class="p">]</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">slide_etl</span><span class="p">(</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="n">slide_urls</span><span class="p">,</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;project_name&quot;</span><span class="p">],</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;comment&quot;</span><span class="p">],</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;no_copy&quot;</span><span class="p">],</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="p">)</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="n">output_filesystem</span><span class="p">,</span> <span class="n">output_path</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">]</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="p">)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="n">f</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;slide_ingest_</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;project_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="k">with</span> <span class="n">output_filesystem</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="k">if</span> <span class="n">extension</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing to csv file&quot;</span><span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="k">elif</span> <span class="n">extension</span> <span class="o">==</span> <span class="s2">&quot;parquet&quot;</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing to parquet file&quot;</span><span class="p">)</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>                <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.slide_etl.slide_etl" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">slide_etl</span><span class="p">(</span><span class="n">slide_urls</span><span class="p">,</span> <span class="n">project_name</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">no_copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.slide_etl.slide_etl" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Ingest slides by adding them to a file or s3 based storage location and generating metadata about them</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_urls</code></td>
          <td>
                <code>Union[str, List[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>path to slide image(s)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>project_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>project name underwhich the slides should reside</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>comment</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>comment and description of dataset</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to reading functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to output table</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to writing functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>no_copy</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>do not copy slides to output path</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="pandera.typing.DataFrame">DataFrame</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DataFrame[SlideSchema]: dataframe containing the metadata of all the slides</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/slide_etl.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="k">def</span> <span class="nf">slide_etl</span><span class="p">(</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="n">slide_urls</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="n">project_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>    <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>    <span class="n">no_copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Ingest slides by adding them to a file or s3 based storage location and generating metadata about them</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">        slide_urls (Union[str, List[str])): path to slide image(s)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">        project_name (str): project name underwhich the slides should reside</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">        comment (str): comment and description of dataset</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">        storage_options (dict): storage options to pass to reading functions</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">        output_urlpath (str): url/path to output table</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">        output_storage_options (dict): storage options to pass to writing functions</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">        no_copy (bool): do not copy slides to output path</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">        DataFrame[SlideSchema]: dataframe containing the metadata of all the slides</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="n">sb</span> <span class="o">=</span> <span class="n">SlideBuilder</span><span class="p">(</span><span class="n">storage_options</span><span class="p">,</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="n">output_storage_options</span><span class="p">)</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slide_urls</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="k">return</span> <span class="n">__slide_etl</span><span class="p">(</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>            <span class="n">sb</span><span class="p">,</span> <span class="n">slide_urls</span><span class="p">,</span> <span class="n">project_name</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="p">,</span> <span class="n">no_copy</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="p">)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">get_or_create_dask_client</span><span class="p">()</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>            <span class="n">__slide_etl</span><span class="p">,</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>            <span class="n">sb</span><span class="p">,</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>            <span class="n">slide_url</span><span class="p">,</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>            <span class="n">project_name</span><span class="p">,</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>            <span class="n">comment</span><span class="p">,</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>            <span class="n">output_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>            <span class="n">no_copy</span><span class="p">,</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="p">)</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="k">for</span> <span class="n">slide_url</span> <span class="ow">in</span> <span class="n">slide_urls</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>    <span class="p">]</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="n">progress</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="n">dfs</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.cli.visualize_tile_labels_png" class="doc doc-heading">
          <code>visualize_tile_labels_png</code>


<a href="#luna.pathology.cli.visualize_tile_labels_png" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.visualize_tile_labels_png.cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">cli</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">tiles_urlpath</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">mpp_units</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_labels</span><span class="o">=</span><span class="s1">&#39;???&#39;</span><span class="p">,</span> <span class="n">output_urlpath</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">requested_magnification</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">output_storage_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">local_config</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

<a href="#luna.pathology.cli.visualize_tile_labels_png.cli" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Generate nice tile markup images with continuous or discrete tile scores</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>tiles_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to a slide-tile manifest file (.tiles.csv)</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>mpp_units</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>if true, additional rescaling is applied to match micro-meter and pixel coordinate systems</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>plot_labels</code></td>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>labels to plot</p>
            </div>
          </td>
          <td>
                <code>&#39;???&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output url/path prefix</p>
            </div>
          </td>
          <td>
                <code>&#39;.&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>requested_magnification</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Magnification scale at which to perform computation</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>tile_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>tile size</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to reading functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>output_storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to writing functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>local_config</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to local config YAML file</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>metadata about function call</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/visualize_tile_labels_png.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="nd">@timed</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="nd">@save_metadata</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="k">def</span> <span class="nf">cli</span><span class="p">(</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="n">slide_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="n">tiles_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="n">mpp_units</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="n">plot_labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;???&quot;</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">output_urlpath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">requested_magnification</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="n">tile_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="n">output_storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="n">local_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="p">):</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate nice tile markup images with continuous or discrete tile scores</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">        slide_urlpath (str): url/path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">        tiles_urlpath (str): url/path to a slide-tile manifest file (.tiles.csv)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">        mpp_units (bool): if true, additional rescaling is applied to match micro-meter and pixel coordinate systems</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">        plot_labels (List[str]): labels to plot</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">        output_urlpath (str): output url/path prefix</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">        requested_magnification (int): Magnification scale at which to perform computation</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        tile_size (int): tile size</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">        storage_options (dict): storage options to pass to reading functions</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">        output_storage_options (dict): storage options to pass to writing functions</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        local_config (str): url/path to local config YAML file</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">        dict: metadata about function call</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tile_size&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tiles_urlpath&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="k">raise</span> <span class="n">fire</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">FireError</span><span class="p">(</span><span class="s2">&quot;Specify either tiles_urlpath or tile_size&quot;</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="n">thumbnails_overlayed</span> <span class="o">=</span> <span class="n">visualize_tiles</span><span class="p">(</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;slide_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tiles_urlpath&quot;</span><span class="p">],</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;mpp_units&quot;</span><span class="p">],</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;plot_labels&quot;</span><span class="p">],</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;requested_magnification&quot;</span><span class="p">],</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;tile_size&quot;</span><span class="p">],</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;storage_options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="p">)</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="n">fs</span><span class="p">,</span> <span class="n">output_path_prefix</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_urlpath&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_storage_options&quot;</span><span class="p">]</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>    <span class="p">)</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="n">images</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="k">for</span> <span class="n">score_type</span><span class="p">,</span> <span class="n">thumbnail_overlayed</span> <span class="ow">in</span> <span class="n">thumbnails_overlayed</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="n">output_file</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>            <span class="n">Path</span><span class="p">(</span><span class="n">output_path_prefix</span><span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;tile_scores_and_labels_visualization_</span><span class="si">{</span><span class="n">score_type</span><span class="si">}</span><span class="s2">.png&quot;</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="p">)</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="n">thumbnail_overlayed</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">thumbnail_overlayed</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>            <span class="n">thumbnail_overlayed</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;PNG&quot;</span><span class="p">)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="n">images</span><span class="p">[</span><span class="n">score_type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">score_type</span><span class="si">}</span><span class="s2"> visualization at </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">fs</span><span class="o">.</span><span class="n">unstrip_protocol</span><span class="p">(</span><span class="n">output_path_prefix</span><span class="p">),</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="n">images</span><span class="p">,</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="p">}</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="k">return</span> <span class="n">properties</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.cli.visualize_tile_labels_png.visualize_tiles" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">visualize_tiles</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="p">,</span> <span class="n">tiles_urlpath</span><span class="p">,</span> <span class="n">mpp_units</span><span class="p">,</span> <span class="n">plot_labels</span><span class="p">,</span> <span class="n">requested_magnification</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.cli.visualize_tile_labels_png.visualize_tiles" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Generate nice tile markup images with continuous or discrete tile scores</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tiles_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url/path to a slide-tile manifest file (.tiles.csv)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>mpp_units</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>if true, additional rescaling is applied to match micro-meter and pixel coordinate systems</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>plot_labels</code></td>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>labels to plot</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>requested_magnification</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Magnification scale at which to perform computation</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>tile_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>tile size</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>storage_options</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>storage options to pass to reading functions</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>dict[str,np.ndarray]: score type to numpy array representation of overlayed thumbnail</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/cli/visualize_tile_labels_png.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="k">def</span> <span class="nf">visualize_tiles</span><span class="p">(</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="n">slide_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="n">tiles_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="n">mpp_units</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="n">plot_labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="n">requested_magnification</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="n">tile_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="p">):</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate nice tile markup images with continuous or discrete tile scores</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">        slide_urlpath (str): url/path to slide image (virtual slide formats compatible with openslide, .svs, .tif, .scn, ...)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">        tiles_urlpath (str): url/path to a slide-tile manifest file (.tiles.csv)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">        mpp_units (bool): if true, additional rescaling is applied to match micro-meter and pixel coordinate systems</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">        plot_labels (List[str]): labels to plot</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">        requested_magnification (int): Magnification scale at which to perform computation</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">        tile_size (int): tile size</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">        storage_options (dict): storage options to pass to reading functions</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="sd">        dict[str,np.ndarray]: score type to numpy array representation of overlayed thumbnail</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">plot_labels</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="n">plot_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">plot_labels</span><span class="p">]</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>    <span class="c1"># Get tiles</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>    <span class="k">if</span> <span class="n">tiles_urlpath</span><span class="p">:</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tiles_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">of</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;address&quot;</span><span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">tile_size</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">generate_tiles</span><span class="p">(</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>            <span class="n">slide_urlpath</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">storage_options</span><span class="p">,</span> <span class="n">requested_magnification</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="p">)</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Specify tile size or url/path to tiling data&quot;</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="n">slide</span> <span class="o">=</span> <span class="n">tiffslide</span><span class="o">.</span><span class="n">TiffSlide</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="n">to_mag_scale_factor</span> <span class="o">=</span> <span class="n">get_scale_factor_at_magnification</span><span class="p">(</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>            <span class="n">slide</span><span class="p">,</span> <span class="n">requested_magnification</span><span class="o">=</span><span class="n">requested_magnification</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="p">)</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="c1"># Create thumbnail image for scoring</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="n">sample_arr</span> <span class="o">=</span> <span class="n">get_downscaled_thumbnail</span><span class="p">(</span><span class="n">slide</span><span class="p">,</span> <span class="n">to_mag_scale_factor</span><span class="p">)</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="c1"># See if we need to adjust scale_factor to account for different units</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="k">if</span> <span class="n">mpp_units</span><span class="p">:</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="n">unit_sf</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="k">for</span> <span class="n">mpp_key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;aperio.MPP&quot;</span><span class="p">,</span> <span class="s2">&quot;openslide.mpp-x&quot;</span><span class="p">):</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                <span class="k">if</span> <span class="n">mpp_key</span> <span class="ow">in</span> <span class="n">slide</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                    <span class="n">unit_sf</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">slide</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">mpp_key</span><span class="p">])</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>            <span class="k">if</span> <span class="n">unit_sf</span><span class="p">:</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>                <span class="n">to_mag_scale_factor</span> <span class="o">*=</span> <span class="n">unit_sf</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                    <span class="s2">&quot;No MPP scale factor was recognized in slide properties.&quot;</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                <span class="p">)</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="c1"># only visualize tile scores that were able to be computed</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>    <span class="n">all_score_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">plot_labels</span><span class="p">)</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>    <span class="n">score_types_to_visualize</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">all_score_types</span><span class="p">)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="n">thumbnails_overlayed</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str,np.ndarray]</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="k">for</span> <span class="n">score_type</span> <span class="ow">in</span> <span class="n">score_types_to_visualize</span><span class="p">:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="n">thumbnails_overlayed</span><span class="p">[</span><span class="n">score_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">visualize_tiling_scores</span><span class="p">(</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>            <span class="n">df</span><span class="p">,</span> <span class="n">sample_arr</span><span class="p">,</span> <span class="n">to_mag_scale_factor</span><span class="p">,</span> <span class="n">score_type</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="p">)</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>    <span class="k">return</span> <span class="n">thumbnails_overlayed</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>


  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h2 id="luna.pathology.common" class="doc doc-heading">
          <code>common</code>


<a href="#luna.pathology.common" class="headerlink" title="Permanent link">&para;</a></h2>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-module">




<h3 id="luna.pathology.common.annotation_utils" class="doc doc-heading">
          <code>annotation_utils</code>


<a href="#luna.pathology.common.annotation_utils" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.annotation_utils.check_slideviewer_and_download_bmp" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">check_slideviewer_and_download_bmp</span><span class="p">(</span><span class="n">sv_project_id</span><span class="p">,</span> <span class="n">slideviewer_path</span><span class="p">,</span> <span class="n">slide_id</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">SLIDE_BMP_DIR</span><span class="p">,</span> <span class="n">SLIDEVIEWER_API_URL</span><span class="p">,</span> <span class="n">TMP_ZIP_DIR</span><span class="p">)</span></code>

<a href="#luna.pathology.common.annotation_utils.check_slideviewer_and_download_bmp" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>download bitmap annotation from slideviwer</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>sv_project_id</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slideviewer project id</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>slideviewer_path</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>filepath to the input slide</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>slide_id</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slide id</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>users</code></td>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>list of users who provided annotations</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>SLIDE_BMP_DIR</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output folder to save bitmap to</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>SLIDEVIEWER_API_URL</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>API url for slide viewer</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Union">Union</span>[None, <span title="typing.List">List</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Union[None, List]: returns none if there are no annotations to process, or
returns a list containing output parameters</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/annotation_utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="k">def</span> <span class="nf">check_slideviewer_and_download_bmp</span><span class="p">(</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="n">sv_project_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>    <span class="n">slideviewer_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>    <span class="n">slide_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>    <span class="n">users</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="n">SLIDE_BMP_DIR</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="n">SLIDEVIEWER_API_URL</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>    <span class="n">TMP_ZIP_DIR</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">List</span><span class="p">]:</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;download bitmap annotation from slideviwer</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">        sv_project_id (str): slideviewer project id</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">        slideviewer_path (str): filepath to the input slide</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">        slide_id (str): slide id</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">        users (List[str]): list of users who provided annotations</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">        SLIDE_BMP_DIR (str): output folder to save bitmap to</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">        SLIDEVIEWER_API_URL (str): API url for slide viewer</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">        TMP_ZIP_DIR (str) temporary directory to save ziped bitmap files to</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">        Union[None, List]: returns none if there are no annotations to process, or</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">            returns a list containing output parameters</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="n">slide_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">slide_id</span><span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="n">output_dict_base</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="s2">&quot;sv_project_id&quot;</span><span class="p">:</span> <span class="n">sv_project_id</span><span class="p">,</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="s2">&quot;slideviewer_path&quot;</span><span class="p">:</span> <span class="n">slideviewer_path</span><span class="p">,</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="s2">&quot;slide_id&quot;</span><span class="p">:</span> <span class="n">slide_id</span><span class="p">,</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;n/a&quot;</span><span class="p">,</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="s2">&quot;bmp_filepath&quot;</span><span class="p">:</span> <span class="s2">&quot;n/a&quot;</span><span class="p">,</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="s2">&quot;npy_filepath&quot;</span><span class="p">:</span> <span class="s2">&quot;n/a&quot;</span><span class="p">,</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>        <span class="s2">&quot;geojson&quot;</span><span class="p">:</span> <span class="s2">&quot;n/a&quot;</span><span class="p">,</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="s2">&quot;geojson_path&quot;</span><span class="p">:</span> <span class="s2">&quot;n/a&quot;</span><span class="p">,</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="p">}</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_dict_base</span><span class="p">)</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="c1"># download bitmap</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="n">bmp_record_uuid</span><span class="p">,</span> <span class="n">bmp_filepath</span> <span class="o">=</span> <span class="n">get_slide_bitmap</span><span class="p">(</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>            <span class="n">slideviewer_path</span><span class="p">,</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>            <span class="n">user</span><span class="p">,</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>            <span class="n">slide_id</span><span class="p">,</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>            <span class="n">SLIDE_BMP_DIR</span><span class="p">,</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>            <span class="n">SLIDEVIEWER_API_URL</span><span class="p">,</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>            <span class="n">TMP_ZIP_DIR</span><span class="p">,</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>            <span class="n">sv_project_id</span><span class="p">,</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="c1"># convert to npy</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="k">if</span> <span class="n">bmp_record_uuid</span> <span class="o">!=</span> <span class="s2">&quot;n/a&quot;</span> <span class="ow">or</span> <span class="n">bmp_filepath</span> <span class="o">!=</span> <span class="s2">&quot;n/a&quot;</span><span class="p">:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>            <span class="n">output_dict</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">output_dict_base</span><span class="p">)</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>            <span class="n">output_dict</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>            <span class="n">output_dict</span><span class="p">[</span><span class="s2">&quot;bmp_filepath&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmp_filepath</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_dict</span><span class="p">)</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>    <span class="c1"># at this point if outputs is empty, return early</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>        <span class="k">return</span> <span class="n">outputs</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.annotation_utils.convert_bmp_to_npy" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">convert_bmp_to_npy</span><span class="p">(</span><span class="n">bmp_file</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">)</span></code>

<a href="#luna.pathology.common.annotation_utils.convert_bmp_to_npy" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>convert bitmap to numpy</p>
<p>Reads a bmp file and creates friendly numpy ndarray file in the uint8 format in the output
directory specified, with extention .annot.npy</p>

<details class="troubleshooting" open>
  <summary>Troubleshooting</summary>
  <p>Make sure Pillow is upgraded to version 8.0.0 if getting an Unsupported BMP Size OS Error</p>
</details>


  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>bmp_file</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>path to .bmp image</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_folder</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>path to output folder</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns
    str: filepath to file containing numpy array</p>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/annotation_utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="k">def</span> <span class="nf">convert_bmp_to_npy</span><span class="p">(</span><span class="n">bmp_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;convert bitmap to numpy</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="sd">    Reads a bmp file and creates friendly numpy ndarray file in the uint8 format in the output</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="sd">    directory specified, with extention .annot.npy</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">    Troubleshooting:</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">        Make sure Pillow is upgraded to version 8.0.0 if getting an Unsupported BMP Size OS Error</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">        bmp_file (str): path to .bmp image</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">        output_folder (str): path to output folder</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">        str: filepath to file containing numpy array</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>    <span class="n">Image</span><span class="o">.</span><span class="n">MAX_IMAGE_PIXELS</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="k">if</span> <span class="s2">&quot;.bmp&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bmp_file</span><span class="p">:</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>    <span class="n">new_image_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">bmp_file</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.bmp&quot;</span><span class="p">,</span> <span class="s2">&quot;.npy&quot;</span><span class="p">)</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="n">bmp_caseid_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">bmp_file</span><span class="p">))</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>    <span class="n">output_caseid_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">bmp_caseid_folder</span><span class="p">)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_caseid_folder</span><span class="p">):</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_caseid_folder</span><span class="p">)</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="n">output_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_caseid_folder</span><span class="p">,</span> <span class="n">new_image_name</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_filepath</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">bmp_file</span><span class="p">)))</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="k">return</span> <span class="n">output_filepath</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.annotation_utils.convert_slide_bitmap_to_geojson" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">convert_slide_bitmap_to_geojson</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">all_labelsets</span><span class="p">,</span> <span class="n">contour_level</span><span class="p">,</span> <span class="n">SLIDE_NPY_DIR</span><span class="p">,</span> <span class="n">slide_store_dir</span><span class="p">)</span></code>

<a href="#luna.pathology.common.annotation_utils.convert_slide_bitmap_to_geojson" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>convert slide bitmap to geoJSON</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>outputs</code></td>
          <td>
                <code><span title="typing.List">List</span>[dict]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>list of output parameter dict</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>all_labelsets</code></td>
          <td>
                <code><span title="typing.List">List</span>[dict]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>a list of dictionaries containing label sets</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>contour_level</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>value along which to find contours</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>SLIDE_NPY_DIR</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>directory containing the slide saved as a .npy</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>slide_store_dir</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>directory of the datastore</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Tuple">Tuple</span>[str, <span title="typing.List">List</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Tuple[str, List]: a pair of slide id and output geojson tables</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/annotation_utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="k">def</span> <span class="nf">convert_slide_bitmap_to_geojson</span><span class="p">(</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>    <span class="n">outputs</span><span class="p">,</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>    <span class="n">all_labelsets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>    <span class="n">contour_level</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>    <span class="n">SLIDE_NPY_DIR</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>    <span class="n">slide_store_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">]:</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;convert slide bitmap to geoJSON</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a><span class="sd">        outputs (List[dict]): list of output parameter dict</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a><span class="sd">        all_labelsets (List[dict]): a list of dictionaries containing label sets</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a><span class="sd">        contour_level (float): value along which to find contours</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a><span class="sd">        SLIDE_NPY_DIR (str): directory containing the slide saved as a .npy</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a><span class="sd">        slide_store_dir (str): directory of the datastore</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a><span class="sd">        Tuple[str, List]: a pair of slide id and output geojson tables</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>    <span class="kn">import</span> <span class="nn">warnings</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;convert_slide_bitmap_to_geojson() is currently depreciated!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.annotation_utils.get_slide_bitmap" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_slide_bitmap</span><span class="p">(</span><span class="n">full_filename</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">slide_id</span><span class="p">,</span> <span class="n">SLIDE_BMP_DIR</span><span class="p">,</span> <span class="n">SLIDEVIEWER_API_URL</span><span class="p">,</span> <span class="n">TMP_ZIP_DIR</span><span class="p">,</span> <span class="n">sv_project_id</span><span class="p">)</span></code>

<a href="#luna.pathology.common.annotation_utils.get_slide_bitmap" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>get slide bitmap</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>full_filename</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>filename of input slide</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>user</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of pathologist/annotater who labled the input slide</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>SLIDE_BMP_DIR</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output folder to save bitmap to</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>SLIDEVIEWER_API_URL</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>API url for slide viewer</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>sv_project_id</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slide viewer project id</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Tuple">Tuple</span>[str, str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Tuple[str, str]: a tuple of the bitmap record uuid and filepath to saved bitmap</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/annotation_utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="k">def</span> <span class="nf">get_slide_bitmap</span><span class="p">(</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="n">full_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="n">slide_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">SLIDE_BMP_DIR</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">SLIDEVIEWER_API_URL</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="n">TMP_ZIP_DIR</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="n">sv_project_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;get slide bitmap</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">        full_filename (str): filename of input slide</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">        user (str): name of pathologist/annotater who labled the input slide</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">        SLIDE_BMP_DIR (str): output folder to save bitmap to</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">        SLIDEVIEWER_API_URL (str): API url for slide viewer</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">        TMP_ZIP_DIR (str) temporary directory to save ziped bitmap files to</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">        sv_project_id (str): slide viewer project id</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        Tuple[str, str]: a tuple of the bitmap record uuid and filepath to saved bitmap</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="n">full_filename_without_ext</span> <span class="o">=</span> <span class="n">full_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.svs&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="n">bmp_dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="n">SLIDE_BMP_DIR</span><span class="p">,</span> <span class="n">full_filename_without_ext</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="n">bmp_dest_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bmp_dirname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">slide_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">user</span> <span class="o">+</span> <span class="s2">&quot;_annot.bmp&quot;</span><span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bmp_dest_path</span><span class="p">):</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removing temporary file &quot;</span> <span class="o">+</span> <span class="n">bmp_dest_path</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">bmp_dest_path</span><span class="p">)</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="c1"># download bitmap file using api (from brush and fill tool), download zips into TMP_ZIP_DIR</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">TMP_ZIP_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="n">zipfile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="n">TMP_ZIP_DIR</span><span class="p">,</span> <span class="n">full_filename_without_ext</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">user</span> <span class="o">+</span> <span class="s2">&quot;.zip&quot;</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="p">)</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="n">url</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="n">SLIDEVIEWER_API_URL</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="o">+</span> <span class="s2">&quot;slides/&quot;</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="o">+</span> <span class="s2">&quot;@mskcc.org/projects;&quot;</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sv_project_id</span><span class="p">)</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="o">+</span> <span class="s2">&quot;;&quot;</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="o">+</span> <span class="n">full_filename</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="o">+</span> <span class="s2">&quot;/getLabelFileBMP&quot;</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="p">)</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pulling from Slideviewer URL=</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="n">success</span> <span class="o">=</span> <span class="n">download_zip</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">zipfile_path</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="n">bmp_record_uuid</span> <span class="o">=</span> <span class="s2">&quot;n/a&quot;</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="n">bmp_filepath</span> <span class="o">=</span> <span class="s2">&quot;n/a&quot;</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">zipfile_path</span><span class="p">)</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">bmp_record_uuid</span><span class="p">,</span> <span class="n">bmp_filepath</span><span class="p">)</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="n">unzipped_file_descriptor</span> <span class="o">=</span> <span class="n">unzip</span><span class="p">(</span><span class="n">zipfile_path</span><span class="p">)</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="k">if</span> <span class="n">unzipped_file_descriptor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">bmp_record_uuid</span><span class="p">,</span> <span class="n">bmp_filepath</span><span class="p">)</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>    <span class="c1"># create bmp file from unzipped file</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">bmp_dest_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">bmp_dest_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="n">ff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>            <span class="n">unzipped_file_descriptor</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;labels.bmp&quot;</span><span class="p">)</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="p">)</span>  <span class="c1"># all bmps from slideviewer are called labels.bmp</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="s2">&quot;Added slide &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">slide_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; to &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">bmp_dest_path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;  * * * * &quot;</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="p">)</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="n">bmp_hash</span> <span class="o">=</span> <span class="n">FileHash</span><span class="p">(</span><span class="s2">&quot;sha256&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">hash_file</span><span class="p">(</span><span class="n">bmp_dest_path</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="n">bmp_record_uuid</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SVBMP-</span><span class="si">{</span><span class="n">bmp_hash</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>    <span class="n">bmp_filepath</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>        <span class="n">bmp_dirname</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">slide_id</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">user</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">bmp_record_uuid</span> <span class="o">+</span> <span class="s2">&quot;_annot.bmp&quot;</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="p">)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">bmp_dest_path</span><span class="p">,</span> <span class="n">bmp_filepath</span><span class="p">)</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="c1"># cleanup</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">zipfile_path</span><span class="p">):</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">zipfile_path</span><span class="p">)</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">bmp_record_uuid</span><span class="p">,</span> <span class="n">bmp_filepath</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.common.build_geojson" class="doc doc-heading">
          <code>build_geojson</code>


<a href="#luna.pathology.common.build_geojson" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.build_geojson.add_contours_for_label" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">add_contours_for_label</span><span class="p">(</span><span class="n">annotation_geojson</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">label_num</span><span class="p">,</span> <span class="n">mappings</span><span class="p">,</span> <span class="n">contour_level</span><span class="p">)</span></code>

<a href="#luna.pathology.common.build_geojson.add_contours_for_label" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>creates geoJSON feature dictionary for labels</p>
<p>Finds the contours for a label mask, builds a polygon and then converts the polygon
to geoJSON feature dictionary</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>annotation_geojson</code></td>
          <td>
                <code>dict[str, any]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>geoJSON result to populate</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>npy array of bitmap</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>label_num</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>the integer cooresponding to the annotated label</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>mappings</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>label map for specified label set</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>contour_level</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>value along which to find contours in the array</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, any]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>dict[str, any]: geoJSON with label countours</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/build_geojson.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="k">def</span> <span class="nf">add_contours_for_label</span><span class="p">(</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="n">annotation_geojson</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">],</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>    <span class="n">annotation</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>    <span class="n">label_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="n">mappings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>    <span class="n">contour_level</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]:</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;creates geoJSON feature dictionary for labels</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="sd">    Finds the contours for a label mask, builds a polygon and then converts the polygon</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="sd">    to geoJSON feature dictionary</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="sd">        annotation_geojson (dict[str, any]): geoJSON result to populate</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">        annotation (np.ndarray): npy array of bitmap</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="sd">        label_num (int): the integer cooresponding to the annotated label</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">        mappings (dict): label map for specified label set</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="sd">        contour_level (float): value along which to find contours in the array</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">         dict[str, any]: geoJSON with label countours</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>    <span class="k">if</span> <span class="n">label_num</span> <span class="ow">in</span> <span class="n">annotation</span><span class="p">:</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Building contours for label &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">label_num</span><span class="p">))</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="n">num_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">annotation</span> <span class="o">==</span> <span class="n">label_num</span><span class="p">)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;num_pixels with label&quot;</span><span class="p">,</span> <span class="n">num_pixels</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">annotation</span> <span class="o">==</span> <span class="n">label_num</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="n">contours</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">find_contours</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">contour_level</span><span class="p">)</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;num_contours&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">contours</span><span class="p">))</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="n">polygons</span> <span class="o">=</span> <span class="p">[</span><span class="n">Polygon</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">]</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="n">parent_nums</span> <span class="o">=</span> <span class="n">find_parents</span><span class="p">(</span><span class="n">polygons</span><span class="p">)</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="n">polygon_by_index_number</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">parent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parent_nums</span><span class="p">):</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="n">contour</span> <span class="o">=</span> <span class="n">contours</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>            <span class="n">contour_list</span> <span class="o">=</span> <span class="n">contour</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>            <span class="c1"># switch coordinates, otherwise gets flipped</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>            <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">contour_list</span><span class="p">:</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>                <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                <span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                <span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>            <span class="c1"># this polygon does not have parent, so this is a parent object (top level)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>            <span class="k">if</span> <span class="n">parent</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>                <span class="n">polygon</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{},</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Polygon&quot;</span><span class="p">,</span> <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[]},</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>                <span class="p">}</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>                <span class="n">polygon</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;label_num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">label_num</span><span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>                <span class="n">polygon</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;label_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mappings</span><span class="p">[</span><span class="n">label_num</span><span class="p">]</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>                <span class="n">polygon</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">][</span><span class="s2">&quot;coordinates&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contour_list</span><span class="p">)</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>                <span class="n">polygon_by_index_number</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">polygon</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>                <span class="c1"># this is a child object, add coordinates as a hole to the parent polygon</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                <span class="c1"># fetch parent&#39;s polygon</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                <span class="n">parent_polygon</span> <span class="o">=</span> <span class="n">polygon_by_index_number</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                <span class="c1"># append as hole to parent</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>                <span class="n">parent_polygon</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">][</span><span class="s2">&quot;coordinates&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contour_list</span><span class="p">)</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="c1"># add parent polygon feature dicts to running annotation geojson object</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">polygon</span> <span class="ow">in</span> <span class="n">polygon_by_index_number</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>            <span class="n">annotation_geojson</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No label &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">label_num</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; found&quot;</span><span class="p">)</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>    <span class="k">return</span> <span class="n">annotation_geojson</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.build_geojson.build_all_geojsons_from_default" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">build_all_geojsons_from_default</span><span class="p">(</span><span class="n">default_annotation_geojson</span><span class="p">,</span> <span class="n">all_labelsets</span><span class="p">,</span> <span class="n">contour_level</span><span class="p">)</span></code>

<a href="#luna.pathology.common.build_geojson.build_all_geojsons_from_default" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>builds geoJSON objects from a set of labels</p>
<p>wraps build_labelset_specific_geojson with logic to generate annotations
from multiple labelsets</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>default_annotation_geojson</code></td>
          <td>
                <code>dict[str, any]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>input geoJSON</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>all_labelsets</code></td>
          <td>
                <code>list[dict]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>a list of dictionaries containing label sets</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>contour_level</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>value along which to find contours</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>a dictionary with labelset name and cooresponding geoJSON as key, value</p>
            </div>
          </td>
        </tr>
        <tr>
<td></td>          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>pairs</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/build_geojson.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-236" name="__codelineno-0-236"></a><span class="k">def</span> <span class="nf">build_all_geojsons_from_default</span><span class="p">(</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>    <span class="n">default_annotation_geojson</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">],</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>    <span class="n">all_labelsets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>    <span class="n">contour_level</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;builds geoJSON objects from a set of labels</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="sd">    wraps build_labelset_specific_geojson with logic to generate annotations</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><span class="sd">    from multiple labelsets</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a><span class="sd">        default_annotation_geojson (dict[str, any]): input geoJSON</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">        all_labelsets (list[dict]): a list of dictionaries containing label sets</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">        contour_level (float):  value along which to find contours</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">        dict: a dictionary with labelset name and cooresponding geoJSON as key, value</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="sd">        pairs</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>    <span class="n">labelset_name_to_labelset_specific_geojson</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>    <span class="k">for</span> <span class="n">labelset_name</span><span class="p">,</span> <span class="n">labelset</span> <span class="ow">in</span> <span class="n">all_labelsets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>        <span class="k">if</span> <span class="n">labelset_name</span> <span class="o">!=</span> <span class="n">DEFAULT_LABELSET_NAME</span><span class="p">:</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>            <span class="c1"># use default labelset geojson to build labelset specific geojson</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>            <span class="n">annotation_geojson</span> <span class="o">=</span> <span class="n">build_labelset_specific_geojson</span><span class="p">(</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>                <span class="n">default_annotation_geojson</span><span class="p">,</span> <span class="n">labelset</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>            <span class="p">)</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>            <span class="n">annotation_geojson</span> <span class="o">=</span> <span class="n">default_annotation_geojson</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="c1"># only add if geojson not none (built correctly and contains &gt;= 1 polygon)</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="k">if</span> <span class="n">annotation_geojson</span><span class="p">:</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>            <span class="n">labelset_name_to_labelset_specific_geojson</span><span class="p">[</span><span class="n">labelset_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>                <span class="n">annotation_geojson</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>            <span class="p">)</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>    <span class="k">return</span> <span class="n">labelset_name_to_labelset_specific_geojson</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.build_geojson.build_default_geojson_from_annotation" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">build_default_geojson_from_annotation</span><span class="p">(</span><span class="n">annotation_npy_filepath</span><span class="p">,</span> <span class="n">all_labelsets</span><span class="p">,</span> <span class="n">contour_level</span><span class="p">)</span></code>

<a href="#luna.pathology.common.build_geojson.build_default_geojson_from_annotation" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>builds geoJSONS from numpy annotation with default label set</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>annotation_npy_filepath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>string to numpy annotation</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>all_labelsets</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>a dictionary of label sets</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>contour_level</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>value along which to find contours</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>dict[str, any]: the default geoJSON annotation</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/build_geojson.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-277" name="__codelineno-0-277"></a><span class="k">def</span> <span class="nf">build_default_geojson_from_annotation</span><span class="p">(</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>    <span class="n">annotation_npy_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">all_labelsets</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">contour_level</span><span class="p">:</span> <span class="nb">float</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><span class="p">):</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;builds geoJSONS from numpy annotation with default label set</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="sd">        annotation_npy_filepath (str): string to numpy annotation</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="sd">        all_labelsets (dict): a dictionary of label sets</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a><span class="sd">        contour_level (float):  value along which to find contours</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="sd">        dict[str, any]: the default geoJSON annotation</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>    <span class="n">annotation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">annotation_npy_filepath</span><span class="p">)</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>    <span class="n">default_annotation_geojson</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">geojson_base</span><span class="p">)</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="c1"># signal logic doesn&#39;t work in dask distributed setup</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>    <span class="n">default_labelset</span> <span class="o">=</span> <span class="n">all_labelsets</span><span class="p">[</span><span class="n">DEFAULT_LABELSET_NAME</span><span class="p">]</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">annotation</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>        <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>            <span class="sa">f</span><span class="s2">&quot;No annotated pixels detected in bitmap loaded from </span><span class="si">{</span><span class="n">annotation_npy_filepath</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>        <span class="p">)</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>    <span class="c1"># vectorize all</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>    <span class="k">for</span> <span class="n">label_num</span> <span class="ow">in</span> <span class="n">default_labelset</span><span class="p">:</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>        <span class="n">default_annotation_geojson</span> <span class="o">=</span> <span class="n">add_contours_for_label</span><span class="p">(</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>            <span class="n">default_annotation_geojson</span><span class="p">,</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>            <span class="n">annotation</span><span class="p">,</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>            <span class="n">label_num</span><span class="p">,</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>            <span class="n">default_labelset</span><span class="p">,</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>            <span class="nb">float</span><span class="p">(</span><span class="n">contour_level</span><span class="p">),</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>        <span class="p">)</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>    <span class="c1"># empty geojson created, return nan and delete from geojson table</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">default_annotation_geojson</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>        <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>            <span class="sa">f</span><span class="s2">&quot;Something went wrong with building default geojson from </span><span class="si">{</span><span class="n">annotation_npy_filepath</span><span class="si">}</span><span class="s2">, quitting&quot;</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>        <span class="p">)</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>    <span class="k">return</span> <span class="n">default_annotation_geojson</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.build_geojson.build_geojson_from_annotation" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">build_geojson_from_annotation</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#luna.pathology.common.build_geojson.build_geojson_from_annotation" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Builds geoJSON for all annotation labels in the specified labelset.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df</code></td>
          <td>
                <code><span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>input regional annotation table</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>pandasDataFrame</code></td>          <td>
                <code><span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>dataframe with geoJSON field poopulated</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/build_geojson.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-324" name="__codelineno-0-324"></a><span class="k">def</span> <span class="nf">build_geojson_from_annotation</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Builds geoJSON for all annotation labels in the specified labelset.</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a><span class="sd">        df (pandas.DataFrame): input regional annotation table</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a><span class="sd">        pandasDataFrame: dataframe with geoJSON field poopulated</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>    <span class="n">labelsets</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">label_config</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>    <span class="n">annotation_npy_filepath</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">npy_filepath</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>    <span class="n">labelset</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">labelset</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>    <span class="n">contour_level</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">contour_level</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>    <span class="n">labelsets</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">labelsets</span><span class="p">)</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>    <span class="n">mappings</span> <span class="o">=</span> <span class="n">labelsets</span><span class="p">[</span><span class="n">labelset</span><span class="p">]</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Building GeoJSON annotation from npy file:&quot;</span><span class="p">,</span> <span class="n">annotation_npy_filepath</span><span class="p">)</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>    <span class="n">annotation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">annotation_npy_filepath</span><span class="p">)</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>    <span class="n">annotation_geojson</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">geojson_base</span><span class="p">)</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>    <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">TIMEOUT_SECONDS</span><span class="p">)</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>        <span class="k">for</span> <span class="n">label_num</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">:</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>            <span class="n">annotation_geojson</span> <span class="o">=</span> <span class="n">add_contours_for_label</span><span class="p">(</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>                <span class="n">annotation_geojson</span><span class="p">,</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>                <span class="n">annotation</span><span class="p">,</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>                <span class="n">label_num</span><span class="p">,</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>                <span class="n">mappings</span><span class="p">,</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>                <span class="nb">float</span><span class="p">(</span><span class="n">contour_level</span><span class="p">),</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>            <span class="p">)</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>    <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>        <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>            <span class="s2">&quot;Timeout Error occured while building geojson from slide&quot;</span><span class="p">,</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>            <span class="n">annotation_npy_filepath</span><span class="p">,</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>        <span class="p">)</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>        <span class="k">raise</span> <span class="n">err</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>    <span class="c1"># disables alarm</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>    <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>    <span class="c1"># empty geojson created, return nan and delete from geojson table</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotation_geojson</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>        <span class="k">return</span> <span class="n">df</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;geojson&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">annotation_geojson</span><span class="p">)</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.build_geojson.build_geojson_from_pointclick_json" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">build_geojson_from_pointclick_json</span><span class="p">(</span><span class="n">labelsets</span><span class="p">,</span> <span class="n">labelset</span><span class="p">,</span> <span class="n">sv_json</span><span class="p">)</span></code>

<a href="#luna.pathology.common.build_geojson.build_geojson_from_pointclick_json" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Build geoJSON m slideviewer JSON</p>
<p>This method extracts point annotations from a slideviwer json object and
converts them to a standardized geoJSON format</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>labelsets</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>dictionary of label set as string (e.g. {labelset:
{label_number: label_name}})</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>labelset</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>the name of the labelset e.g. default_labels</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>sv_json</code></td>
          <td>
                <code>list[dict]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>annotatations from slideviwer in the form of a list of dictionaries</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>list</code></td>          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>a list of geoJSON annotation objects</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/build_geojson.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="k">def</span> <span class="nf">build_geojson_from_pointclick_json</span><span class="p">(</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="n">labelsets</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">labelset</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sv_json</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build geoJSON m slideviewer JSON</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">    This method extracts point annotations from a slideviwer json object and</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    converts them to a standardized geoJSON format</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        labelsets (dict): dictionary of label set as string (e.g. {labelset:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">            {label_number: label_name}})</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        labelset (str): the name of the labelset e.g. default_labels</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        sv_json (list[dict]): annotatations from slideviwer in the form of a list of dictionaries</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">        list: a list of geoJSON annotation objects</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="n">labelsets</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">labelsets</span><span class="p">)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="n">mappings</span> <span class="o">=</span> <span class="n">labelsets</span><span class="p">[</span><span class="n">labelset</span><span class="p">]</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="n">output_geojson</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">sv_json</span><span class="p">:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="n">point</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">])</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="n">class_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">])</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="k">if</span> <span class="n">class_num</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>            <span class="k">continue</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="n">class_name</span> <span class="o">=</span> <span class="n">mappings</span><span class="p">[</span><span class="n">class_num</span><span class="p">]</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="n">coordinates</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="n">point</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Feature&quot;</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="n">point</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PathAnnotationObject&quot;</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="n">point</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Point&quot;</span><span class="p">,</span> <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="n">coordinates</span><span class="p">}</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="n">point</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;classification&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">class_name</span><span class="p">}}</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="n">output_geojson</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="k">return</span> <span class="n">output_geojson</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.build_geojson.build_labelset_specific_geojson" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">build_labelset_specific_geojson</span><span class="p">(</span><span class="n">default_annotation_geojson</span><span class="p">,</span> <span class="n">labelset</span><span class="p">)</span></code>

<a href="#luna.pathology.common.build_geojson.build_labelset_specific_geojson" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>builds geoJSON for labelset</p>
<p>Instead of working with a large geJSON object, you can extact polygons
that coorspond to specific labels into a smaller object.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>default_annotation_geojson</code></td>
          <td>
                <code>dict[str, any]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>geoJSON annotation file</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>labelset</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>label set dictionary</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, any]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>dict[str, any]: geoJSON with only polygons from provided labelset</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/build_geojson.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-196" name="__codelineno-0-196"></a><span class="k">def</span> <span class="nf">build_labelset_specific_geojson</span><span class="p">(</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>    <span class="n">default_annotation_geojson</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">],</span> <span class="n">labelset</span><span class="p">:</span> <span class="nb">dict</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]:</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;builds geoJSON for labelset</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a><span class="sd">    Instead of working with a large geJSON object, you can extact polygons</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a><span class="sd">    that coorspond to specific labels into a smaller object.</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">        default_annotation_geojson (dict[str, any]):  geoJSON annotation file</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="sd">        labelset (dict): label set dictionary</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">        dict[str, any]: geoJSON with only polygons from provided labelset</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>    <span class="n">annotation_geojson</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">geojson_base</span><span class="p">)</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">default_annotation_geojson</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>        <span class="c1"># number is fixed</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>        <span class="n">label_num</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;label_num&quot;</span><span class="p">]</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="c1"># add polygon to json, change name potentially needed</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>        <span class="k">if</span> <span class="n">label_num</span> <span class="ow">in</span> <span class="n">labelset</span><span class="p">:</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>            <span class="n">new_feature_polygon</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="c1"># get new name and change</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="n">new_label_name</span> <span class="o">=</span> <span class="n">labelset</span><span class="p">[</span><span class="n">label_num</span><span class="p">]</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>            <span class="n">new_feature_polygon</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;label_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_label_name</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>            <span class="c1"># add to annotation_geojson being built</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>            <span class="n">annotation_geojson</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_feature_polygon</span><span class="p">)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>    <span class="c1"># no polygons containing labels in labelset</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotation_geojson</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>    <span class="k">return</span> <span class="n">annotation_geojson</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.build_geojson.concatenate_regional_geojsons" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">concatenate_regional_geojsons</span><span class="p">(</span><span class="n">geojson_list</span><span class="p">)</span></code>

<a href="#luna.pathology.common.build_geojson.concatenate_regional_geojsons" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>concatenate regional annotations</p>
<p>Concatenates geojsons if there are more than one annotations for the labelset.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>geojson_list</code></td>
          <td>
                <code>list[dict[str, any]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>list of geoJSON strings</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, any]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>dict[str, any]: a single concatenated geoJSON</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/build_geojson.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-377" name="__codelineno-0-377"></a><span class="k">def</span> <span class="nf">concatenate_regional_geojsons</span><span class="p">(</span><span class="n">geojson_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]:</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;concatenate regional annotations</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a><span class="sd">    Concatenates geojsons if there are more than one annotations for the labelset.</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a><span class="sd">        geojson_list (list[dict[str, any]]): list of geoJSON strings</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a><span class="sd">        dict[str, any]: a single concatenated geoJSON</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>    <span class="c1"># create json from str representations</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>    <span class="n">geojson_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">geojson</span><span class="p">)</span> <span class="k">for</span> <span class="n">geojson</span> <span class="ow">in</span> <span class="n">geojson_list</span><span class="p">]</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>    <span class="n">concat_geojson</span> <span class="o">=</span> <span class="n">geojson_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">geojson_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>        <span class="k">return</span> <span class="n">concat_geojson</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>    <span class="c1"># create concatenated geojson</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>    <span class="k">for</span> <span class="n">json_dict</span> <span class="ow">in</span> <span class="n">geojson_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Concatenating </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">geojson_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> geojsons&quot;</span><span class="p">)</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>        <span class="n">concat_geojson</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">json_dict</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">])</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>    <span class="k">return</span> <span class="n">concat_geojson</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.build_geojson.find_parents" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">find_parents</span><span class="p">(</span><span class="n">polygons</span><span class="p">)</span></code>

<a href="#luna.pathology.common.build_geojson.find_parents" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>determines of parent child relationships of polygons</p>
<p>Returns a list of size n (where n is the number of input polygons in the input list
polygons) where the value at index n cooresponds to the nth polygon's parent. In
the case of no parent, -1 is used. for example, parent_nums[0] = 2 means that
polygon 0's parent is polygon 2</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>polygons</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>a list of shapely polygon objects</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>list</code></td>          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>a list of parent-child relationships for the polygon objects</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/build_geojson.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span>
<span class="normal"><a href="#__codelineno-0-92">92</a></span>
<span class="normal"><a href="#__codelineno-0-93">93</a></span>
<span class="normal"><a href="#__codelineno-0-94">94</a></span>
<span class="normal"><a href="#__codelineno-0-95">95</a></span>
<span class="normal"><a href="#__codelineno-0-96">96</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="k">def</span> <span class="nf">find_parents</span><span class="p">(</span><span class="n">polygons</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;determines of parent child relationships of polygons</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">    Returns a list of size n (where n is the number of input polygons in the input list</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">    polygons) where the value at index n cooresponds to the nth polygon&#39;s parent. In</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">    the case of no parent, -1 is used. for example, parent_nums[0] = 2 means that</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    polygon 0&#39;s parent is polygon 2</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">        polygons (list): a list of shapely polygon objects</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">        list: a list of parent-child relationships for the polygon objects</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="n">parent_nums</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">polygons</span><span class="p">:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="n">found_parent</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="k">for</span> <span class="n">parent_idx</span><span class="p">,</span> <span class="n">parent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">polygons</span><span class="p">):</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>            <span class="k">if</span> <span class="n">child</span> <span class="o">==</span> <span class="n">parent</span><span class="p">:</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>                <span class="k">continue</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="c1"># found parent for child</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>            <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">child</span><span class="p">):</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>                <span class="n">parent_nums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent_idx</span><span class="p">)</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>                <span class="n">found_parent</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>                <span class="k">break</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="c1"># finished looping through all potential parents, so child is a parent</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">found_parent</span><span class="p">:</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="n">parent_nums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">parent_nums</span><span class="p">)</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="k">return</span> <span class="n">parent_nums</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.build_geojson.handler" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span></code>

<a href="#luna.pathology.common.build_geojson.handler" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>signal handler for geojson</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>signum</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>signal number</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>fname</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>filename for which exception occurred</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>None</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>None</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/build_geojson.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">signum</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;signal handler for geojson</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a><span class="sd">        signum (str): signal number</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a><span class="sd">        fname (str): filename for which exception occurred</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a><span class="sd">        None</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>    <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;Geojson generation timed out.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.common.deepzoom" class="doc doc-heading">
          <code>deepzoom</code>


<a href="#luna.pathology.common.deepzoom" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">




<h4 id="luna.pathology.common.deepzoom.DeepZoomGenerator" class="doc doc-heading">
          <code>DeepZoomGenerator</code>


<a href="#luna.pathology.common.deepzoom.DeepZoomGenerator" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>src/luna/pathology/common/deepzoom.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-0-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-0-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="k">class</span> <span class="nc">DeepZoomGenerator</span><span class="p">:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>    <span class="n">BOUNDS_OFFSET_PROPS</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>        <span class="n">tiffslide</span><span class="o">.</span><span class="n">PROPERTY_NAME_BOUNDS_X</span><span class="p">,</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>        <span class="n">tiffslide</span><span class="o">.</span><span class="n">PROPERTY_NAME_BOUNDS_Y</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="n">BOUNDS_SIZE_PROPS</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="n">tiffslide</span><span class="o">.</span><span class="n">PROPERTY_NAME_BOUNDS_WIDTH</span><span class="p">,</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>        <span class="n">tiffslide</span><span class="o">.</span><span class="n">PROPERTY_NAME_BOUNDS_HEIGHT</span><span class="p">,</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="n">urlpath</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">OpenFile</span><span class="p">],</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="n">tile_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">254</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">overlap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n">limit_bounds</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_z_t_downsample</span> <span class="o">=</span> <span class="n">tile_size</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_z_overlap</span> <span class="o">=</span> <span class="n">overlap</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_limit_bounds</span> <span class="o">=</span> <span class="n">limit_bounds</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_storage_options</span> <span class="o">=</span> <span class="n">storage_options</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">urlpath</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_openfile</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_openfile</span> <span class="o">=</span> <span class="n">urlpath</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_openfile</span> <span class="k">as</span> <span class="n">f</span><span class="p">,</span> <span class="n">tiffslide</span><span class="o">.</span><span class="n">TiffSlide</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">as</span> <span class="n">tiff</span><span class="p">:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>            <span class="k">if</span> <span class="n">limit_bounds</span><span class="p">:</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>                <span class="c1"># Level 0 coordinate offset</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_l0_offset</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>                    <span class="nb">int</span><span class="p">(</span><span class="n">tiff</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>                    <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BOUNDS_OFFSET_PROPS</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>                <span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>                <span class="c1"># Slide level dimensions scale factor in each axis</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>                <span class="n">size_scale</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>                    <span class="nb">int</span><span class="p">(</span><span class="n">tiff</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">l0_lim</span><span class="p">))</span> <span class="o">/</span> <span class="n">l0_lim</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>                    <span class="k">for</span> <span class="n">prop</span><span class="p">,</span> <span class="n">l0_lim</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BOUNDS_SIZE_PROPS</span><span class="p">,</span> <span class="n">tiff</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>                <span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>                <span class="c1"># Dimensions of active area</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_l_dimensions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>                    <span class="nb">tuple</span><span class="p">(</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>                        <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">l_lim</span> <span class="o">*</span> <span class="n">scale</span><span class="p">))</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>                        <span class="k">for</span> <span class="n">l_lim</span><span class="p">,</span> <span class="n">scale</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l_size</span><span class="p">,</span> <span class="n">size_scale</span><span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>                    <span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>                    <span class="k">for</span> <span class="n">l_size</span> <span class="ow">in</span> <span class="n">tiff</span><span class="o">.</span><span class="n">level_dimensions</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>                <span class="p">)</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_l_dimensions</span> <span class="o">=</span> <span class="n">tiff</span><span class="o">.</span><span class="n">level_dimensions</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_l0_offset</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_l0_dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_l_dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>            <span class="c1"># Deep Zoom level</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>            <span class="n">z_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_l0_dimensions</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>            <span class="n">z_dimensions</span> <span class="o">=</span> <span class="p">[</span><span class="n">z_size</span><span class="p">]</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>            <span class="k">while</span> <span class="n">z_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">z_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>                <span class="n">z_size</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">z</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)))</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">z_size</span><span class="p">)</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>                <span class="n">z_dimensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z_size</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_z_dimensions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">z_dimensions</span><span class="p">))</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>            <span class="c1"># Tile</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="k">def</span> <span class="nf">tiles</span><span class="p">(</span><span class="n">z_lim</span><span class="p">):</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">z_lim</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_t_downsample</span><span class="p">))</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_t_dimensions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>                <span class="p">(</span><span class="n">tiles</span><span class="p">(</span><span class="n">z_w</span><span class="p">),</span> <span class="n">tiles</span><span class="p">(</span><span class="n">z_h</span><span class="p">))</span> <span class="k">for</span> <span class="n">z_w</span><span class="p">,</span> <span class="n">z_h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_dimensions</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>            <span class="c1"># Deep Zoom level count</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_dz_levels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_z_dimensions</span><span class="p">)</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>            <span class="c1"># Total downsamples for each Deep Zoom level</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>            <span class="n">l0_z_downsamples</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>                <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dz_levels</span> <span class="o">-</span> <span class="n">dz_level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>                <span class="k">for</span> <span class="n">dz_level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dz_levels</span><span class="p">)</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="p">)</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>            <span class="c1"># Preferred slide levels for each Deep Zoom level</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_slide_from_dz_level</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>                <span class="n">tiff</span><span class="o">.</span><span class="n">get_best_level_for_downsample</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">l0_z_downsamples</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="p">)</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="c1"># Piecewise downsamples</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_l0_l_downsamples</span> <span class="o">=</span> <span class="n">tiff</span><span class="o">.</span><span class="n">level_downsamples</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_l_z_downsamples</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>                <span class="n">l0_z_downsamples</span><span class="p">[</span><span class="n">dz_level</span><span class="p">]</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>                <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_l0_l_downsamples</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_slide_from_dz_level</span><span class="p">[</span><span class="n">dz_level</span><span class="p">]]</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                <span class="k">for</span> <span class="n">dz_level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dz_levels</span><span class="p">)</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>            <span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>            <span class="c1"># Slide background color</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="n">bg_color</span> <span class="o">=</span> <span class="n">tiff</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tiffslide</span><span class="o">.</span><span class="n">PROPERTY_NAME_BACKGROUND_COLOR</span><span class="p">)</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="k">if</span> <span class="n">bg_color</span><span class="p">:</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_bg_color</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">bg_color</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_bg_color</span> <span class="o">=</span> <span class="s2">&quot;#ffffff&quot;</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>    <span class="k">def</span> <span class="nf">level_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of Deep Zoom levels in the image.&quot;&quot;&quot;</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dz_levels</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="k">def</span> <span class="nf">level_tiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;A list of (tiles_x, tiles_y) tuples for each Deep Zoom level.&quot;&quot;&quot;</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t_dimensions</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>    <span class="k">def</span> <span class="nf">level_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;A list of (pixels_x, pixels_y) tuples for each Deep Zoom level.&quot;&quot;&quot;</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_dimensions</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>    <span class="k">def</span> <span class="nf">tile_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The total number of Deep Zoom tiles in the image.&quot;&quot;&quot;</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t_cols</span> <span class="o">*</span> <span class="n">t_rows</span> <span class="k">for</span> <span class="n">t_cols</span><span class="p">,</span> <span class="n">t_rows</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t_dimensions</span><span class="p">)</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="k">def</span> <span class="nf">get_tile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an RGB PIL.Image for a tile.</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">        level:     the Deep Zoom level.</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">        address:   the address of the tile within the level as a (col, row)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">                   tuple.&quot;&quot;&quot;</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="c1"># Read tile</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>        <span class="n">args</span><span class="p">,</span> <span class="n">z_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tile_info</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_openfile</span> <span class="k">as</span> <span class="n">f</span><span class="p">,</span> <span class="n">tiffslide</span><span class="o">.</span><span class="n">TiffSlide</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">as</span> <span class="n">tiff</span><span class="p">:</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>            <span class="n">tile</span> <span class="o">=</span> <span class="n">tiff</span><span class="o">.</span><span class="n">read_region</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>            <span class="c1"># Apply on solid background</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="c1"># bg = Image.new(&#39;RGB&#39;, tile.size, self._bg_color)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="c1"># tile = Image.composite(tile, bg, tile)</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>            <span class="c1"># Scale to the correct size</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>            <span class="k">if</span> <span class="n">tile</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">z_size</span><span class="p">:</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                <span class="c1"># Image.Resampling added in Pillow 9.1.0</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>                <span class="c1"># Image.LANCZOS removed in Pillow 10</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>                <span class="n">tile</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">(</span><span class="n">z_size</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">Image</span><span class="p">,</span> <span class="s2">&quot;Resampling&quot;</span><span class="p">,</span> <span class="n">Image</span><span class="p">)</span><span class="o">.</span><span class="n">LANCZOS</span><span class="p">)</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>            <span class="k">return</span> <span class="n">tile</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="k">def</span> <span class="nf">_get_tile_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dz_level</span><span class="p">,</span> <span class="n">t_location</span><span class="p">):</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="c1"># Check parameters</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="k">if</span> <span class="n">dz_level</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">dz_level</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dz_levels</span><span class="p">:</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid level&quot;</span><span class="p">)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">t_lim</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t_location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t_dimensions</span><span class="p">[</span><span class="n">dz_level</span><span class="p">]):</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>            <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="n">t_lim</span><span class="p">:</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid address: </span><span class="si">{</span><span class="n">dz_level</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">t_location</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="c1"># Get preferred slide level</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="n">slide_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slide_from_dz_level</span><span class="p">[</span><span class="n">dz_level</span><span class="p">]</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>        <span class="c1"># Calculate top/left and bottom/right overlap</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="n">z_overlap_tl</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_z_overlap</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_location</span><span class="p">)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="n">z_overlap_br</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_z_overlap</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span> <span class="o">!=</span> <span class="n">t_lim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>            <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">t_lim</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t_location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_tiles</span><span class="p">[</span><span class="n">dz_level</span><span class="p">])</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>        <span class="p">)</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>        <span class="c1"># Get final size of the tile</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="n">z_size</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>            <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_z_t_downsample</span><span class="p">,</span> <span class="n">z_lim</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_t_downsample</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">z_tl</span> <span class="o">+</span> <span class="n">z_br</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>            <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">z_lim</span><span class="p">,</span> <span class="n">z_tl</span><span class="p">,</span> <span class="n">z_br</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                <span class="n">t_location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_dimensions</span><span class="p">[</span><span class="n">dz_level</span><span class="p">],</span> <span class="n">z_overlap_tl</span><span class="p">,</span> <span class="n">z_overlap_br</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>            <span class="p">)</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="c1"># Obtain the region coordinates</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="n">z_location</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_z_from_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_location</span><span class="p">]</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="n">l_location</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_l_from_z</span><span class="p">(</span><span class="n">dz_level</span><span class="p">,</span> <span class="n">z</span> <span class="o">-</span> <span class="n">z_tl</span><span class="p">)</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>            <span class="k">for</span> <span class="n">z</span><span class="p">,</span> <span class="n">z_tl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">z_location</span><span class="p">,</span> <span class="n">z_overlap_tl</span><span class="p">)</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="p">]</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="c1"># Round location down and size up, and add offset of active area</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="n">l0_location</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>            <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_l0_from_l</span><span class="p">(</span><span class="n">slide_level</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span> <span class="o">+</span> <span class="n">l0_off</span><span class="p">)</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>            <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">l0_off</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l_location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_l0_offset</span><span class="p">)</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="p">)</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="n">l_size</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>            <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_l_from_z</span><span class="p">(</span><span class="n">dz_level</span><span class="p">,</span> <span class="n">dz</span><span class="p">)),</span> <span class="n">l_lim</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">loc</span><span class="p">)))</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>            <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">l_lim</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>                <span class="n">l_location</span><span class="p">,</span> <span class="n">z_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_l_dimensions</span><span class="p">[</span><span class="n">slide_level</span><span class="p">]</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>            <span class="p">)</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="p">)</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="c1"># Return read_region() parameters plus tile size for final scaling</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="k">return</span> <span class="p">((</span><span class="n">l0_location</span><span class="p">,</span> <span class="n">slide_level</span><span class="p">,</span> <span class="n">l_size</span><span class="p">),</span> <span class="n">z_size</span><span class="p">)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>    <span class="k">def</span> <span class="nf">_l0_from_l</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slide_level</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_l0_l_downsamples</span><span class="p">[</span><span class="n">slide_level</span><span class="p">]</span> <span class="o">*</span> <span class="n">loc</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>    <span class="k">def</span> <span class="nf">_l_from_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dz_level</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_l_z_downsamples</span><span class="p">[</span><span class="n">dz_level</span><span class="p">]</span> <span class="o">*</span> <span class="n">z</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>    <span class="k">def</span> <span class="nf">_z_from_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_t_downsample</span> <span class="o">*</span> <span class="n">t</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">




<h5 id="luna.pathology.common.deepzoom.DeepZoomGenerator.level_count" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">level_count</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#luna.pathology.common.deepzoom.DeepZoomGenerator.level_count" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>The number of Deep Zoom levels in the image.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h5 id="luna.pathology.common.deepzoom.DeepZoomGenerator.level_dimensions" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">level_dimensions</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#luna.pathology.common.deepzoom.DeepZoomGenerator.level_dimensions" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>A list of (pixels_x, pixels_y) tuples for each Deep Zoom level.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h5 id="luna.pathology.common.deepzoom.DeepZoomGenerator.level_tiles" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">level_tiles</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#luna.pathology.common.deepzoom.DeepZoomGenerator.level_tiles" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>A list of (tiles_x, tiles_y) tuples for each Deep Zoom level.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h5 id="luna.pathology.common.deepzoom.DeepZoomGenerator.tile_count" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">tile_count</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#luna.pathology.common.deepzoom.DeepZoomGenerator.tile_count" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>The total number of Deep Zoom tiles in the image.</p>
  </div>

</div>




<div class="doc doc-object doc-function">




<h5 id="luna.pathology.common.deepzoom.DeepZoomGenerator.get_tile" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_tile</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span></code>

<a href="#luna.pathology.common.deepzoom.DeepZoomGenerator.get_tile" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Return an RGB PIL.Image for a tile.</p>
<p>level:     the Deep Zoom level.
address:   the address of the tile within the level as a (col, row)
           tuple.</p>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/deepzoom.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="k">def</span> <span class="nf">get_tile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return an RGB PIL.Image for a tile.</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">    level:     the Deep Zoom level.</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">    address:   the address of the tile within the level as a (col, row)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">               tuple.&quot;&quot;&quot;</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>    <span class="c1"># Read tile</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="n">args</span><span class="p">,</span> <span class="n">z_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tile_info</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_openfile</span> <span class="k">as</span> <span class="n">f</span><span class="p">,</span> <span class="n">tiffslide</span><span class="o">.</span><span class="n">TiffSlide</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">as</span> <span class="n">tiff</span><span class="p">:</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="n">tile</span> <span class="o">=</span> <span class="n">tiff</span><span class="o">.</span><span class="n">read_region</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="c1"># Apply on solid background</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="c1"># bg = Image.new(&#39;RGB&#39;, tile.size, self._bg_color)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="c1"># tile = Image.composite(tile, bg, tile)</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="c1"># Scale to the correct size</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="k">if</span> <span class="n">tile</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">z_size</span><span class="p">:</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>            <span class="c1"># Image.Resampling added in Pillow 9.1.0</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>            <span class="c1"># Image.LANCZOS removed in Pillow 10</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>            <span class="n">tile</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">(</span><span class="n">z_size</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">Image</span><span class="p">,</span> <span class="s2">&quot;Resampling&quot;</span><span class="p">,</span> <span class="n">Image</span><span class="p">)</span><span class="o">.</span><span class="n">LANCZOS</span><span class="p">)</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="k">return</span> <span class="n">tile</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.common.schemas" class="doc doc-heading">
          <code>schemas</code>


<a href="#luna.pathology.common.schemas" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">




<h4 id="luna.pathology.common.schemas.SlideTiles" class="doc doc-heading">
          <code>SlideTiles</code>


<a href="#luna.pathology.common.schemas.SlideTiles" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>src/luna/pathology/common/schemas.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="k">class</span> <span class="nc">SlideTiles</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>    <span class="n">REQ_COLUMNS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>        <span class="p">[</span><span class="s2">&quot;address&quot;</span><span class="p">,</span> <span class="s2">&quot;x_coord&quot;</span><span class="p">,</span> <span class="s2">&quot;y_coord&quot;</span><span class="p">,</span> <span class="s2">&quot;xy_extent&quot;</span><span class="p">,</span> <span class="s2">&quot;tile_size&quot;</span><span class="p">,</span> <span class="s2">&quot;tile_units&quot;</span><span class="p">]</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>    <span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slide_tiles</span><span class="p">):</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns True if the given path is readable as &quot;SlideTiles &lt;slide_tiles&gt;&quot;, else, reaises SchemaMismatchError&quot;&quot;&quot;</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">slide_tiles</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">REQ_COLUMNS</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">REQ_COLUMNS</span><span class="p">:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>            <span class="k">raise</span> <span class="n">SchemaMismatchError</span><span class="p">(</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>                <span class="s2">&quot;SlideTile failed schema check: missing columns: &quot;</span><span class="p">,</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>                <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">REQ_COLUMNS</span><span class="p">))</span><span class="o">.</span><span class="n">symmetric_difference</span><span class="p">(</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">REQ_COLUMNS</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>                <span class="p">),</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>            <span class="p">)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h5 id="luna.pathology.common.schemas.SlideTiles.check" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">check</span><span class="p">(</span><span class="n">slide_tiles</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#luna.pathology.common.schemas.SlideTiles.check" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Returns True if the given path is readable as "SlideTiles <slide_tiles>", else, reaises SchemaMismatchError</p>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/schemas.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="nd">@classmethod</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slide_tiles</span><span class="p">):</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns True if the given path is readable as &quot;SlideTiles &lt;slide_tiles&gt;&quot;, else, reaises SchemaMismatchError&quot;&quot;&quot;</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">slide_tiles</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">REQ_COLUMNS</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">REQ_COLUMNS</span><span class="p">:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="k">raise</span> <span class="n">SchemaMismatchError</span><span class="p">(</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>            <span class="s2">&quot;SlideTile failed schema check: missing columns: &quot;</span><span class="p">,</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>            <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">REQ_COLUMNS</span><span class="p">))</span><span class="o">.</span><span class="n">symmetric_difference</span><span class="p">(</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">REQ_COLUMNS</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>            <span class="p">),</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="p">)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.common.slideviewer_client" class="doc doc-heading">
          <code>slideviewer_client</code>


<a href="#luna.pathology.common.slideviewer_client" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">
  
      <p>Created on January 31, 2021</p>
<p>@author: pashaa@mskcc.org</p>
<p>Functions for downloading annotations from SlideViewer</p>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.slideviewer_client.download_sv_point_annotation" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">download_sv_point_annotation</span><span class="p">(</span><span class="n">url</span><span class="p">)</span></code>

<a href="#luna.pathology.common.slideviewer_client.download_sv_point_annotation" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>download slideviwer point annotation</p>
<p>Calls slideviewer API with the given url</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>url</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slide viewer api to call</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, any]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>dict[str, any]: json response</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/slideviewer_client.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="k">def</span> <span class="nf">download_sv_point_annotation</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]:</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;download slideviwer point annotation</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">    Calls slideviewer API with the given url</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="sd">        url (str): slide viewer api to call</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">        dict[str, any]: json response</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;General exception raised while trying &quot;</span> <span class="o">+</span> <span class="n">url</span><span class="p">)</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found data = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;[]&quot;</span><span class="p">:</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="k">return</span> <span class="n">data</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Label annotation file does not exist for slide and user.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.slideviewer_client.download_zip" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">download_zip</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">dest_path</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span></code>

<a href="#luna.pathology.common.slideviewer_client.download_zip" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Download zip file</p>
<p>Downloads zip from the specified URL and saves it to the specified file path.
see https://stackoverflow.com/questions/9419162/download-returned-zip-file-from-url</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>url</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slideviewer url to download zip from</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dest_path</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>file path where zipfile should be saved</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>chunk_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>size in bytes of chunks to batch out during download</p>
            </div>
          </td>
          <td>
                <code>128</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>bool</code></td>          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>True if zipfile downloaded and saved successfully, else false</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/slideviewer_client.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="k">def</span> <span class="nf">download_zip</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dest_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Download zip file</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">    Downloads zip from the specified URL and saves it to the specified file path.</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">    see https://stackoverflow.com/questions/9419162/download-returned-zip-file-from-url</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">        url (str): slideviewer url to download zip from</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="sd">        dest_path (str): file path where zipfile should be saved</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">        chunk_size (int): size in bytes of chunks to batch out during download</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">        bool: True if zipfile downloaded and saved successfully, else false</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">):</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="k">if</span> <span class="n">chunk</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;Label image not found.&quot;</span><span class="p">:</span>  <span class="c1"># message from slideviewer</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.slideviewer_client.fetch_slide_ids" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">fetch_slide_ids</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">,</span> <span class="n">csv_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#luna.pathology.common.slideviewer_client.fetch_slide_ids" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>get slide ids</p>
<p>Fetch the list of slide ids from the slideviewer server for the project with the
specified project id. Alternately, a slideviewer csv file may be provided to
override download from server.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>url</code></td>
          <td>
                <code>str or None</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slideviewer url. url may be None if csv_file is specified.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>project_id</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slideviewer project id from which to fetch slide ids</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dest_dir</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>directory where csv file should be downloaded</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>csv_file</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slideviewer csv file may be provided to override the need</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>list</code></td>          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>list of (slideviewer_path, slide_id, sv_project_id)</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/slideviewer_client.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="k">def</span> <span class="nf">fetch_slide_ids</span><span class="p">(</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">project_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">csv_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;get slide ids</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    Fetch the list of slide ids from the slideviewer server for the project with the</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">    specified project id. Alternately, a slideviewer csv file may be provided to</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">    override download from server.</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        url (str or None): slideviewer url. url may be None if csv_file is specified.</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">        project_id (int): slideviewer project id from which to fetch slide ids</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">        dest_dir (str): directory where csv file should be downloaded</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        csv_file (str): slideviewer csv file may be provided to override the need</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">        to download the file</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">        list:  list of (slideviewer_path, slide_id, sv_project_id)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="c1"># run on all slides from specified SLIDEVIEWER_CSV file.</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="c1"># if file is not specified, then download file using slideviewer API</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="c1"># download entire slide set using project id</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="c1"># the file is then written to the dest directory</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="n">new_csv_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="s2">&quot;project_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="k">if</span> <span class="n">csv_file</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">csv_file</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">csv_file</span><span class="p">):</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;exportProjectCSV?pid=</span><span class="si">{pid}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">project_id</span><span class="p">))</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">new_csv_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">slideoutfile</span><span class="p">:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>            <span class="n">slideoutfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="c1"># copy given csv_file to dest directory</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">new_csv_file</span><span class="p">)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="c1"># read slide ids</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="n">slides</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">new_csv_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">slideoutfile</span><span class="p">:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="c1"># skip first 4 lines</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">slideoutfile</span><span class="p">:</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>            <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>                <span class="k">break</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="c1"># read whole slide image file names contained in the project in slide viewer</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">slideoutfile</span><span class="p">:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="n">full_filename</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>            <span class="n">slidename</span> <span class="o">=</span> <span class="n">get_slide_id</span><span class="p">(</span><span class="n">full_filename</span><span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>            <span class="n">slides</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">full_filename</span><span class="p">,</span> <span class="n">slidename</span><span class="p">,</span> <span class="n">project_id</span><span class="p">])</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="k">return</span> <span class="n">slides</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.slideviewer_client.get_slide_id" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_slide_id</span><span class="p">(</span><span class="n">full_filename</span><span class="p">)</span></code>

<a href="#luna.pathology.common.slideviewer_client.get_slide_id" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>get slide id</p>
<p>Get slide id from the slideviewer full file name. The full_filename in
the slideview csv is of the format: year;HOBS_ID;slide_id.svs
for example: 2013;HobS13-283072057510;1435197.svs</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>full_filename</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>full filename of slide</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>str</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>numeric slide id</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/slideviewer_client.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="k">def</span> <span class="nf">get_slide_id</span><span class="p">(</span><span class="n">full_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;get slide id</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">    Get slide id from the slideviewer full file name. The full_filename in</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">    the slideview csv is of the format: year;HOBS_ID;slide_id.svs</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">    for example: 2013;HobS13-283072057510;1435197.svs</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">        full_filename (str): full filename of slide</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        str: numeric slide id</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">full_filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.svs&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.slideviewer_client.unzip" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">unzip</span><span class="p">(</span><span class="n">zipfile_path</span><span class="p">)</span></code>

<a href="#luna.pathology.common.slideviewer_client.unzip" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>unzip zip file</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>zipfile_path</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>path of zipfile to unzip</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>any</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>readfile pointer to unzippped file if successfully unzippped, else None</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/slideviewer_client.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="k">def</span> <span class="nf">unzip</span><span class="p">(</span><span class="n">zipfile_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">any</span><span class="p">:</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;unzip zip file</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="sd">        zipfile_path (str): path of zipfile to unzip</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">        readfile pointer to unzippped file if successfully unzippped, else None</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unzipping &quot;</span> <span class="o">+</span> <span class="n">zipfile_path</span><span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="k">return</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zipfile_path</span><span class="p">)</span>  <span class="c1"># returns read file pointer</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="k">except</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">BadZipFile</span><span class="p">:</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Dumping invalid Zipfile &quot;</span> <span class="o">+</span> <span class="n">zipfile_path</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.common.utils" class="doc doc-heading">
          <code>utils</code>


<a href="#luna.pathology.common.utils" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.utils.address_to_coord" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">address_to_coord</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></code>

<a href="#luna.pathology.common.utils.address_to_coord" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>converts address into coordinates</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>s</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>a string consisting of an x_y_z address</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>[int, int]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Tuple[int, int]: a tuple consisting of an x, y pair</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-440" name="__codelineno-0-440"></a><span class="k">def</span> <span class="nf">address_to_coord</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;converts address into coordinates</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a><span class="sd">        s (str): a string consisting of an x_y_z address</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a><span class="sd">        Tuple[int, int]: a tuple consisting of an x, y pair</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>    <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>    <span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;x(\d+)_y(\d+)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>    <span class="n">m</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>        <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>        <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.utils.convert_halo_xml_to_roi" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">convert_halo_xml_to_roi</span><span class="p">(</span><span class="n">xml_fn</span><span class="p">)</span></code>

<a href="#luna.pathology.common.utils.convert_halo_xml_to_roi" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>get roi from halo XML file</p>
<p>Read the rectangle ROI of a halo XML annotation file</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>xml_fn</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>file path to input halo XML file</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>[<span title="typing.List">List</span>, <span title="typing.List">List</span>]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Tuple[list, list]: returns a tuple of x, y coordinates of the recangular roi</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="k">def</span> <span class="nf">convert_halo_xml_to_roi</span><span class="p">(</span><span class="n">xml_fn</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">List</span><span class="p">]]:</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;get roi from halo XML file</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">    Read the rectangle ROI of a halo XML annotation file</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">        xml_fn: file path to input halo XML file</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">        Tuple[list, list]: returns a tuple of x, y coordinates of the recangular roi</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>    <span class="n">ylist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>    <span class="n">xlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Converting to ROI:&quot;</span><span class="p">,</span> <span class="n">xml_fn</span><span class="p">)</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>    <span class="n">e</span> <span class="o">=</span> <span class="n">et</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">xml_fn</span><span class="p">)</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>    <span class="k">for</span> <span class="n">ann</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;Annotation&quot;</span><span class="p">):</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="n">regions</span> <span class="o">=</span> <span class="n">ann</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;Regions&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>            <span class="k">continue</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Rectangle&quot;</span><span class="p">:</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>            <span class="k">continue</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">regions</span><span class="p">):</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>            <span class="n">vs</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;Vertices&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>            <span class="n">vs</span> <span class="o">=</span> <span class="n">vs</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;V&quot;</span><span class="p">)</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vs</span><span class="p">:</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>                <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>                <span class="n">ylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>                <span class="n">xlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="k">if</span> <span class="n">xlist</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">or</span> <span class="n">ylist</span> <span class="o">==</span> <span class="p">[]:</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No Rectangle found, returning None!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">xlist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Somehow a negative x rectangle coordinate!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="n">xlist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">xlist</span><span class="p">)]</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">ylist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Somehow a negative y rectangle coordinate!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="n">ylist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">ylist</span><span class="p">)]</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>    <span class="k">return</span> <span class="n">xlist</span><span class="p">,</span> <span class="n">ylist</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.utils.convert_xml_to_mask" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">convert_xml_to_mask</span><span class="p">(</span><span class="n">xml_urlpath</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.common.utils.convert_xml_to_mask" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>convert xml to bitmask</p>
<p>Converts a sparse halo XML annotation file (polygons) to a dense bitmask</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>xml_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>file path to input halo XML file</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>shape</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>desired polygon shape</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of annotation</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>[<span title="numpy.ndarray">ndarray</span>, <span title="typing.Dict">Dict</span>[str, <span title="typing.Any">Any</span>]]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Optional[Tuple[np.ndarray, Dict[str, Any]]]: annotation bitmask of specified shape</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="k">def</span> <span class="nf">convert_xml_to_mask</span><span class="p">(</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="n">xml_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="n">shape</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;convert xml to bitmask</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">    Converts a sparse halo XML annotation file (polygons) to a dense bitmask</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">        xml_urlpath (str): file path to input halo XML file</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">        shape (list): desired polygon shape</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">        annotation_name (str): name of annotation</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">        Optional[Tuple[np.ndarray, Dict[str, Any]]]: annotation bitmask of specified shape</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="n">ret</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="c1"># Annotations &gt;&gt;</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">xml_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="n">e</span> <span class="o">=</span> <span class="n">et</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">of</span><span class="p">)</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;Annotation&quot;</span><span class="p">)</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="n">n_regions</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="k">for</span> <span class="n">ann</span> <span class="ow">in</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="k">if</span> <span class="n">ann</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">annotation_name</span><span class="p">:</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="k">continue</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found region </span><span class="si">{</span><span class="n">ann</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="n">board_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>        <span class="n">board_neg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="n">regions</span> <span class="o">=</span> <span class="n">ann</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;Regions&quot;</span><span class="p">)</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="n">rs</span> <span class="o">=</span> <span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;Region&quot;</span><span class="p">)</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rs</span><span class="p">):</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="n">negative_flag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NegativeROA&quot;</span><span class="p">))</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="k">assert</span> <span class="n">negative_flag</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">negative_flag</span> <span class="o">==</span> <span class="mi">1</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="n">negative_flag</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">negative_flag</span><span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="n">vs</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;Vertices&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="n">vs</span> <span class="o">=</span> <span class="n">vs</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;V&quot;</span><span class="p">)</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="n">vs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># last dot should be linked to the first dot</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="n">plist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vs</span><span class="p">:</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                <span class="n">plist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="k">if</span> <span class="n">negative_flag</span><span class="p">:</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                <span class="n">board_neg</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">drawContours</span><span class="p">(</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                    <span class="n">board_neg</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plist</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                <span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                <span class="n">board_pos</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">drawContours</span><span class="p">(</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                    <span class="n">board_pos</span><span class="p">,</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                    <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plist</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)],</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>                    <span class="n">contourIdx</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>                    <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                    <span class="n">thickness</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>                <span class="p">)</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>            <span class="n">n_regions</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">board_pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">board_neg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>    <span class="k">if</span> <span class="n">ret</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>            <span class="s2">&quot;n_regions&quot;</span><span class="p">:</span> <span class="n">n_regions</span><span class="p">,</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>            <span class="s2">&quot;n_positive_pixels&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="p">}</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="k">return</span> <span class="n">mask</span><span class="p">,</span> <span class="n">properties</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.utils.coord_to_address" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">coord_to_address</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">magnification</span><span class="p">)</span></code>

<a href="#luna.pathology.common.utils.coord_to_address" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>converts coordinate to address</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>s</code></td>
          <td>
                <code>tuple[int, int]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>coordinate consisting of an (x, y) tuple</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>magnification</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>magnification factor</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>str</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>a string consisting of an x_y_z address</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-420" name="__codelineno-0-420"></a><span class="k">def</span> <span class="nf">coord_to_address</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">magnification</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;converts coordinate to address</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a><span class="sd">        s (tuple[int, int]): coordinate consisting of an (x, y) tuple</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a><span class="sd">        magnification (int): magnification factor</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a><span class="sd">        str: a string consisting of an x_y_z address</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>    <span class="n">y</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>    <span class="n">address</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;x</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">_y</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>    <span class="k">if</span> <span class="n">magnification</span><span class="p">:</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>        <span class="n">address</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_z</span><span class="si">{</span><span class="n">magnification</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>    <span class="k">return</span> <span class="n">address</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.utils.extract_patch_texture_features" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">extract_patch_texture_features</span><span class="p">(</span><span class="n">image_patch</span><span class="p">,</span> <span class="n">mask_patch</span><span class="p">,</span> <span class="n">stain_vectors</span><span class="p">,</span> <span class="n">stain_channel</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#luna.pathology.common.utils.extract_patch_texture_features" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>extact patch texture features</p>
<p>Runs patch-wise extraction from an image_patch, mask_patch pair given a stain
vector and stain channel.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>image_patch</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>input image patch</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>mask_patch</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>input image mask</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>stain_vectors</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>stain vectors extacted from the image patch</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>stain_channel</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>stain channel</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>plot</code></td>
          <td>
                <code>(<span title="typing.Optional">Optional</span>, bool)</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>unused?</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[str, <span title="numpy.ndarray">ndarray</span>]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Optional[Dict[str, np.ndarray]]: texture features from image patch</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="k">def</span> <span class="nf">extract_patch_texture_features</span><span class="p">(</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>    <span class="n">image_patch</span><span class="p">,</span> <span class="n">mask_patch</span><span class="p">,</span> <span class="n">stain_vectors</span><span class="p">,</span> <span class="n">stain_channel</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;extact patch texture features</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="sd">    Runs patch-wise extraction from an image_patch, mask_patch pair given a stain</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="sd">    vector and stain channel.</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">        image_patch (np.ndarray): input image patch</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="sd">        mask_patch (np.ndarray): input image mask</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a><span class="sd">        stain_vectors (np.ndarray): stain vectors extacted from the image patch</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="sd">        stain_channel (int): stain channel</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="sd">        plot (Optional, bool): unused?</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a><span class="sd">        Optional[Dict[str, np.ndarray]]: texture features from image patch</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>    <span class="c1"># logging.getLogger(&quot;radiomics.featureextractor&quot;).setLevel(logging.WARNING)</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mask_patch</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">mask_patch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>    <span class="n">output_dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, Any]</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>    <span class="n">stain_patch</span> <span class="o">=</span> <span class="n">pull_stain_channel</span><span class="p">(</span><span class="n">image_patch</span><span class="p">,</span> <span class="n">stain_vectors</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">stain_channel</span><span class="p">)</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>    <span class="n">original_pixels</span> <span class="o">=</span> <span class="n">stain_patch</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)[</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_patch</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">))</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>    <span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>    <span class="n">original_pixels_valid</span> <span class="o">=</span> <span class="n">original_pixels</span><span class="p">[</span><span class="n">original_pixels</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>    <span class="n">output_dict</span><span class="p">[</span><span class="s2">&quot;original_pixels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_pixels_valid</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>    <span class="n">extractor</span> <span class="o">=</span> <span class="n">radiomics</span><span class="o">.</span><span class="n">featureextractor</span><span class="o">.</span><span class="n">RadiomicsFeatureExtractor</span><span class="p">(</span><span class="n">binWidth</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>    <span class="n">extractor</span><span class="o">.</span><span class="n">disableAllFeatures</span><span class="p">()</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>    <span class="n">extractor</span><span class="o">.</span><span class="n">enableImageTypeByName</span><span class="p">(</span><span class="s2">&quot;Original&quot;</span><span class="p">)</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>    <span class="n">extractor</span><span class="o">.</span><span class="n">enableFeatureClassByName</span><span class="p">(</span><span class="s2">&quot;glcm&quot;</span><span class="p">)</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="c1"># extractor.enableFeatureByName(&#39;original_glcm_MCC&#39;, enable=False)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>    <span class="n">sitk_image</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">.</span><span class="n">GetImageFromArray</span><span class="p">(</span><span class="n">stain_patch</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>    <span class="n">sitk_mask</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">.</span><span class="n">GetImageFromArray</span><span class="p">(</span><span class="n">mask_patch</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>        <span class="n">bbox</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">radiomics</span><span class="o">.</span><span class="n">imageoperations</span><span class="o">.</span><span class="n">checkMask</span><span class="p">(</span><span class="n">sitk_image</span><span class="p">,</span> <span class="n">sitk_mask</span><span class="p">)</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping this patch, mask pair due to &#39;</span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>        <span class="c1"># cimg, cmas = radiomics.imageoperations.cropToTumorMask(sitk_image, sitk_mask, bbox)</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>        <span class="n">fts</span> <span class="o">=</span> <span class="n">extractor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sitk_image</span><span class="p">,</span> <span class="n">sitk_mask</span><span class="p">,</span> <span class="n">voxelBased</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fts</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>            <span class="k">if</span> <span class="s2">&quot;original_glcm&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>                <span class="k">continue</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>            <span class="n">stainomics_patch</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">.</span><span class="n">GetArrayFromImage</span><span class="p">(</span><span class="n">fts</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>            <span class="n">stainomics_nonzero</span> <span class="o">=</span> <span class="n">stainomics_patch</span><span class="p">[</span><span class="n">stainomics_patch</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>            <span class="n">stainomics_valid</span> <span class="o">=</span> <span class="n">stainomics_nonzero</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">stainomics_nonzero</span><span class="p">)]</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>            <span class="n">output_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">stainomics_valid</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>        <span class="k">return</span> <span class="n">output_dict</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.utils.get_downscaled_thumbnail" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_downscaled_thumbnail</span><span class="p">(</span><span class="n">slide</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">)</span></code>

<a href="#luna.pathology.common.utils.get_downscaled_thumbnail" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>get downscaled thumbnail</p>
<p>yields a thumbnail image of a whole slide rescaled by a specified scale factor</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide</code></td>
          <td>
                <code><span title="tiffslide.TiffSlide">TiffSlide</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slide object</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>scale_factor</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>integer scaling factor to resize the whole slide by</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>np.ndarray: downsized whole slie thumbnail</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-459" name="__codelineno-0-459"></a><span class="nd">@timed</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a><span class="k">def</span> <span class="nf">get_downscaled_thumbnail</span><span class="p">(</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>    <span class="n">slide</span><span class="p">:</span> <span class="n">TiffSlide</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;get downscaled thumbnail</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a><span class="sd">    yields a thumbnail image of a whole slide rescaled by a specified scale factor</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a><span class="sd">        slide (TiffSlide): slide object</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a><span class="sd">        scale_factor (int): integer scaling factor to resize the whole slide by</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a><span class="sd">        np.ndarray: downsized whole slie thumbnail</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>    <span class="n">new_width</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">scale_factor</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>    <span class="n">new_height</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="n">scale_factor</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>    <span class="n">img</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">get_thumbnail</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">new_width</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_height</span><span class="p">)))</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.utils.get_full_resolution_generator" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_full_resolution_generator</span><span class="p">(</span><span class="n">slide_urlpath</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.common.utils.get_full_resolution_generator" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Return MinimalComputeAperioDZGenerator and generator level</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slide urlpath</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Tuple">Tuple</span>[<a class="autorefs autorefs-internal" title="luna.pathology.common.deepzoom.DeepZoomGenerator" href="#luna.pathology.common.deepzoom.DeepZoomGenerator">DeepZoomGenerator</a>, int]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Tuple[MinimalComputeAperioDZGenerator, int]</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-480" name="__codelineno-0-480"></a><span class="k">def</span> <span class="nf">get_full_resolution_generator</span><span class="p">(</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>    <span class="n">slide_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>    <span class="n">tile_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">DeepZoomGenerator</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return MinimalComputeAperioDZGenerator and generator level</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a><span class="sd">        slide_urlpath (str): slide urlpath</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a><span class="sd">        Tuple[MinimalComputeAperioDZGenerator, int]</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>    <span class="n">generator</span> <span class="o">=</span> <span class="n">DeepZoomGenerator</span><span class="p">(</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>        <span class="n">slide_urlpath</span><span class="p">,</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>        <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>        <span class="n">tile_size</span><span class="o">=</span><span class="n">tile_size</span><span class="p">,</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>        <span class="n">limit_bounds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>        <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_options</span><span class="p">,</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>    <span class="p">)</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>    <span class="n">generator_level</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">level_count</span> <span class="o">-</span> <span class="mi">1</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>    <span class="c1"># assert generator.level_dimensions[generator_level] == slide.dimensions</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>    <span class="k">return</span> <span class="n">generator</span><span class="p">,</span> <span class="n">generator_level</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.utils.get_layer_names" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_layer_names</span><span class="p">(</span><span class="n">xml_urlpath</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.common.utils.get_layer_names" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>get available layer names</p>
<p>Finds all possible annotation layer names from a Halo generated xml ROI file</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>xml_urlpath</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>absolute or relativefile path to input halo XML file. prefix scheme to use alternative filesystems.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>set</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Available region names</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="k">def</span> <span class="nf">get_layer_names</span><span class="p">(</span><span class="n">xml_urlpath</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{}):</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;get available layer names</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">    Finds all possible annotation layer names from a Halo generated xml ROI file</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">        xml_urlpath (str): absolute or relativefile path to input halo XML file. prefix scheme to use alternative filesystems.</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">        set: Available region names</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># Annotations &gt;&gt;</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">xml_urlpath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="n">e</span> <span class="o">=</span> <span class="n">et</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">of</span><span class="p">)</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;Annotation&quot;</span><span class="p">)</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="n">names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">ann</span> <span class="ow">in</span> <span class="n">e</span><span class="p">]</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="k">return</span> <span class="n">names</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.utils.get_scale_factor_at_magnification" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_scale_factor_at_magnification</span><span class="p">(</span><span class="n">slide</span><span class="p">,</span> <span class="n">requested_magnification</span><span class="p">)</span></code>

<a href="#luna.pathology.common.utils.get_scale_factor_at_magnification" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>get scale factor at magnification</p>
<p>Return a scale factor if slide scanned magnification and
requested magnification are different.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide</code></td>
          <td>
                <code><span title="tiffslide.TiffSlide">TiffSlide</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>slide object</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>requested_magnification</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>requested magnification</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>int</code></td>          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>scale factor required to achieve requested magnification</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-507" name="__codelineno-0-507"></a><span class="k">def</span> <span class="nf">get_scale_factor_at_magnification</span><span class="p">(</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>    <span class="n">slide</span><span class="p">:</span> <span class="n">TiffSlide</span><span class="p">,</span> <span class="n">requested_magnification</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;get scale factor at magnification</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a><span class="sd">    Return a scale factor if slide scanned magnification and</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a><span class="sd">    requested magnification are different.</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a><span class="sd">        slide (TiffSlide): slide object</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a><span class="sd">        requested_magnification (Optional[int]): requested magnification</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a><span class="sd">        int: scale factor required to achieve requested magnification</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>    <span class="c1"># First convert to float to handle true integers encoded as string floats (e.g. &#39;20.000&#39;)</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>    <span class="n">mag_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">slide</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;aperio.AppMag&quot;</span><span class="p">])</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>    <span class="c1"># Then convert to integer</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>    <span class="n">scanned_magnification</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mag_value</span><span class="p">)</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>    <span class="c1"># # Make sure we don&#39;t have non-integer magnifications</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">(</span><span class="n">mag_value</span><span class="p">)</span> <span class="o">==</span> <span class="n">mag_value</span><span class="p">:</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>            <span class="s2">&quot;Can&#39;t handle slides scanned at non-integer magnficiations! (yet)&quot;</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>        <span class="p">)</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>    <span class="c1"># Verify magnification valid</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>    <span class="n">scale_factor</span> <span class="o">=</span> <span class="mf">1.0</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>    <span class="k">if</span> <span class="n">requested_magnification</span> <span class="ow">and</span> <span class="n">scanned_magnification</span> <span class="o">!=</span> <span class="n">requested_magnification</span><span class="p">:</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>        <span class="k">if</span> <span class="n">scanned_magnification</span> <span class="o">&lt;</span> <span class="n">requested_magnification</span><span class="p">:</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>                <span class="sa">f</span><span class="s2">&quot;Expected magnification &lt;=</span><span class="si">{</span><span class="n">scanned_magnification</span><span class="si">}</span><span class="s2"> but got </span><span class="si">{</span><span class="n">requested_magnification</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>            <span class="p">)</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>        <span class="k">elif</span> <span class="p">(</span><span class="n">scanned_magnification</span> <span class="o">%</span> <span class="n">requested_magnification</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>            <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">scanned_magnification</span> <span class="o">//</span> <span class="n">requested_magnification</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Scale factor is not an integer, be careful!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>            <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">scanned_magnification</span> <span class="o">/</span> <span class="n">requested_magnification</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>    <span class="k">return</span> <span class="n">scale_factor</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.utils.get_stain_vectors_macenko" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_stain_vectors_macenko</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span></code>

<a href="#luna.pathology.common.utils.get_stain_vectors_macenko" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>get_stain_vectors</p>
<p>Uses the staintools MacenkoStainExtractor to extract stain vectors</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>sample</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>input patch</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    np.ndarray: the stain matrix</p>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-202" name="__codelineno-0-202"></a><span class="k">def</span> <span class="nf">get_stain_vectors_macenko</span><span class="p">(</span><span class="n">sample</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;get_stain_vectors</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">    Uses the staintools MacenkoStainExtractor to extract stain vectors</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="sd">        sample (np.ndarray): input patch</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="sd">        np.ndarray: the stain matrix</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>    <span class="kn">from</span> <span class="nn">staintools.stain_extraction.macenko_stain_extractor</span> <span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>        <span class="n">MacenkoStainExtractor</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>    <span class="p">)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>    <span class="n">extractor</span> <span class="o">=</span> <span class="n">MacenkoStainExtractor</span><span class="p">()</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>    <span class="n">vectors</span> <span class="o">=</span> <span class="n">extractor</span><span class="o">.</span><span class="n">get_stain_matrix</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>    <span class="k">return</span> <span class="n">vectors</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.utils.get_tile_array" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_tile_array</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.common.utils.get_tile_array" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Returns a tile image as a numpy array.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>row</code></td>
          <td>
                <code><span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>row with address and tile_image_file columns</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-404" name="__codelineno-0-404"></a><span class="k">def</span> <span class="nf">get_tile_array</span><span class="p">(</span><span class="n">row</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{})</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a><span class="sd">    Returns a tile image as a numpy array.</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a><span class="sd">        row (pd.DataFrame): row with address and tile_image_file columns</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>    <span class="n">fs</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">tile_store</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>    <span class="n">cache_fs</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">filesystem</span><span class="p">(</span><span class="s2">&quot;filecache&quot;</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>    <span class="k">with</span> <span class="n">cache_fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf</span><span class="p">:</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>            <span class="n">tile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hf</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>            <span class="k">return</span> <span class="n">tile</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.utils.get_tile_arrays" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_tile_arrays</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">input_slide_urlpath</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.common.utils.get_tile_arrays" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Get tile arrays for the tile indices</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>indices</code></td>
          <td>
                <code><span title="typing.List">List</span>[int]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>list of integers to return as tiles</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>input_slide_image</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>path to WSI</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tile_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>width, height of generated tile</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[<span title="typing.Tuple">Tuple</span>[int, <span title="numpy.ndarray">ndarray</span>]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>a list of tuples (index, tile array) for given indices</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-371" name="__codelineno-0-371"></a><span class="k">def</span> <span class="nf">get_tile_arrays</span><span class="p">(</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>    <span class="n">indices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>    <span class="n">input_slide_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>    <span class="n">tile_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a><span class="sd">    Get tile arrays for the tile indices</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a><span class="sd">        indices (List[int]): list of integers to return as tiles</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a><span class="sd">        input_slide_image (str): path to WSI</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a><span class="sd">        tile_size (int): width, height of generated tile</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a><span class="sd">        a list of tuples (index, tile array) for given indices</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>    <span class="n">full_generator</span><span class="p">,</span> <span class="n">full_level</span> <span class="o">=</span> <span class="n">get_full_resolution_generator</span><span class="p">(</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>        <span class="n">input_slide_urlpath</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="n">tile_size</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_options</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>    <span class="p">)</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>    <span class="k">return</span> <span class="p">[</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>        <span class="p">(</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>            <span class="n">index</span><span class="p">,</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>                <span class="n">full_generator</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>                    <span class="n">full_level</span><span class="p">,</span> <span class="n">address_to_coord</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>                <span class="p">)</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">tile_size</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">))</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>            <span class="p">),</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>        <span class="p">)</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.utils.get_tile_color" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_tile_color</span><span class="p">(</span><span class="n">score</span><span class="p">)</span></code>

<a href="#luna.pathology.common.utils.get_tile_color" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>get tile color</p>
<p>uses deafult color palette to return color of tile based on score</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>score</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[str, float]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>a value between [0,1] such as the
Otsu threshold, puple score, a model output, etc.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    Union[float, None]: returns the color is the input is of valid type
        else None</p>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-602" name="__codelineno-0-602"></a><span class="k">def</span> <span class="nf">get_tile_color</span><span class="p">(</span><span class="n">score</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">]:</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;get tile color</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a><span class="sd">    uses deafult color palette to return color of tile based on score</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a><span class="sd">        score (Union[str, float]): a value between [0,1] such as the</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a><span class="sd">            Otsu threshold, puple score, a model output, etc.</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a><span class="sd">        Union[float, None]: returns the color is the input is of valid type</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a><span class="sd">            else None</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>    <span class="c1"># categorical</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>        <span class="k">if</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">categorical_colors</span><span class="p">:</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>            <span class="k">return</span> <span class="n">categorical_colors</span><span class="p">[</span><span class="n">score</span><span class="p">]</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>            <span class="n">tile_color</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">categorial</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">categorical_colors</span><span class="o">.</span><span class="n">keys</span><span class="p">())])</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>            <span class="n">categorical_colors</span><span class="p">[</span><span class="n">score</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile_color</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>            <span class="k">return</span> <span class="n">tile_color</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>    <span class="c1"># float, expected to be value from [0,1]</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">score</span> <span class="o">&lt;=</span> <span class="mf">1.0</span> <span class="ow">and</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">:</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>        <span class="n">tile_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">palette</span><span class="p">(</span><span class="n">score</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]])</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>        <span class="k">return</span> <span class="n">tile_color</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid Score Type&quot;</span><span class="p">)</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a>        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.utils.pull_stain_channel" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">pull_stain_channel</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="n">vectors</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#luna.pathology.common.utils.pull_stain_channel" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>pull stain channel</p>
<p>adds 'stain channel' to the image patch</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>patch</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>input image patch</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>vectors</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>stain vectors</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>channel</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>stain channel</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>np.ndarray: the input image patch with an added stain channel</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="k">def</span> <span class="nf">pull_stain_channel</span><span class="p">(</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>    <span class="n">patch</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">vectors</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">channel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;pull stain channel</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a><span class="sd">    adds &#39;stain channel&#39; to the image patch</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a><span class="sd">        patch (np.ndarray): input image patch</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a><span class="sd">        vectors (np.ndarray): stain vectors</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a><span class="sd">        channel (int): stain channel</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a><span class="sd">        np.ndarray: the input image patch with an added stain channel</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>    <span class="kn">from</span> <span class="nn">staintools.miscellaneous.get_concentrations</span> <span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>        <span class="n">get_concentrations</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>    <span class="p">)</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>    <span class="n">tile_concentrations</span> <span class="o">=</span> <span class="n">get_concentrations</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="n">vectors</span><span class="p">)</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>    <span class="n">identity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>    <span class="n">tmp</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tile_concentrations</span><span class="p">,</span> <span class="n">identity</span><span class="p">)))</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>    <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>    <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>        <span class="k">return</span> <span class="n">tmp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">channel</span><span class="p">]</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>        <span class="k">return</span> <span class="n">tmp</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.common.utils.visualize_tiling_scores" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">visualize_tiling_scores</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">thumbnail_img</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">score_type_to_visualize</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#luna.pathology.common.utils.visualize_tiling_scores" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>visualize tile scores</p>
<p>draws colored boxes around tiles to indicate the value of the score</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df</code></td>
          <td>
                <code><span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>input dataframe</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>thumbnail_img</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>input tile</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tile_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>tile width/length</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>score_type_to_visualize</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>column name from data frame</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>np.ndarray: new thumbnail image with boxes around tiles passing indicating the</p>
            </div>
          </td>
        </tr>
        <tr>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>value of the score</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/common/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-550" name="__codelineno-0-550"></a><span class="k">def</span> <span class="nf">visualize_tiling_scores</span><span class="p">(</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>    <span class="n">thumbnail_img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>    <span class="n">scale_factor</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>    <span class="n">score_type_to_visualize</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>    <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;visualize tile scores</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a><span class="sd">    draws colored boxes around tiles to indicate the value of the score</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a><span class="sd">        df (pd.DataFrame): input dataframe</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a><span class="sd">        thumbnail_img (np.ndarray): input tile</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a><span class="sd">        tile_size (int): tile width/length</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a><span class="sd">        score_type_to_visualize (str): column name from data frame</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a><span class="sd">        np.ndarray: new thumbnail image with boxes around tiles passing indicating the</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a><span class="sd">        value of the score</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thumbnail_img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>    <span class="k">if</span> <span class="n">normalize</span> <span class="ow">and</span> <span class="n">df</span><span class="p">[</span><span class="n">score_type_to_visualize</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="s2">&quot;biuf&quot;</span><span class="p">:</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>        <span class="n">df</span><span class="p">[</span><span class="n">score_type_to_visualize</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>            <span class="n">df</span><span class="p">[</span><span class="n">score_type_to_visualize</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">score_type_to_visualize</span><span class="p">])</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>        <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">score_type_to_visualize</span><span class="p">])</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)):</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>        <span class="k">if</span> <span class="s2">&quot;regional_label&quot;</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">regional_label</span><span class="p">):</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>            <span class="k">continue</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>        <span class="n">start</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>            <span class="n">row</span><span class="o">.</span><span class="n">y_coord</span> <span class="o">/</span> <span class="n">scale_factor</span><span class="p">,</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>            <span class="n">row</span><span class="o">.</span><span class="n">x_coord</span> <span class="o">/</span> <span class="n">scale_factor</span><span class="p">,</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>        <span class="p">)</span>  <span class="c1"># flip because OpenSlide uses (column, row), but skimage, uses (row, column)</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>        <span class="n">rr</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">rectangle_perimeter</span><span class="p">(</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>            <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>            <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">xy_extent</span> <span class="o">/</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">xy_extent</span> <span class="o">/</span> <span class="n">scale_factor</span><span class="p">),</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a>            <span class="n">shape</span><span class="o">=</span><span class="n">thumbnail_img</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a>        <span class="p">)</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a>        <span class="c1"># set color based on intensity of value instead of black border (1)</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>        <span class="n">score</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">score_type_to_visualize</span><span class="p">]</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>        <span class="n">thumbnail_img</span><span class="p">[</span><span class="n">rr</span><span class="p">,</span> <span class="n">cc</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_tile_color</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>    <span class="k">return</span> <span class="n">thumbnail_img</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>


  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h2 id="luna.pathology.dsa" class="doc doc-heading">
          <code>dsa</code>


<a href="#luna.pathology.dsa" class="headerlink" title="Permanent link">&para;</a></h2>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-module">




<h3 id="luna.pathology.dsa.dsa_api_handler" class="doc doc-heading">
          <code>dsa_api_handler</code>


<a href="#luna.pathology.dsa.dsa_api_handler" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.dsa.dsa_api_handler.copy_item" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">copy_item</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">destination_id</span><span class="p">)</span></code>

<a href="#luna.pathology.dsa.dsa_api_handler.copy_item" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Copies the item to the destination.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>gc</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>girder_client</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>item_id</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>uuid of the item to be copied</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>destination_id</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>uuid of the destination folder</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/dsa/dsa_api_handler.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-345" name="__codelineno-0-345"></a><span class="k">def</span> <span class="nf">copy_item</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">item_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">destination_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a><span class="sd">    Copies the item to the destination.</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a><span class="sd">        gc: girder_client</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a><span class="sd">        item_id (string): uuid of the item to be copied</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a><span class="sd">        destination_id (string): uuid of the destination folder</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>    <span class="n">request_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;item/</span><span class="si">{</span><span class="n">item_id</span><span class="si">}</span><span class="s2">/copy?folderId=</span><span class="si">{</span><span class="n">destination_id</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>        <span class="n">gc</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">request_url</span><span class="p">)</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error copying item: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Can not copy item&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.dsa.dsa_api_handler.create_collection" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">create_collection</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">)</span></code>

<a href="#luna.pathology.dsa.dsa_api_handler.create_collection" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Creates a dsa collection and returns a collection uuid from the created
collection on successful creation.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>gc</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>girder client</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>collection_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the collection</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>string</code></td>          <td>
                <code><span title="typing.Optional">Optional</span>[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA collection uuid. Or an error in the post request.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/dsa/dsa_api_handler.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="k">def</span> <span class="nf">create_collection</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">    Creates a dsa collection and returns a collection uuid from the created</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">    collection on successful creation.</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">        gc: girder client</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">        collection_name (string): name of the collection</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">        string: DSA collection uuid. Or an error in the post request.</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="n">gc</span><span class="o">.</span><span class="n">createCollection</span><span class="p">(</span><span class="n">collection_name</span><span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created collection </span><span class="si">{</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="n">new_collection_id</span> <span class="o">=</span> <span class="n">get_collection_uuid</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">)</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Collection </span><span class="si">{</span><span class="n">collection_name</span><span class="si">}</span><span class="s2"> has id </span><span class="si">{</span><span class="n">new_collection_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Couldn&#39;t create collection </span><span class="si">{</span><span class="n">collection_name</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="k">return</span> <span class="n">new_collection_id</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.dsa.dsa_api_handler.create_folder" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">create_folder</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">parent_type</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">)</span></code>

<a href="#luna.pathology.dsa.dsa_api_handler.create_folder" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Creates a dsa folder and returns a folder uuid from the created
folder on successful creation.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>gc</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>girder client</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>folder_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the folder in DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>parent_type</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>type of the parent container (ie. folder, collection)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>parent_id</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>uuid of the parent container</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>string</code></td>          <td>
                <code><span title="typing.Optional">Optional</span>[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA folder uuid. Or an error in the post request.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/dsa/dsa_api_handler.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="k">def</span> <span class="nf">create_folder</span><span class="p">(</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="n">gc</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parent_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="sd">    Creates a dsa folder and returns a folder uuid from the created</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="sd">    folder on successful creation.</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">        gc: girder client</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="sd">        folder_name (string): name of the folder in DSA</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="sd">        parent_type (string): type of the parent container (ie. folder, collection)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">        parent_id (string): uuid of the parent container</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">        string: DSA folder uuid. Or an error in the post request.</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="n">gc</span><span class="o">.</span><span class="n">createFolder</span><span class="p">(</span><span class="n">parent_id</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">parentType</span><span class="o">=</span><span class="n">parent_type</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created folder </span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="n">new_folder_uuid</span> <span class="o">=</span> <span class="n">get_folder_uuid</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">parent_type</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Folder </span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2"> has id </span><span class="si">{</span><span class="n">new_folder_uuid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Couldn&#39;t create folder </span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="k">return</span> <span class="n">new_folder_uuid</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.dsa.dsa_api_handler.create_s3_assetstore" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">create_s3_assetstore</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">access</span><span class="p">,</span> <span class="n">secret</span><span class="p">,</span> <span class="n">service</span><span class="p">)</span></code>

<a href="#luna.pathology.dsa.dsa_api_handler.create_s3_assetstore" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Creates a s3 assetstore.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>gc</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>girder client</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>bucket</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the folder in DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>access</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>s3 access ID</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>secret</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>s3 password</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>service</code></td>
          <td>
                <code>string) </code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>url of the s3 host</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>string</code></td>          <td>
                <code><span title="typing.Optional">Optional</span>[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA assetstore uuid. Or an error in the post request.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/dsa/dsa_api_handler.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="k">def</span> <span class="nf">create_s3_assetstore</span><span class="p">(</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>    <span class="n">gc</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">access</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">secret</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">service</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">    Creates a s3 assetstore.</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="sd">        gc: girder client</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">        bucket (string): name of the folder in DSA</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="sd">        access (string): s3 access ID</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="sd">        secret (string): s3 password</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a><span class="sd">        service (string) : url of the s3 host</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a><span class="sd">        string: DSA assetstore uuid. Or an error in the post request.</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="n">request_url</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="sa">f</span><span class="s2">&quot;assetstore?name=</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&amp;type=2&amp;bucket=</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">&amp;accessKeyId=</span><span class="si">{</span><span class="n">access</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;&amp;secret=</span><span class="si">{</span><span class="n">secret</span><span class="si">}</span><span class="s2">&amp;service=</span><span class="si">{</span><span class="n">service</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>    <span class="p">)</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="n">gc</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">request_url</span><span class="p">)</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created assetstore </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="n">new_assetstore_uuid</span> <span class="o">=</span> <span class="n">get_assetstore_uuid</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assetstore </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> has id </span><span class="si">{</span><span class="n">new_assetstore_uuid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Couldn&#39;t create assetstore </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unable to create s3 assetstore&quot;</span><span class="p">)</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>    <span class="k">return</span> <span class="n">new_assetstore_uuid</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.dsa.dsa_api_handler.dsa_authenticate" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">dsa_authenticate</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span></code>

<a href="#luna.pathology.dsa.dsa_api_handler.dsa_authenticate" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Authenticate girder client</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>gc</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>girder client</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>username</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA username</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>password</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA password</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/dsa/dsa_api_handler.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-442" name="__codelineno-0-442"></a><span class="k">def</span> <span class="nf">dsa_authenticate</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Authenticate girder client</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a><span class="sd">        gc: girder client</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a><span class="sd">        username (str): DSA username</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a><span class="sd">        password (str): DSA password</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>    <span class="c1"># Initial connnection</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>        <span class="n">gc</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connected to DSA @ </span><span class="si">{</span><span class="n">gc</span><span class="o">.</span><span class="n">urlBase</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>    <span class="k">except</span> <span class="n">girder_client</span><span class="o">.</span><span class="n">AuthenticationError</span><span class="p">:</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t authenticate DSA due to AuthenticationError&quot;</span><span class="p">)</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Connection to DSA endpoint failed.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t authenticate DSA due to some other exception&quot;</span><span class="p">)</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Connection to DSA endpoint failed.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.dsa.dsa_api_handler.get_annotation_df" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_annotation_df</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">annotation_uuid</span><span class="p">)</span></code>

<a href="#luna.pathology.dsa.dsa_api_handler.get_annotation_df" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Return annotation metadata (regions) for a given annotation as a dataframe</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>gc</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>girder client</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_uuid</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA annotation uuid</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    pd.DataFrame: annotation/region metadata, with slide_item_uuid as additional indicies</p>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/dsa/dsa_api_handler.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-561" name="__codelineno-0-561"></a><span class="k">def</span> <span class="nf">get_annotation_df</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">annotation_uuid</span><span class="p">):</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return annotation metadata (regions) for a given annotation as a dataframe</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a><span class="sd">        gc: girder client</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a><span class="sd">        annotation_uuid (str): DSA annotation uuid</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a><span class="sd">        pd.DataFrame: annotation/region metadata, with slide_item_uuid as additional indicies</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>    <span class="c1"># Here we get all the annotation data as a json document</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>    <span class="n">annot</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;annotation/</span><span class="si">{</span><span class="n">annotation_uuid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>    <span class="p">(</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>        <span class="n">df_summary</span><span class="p">,</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>        <span class="n">df_regions</span><span class="p">,</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>    <span class="p">)</span> <span class="o">=</span> <span class="n">histomicstk</span><span class="o">.</span><span class="n">annotations_and_masks</span><span class="o">.</span><span class="n">annotation_and_mask_utils</span><span class="o">.</span><span class="n">parse_slide_annotations_into_tables</span><span class="p">(</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>        <span class="p">[</span><span class="n">annot</span><span class="p">]</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>    <span class="p">)</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>    <span class="c1"># Lets process the coordiates a bit...</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>    <span class="n">df_regions</span><span class="p">[</span><span class="s2">&quot;x_coords&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>        <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">coords_x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span> <span class="k">for</span> <span class="n">coords_x</span> <span class="ow">in</span> <span class="n">df_regions</span><span class="p">[</span><span class="s2">&quot;coords_x&quot;</span><span class="p">]</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>    <span class="p">]</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>    <span class="n">df_regions</span><span class="p">[</span><span class="s2">&quot;y_coords&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>        <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">coords_x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span> <span class="k">for</span> <span class="n">coords_x</span> <span class="ow">in</span> <span class="n">df_regions</span><span class="p">[</span><span class="s2">&quot;coords_y&quot;</span><span class="p">]</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>    <span class="p">]</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>    <span class="n">df_regions</span> <span class="o">=</span> <span class="n">df_regions</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;coords_x&quot;</span><span class="p">,</span> <span class="s2">&quot;coords_y&quot;</span><span class="p">])</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>    <span class="c1"># And join the summary data with the regional data</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>    <span class="n">df_annotations</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>        <span class="n">df_summary</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;annotation_girder_id&quot;</span><span class="p">)</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_regions</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;annotation_girder_id&quot;</span><span class="p">))</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a>        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>    <span class="p">)</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>    <span class="n">df_annotations</span> <span class="o">=</span> <span class="n">df_annotations</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;itemId&quot;</span><span class="p">:</span> <span class="s2">&quot;slide_item_uuid&quot;</span><span class="p">})</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>    <span class="k">return</span> <span class="n">df_annotations</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.dsa.dsa_api_handler.get_assetstore_uuid" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_assetstore_uuid</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">assetstore_name</span><span class="p">)</span></code>

<a href="#luna.pathology.dsa.dsa_api_handler.get_assetstore_uuid" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Returns the DSA assetstore uuid from the provided <code>assetstore_name</code></p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>gc</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>girder client</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>assetstore_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the assetstore in DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>string</code></td>          <td>
                <code><span title="typing.Optional">Optional</span>[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA assetstore uuid. None if nothing matches the assetstore name or an
    error in the get request</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/dsa/dsa_api_handler.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="k">def</span> <span class="nf">get_assetstore_uuid</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">assetstore_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the DSA assetstore uuid from the provided `assetstore_name`</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">        gc: girder client</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">        assetstore_name (string): name of the assetstore in DSA</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="sd">        string: DSA assetstore uuid. None if nothing matches the assetstore name or an</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="sd">                error in the get request</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="n">df_assetstores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assetstore?&quot;</span><span class="p">))</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_assetstores</span><span class="p">):</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>            <span class="n">df_assetstores</span> <span class="o">=</span> <span class="n">df_assetstores</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">)</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>            <span class="n">df_assetstores</span> <span class="o">=</span> <span class="n">df_assetstores</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;name==&#39;</span><span class="si">{</span><span class="n">assetstore_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found assetstores </span><span class="si">{</span><span class="n">df_assetstores</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Couldn&#39;t retrieve data from DSA: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Connection to DSA endpoint failed.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_assetstores</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No matching assetstore &#39;</span><span class="si">{</span><span class="n">assetstore_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>    <span class="n">assetstore_uuid</span> <span class="o">=</span> <span class="n">df_assetstores</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>        <span class="sa">f</span><span class="s2">&quot;Found assetstore id=</span><span class="si">{</span><span class="n">assetstore_uuid</span><span class="si">}</span><span class="s2"> for assetstore=</span><span class="si">{</span><span class="n">assetstore_name</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>    <span class="p">)</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>    <span class="k">return</span> <span class="n">assetstore_uuid</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.dsa.dsa_api_handler.get_collection_metadata" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_collection_metadata</span><span class="p">(</span><span class="n">collection_name</span><span class="p">,</span> <span class="n">gc</span><span class="p">)</span></code>

<a href="#luna.pathology.dsa.dsa_api_handler.get_collection_metadata" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>A function used to get the stylehseet associated with a DSA collection. The stylesheet
can store the labels used in the annotation process</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>collection_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of DSA collection used to store the slides</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>gc</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>girder client</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    Optional[Tuple[str, Dict[str, any]]]: a tuple consisting of the collection uuid
        and thei stylesheet in JSON format or None if no stylesheet is associated
        with the provided collection</p>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/dsa/dsa_api_handler.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-484" name="__codelineno-0-484"></a><span class="k">def</span> <span class="nf">get_collection_metadata</span><span class="p">(</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>    <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">gc</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]]]:</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A function used to get the stylehseet associated with a DSA collection. The stylesheet</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a><span class="sd">    can store the labels used in the annotation process</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a><span class="sd">        collection_name (str): name of DSA collection used to store the slides</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a><span class="sd">        gc: girder client</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a><span class="sd">        Optional[Tuple[str, Dict[str, any]]]: a tuple consisting of the collection uuid</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a><span class="sd">            and thei stylesheet in JSON format or None if no stylesheet is associated</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a><span class="sd">            with the provided collection</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>    <span class="n">collection_uuid</span> <span class="o">=</span> <span class="n">get_collection_uuid</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">)</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>    <span class="k">if</span> <span class="n">collection_uuid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;retreived collection uuid&quot;</span><span class="p">)</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>        <span class="c1"># try get request from girder</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>            <span class="n">collection_response</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/collection/</span><span class="si">{</span><span class="n">collection_uuid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>                <span class="sa">f</span><span class="s2">&quot;Error in collection get request: </span><span class="si">{</span><span class="n">err</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">err</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>            <span class="p">)</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>        <span class="c1"># if response successful, attempt to get stylehseet</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>            <span class="n">metadata_stylesheet</span> <span class="o">=</span> <span class="n">collection_response</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">][</span><span class="s2">&quot;stylesheet&quot;</span><span class="p">]</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No stylesheet in collection: </span><span class="si">{</span><span class="n">collection_uuid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>            <span class="n">metadata_stylesheet</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid collection name: </span><span class="si">{</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">collection_uuid</span><span class="p">,</span> <span class="n">metadata_stylesheet</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.dsa.dsa_api_handler.get_collection_uuid" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_collection_uuid</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">)</span></code>

<a href="#luna.pathology.dsa.dsa_api_handler.get_collection_uuid" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Returns the DSA collection uuid from the provided <code>collection_name</code></p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>gc</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>girder client</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>collection_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the collection in DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>string</code></td>          <td>
                <code><span title="typing.Optional">Optional</span>[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA collection uuid. None if nothing matches the collection name or an
    error in the get request</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/dsa/dsa_api_handler.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="k">def</span> <span class="nf">get_collection_uuid</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the DSA collection uuid from the provided `collection_name`</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">        gc: girder client</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">        collection_name (string): name of the collection in DSA</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">        string: DSA collection uuid. None if nothing matches the collection name or an</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">                error in the get request</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>        <span class="n">df_collections</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">listCollection</span><span class="p">())</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_collections</span><span class="p">):</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>            <span class="n">df_collections</span> <span class="o">=</span> <span class="n">df_collections</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">)</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>            <span class="n">df_collections</span> <span class="o">=</span> <span class="n">df_collections</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;name==&#39;</span><span class="si">{</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found collections </span><span class="si">{</span><span class="n">df_collections</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Couldn&#39;t retrieve data from DSA: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Connection to DSA endpoint failed.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="c1"># Look for a collection called our collection name</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_collections</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No matching collection &#39;</span><span class="si">{</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="n">collection_uuid</span> <span class="o">=</span> <span class="n">df_collections</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="sa">f</span><span class="s2">&quot;Found collection id=</span><span class="si">{</span><span class="n">collection_uuid</span><span class="si">}</span><span class="s2"> for collection=</span><span class="si">{</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="k">return</span> <span class="n">collection_uuid</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.dsa.dsa_api_handler.get_folder_uuid" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_folder_uuid</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">parent_type</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">)</span></code>

<a href="#luna.pathology.dsa.dsa_api_handler.get_folder_uuid" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Returns the DSA folder uuid from the provided <code>folder_name</code></p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>gc</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>girder client</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>folder_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the folder in DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>parent_type</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>type of the parent container (ie. folder, collection)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>parent_id</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>uuid of the parent container</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>string</code></td>          <td>
                <code><span title="typing.Optional">Optional</span>[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA folder uuid. None if nothing matches the collection name or an
    error in the get request</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/dsa/dsa_api_handler.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="k">def</span> <span class="nf">get_folder_uuid</span><span class="p">(</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="n">gc</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parent_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the DSA folder uuid from the provided `folder_name`</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">        gc: girder client</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">        folder_name (string): name of the folder in DSA</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">        parent_type (string): type of the parent container (ie. folder, collection)</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">        parent_id (string): uuid of the parent container</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">        string: DSA folder uuid. None if nothing matches the collection name or an</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">                error in the get request</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="n">df_folders</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">listFolder</span><span class="p">(</span><span class="n">parent_id</span><span class="p">,</span> <span class="n">parent_type</span><span class="p">))</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_folders</span><span class="p">):</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>            <span class="n">df_folders</span> <span class="o">=</span> <span class="n">df_folders</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">)</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>            <span class="n">df_folders</span> <span class="o">=</span> <span class="n">df_folders</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;name==&#39;</span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found folders </span><span class="si">{</span><span class="n">df_folders</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Couldn&#39;t retrieve data from DSA: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Connection to DSA endpoint failed.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_folders</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No matching folders &#39;</span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="n">folder_uuid</span> <span class="o">=</span> <span class="n">df_folders</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found folder id=</span><span class="si">{</span><span class="n">folder_uuid</span><span class="si">}</span><span class="s2"> for folder=</span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>    <span class="k">return</span> <span class="n">folder_uuid</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.dsa.dsa_api_handler.get_item_uuid" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_item_uuid</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">image_name</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">)</span></code>

<a href="#luna.pathology.dsa.dsa_api_handler.get_item_uuid" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Returns the DSA item uuid from the provided <code>image_name</code></p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>image_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the image in DSA e.g. 123.svs</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>collection_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of DSA collection</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>gc</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>girder client</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>string</code></td>          <td>
                <code><span title="typing.Optional">Optional</span>[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA item uuid. None if nothing matches the collection/image name.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/dsa/dsa_api_handler.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="k">def</span> <span class="nf">get_item_uuid</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">image_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the DSA item uuid from the provided `image_name`</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a><span class="sd">        image_name (string): name of the image in DSA e.g. 123.svs</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a><span class="sd">        collection_name (str): name of DSA collection</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a><span class="sd">        gc: girder client</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a><span class="sd">        string: DSA item uuid. None if nothing matches the collection/image name.</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>    <span class="n">collection_uuid</span> <span class="o">=</span> <span class="n">get_collection_uuid</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">)</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">collection_uuid</span><span class="p">:</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>    <span class="n">image_id</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">image_name</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>        <span class="n">uuid_response</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/item?text=&quot;</span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>            <span class="sa">f</span><span class="s2">&quot;Error in item get request: </span><span class="si">{</span><span class="n">err</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">err</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>        <span class="p">)</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="k">if</span> <span class="n">uuid_response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">uuid_response</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>        <span class="c1"># multiple entries can come up based on substring matches, return the correct item id by checking name field in dictionary.</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>        <span class="k">for</span> <span class="n">uuid_response_dict</span> <span class="ow">in</span> <span class="n">uuid_response</span><span class="p">:</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>            <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">uuid_response_dict</span> <span class="ow">and</span> <span class="s2">&quot;_id&quot;</span> <span class="ow">in</span> <span class="n">uuid_response_dict</span><span class="p">:</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>                <span class="k">if</span> <span class="p">(</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>                    <span class="n">uuid_response_dict</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">image_name</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>                    <span class="ow">and</span> <span class="n">uuid_response_dict</span><span class="p">[</span><span class="s2">&quot;baseParentId&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">collection_uuid</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>                <span class="p">):</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>                    <span class="n">dsa_uuid</span> <span class="o">=</span> <span class="n">uuid_response_dict</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image file </span><span class="si">{</span><span class="n">image_name</span><span class="si">}</span><span class="s2"> found with id: </span><span class="si">{</span><span class="n">dsa_uuid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>                    <span class="k">return</span> <span class="n">dsa_uuid</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image file </span><span class="si">{</span><span class="n">image_name</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.dsa.dsa_api_handler.get_item_uuid_by_folder" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_item_uuid_by_folder</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">image_name</span><span class="p">,</span> <span class="n">folder_uuid</span><span class="p">)</span></code>

<a href="#luna.pathology.dsa.dsa_api_handler.get_item_uuid_by_folder" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Returns the DSA item uuid from the provided folder</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>gc</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>girder client</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>image_name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of the image in DSA e.g. 123.svs</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>folder_uuid</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>uuid of parent DSA folder</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>string</code></td>          <td>
                <code><span title="typing.Optional">Optional</span>[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA item uuid. None if nothing matches the folder uuid / image name.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/dsa/dsa_api_handler.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-309" name="__codelineno-0-309"></a><span class="k">def</span> <span class="nf">get_item_uuid_by_folder</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">image_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">folder_uuid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the DSA item uuid from the provided folder</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a><span class="sd">        gc: girder client</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a><span class="sd">        image_name (string): name of the image in DSA e.g. 123.svs</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a><span class="sd">        folder_uuid (string): uuid of parent DSA folder</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a><span class="sd">        string: DSA item uuid. None if nothing matches the folder uuid / image name.</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>    <span class="n">image_id</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">image_name</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>        <span class="n">uuid_response</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/item?text=&quot;</span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>            <span class="sa">f</span><span class="s2">&quot;Error in item get request: </span><span class="si">{</span><span class="n">err</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">err</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>        <span class="p">)</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>    <span class="k">if</span> <span class="n">uuid_response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">uuid_response</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>        <span class="c1"># multiple entries can come up based on substring matches, return the correct item id by checking name field in dictionary.</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>        <span class="k">for</span> <span class="n">uuid_response_dict</span> <span class="ow">in</span> <span class="n">uuid_response</span><span class="p">:</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">uuid_response_dict</span> <span class="ow">and</span> <span class="s2">&quot;_id&quot;</span> <span class="ow">in</span> <span class="n">uuid_response_dict</span><span class="p">:</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>                <span class="k">if</span> <span class="p">(</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>                    <span class="n">uuid_response_dict</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">image_name</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>                    <span class="ow">and</span> <span class="n">uuid_response_dict</span><span class="p">[</span><span class="s2">&quot;folderId&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">folder_uuid</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>                <span class="p">):</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>                    <span class="n">dsa_uuid</span> <span class="o">=</span> <span class="n">uuid_response_dict</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image file </span><span class="si">{</span><span class="n">image_name</span><span class="si">}</span><span class="s2"> found with id: </span><span class="si">{</span><span class="n">dsa_uuid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>                    <span class="k">return</span> <span class="n">dsa_uuid</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image file </span><span class="si">{</span><span class="n">image_name</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.dsa.dsa_api_handler.get_slide_annotation" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_slide_annotation</span><span class="p">(</span><span class="n">slide_id</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">gc</span><span class="p">)</span></code>

<a href="#luna.pathology.dsa.dsa_api_handler.get_slide_annotation" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>A helper function that pulls json annotations along with
metadata for a particular slide from DSA. Used for both point and regional
annotation types.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>slide_id</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>image name of WSI on DSA.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>annotation_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of annotation, or label, created on DSA</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>collection_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>name of DSA collection the WSI belongs to</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>gc</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>girder client</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>[str, <span title="typing.Dict">Dict</span>[str, any], <span title="typing.Dict">Dict</span>[str, any]]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Optional[Tuple[str, dict[str, any], dict[str, any]. A tuple consisting of the slide id,
a json formatted annotation from slideviweer and slide metadata or None if the
annotation can't be found (ie if image_id, annotation_name or collection_name are
mis-specified)</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/dsa/dsa_api_handler.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span>
<span class="normal"><a href="#__codelineno-0-679">679</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-600" name="__codelineno-0-600"></a><span class="k">def</span> <span class="nf">get_slide_annotation</span><span class="p">(</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>    <span class="n">slide_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>    <span class="n">annotation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>    <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>    <span class="n">gc</span><span class="p">,</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]]]:</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A helper function that pulls json annotations along with</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a><span class="sd">    metadata for a particular slide from DSA. Used for both point and regional</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a><span class="sd">    annotation types.</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a><span class="sd">        slide_id (str): image name of WSI on DSA.</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a><span class="sd">        annotation_name (str): name of annotation, or label, created on DSA</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a><span class="sd">        collection_name (str): name of DSA collection the WSI belongs to</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a><span class="sd">        gc: girder client</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a><span class="sd">        Optional[Tuple[str, dict[str, any], dict[str, any]. A tuple consisting of the slide id,</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a><span class="sd">            a json formatted annotation from slideviweer and slide metadata or None if the</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a><span class="sd">            annotation can&#39;t be found (ie if image_id, annotation_name or collection_name are</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a><span class="sd">            mis-specified)</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>    <span class="n">item_uuid</span> <span class="o">=</span> <span class="n">get_item_uuid</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">slide_id</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">)</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">item_uuid</span><span class="p">:</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slide </span><span class="si">{</span><span class="n">slide_id</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>    <span class="c1"># search for annotation</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting request for annotation&quot;</span><span class="p">)</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a>        <span class="n">annotation_response</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a>            <span class="sa">f</span><span class="s2">&quot;/annotation?itemId=</span><span class="si">{</span><span class="n">item_uuid</span><span class="si">}</span><span class="s2">&amp;name=</span><span class="si">{</span><span class="n">annotation_name</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a>        <span class="p">)</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in annotation get request: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>    <span class="c1"># get annotation json from response</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a>    <span class="k">if</span> <span class="n">annotation_response</span><span class="p">:</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a>        <span class="n">annotation_response</span> <span class="o">=</span> <span class="n">annotation_response</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a>        <span class="n">annotation</span> <span class="o">=</span> <span class="n">annotation_response</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">]</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No annotation found for slide </span><span class="si">{</span><span class="n">slide_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>    <span class="c1"># get additional slide-level metadata from response</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>    <span class="n">date_created</span> <span class="o">=</span> <span class="n">annotation_response</span><span class="p">[</span><span class="s2">&quot;created&quot;</span><span class="p">]</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a>    <span class="n">date_updated</span> <span class="o">=</span> <span class="n">annotation_response</span><span class="p">[</span><span class="s2">&quot;updated&quot;</span><span class="p">]</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>    <span class="n">annotation_id</span> <span class="o">=</span> <span class="n">annotation_response</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>    <span class="n">creator_id</span> <span class="o">=</span> <span class="n">annotation_response</span><span class="p">[</span><span class="s2">&quot;creatorId&quot;</span><span class="p">]</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>    <span class="n">creator_updated_id</span> <span class="o">=</span> <span class="n">annotation_response</span><span class="p">[</span><span class="s2">&quot;updatedId&quot;</span><span class="p">]</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a>    <span class="n">annotation_name</span> <span class="o">=</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>        <span class="n">creator_response</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/user/</span><span class="si">{</span><span class="n">creator_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a>        <span class="n">creator_updated_response</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/user/</span><span class="si">{</span><span class="n">creator_updated_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a>    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a>            <span class="sa">f</span><span class="s2">&quot;Error in user get request: </span><span class="si">{</span><span class="n">err</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">err</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a>        <span class="p">)</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a>    <span class="n">creator_login</span> <span class="o">=</span> <span class="n">creator_response</span><span class="p">[</span><span class="s2">&quot;login&quot;</span><span class="p">]</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a>    <span class="n">creator_login_updated</span> <span class="o">=</span> <span class="n">creator_updated_response</span><span class="p">[</span><span class="s2">&quot;login&quot;</span><span class="p">]</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>    <span class="n">slide_metadata</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a>        <span class="s2">&quot;annotation_id&quot;</span><span class="p">:</span> <span class="n">annotation_id</span><span class="p">,</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a>        <span class="s2">&quot;annotation_name&quot;</span><span class="p">:</span> <span class="n">annotation_name</span><span class="p">,</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a>        <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">date_created</span><span class="p">,</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a>        <span class="s2">&quot;date_updated&quot;</span><span class="p">:</span> <span class="n">date_updated</span><span class="p">,</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a>        <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">creator_login</span><span class="p">,</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>        <span class="s2">&quot;user_updated&quot;</span><span class="p">:</span> <span class="n">creator_login_updated</span><span class="p">,</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>    <span class="p">}</span>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">slide_id</span><span class="p">,</span> <span class="n">slide_metadata</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">annotation</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.dsa.dsa_api_handler.get_slide_df" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_slide_df</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">collection_uuid</span><span class="p">)</span></code>

<a href="#luna.pathology.dsa.dsa_api_handler.get_slide_df" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Return slide metadata (largeImage items) for a given colleciton as a dataframe</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>gc</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>girder client</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>collection_uuid</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA collection uuid</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    pd.DataFrame: slide metadata, with slide_id and slide_item_uuid as additional indicies</p>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/dsa/dsa_api_handler.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-526" name="__codelineno-0-526"></a><span class="k">def</span> <span class="nf">get_slide_df</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">collection_uuid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return slide metadata (largeImage items) for a given colleciton as a dataframe</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a><span class="sd">        gc: girder client</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a><span class="sd">        collection_uuid (str): DSA collection uuid</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a><span class="sd">        pd.DataFrame: slide metadata, with slide_id and slide_item_uuid as additional indicies</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>        <span class="n">resource_response</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">listResource</span><span class="p">(</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>            <span class="sa">f</span><span class="s2">&quot;resource/</span><span class="si">{</span><span class="n">collection_uuid</span><span class="si">}</span><span class="s2">/items&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;collection&quot;</span><span class="p">}</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>        <span class="p">)</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>            <span class="sa">f</span><span class="s2">&quot;Couldn&#39;t retrieve resource data from DSA for </span><span class="si">{</span><span class="n">collection_uuid</span><span class="si">}</span><span class="s2">, perhaps the collection UUID does not exist?&quot;</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>        <span class="p">)</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Retriving slide data from DSA failed.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>    <span class="n">df_slide_items</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">resource_response</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>        <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;largeImage&quot;</span><span class="p">]</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>    <span class="p">)</span>  <span class="c1"># Get largeImage types from collection items</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>    <span class="c1"># Fill additional metadata based on convention (slide_id)</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>    <span class="n">df_slide_items</span><span class="p">[</span><span class="s2">&quot;slide_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_slide_items</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>    <span class="p">)</span>  <span class="c1"># The stem</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>    <span class="n">df_slide_items</span><span class="p">[</span><span class="s2">&quot;slide_item_uuid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_slide_items</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_slide_items</span><span class="p">)</span><span class="si">}</span><span class="s2"> slides!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>    <span class="k">return</span> <span class="n">df_slide_items</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.dsa.dsa_api_handler.import_assetstore_to_folder" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">import_assetstore_to_folder</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">assetstore_uuid</span><span class="p">,</span> <span class="n">destination_uuid</span><span class="p">)</span></code>

<a href="#luna.pathology.dsa.dsa_api_handler.import_assetstore_to_folder" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Imports the assetstore to the specified destination folder.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>gc</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>girder client</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>assetstore_uuid</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>uuid of the assetstore</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>destination_uuid</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>uuid of the destination folder</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Optional">Optional</span>[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>None, raises error if post request fails</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/dsa/dsa_api_handler.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="k">def</span> <span class="nf">import_assetstore_to_folder</span><span class="p">(</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>    <span class="n">gc</span><span class="p">,</span> <span class="n">assetstore_uuid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">destination_uuid</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">    Imports the assetstore to the specified destination folder.</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="sd">        gc: girder client</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a><span class="sd">        assetstore_uuid (string): uuid of the assetstore</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a><span class="sd">        destination_uuid (string): uuid of the destination folder</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a><span class="sd">        None, raises error if post request fails</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>    <span class="n">request_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;assetstore/</span><span class="si">{</span><span class="n">assetstore_uuid</span><span class="si">}</span><span class="s2">/import&quot;</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>        <span class="s2">&quot;destinationId&quot;</span><span class="p">:</span> <span class="n">destination_uuid</span><span class="p">,</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>        <span class="s2">&quot;destinationType&quot;</span><span class="p">:</span> <span class="s2">&quot;folder&quot;</span><span class="p">,</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>        <span class="s2">&quot;importPath&quot;</span><span class="p">:</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>    <span class="p">}</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="n">gc</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">request_url</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>            <span class="sa">f</span><span class="s2">&quot;Importing from assetstore id </span><span class="si">{</span><span class="n">assetstore_uuid</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;to destination id </span><span class="si">{</span><span class="n">destination_uuid</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="p">)</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Couldn&#39;t import assetstore id </span><span class="si">{</span><span class="n">assetstore_uuid</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unable to import assetstore to collection&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.dsa.dsa_api_handler.push_annotation_to_dsa_image" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">push_annotation_to_dsa_image</span><span class="p">(</span><span class="n">item_uuid</span><span class="p">,</span> <span class="n">annotation_file_urlpath</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="p">{})</span></code>

<a href="#luna.pathology.dsa.dsa_api_handler.push_annotation_to_dsa_image" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Pushes annotation to DSA, adding given item_uuid (slide-specific id)</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>item_uuid</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA item uuid to be tied to the annotation</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dsa_annotation_json</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, any]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>annotation JSON in DSA compatable format</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>uri</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>DSA scheme://host:port e.g. http://localhost:8080</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>gc</code></td>
          <td>
                <code><span title="girder_client.GirderClient">GirderClient</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>girder client</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>int</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>0 for successful upload, 1 otherwise</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/dsa/dsa_api_handler.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-381" name="__codelineno-0-381"></a><span class="k">def</span> <span class="nf">push_annotation_to_dsa_image</span><span class="p">(</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>    <span class="n">item_uuid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>    <span class="n">annotation_file_urlpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>    <span class="n">uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>    <span class="n">gc</span><span class="p">:</span> <span class="n">girder_client</span><span class="o">.</span><span class="n">GirderClient</span><span class="p">,</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a><span class="p">):</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Pushes annotation to DSA, adding given item_uuid (slide-specific id)</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a><span class="sd">        item_uuid (str): DSA item uuid to be tied to the annotation</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a><span class="sd">        dsa_annotation_json (Dict[str, any]): annotation JSON in DSA compatable format</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a><span class="sd">        uri (str): DSA scheme://host:port e.g. http://localhost:8080</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a><span class="sd">        gc: girder client</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a><span class="sd">        int: 0 for successful upload, 1 otherwise</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>    <span class="n">annotation_name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">annotation_file_urlpath</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>    <span class="c1"># always post a new annotation.</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>    <span class="c1"># updating or deleting an existing annotation for a large annotation</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>    <span class="c1"># document results in timeout.</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>        <span class="n">fs</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span><span class="n">annotation_file_urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">)</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>        <span class="n">size</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>        <span class="n">reference</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>            <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">-AnnotationFile&quot;</span><span class="p">,</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>            <span class="s2">&quot;itemId&quot;</span><span class="p">:</span> <span class="n">item_uuid</span><span class="p">,</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>        <span class="p">}</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>        <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>            <span class="n">gc</span><span class="o">.</span><span class="n">uploadFile</span><span class="p">(</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>                <span class="n">item_uuid</span><span class="p">,</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>                <span class="n">of</span><span class="p">,</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>                <span class="n">annotation_name</span><span class="p">,</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>                <span class="n">size</span><span class="p">,</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>                <span class="n">reference</span><span class="o">=</span><span class="n">orjson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>            <span class="p">)</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>            <span class="sa">f</span><span class="s2">&quot;Error in annotation upload: </span><span class="si">{</span><span class="n">err</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>            <span class="o">+</span> <span class="n">err</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">text</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>        <span class="p">)</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>    <span class="c1"># Wait for annotation to be processed</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>    <span class="n">annotation_id</span> <span class="o">=</span> <span class="n">check_annotation_exists_with_retry</span><span class="p">(</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>        <span class="n">gc</span><span class="p">,</span> <span class="n">item_uuid</span><span class="p">,</span> <span class="n">annotation_name</span><span class="p">,</span> <span class="n">retry_count</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">20</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>    <span class="p">)</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>    <span class="k">if</span> <span class="n">annotation_id</span><span class="p">:</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Annotation successfully pushed to DSA as </span><span class="si">{</span><span class="n">annotation_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Annotation pushed to DSA but still processing.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time to push annotation </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uri</span><span class="si">}</span><span class="s2">/histomics#?image=</span><span class="si">{</span><span class="n">item_uuid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>    <span class="k">return</span> <span class="n">annotation_id</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.dsa.dsa_api_handler.system_check" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">system_check</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span></code>

<a href="#luna.pathology.dsa.dsa_api_handler.system_check" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Check DSA connection with the girder client</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>gc</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>girder client</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    int: 0 for successful connection, 1 otherwise</p>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/dsa/dsa_api_handler.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-462" name="__codelineno-0-462"></a><span class="k">def</span> <span class="nf">system_check</span><span class="p">(</span><span class="n">gc</span><span class="p">):</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Check DSA connection with the girder client</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a><span class="sd">        gc: girder client</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a><span class="sd">        int: 0 for successful connection, 1 otherwise</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>        <span class="n">_</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/system/check&quot;</span><span class="p">)</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Please check your host or credentials&quot;</span><span class="p">)</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>        <span class="k">return</span> <span class="mi">1</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully connected to DSA&quot;</span><span class="p">)</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>    <span class="k">return</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.dsa.utils" class="doc doc-heading">
          <code>utils</code>


<a href="#luna.pathology.dsa.utils" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.dsa.utils.get_color" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_color</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="p">{},</span> <span class="n">fill_colors</span><span class="o">=</span><span class="p">{},</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span></code>

<a href="#luna.pathology.dsa.utils.get_color" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Get colors for cells/regions based on discrete categories.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>name</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>feature name e.g. Stroma, Tumor</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>line_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>line color map with {feature name:rgb values}</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>fill_colors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>fill color map with {feature name:rgba values}</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>alpha</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>alpha value for the fill color. 100 by default</p>
            </div>
          </td>
          <td>
                <code>100</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>string</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>RGBA values for line and fill colors</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/dsa/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="k">def</span> <span class="nf">get_color</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="p">{},</span> <span class="n">fill_colors</span><span class="o">=</span><span class="p">{},</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get colors for cells/regions based on discrete categories.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">        name (string): feature name e.g. Stroma, Tumor</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">        line_colors (dict, optional): line color map with {feature name:rgb values}</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">        fill_colors (dict, optional): fill color map with {feature name:rgba values}</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">        alpha (int, optional): alpha value for the fill color. 100 by default</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">        string: RGBA values for line and fill colors</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line_colors</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fill_colors</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="n">g</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">b</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n">fill_colors</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;rgba(</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="n">line_colors</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;rgb(</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="k">return</span> <span class="n">line_colors</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">fill_colors</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.dsa.utils.get_continuous_color" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_continuous_color</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">outline_color</span><span class="o">=</span><span class="s1">&#39;same_as_fill&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span></code>

<a href="#luna.pathology.dsa.utils.get_continuous_color" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Get RGBA line and fill colors for value.</p>
<p>Use color palette <code>viridis</code> to set a fill value - the color ranges from purple to yellow,
 for the values from 0 to 1. This function is used in generating a heatmap.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>value</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>continuous value in [0,1]</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>outline_color</code></td>
          <td>
                <code>string</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>manages the color used to outline the border of the annotation.
by default, uses the same color as fill_color.</p>
            </div>
          </td>
          <td>
                <code>&#39;same_as_fill&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>alpha</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>alpha value for the fill color. 100 by default</p>
            </div>
          </td>
          <td>
                <code>100</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>string</code></td>          <td>
                <code><span title="typing.Tuple">Tuple</span>[str, str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>RGBA line and fill colors</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/dsa/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="k">def</span> <span class="nf">get_continuous_color</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="n">value</span><span class="p">,</span> <span class="n">outline_color</span><span class="o">=</span><span class="s2">&quot;same_as_fill&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">100</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get RGBA line and fill colors for value.</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">    Use color palette `viridis` to set a fill value - the color ranges from purple to yellow,</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">     for the values from 0 to 1. This function is used in generating a heatmap.</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">        value (float): continuous value in [0,1]</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">        outline_color (string, optional): manages the color used to outline the border of the annotation.</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">            by default, uses the same color as fill_color.</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">        alpha (int, optional): alpha value for the fill color. 100 by default</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        string: RGBA line and fill colors</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="n">c</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">as_cmap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="n">fill_color</span> <span class="o">=</span> <span class="s2">&quot;rgba(</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="k">if</span> <span class="n">outline_color</span> <span class="o">==</span> <span class="s2">&quot;same_as_fill&quot;</span><span class="p">:</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="n">line_color</span> <span class="o">=</span> <span class="s2">&quot;rgb(</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="k">elif</span> <span class="n">outline_color</span> <span class="o">==</span> <span class="s2">&quot;black&quot;</span><span class="p">:</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="n">line_color</span> <span class="o">=</span> <span class="s2">&quot;rgb(</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="k">elif</span> <span class="n">outline_color</span> <span class="o">==</span> <span class="s2">&quot;white&quot;</span><span class="p">:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="n">line_color</span> <span class="o">=</span> <span class="s2">&quot;rgb(</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="k">return</span> <span class="n">line_color</span><span class="p">,</span> <span class="n">fill_color</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="luna.pathology.dsa.utils.vectorize_np_array_bitmask_by_pixel_value" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">vectorize_np_array_bitmask_by_pixel_value</span><span class="p">(</span><span class="n">bitmask_np</span><span class="p">,</span> <span class="n">label_num</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">polygon_tolerance</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">contour_level</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

<a href="#luna.pathology.dsa.utils.vectorize_np_array_bitmask_by_pixel_value" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Get simplified contours from the bitmask</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>bitmask_np</code></td>
          <td>
                <code><span title="numpy.array">array</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>a numpy bitmask</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>label_num</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>numeric value to filter the numpy array</p>
            </div>
          </td>
          <td>
                <code>255</code>
          </td>
        </tr>
        <tr>
          <td><code>polygon_tolerance</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Maximum distance from original points of polygon
to approximated polygonal chain. If tolerance is 0, the original coordinate array is returned.</p>
            </div>
          </td>
          <td>
                <code>1</code>
          </td>
        </tr>
        <tr>
          <td><code>contour_level</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Value along which to find contours in the array.
0.5 by default</p>
            </div>
          </td>
          <td>
                <code>0.5</code>
          </td>
        </tr>
        <tr>
          <td><code>scale_factor</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>scale to match image. default 1</p>
            </div>
          </td>
          <td>
                <code>1</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>list</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>simplified approximated contours</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/dsa/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span>
<span class="normal"><a href="#__codelineno-0-92">92</a></span>
<span class="normal"><a href="#__codelineno-0-93">93</a></span>
<span class="normal"><a href="#__codelineno-0-94">94</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="k">def</span> <span class="nf">vectorize_np_array_bitmask_by_pixel_value</span><span class="p">(</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="n">bitmask_np</span><span class="p">,</span> <span class="n">label_num</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">polygon_tolerance</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">contour_level</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mi">1</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="p">):</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get simplified contours from the bitmask</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">        bitmask_np (np.array): a numpy bitmask</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">        label_num (int, optional): numeric value to filter the numpy array</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">        polygon_tolerance (float, optional): Maximum distance from original points of polygon</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">            to approximated polygonal chain. If tolerance is 0, the original coordinate array is returned.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">        contour_level (float, optional): Value along which to find contours in the array.</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">            0.5 by default</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">        scale_factor (int, optional): scale to match image. default 1</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">        list: simplified approximated contours</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">scale_factor</span><span class="p">:</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="n">scale_factor</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bitmask_np</span> <span class="o">==</span> <span class="n">label_num</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="n">contours</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">find_contours</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">contour_level</span><span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="n">simplified_contours</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="n">measure</span><span class="o">.</span><span class="n">approximate_polygon</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="n">polygon_tolerance</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contours</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>    <span class="p">]</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">contour</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">simplified_contours</span><span class="p">):</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">contour</span><span class="p">:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>            <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>            <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="c1"># switch coordinates, otherwise gets flipped</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>            <span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">scale_factor</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">scale_factor</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="k">return</span> <span class="n">simplified_contours</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>


  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h2 id="luna.pathology.slideviewer" class="doc doc-heading">
          <code>slideviewer</code>


<a href="#luna.pathology.slideviewer" class="headerlink" title="Permanent link">&para;</a></h2>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-module">




<h3 id="luna.pathology.slideviewer.regional_annotation" class="doc doc-heading">
          <code>regional_annotation</code>


<a href="#luna.pathology.slideviewer.regional_annotation" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-module">




<h4 id="luna.pathology.slideviewer.regional_annotation.dask_generate" class="doc doc-heading">
          <code>dask_generate</code>


<a href="#luna.pathology.slideviewer.regional_annotation.dask_generate" class="headerlink" title="Permanent link">&para;</a></h4>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h5 id="luna.pathology.slideviewer.regional_annotation.dask_generate.cli" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">cli</span><span class="p">(</span><span class="n">data_config_file</span><span class="p">,</span> <span class="n">app_config_file</span><span class="p">)</span></code>

<a href="#luna.pathology.slideviewer.regional_annotation.dask_generate.cli" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>This module generates parquets with regional annotation pathology data</p>
<p>INPUT PARAMETERS</p>
<p>app_config_file - path to yaml file containing application runtime parameters. See config.yaml.template</p>
<p>data_config_file - path to yaml file containing data input and output parameters. See dask_data_config.yaml.template</p>
<p>TABLE SCHEMA</p>
<ul>
<li>
<p>sv_project_id: project number in slide viewer</p>
</li>
<li>
<p>slideviewer_path: slide path based on slideviewer organization</p>
</li>
<li>
<p>slide_id: slide id. synonymous with image_id</p>
</li>
<li>
<p>user: username of the annotator for a given annotation. For all slides, we combine multiple annotations from
    different users for a slide. In this case, user is set to 'CONCAT' and bmp_filepath, npy_filepath are null.</p>
</li>
<li>
<p>bmp_filepath: file path to downloaded bmp annotation file</p>
</li>
<li>
<p>npy_filepath: file path to npy annotation file converted from bmp</p>
</li>
<li>
<p>geojson_path: file path to  geojson file converted from numpy</p>
</li>
<li>
<p>date: creation date</p>
</li>
<li>
<p>labelset:</p>
</li>
</ul>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/slideviewer/regional_annotation/dask_generate.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span>
<span class="normal"><a href="#__codelineno-0-92">92</a></span>
<span class="normal"><a href="#__codelineno-0-93">93</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="nd">@click</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="s2">&quot;-d&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="s2">&quot;--data_config_file&quot;</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;path to yaml file containing data input and output parameters. &quot;</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="s2">&quot;See dask_data_config.yaml.template&quot;</span><span class="p">,</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="p">)</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="s2">&quot;-a&quot;</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="s2">&quot;--app_config_file&quot;</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;config.yaml&quot;</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;path to yaml file containing application runtime parameters. &quot;</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="s2">&quot;See config.yaml.template&quot;</span><span class="p">,</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="k">def</span> <span class="nf">cli</span><span class="p">(</span><span class="n">data_config_file</span><span class="p">,</span> <span class="n">app_config_file</span><span class="p">):</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;This module generates parquets with regional annotation pathology data</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">    INPUT PARAMETERS</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">    app_config_file - path to yaml file containing application runtime parameters. See config.yaml.template</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">    data_config_file - path to yaml file containing data input and output parameters. See dask_data_config.yaml.template</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">    TABLE SCHEMA</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">    - sv_project_id: project number in slide viewer</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">    - slideviewer_path: slide path based on slideviewer organization</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">    - slide_id: slide id. synonymous with image_id</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">    - user: username of the annotator for a given annotation. For all slides, we combine multiple annotations from</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">        different users for a slide. In this case, user is set to &#39;CONCAT&#39; and bmp_filepath, npy_filepath are null.</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">    - bmp_filepath: file path to downloaded bmp annotation file</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">    - npy_filepath: file path to npy annotation file converted from bmp</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">    - geojson_path: file path to  geojson file converted from numpy</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">    - date: creation date</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">    - labelset:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="n">logger</span> <span class="o">=</span> <span class="n">init_logger</span><span class="p">()</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>    <span class="c1"># load configs</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="n">cfg</span> <span class="o">=</span> <span class="n">ConfigSet</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;DATA_CFG&quot;</span><span class="p">,</span> <span class="n">config_file</span><span class="o">=</span><span class="n">data_config_file</span><span class="p">)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="n">cfg</span> <span class="o">=</span> <span class="n">ConfigSet</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;APP_CFG&quot;</span><span class="p">,</span> <span class="n">config_file</span><span class="o">=</span><span class="n">app_config_file</span><span class="p">)</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="k">with</span> <span class="n">CodeTimer</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="s2">&quot;generate annotation geojson table&quot;</span><span class="p">):</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;data template: &quot;</span> <span class="o">+</span> <span class="n">data_config_file</span><span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;config_file: &quot;</span> <span class="o">+</span> <span class="n">app_config_file</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="c1"># copy app and data configuration to destination config dir</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="n">config_location</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">CONFIG_LOCATION</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">config_location</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">app_config_file</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_location</span><span class="p">,</span> <span class="s2">&quot;app_config.yaml&quot;</span><span class="p">))</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data_config_file</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_location</span><span class="p">,</span> <span class="s2">&quot;data_config.yaml&quot;</span><span class="p">))</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;config files copied to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">config_location</span><span class="p">)</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="n">failed</span> <span class="o">=</span> <span class="n">create_geojson_table</span><span class="p">()</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="k">if</span> <span class="n">failed</span><span class="p">:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;GEOJSON table creation had errors. Exiting.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">failed</span><span class="p">)</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;GEOJSON table creation had errors. Exiting.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="k">return</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h5 id="luna.pathology.slideviewer.regional_annotation.dask_generate.create_geojson_table" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">create_geojson_table</span><span class="p">()</span></code>

<a href="#luna.pathology.slideviewer.regional_annotation.dask_generate.create_geojson_table" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Vectorizes npy array annotation file into polygons and builds GeoJson with the polygon features.
Creates a geojson file per labelset.
Combines multiple annotations from different users for a slide.</p>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>list</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>list of slide ids that failed</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/slideviewer/regional_annotation/dask_generate.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="k">def</span> <span class="nf">create_geojson_table</span><span class="p">():</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Vectorizes npy array annotation file into polygons and builds GeoJson with the polygon features.</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">    Creates a geojson file per labelset.</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">    Combines multiple annotations from different users for a slide.</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">        list: list of slide ids that failed</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>    <span class="n">failed</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="c1"># get application and data config variables</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>    <span class="n">cfg</span> <span class="o">=</span> <span class="n">ConfigSet</span><span class="p">()</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">n_workers</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">memory_limit</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="n">client</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">init_logger</span><span class="p">)</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="n">SLIDEVIEWER_API_URL</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;DATA_CFG::SLIDEVIEWER_API_URL&quot;</span><span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="n">SLIDEVIEWER_CSV_FILE</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;DATA_CFG::SLIDEVIEWER_CSV_FILE&quot;</span><span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>    <span class="n">PROJECT_ID</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;DATA_CFG::PROJECT_ID&quot;</span><span class="p">)</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>    <span class="n">LANDING_PATH</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;DATA_CFG::LANDING_PATH&quot;</span><span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>    <span class="n">TMP_ZIP_DIR_NAME</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;DATA_CFG::REQUESTOR_DEPARTMENT&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_tmp_zips&quot;</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>    <span class="n">TMP_ZIP_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LANDING_PATH</span><span class="p">,</span> <span class="n">TMP_ZIP_DIR_NAME</span><span class="p">)</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>    <span class="n">SLIDE_BMP_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LANDING_PATH</span><span class="p">,</span> <span class="s2">&quot;regional_bmps&quot;</span><span class="p">)</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>    <span class="n">SLIDE_NPY_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LANDING_PATH</span><span class="p">,</span> <span class="s2">&quot;regional_npys&quot;</span><span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>    <span class="n">SLIDE_STORE_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LANDING_PATH</span><span class="p">,</span> <span class="s2">&quot;slides&quot;</span><span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>    <span class="n">TABLE_OUT_DIR</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">TABLE_LOCATION</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">TABLE_OUT_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Table output directory = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">TABLE_OUT_DIR</span><span class="p">)</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="c1"># setup variables needed for build geojson UDF</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="n">contour_level</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;DATA_CFG::CONTOUR_LEVEL&quot;</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>    <span class="c1"># fetch full set of slideviewer slides for project</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>    <span class="n">slides</span> <span class="o">=</span> <span class="n">fetch_slide_ids</span><span class="p">(</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="n">SLIDEVIEWER_API_URL</span><span class="p">,</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="n">PROJECT_ID</span><span class="p">,</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="n">const</span><span class="o">.</span><span class="n">CONFIG_LOCATION</span><span class="p">(</span><span class="n">cfg</span><span class="p">),</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>        <span class="n">SLIDEVIEWER_CSV_FILE</span><span class="p">,</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="p">)</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">slides</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;slideviewer_path&quot;</span><span class="p">,</span> <span class="s2">&quot;slide_id&quot;</span><span class="p">,</span> <span class="s2">&quot;sv_project_id&quot;</span><span class="p">]</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="p">)</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>    <span class="c1"># get users and labelsets for df explosion</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="n">all_users_list</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;DATA_CFG::USERS&quot;</span><span class="p">)</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>    <span class="n">all_labelsets</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;DATA_CFG::LABEL_SETS&quot;</span><span class="p">)</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="k">global</span> <span class="n">params</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="n">params</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get_config_set</span><span class="p">(</span><span class="s2">&quot;APP_CFG&quot;</span><span class="p">)</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="n">bmp_jobs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="n">bmp_future</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>            <span class="n">check_slideviewer_and_download_bmp</span><span class="p">,</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>            <span class="n">row</span><span class="o">.</span><span class="n">sv_project_id</span><span class="p">,</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>            <span class="n">row</span><span class="o">.</span><span class="n">slideviewer_path</span><span class="p">,</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>            <span class="n">row</span><span class="o">.</span><span class="n">slide_id</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>            <span class="n">all_users_list</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>            <span class="n">SLIDE_BMP_DIR</span><span class="p">,</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="n">SLIDEVIEWER_API_URL</span><span class="p">,</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="n">TMP_ZIP_DIR</span><span class="p">,</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="n">bmp_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bmp_future</span><span class="p">)</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>    <span class="n">json_jobs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>    <span class="k">for</span> <span class="n">bmp_future</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">bmp_jobs</span><span class="p">):</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="k">if</span> <span class="n">bmp_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>            <span class="n">json_future</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                <span class="n">convert_slide_bitmap_to_geojson</span><span class="p">,</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                <span class="n">bmp_future</span><span class="p">,</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                <span class="n">all_labelsets</span><span class="p">,</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                <span class="n">contour_level</span><span class="p">,</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>                <span class="n">SLIDE_NPY_DIR</span><span class="p">,</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                <span class="n">SLIDE_STORE_DIR</span><span class="p">,</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>            <span class="p">)</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>            <span class="n">json_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json_future</span><span class="p">)</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="k">for</span> <span class="n">json_future</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">json_jobs</span><span class="p">):</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="n">slide_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>            <span class="k">if</span> <span class="n">json_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>                <span class="n">slide_id</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">json_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>                <span class="k">if</span> <span class="n">slide_id</span> <span class="ow">and</span> <span class="n">data</span><span class="p">:</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>                    <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">result_df</span><span class="p">)</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>                    <span class="n">result_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;geojson&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">TABLE_OUT_DIR</span><span class="si">}</span><span class="s2">/regional_annot_slice_slide=</span><span class="si">{</span><span class="n">slide_id</span><span class="si">}</span><span class="s2">.parquet&quot;</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>                    <span class="p">)</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>                    <span class="n">failed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slide_id</span><span class="p">)</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>                        <span class="s2">&quot;Empty geojson returned. this means either this was an empty slide or an error occured during geojson generate&quot;</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>                    <span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>            <span class="n">failed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slide_id</span><span class="p">)</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Something was wrong with future </span><span class="si">{</span><span class="n">json_future</span><span class="si">}</span><span class="s2">, skipping.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>    <span class="n">client</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>    <span class="k">return</span> <span class="n">failed</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>


  </div>

  </div>

</div>


  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h2 id="luna.pathology.spatial" class="doc doc-heading">
          <code>spatial</code>


<a href="#luna.pathology.spatial" class="headerlink" title="Permanent link">&para;</a></h2>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-module">




<h3 id="luna.pathology.spatial.stats" class="doc doc-heading">
          <code>stats</code>


<a href="#luna.pathology.spatial.stats" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.spatial.stats.Kfunction" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">Kfunction</span><span class="p">(</span><span class="n">p1XY</span><span class="p">,</span> <span class="n">p2XY</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">intensity</span><span class="o">=</span><span class="p">[],</span> <span class="n">distance</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">distance_scale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span></code>

<a href="#luna.pathology.spatial.stats.Kfunction" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Computes the Counting, Intensity, and experimental
            Intensity-Distance K functions</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>p1XY</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>An Nx2 array representing the (X,Y) coordinates of cells with phenotype 1</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>p2XY</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Same as p1XY but for phenotype 2 cells</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>radius</code></td>
          <td>
                <code>(float, list[float])</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The radius (or list of radii) to consider</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>ls</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If True, returns an |radius|x|p1XY| 2D array representing the K function
for each phenotype 1 cell for each radius. If False, returns the mean
for each radius</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>count</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>By default, this function only computes the Counting K function.
Can be disabled with count=False.</p>
            </div>
          </td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>intensity</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>An array of length |p2XY| representing the intensity of each
   phenotype 2 cell. When passed in, this method will also compute
   the Intensity K function</p>
            </div>
          </td>
          <td>
                <code>[]</code>
          </td>
        </tr>
    </tbody>
  </table>
      <div class="highlight"><pre><span></span><code>distance (bool): If an intensity array is passed in, then setting distance=True
          will compute the experimental Intensity-Distance K function
        distance_scale (float): Characteristic distance scale (usually approx. 1 cell length in the given units)

Returns:
        dict: a dictionary with keys [&quot;count&quot;, &quot;intensity&quot;, &quot;distance&quot;] and values corresponding to the result of each K function
</code></pre></div>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/spatial/stats.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="k">def</span> <span class="nf">Kfunction</span><span class="p">(</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="n">p1XY</span><span class="p">,</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="n">p2XY</span><span class="p">,</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="n">radius</span><span class="p">,</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="n">ls</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="n">intensity</span><span class="o">=</span><span class="p">[],</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="n">distance</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="n">distance_scale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="p">):</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes the Counting, Intensity, and experimental</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">                Intensity-Distance K functions</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">            p1XY (np.ndarray): An Nx2 array representing the (X,Y) coordinates of cells with phenotype 1</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">            p2XY (np.ndarray): Same as p1XY but for phenotype 2 cells</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">            radius (float, list[float]): The radius (or list of radii) to consider</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">            ls (bool): If True, returns an |radius|x|p1XY| 2D array representing the K function</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">                for each phenotype 1 cell for each radius. If False, returns the mean</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">                for each radius</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">            count (bool): By default, this function only computes the Counting K function.</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">                   Can be disabled with count=False.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">            intensity (np.ndarray): An array of length |p2XY| representing the intensity of each</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">                       phenotype 2 cell. When passed in, this method will also compute</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">                       the Intensity K function</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">        distance (bool): If an intensity array is passed in, then setting distance=True</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">                  will compute the experimental Intensity-Distance K function</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">                distance_scale (float): Characteristic distance scale (usually approx. 1 cell length in the given units)</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">                dict: a dictionary with keys [&quot;count&quot;, &quot;intensity&quot;, &quot;distance&quot;] and values corresponding to the result of each K function</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="c1"># Compute the distance matrix</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="n">dists</span> <span class="o">=</span> <span class="n">cdist</span><span class="p">(</span><span class="n">p1XY</span><span class="p">,</span> <span class="n">p2XY</span><span class="p">)</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="c1"># Turn radius into an array if it isn&#39;t one already</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="nb">iter</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="n">radius</span> <span class="o">=</span> <span class="p">[</span><span class="n">radius</span><span class="p">]</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="c1"># Define the lambdas for each K function variant</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="n">CKfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="n">IKfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">Imask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Imask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>    <span class="n">IDKfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">Imask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="n">Imask</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">distance_scale</span> <span class="o">+</span> <span class="p">(</span><span class="n">dists</span> <span class="o">/</span> <span class="n">distance_scale</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="p">)</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="c1"># Compute the mask for each radius</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>    <span class="n">masks</span> <span class="o">=</span> <span class="p">[(</span><span class="n">dists</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">radius</span><span class="p">]</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>    <span class="c1"># Calculate each K function</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="n">Kdict</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="n">CK</span> <span class="o">=</span> <span class="p">[</span><span class="n">CKfunc</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">]</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="n">Kdict</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ret</span><span class="p">(</span><span class="n">CK</span><span class="p">,</span> <span class="n">ls</span><span class="p">)</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">p2XY</span><span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="n">Imasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">mask</span> <span class="o">*</span> <span class="n">intensity</span> <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">]</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="n">IK</span> <span class="o">=</span> <span class="p">[</span><span class="n">IKfunc</span><span class="p">(</span><span class="n">Imask</span><span class="p">)</span> <span class="k">for</span> <span class="n">Imask</span> <span class="ow">in</span> <span class="n">Imasks</span><span class="p">]</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="n">Kdict</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ret</span><span class="p">(</span><span class="n">IK</span><span class="p">,</span> <span class="n">ls</span><span class="p">)</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="k">if</span> <span class="n">distance</span><span class="p">:</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="n">IDK</span> <span class="o">=</span> <span class="p">[</span><span class="n">IDKfunc</span><span class="p">(</span><span class="n">Imask</span><span class="p">)</span> <span class="k">for</span> <span class="n">Imask</span> <span class="ow">in</span> <span class="n">Imasks</span><span class="p">]</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="n">Kdict</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ret</span><span class="p">(</span><span class="n">IDK</span><span class="p">,</span> <span class="n">ls</span><span class="p">)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>    <span class="k">return</span> <span class="n">Kdict</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">




<h3 id="luna.pathology.spatial.transforms" class="doc doc-heading">
          <code>transforms</code>


<a href="#luna.pathology.spatial.transforms" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">
  
      <p>Higher-level transformation functions</p>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="luna.pathology.spatial.transforms.generate_k_function_statistics" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">generate_k_function_statistics</span><span class="p">(</span><span class="n">cell_paths</span><span class="p">,</span> <span class="n">method_data</span><span class="p">,</span> <span class="n">main_index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#luna.pathology.spatial.transforms.generate_k_function_statistics" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Compute K-function spatial statistics on given cell-data</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>cell_paths</code></td>
          <td>
                <code>str or list[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>paths to a single or multiple FOV regions</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>method_data</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Configuration:
    "index": (str, optional) Column containting the patient/desired ID, if available (overrides main_index)
    "phenotype1" : {
            "name" : (str) Column name to query
            'value' : (str) Phenotype string to match (e.g. CD68)
    },
    "phenotype2" : {
            "name" : (str) Column name to query
            'value' : (str) Phenotype string to match (e.g. panCK)
    },
    "count" : (bool) Flag to compute counting stats.
    "radius" : (float) Radius cutoff
    "intensity" : (str, optional) Column containing intensity information
    "distance" : (bool) Flag to compute intensity-distance stats.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>pd.DataFrame: spatial statistics aggregated over FOVs</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/luna/pathology/spatial/transforms.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="k">def</span> <span class="nf">generate_k_function_statistics</span><span class="p">(</span><span class="n">cell_paths</span><span class="p">,</span> <span class="n">method_data</span><span class="p">,</span> <span class="n">main_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">    Compute K-function spatial statistics on given cell-data</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">        cell_paths (str or list[str]): paths to a single or multiple FOV regions</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">        method_data (dict): Configuration:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">                &quot;index&quot;: (str, optional) Column containting the patient/desired ID, if available (overrides main_index)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">                &quot;phenotype1&quot; : {</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">                        &quot;name&quot; : (str) Column name to query</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">                        &#39;value&#39; : (str) Phenotype string to match (e.g. CD68)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">                },</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">                &quot;phenotype2&quot; : {</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">                        &quot;name&quot; : (str) Column name to query</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">                        &#39;value&#39; : (str) Phenotype string to match (e.g. panCK)</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">                },</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">                &quot;count&quot; : (bool) Flag to compute counting stats.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">                &quot;radius&quot; : (float) Radius cutoff</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">                &quot;intensity&quot; : (str, optional) Column containing intensity information</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">                &quot;distance&quot; : (bool) Flag to compute intensity-distance stats.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        pd.DataFrame: spatial statistics aggregated over FOVs</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">cell_paths</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="n">cell_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">cell_paths</span><span class="p">]</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">cell_paths</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="n">agg_k_data</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="n">pheno1_col</span> <span class="o">=</span> <span class="n">method_data</span><span class="p">[</span><span class="s2">&quot;phenotype1&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="n">pheno1_val</span> <span class="o">=</span> <span class="n">method_data</span><span class="p">[</span><span class="s2">&quot;phenotype1&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="n">pheno2_col</span> <span class="o">=</span> <span class="n">method_data</span><span class="p">[</span><span class="s2">&quot;phenotype2&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="n">pheno2_val</span> <span class="o">=</span> <span class="n">method_data</span><span class="p">[</span><span class="s2">&quot;phenotype2&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="n">index_col</span> <span class="o">=</span> <span class="n">method_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="n">radius</span> <span class="o">=</span> <span class="n">method_data</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">]</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="n">count</span> <span class="o">=</span> <span class="n">method_data</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="n">distance</span> <span class="o">=</span> <span class="n">method_data</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="n">intensity_col</span> <span class="o">=</span> <span class="n">method_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="n">indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="k">for</span> <span class="n">cell_path</span> <span class="ow">in</span> <span class="n">cell_paths</span><span class="p">:</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">cell_path</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.parquet&quot;</span><span class="p">:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">cell_path</span><span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="k">elif</span> <span class="n">Path</span><span class="p">(</span><span class="n">cell_path</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.csv&quot;</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">cell_path</span><span class="p">)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid input data type </span><span class="si">{</span><span class="n">cell_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="c1"># Look up the index for this slice</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="k">if</span> <span class="n">index_col</span><span class="p">:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>            <span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">method_data</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>            <span class="n">indices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="c1"># Create the data arrays</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="n">pheno1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">pheno1_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">pheno1_val</span><span class="p">]</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="n">pheno2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">pheno2_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">pheno2_val</span><span class="p">]</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="n">p1XY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pheno1</span><span class="p">[[</span><span class="s2">&quot;Centroid X m&quot;</span><span class="p">,</span> <span class="s2">&quot;Centroid Y m&quot;</span><span class="p">]])</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="n">p2XY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pheno2</span><span class="p">[[</span><span class="s2">&quot;Centroid X m&quot;</span><span class="p">,</span> <span class="s2">&quot;Centroid Y m&quot;</span><span class="p">]])</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="k">if</span> <span class="n">intensity_col</span><span class="p">:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="n">intensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pheno2</span><span class="p">[</span><span class="n">intensity_col</span><span class="p">])</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>            <span class="n">intensity</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>            <span class="k">if</span> <span class="n">distance</span><span class="p">:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>                    <span class="s2">&quot;Can&#39;t compute intensity-distance function without intensity information&quot;</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>                <span class="p">)</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="k">if</span> <span class="n">p1XY</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>            <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>                <span class="sa">f</span><span class="s2">&quot;WARNING: List of phenotype 1 cells (</span><span class="si">{</span><span class="n">pheno1_val</span><span class="si">}</span><span class="s2">) is empty for </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>            <span class="p">)</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="k">if</span> <span class="n">p2XY</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                <span class="sa">f</span><span class="s2">&quot;WARNING: List of phenotype 2 cells (</span><span class="si">{</span><span class="n">pheno2_val</span><span class="si">}</span><span class="s2">) is empty for </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="p">)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="c1"># Compute the K function</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running... </span><span class="si">{</span><span class="n">cell_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="n">fov_k_data</span> <span class="o">=</span> <span class="n">Kfunction</span><span class="p">(</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>            <span class="n">p1XY</span><span class="p">,</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>            <span class="n">p2XY</span><span class="p">,</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>            <span class="n">radius</span><span class="p">,</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="n">ls</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="n">intensity</span><span class="o">=</span><span class="n">intensity</span><span class="p">,</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fov_k_data</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">agg_k_data</span><span class="p">:</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>                <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agg_k_data</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">fov_k_data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                <span class="n">agg_k_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fov_k_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="n">data_out</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>    <span class="k">for</span> <span class="n">kfunct</span> <span class="ow">in</span> <span class="n">agg_k_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="n">arr</span> <span class="o">=</span> <span class="n">agg_k_data</span><span class="p">[</span><span class="n">kfunct</span><span class="p">]</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="n">data_out</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="p">{</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                <span class="sa">f</span><span class="s2">&quot;For_</span><span class="si">{</span><span class="n">pheno1_val</span><span class="si">}</span><span class="s2">_Find_</span><span class="si">{</span><span class="n">pheno2_val</span><span class="si">}</span><span class="s2">_at</span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">kfunct</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">intensity_col</span><span class="si">}</span><span class="s2">_mean&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                    <span class="n">arr</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                <span class="p">),</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                <span class="sa">f</span><span class="s2">&quot;For_</span><span class="si">{</span><span class="n">pheno1_val</span><span class="si">}</span><span class="s2">_Find_</span><span class="si">{</span><span class="n">pheno2_val</span><span class="si">}</span><span class="s2">_at</span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">kfunct</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">intensity_col</span><span class="si">}</span><span class="s2">_variance&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                    <span class="n">arr</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                <span class="p">),</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>                <span class="sa">f</span><span class="s2">&quot;For_</span><span class="si">{</span><span class="n">pheno1_val</span><span class="si">}</span><span class="s2">_Find_</span><span class="si">{</span><span class="n">pheno2_val</span><span class="si">}</span><span class="s2">_at</span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">kfunct</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">intensity_col</span><span class="si">}</span><span class="s2">_skew&quot;</span><span class="p">:</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">skew</span><span class="p">(</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                    <span class="n">arr</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                <span class="p">),</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                <span class="sa">f</span><span class="s2">&quot;For_</span><span class="si">{</span><span class="n">pheno1_val</span><span class="si">}</span><span class="s2">_Find_</span><span class="si">{</span><span class="n">pheno2_val</span><span class="si">}</span><span class="s2">_at</span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">kfunct</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">intensity_col</span><span class="si">}</span><span class="s2">_kurtosis&quot;</span><span class="p">:</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">kurtosis</span><span class="p">(</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                    <span class="n">arr</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                <span class="p">),</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>            <span class="p">}</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="p">)</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="n">df_slice_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_out</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>    <span class="k">if</span> <span class="n">main_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                <span class="sa">f</span><span class="s2">&quot;Multiple cell maps with different indices! Found: </span><span class="si">{</span><span class="n">indices</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="p">)</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="n">main_index</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="n">df_slice_out</span><span class="p">[</span><span class="s2">&quot;main_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_index</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="n">df_slice_out</span> <span class="o">=</span> <span class="n">df_slice_out</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;main_index&quot;</span><span class="p">)</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">df_slice_out</span><span class="p">)</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>    <span class="k">return</span> <span class="n">df_slice_out</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>


  </div>

  </div>

</div>


  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../common/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Luna Common" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Luna Common
            </div>
          </div>
        </a>
      
      
        
        <a href="../radiology/" class="md-footer__link md-footer__link--next" aria-label="Next: Luna Radiology" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Luna Radiology
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.indexes", "instant", "tabs"], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
    
    
  </body>
</html>